# 智能财务管理系统 - 超详细操作指南（大白话版）

---

## 📚 目录

1. [系统介绍](#系统介绍)
2. [两个系统的区别](#两个系统的区别)
3. [信用卡管理系统操作指南](#信用卡管理系统操作指南)
4. [银行贷款会计系统操作指南](#银行贷款会计系统操作指南)
5. [常见问题解答](#常见问题解答)

---

## 系统介绍

您现在有**两个**系统在运行：

### 🏦 系统1：信用卡管理系统（端口5000）
- **用途**：帮马来西亚的客户管理他们的信用卡账单
- **谁用**：您的客户（普通人）
- **能做什么**：上传PDF账单、自动分类消费、生成月度报告、贷款分析

### 💼 系统2：银行贷款会计系统（端口8000）
- **用途**：帮公司做会计账，符合银行贷款审批要求
- **谁用**：会计人员、财务经理
- **能做什么**：上传银行月结单、自动生成会计分录、出报表给银行

---

## 两个系统的区别

| 特点 | 信用卡系统（5000端口） | 会计系统（8000端口） |
|------|----------------------|---------------------|
| **访问地址** | `http://你的域名:5000` | `http://你的域名:8000` |
| **使用者** | 客户（普通人） | 会计、财务专业人员 |
| **主要功能** | 信用卡账单分析 | 公司账目管理 |
| **数据存储** | SQLite文件 | PostgreSQL数据库 |
| **设计风格** | 黑+粉红+紫色，很炫酷 | 专业财务报表风格 |

---

## 信用卡管理系统操作指南

### 🎯 第一次使用：管理员设置

#### 步骤1：访问系统
1. 打开浏览器（Chrome或Edge都可以）
2. 输入网址：`http://你的域名:5000`
3. 您会看到一个**黑色背景、粉红色标题**的首页
4. 页面上会显示"智能信用卡&贷款管理系统"

**预期效果**：
- ✅ 页面背景是纯黑色
- ✅ 标题和按钮是粉红色（#FF007F）
- ✅ 看到"所有客户"列表（可能是空的）

---

#### 步骤2：添加第一个客户

1. **找到"添加客户"按钮**
   - 在首页右上角，有个粉红色的按钮
   - 点击它

2. **填写客户资料**
   - 姓名：`张三` （随便写个名字）
   - 邮箱：`zhangsan@example.com`
   - 电话：`0123456789`
   - 月收入：`8000` （写数字，单位是马币）
   - 点击**"提交"**按钮

3. **系统会自动跳转到客户页面**

**预期效果**：
- ✅ 看到一个成功提示："客户 张三 (Be_rich_ZS) 添加成功！"
- ✅ 自动跳转到张三的个人页面
- ✅ 页面上显示张三的名字和基本信息
- ✅ 系统自动生成了客户代码：`Be_rich_ZS`（取名字首字母）

---

#### 步骤3：为客户添加信用卡

现在我们要给张三添加一张信用卡。

1. **在张三的页面上找"添加信用卡"按钮**
   - 页面中间有个按钮，上面写着"添加信用卡"
   - 点击它

2. **填写信用卡信息**
   - 银行名称：`Maybank` （马来西亚银行）
   - 卡号后4位：`1234` （只写最后4位数字）
   - 卡类型：选`Visa` 或 `Mastercard`
   - 信用额度：`15000` （这张卡的最高额度）
   - 利率：`18` （年利率，写百分比数字）
   - 返现率：`1.5` （有些卡有返现）
   - 账单日：选一个日期，比如`5号`
   - 点击**"保存"**

**预期效果**：
- ✅ 看到成功提示："信用卡添加成功"
- ✅ 返回到张三的页面
- ✅ 在"我的信用卡"区域看到刚刚添加的Maybank卡
- ✅ 卡片上显示：Maybank-1234, 额度RM15,000

---

#### 步骤4：上传第一份信用卡账单（重点！）

这是系统的核心功能，我详细说明：

1. **准备PDF账单**
   - 您需要一份真实的银行信用卡账单PDF
   - 比如：Maybank的2024年7月账单
   - 文件名示例：`Maybank_July_2024.pdf`

2. **在张三的页面上找"上传账单"功能**
   - 滚动页面，找到"账单管理"区域
   - 点击**"上传账单"**按钮

3. **填写上传表单**
   - 选择信用卡：选刚才添加的`Maybank-1234`
   - 账单月份：选`2024-07`（年-月格式）
   - 选择文件：点击"选择文件"，找到您的PDF
   - 点击**"上传并解析"**

4. **等待系统处理**
   - 系统会花几秒钟读取PDF
   - 您会看到一个加载动画（转圈圈）
   - 等待直到页面跳转

**预期效果**：
- ✅ 上传成功后，跳转到"验证页面"
- ✅ 左边显示原始PDF（您可以看到银行账单的样子）
- ✅ 右边显示系统解析出来的交易记录
- ✅ 每一笔交易旁边有个分类标签（比如"餐饮"、"购物"）
- ✅ 页面底部显示总数：比如"解析了45笔交易"

---

#### 步骤5：验证账单数据

在验证页面上，您需要检查：

1. **核对交易数量**
   - 数一下PDF上有多少笔交易
   - 看右边系统解析了多少笔
   - **如果数量一样**：说明系统没漏掉任何交易 ✅

2. **随机抽查几笔交易**
   - 找PDF上的某一笔，比如"Starbucks RM35.00"
   - 看右边系统有没有这一笔
   - 检查金额是否正确
   - 看分类对不对（Starbucks应该分类为"餐饮"）

3. **确认账单**
   - 如果都正确，点击页面底部的**"确认无误"**按钮
   - 如果有错误，点击**"重新上传"**

**预期效果**：
- ✅ 点击"确认无误"后，跳转回张三的主页
- ✅ 看到成功提示："账单验证成功"
- ✅ 在"最近账单"列表中看到这份账单
- ✅ 账单状态显示为"已验证"（绿色标记）

---

#### 步骤6：查看自动生成的报告

现在系统已经帮您分析好了张三的消费情况。

1. **在张三的页面上找"月度报告"**
   - 滚动到页面中间
   - 看到一个区域叫"月度财务报告"
   - 里面有一份2024年7月的报告

2. **点击查看报告**
   - 点击报告上的**"查看详情"**按钮
   - 系统会打开一个新页面

**预期效果**：
- ✅ 看到一份漂亮的PDF报告（星空主题，紫色渐变背景）
- ✅ 报告第1页：客户基本信息和月度总结
- ✅ 报告第2页：按类别统计（餐饮花了多少、购物花了多少）
- ✅ 报告第3页：消费趋势图（折线图）
- ✅ 报告第4页：AI建议（比如"您在餐饮上花费较多，建议控制"）
- ✅ 报告最后一页：财务优化建议

---

### 📊 第二部分：日常使用功能

#### 功能1：查看所有客户

1. **回到首页**
   - 点击左上角的"系统首页"链接
   - 或者直接访问：`http://你的域名:5000`

2. **浏览客户列表**
   - 您会看到所有客户的卡片
   - 每张卡片显示：客户名字、邮箱、卡数量

3. **点击任意客户**
   - 点击卡片上的客户名字
   - 跳转到该客户的详细页面

**预期效果**：
- ✅ 首页显示所有客户（像名片一样排列）
- ✅ 每张卡片有粉红色边框
- ✅ 点击客户后跳转到他们的个人仪表板

---

#### 功能2：查看信用卡时间轴

这个功能帮您快速看到某张信用卡有哪些月份的账单。

1. **进入客户页面**
   - 比如张三的页面

2. **找到"信用卡账本"按钮**
   - 在页面上有个紫色按钮："查看信用卡账本"
   - 点击它

3. **看到12个月的时间轴**
   - 页面显示一个日历格子（12个月）
   - 有账单的月份会显示绿色✅
   - 没账单的月份显示灰色⭕

4. **点击任意月份**
   - 比如点击"2024-07"
   - 跳转到这个月的详细账单

**预期效果**：
- ✅ 看到一个时间轴视图（像日历）
- ✅ 一眼看出哪些月份有账单、哪些没有
- ✅ 点击有账单的月份，立即看到详情

---

#### 功能3：查看月度账单详情

1. **从时间轴点进某个月**
   - 比如2024年7月

2. **看到这个月的完整报告**
   - 上期结余（Previous Balance）
   - 本期消费（Owner Expenses）
   - 本期还款（Owner Payments）
   - 本期结余（Closing Balance）
   - **INFINITE部分**（如果有供应商交易）
     - INFINITE消费
     - INFINITE还款
     - 1%手续费

3. **查看交易明细**
   - 页面下方有个表格
   - 列出这个月所有交易
   - 每笔交易显示：日期、商家、金额、分类

**预期效果**：
- ✅ 看到完整的月度账单（像银行账单一样）
- ✅ 数字全部准确（100%数据准确性）
- ✅ OWNER和INFINITE分开统计
- ✅ 最后的结余 = 上期结余 + 消费 - 还款

---

#### 功能4：搜索交易

假设客户想找"上个月在Starbucks花了多少钱"。

1. **在客户页面找"搜索交易"**
   - 有个搜索框
   - 输入关键词：`Starbucks`

2. **点击搜索**
   - 系统会列出所有包含"Starbucks"的交易
   - 显示日期、金额、卡号

3. **筛选日期**
   - 可以选择日期范围
   - 比如"2024-01-01 到 2024-12-31"

**预期效果**：
- ✅ 秒速找到所有相关交易
- ✅ 显示总金额（比如"您在Starbucks共消费RM450"）
- ✅ 可以导出Excel表格

---

#### 功能5：导出数据

1. **在任意账单页面**
   - 找到"导出"按钮

2. **选择格式**
   - Excel（推荐）
   - CSV（给会计用）
   - PDF（打印用）

3. **点击下载**
   - 文件自动下载到您的电脑

**预期效果**：
- ✅ Excel文件包含所有交易
- ✅ 每列有表头（日期、商家、金额、分类）
- ✅ 可以在Excel里做进一步分析

---

#### 功能6：储蓄账户管理

如果客户有储蓄账户（Savings Account），也可以在这里管理。

1. **访问储蓄账户页面**
   - 在首页点击"储蓄账户"菜单
   - 或访问：`http://你的域名:5000/savings`

2. **上传储蓄账户月结单**
   - 点击"上传月结单"
   - 选择银行：比如Maybank Savings
   - 上传PDF文件
   - 系统自动解析存款、取款记录

3. **搜索客户转账**
   - 在搜索框输入客户名字
   - 找出这个客户所有的转账记录
   - 用于**预付款结算**

**预期效果**：
- ✅ 看到所有储蓄账户交易
- ✅ 区分存款（绿色↑）和取款（红色↓）
- ✅ 搜索客户名字，立即找到转账记录

---

#### 功能7：智能贷款匹配

这是一个帮客户找合适贷款的功能。

1. **访问贷款匹配页面**
   - 在客户页面点击"贷款分析"
   - 或访问：`http://你的域名:5000/loan-matcher`

2. **上传CTOS报告**（马来西亚信用报告）
   - 如果客户有CTOS PDF，上传它
   - 系统会自动读取信用分数

3. **填写财务信息**
   - 月收入：`8000`
   - 现有贷款月供：`2000`
   - 信用卡欠款：`5000`

4. **点击"分析"**
   - 系统计算DSR（债务偿还率）
   - 推荐合适的贷款产品

**预期效果**：
- ✅ 看到DSR计算结果（比如"您的DSR是35%，符合银行要求"）
- ✅ 看到推荐的贷款产品列表
- ✅ 每个产品显示：利率、最高额度、还款期

---

#### 功能8：收据管理（OCR识别）

客户可以拍照收据，系统自动识别金额。

1. **访问收据页面**
   - 在客户页面点击"收据管理"
   - 或访问：`http://你的域名:5000/receipts`

2. **上传收据照片**
   - 点击"上传收据"
   - 选择JPG或PNG图片（手机拍的照片）
   - 系统用OCR识别

3. **系统自动匹配交易**
   - 根据金额和日期，自动找到对应的信用卡交易
   - 把收据图片和交易绑定

**预期效果**：
- ✅ 上传照片后，系统自动识别金额（比如"RM35.50"）
- ✅ 系统建议匹配到某笔交易
- ✅ 确认后，以后查账单可以看到收据图片

---

### 🎨 第三部分：高级分析功能

#### 功能9：财务健康评分

1. **进入客户的"高级分析"页面**
   - 在客户页面点击"高级分析"按钮
   - 或访问：`http://你的域名:5000/advanced-analytics/<客户ID>`

2. **查看财务健康评分**
   - 系统给客户打分（0-100分）
   - 比如："您的财务健康分数是75分（良好）"

3. **查看评分依据**
   - 收入稳定性
   - 债务比率
   - 储蓄率
   - 消费习惯

**预期效果**：
- ✅ 看到一个大大的分数（比如75分）
- ✅ 分数旁边有个颜色条（绿色=好，黄色=警告，红色=危险）
- ✅ 下面列出具体建议

---

#### 功能10：现金流预测

AI预测客户未来3/6/12个月的现金流。

1. **在"高级分析"页面往下滚动**
   - 找到"现金流预测"图表

2. **查看预测曲线**
   - 蓝色线：历史数据
   - 绿色线：AI预测的未来现金流
   - 红色虚线：警戒线

**预期效果**：
- ✅ 看到一个折线图
- ✅ 预测未来6个月的收入和支出
- ✅ 如果某个月会出现资金短缺，提前预警

---

#### 功能11：异常检测

系统自动发现异常消费。

1. **在"高级分析"页面查看"异常警告"**
   - 如果有异常，会显示红色提示框

2. **点击查看详情**
   - 比如："2024年7月餐饮消费RM2,500，比平均高出150%"
   - 系统会建议："请核实是否有非常规支出"

**预期效果**：
- ✅ 发现客户的异常消费模式
- ✅ 帮助防止信用卡盗刷
- ✅ 提醒客户控制超支

---

#### 功能12：客户等级系统

根据客户的信用卡使用情况，系统分级。

1. **在客户页面查看等级徽章**
   - 银卡（Silver）：新客户
   - 金卡（Gold）：月消费>RM5,000
   - 白金卡（Platinum）：月消费>RM15,000

2. **查看升级条件**
   - 系统会提示："您再消费RM2,000就能升级到金卡"

**预期效果**：
- ✅ 看到客户当前等级
- ✅ 看到升级进度条
- ✅ 不同等级享受不同服务费率

---

### 👨‍💼 第四部分：管理员功能

#### 功能13：管理员仪表板

1. **访问管理员页面**
   - 访问：`http://你的域名:5000/admin`
   - （目前是公开的，没有密码保护）

2. **查看系统总览**
   - 总客户数
   - 总账单数
   - 总交易数
   - 总信用卡数

3. **查看所有账单列表**
   - 按客户、银行、月份排序
   - 一眼看出哪些账单已验证、哪些待处理

**预期效果**：
- ✅ 看到系统所有数据的汇总
- ✅ 看到最近上传的账单
- ✅ 可以快速点击进入任意客户页面

---

#### 功能14：API密钥管理

如果您想让外部系统调用这个系统的数据。

1. **在管理员页面点击"API密钥管理"**
   - 访问：`http://你的域名:5000/admin/api-keys`

2. **创建新密钥**
   - 点击"创建API密钥"
   - 填写名称：比如"移动APP密钥"
   - 选择权限：比如"只读权限"
   - 点击"生成"

3. **复制密钥**
   - 系统显示一串密钥：`sk_live_xxxxx...`
   - **立即复制保存**，因为只显示一次！

**预期效果**：
- ✅ 生成一个API密钥
- ✅ 可以用这个密钥从外部调用系统
- ✅ 可以随时撤销密钥

---

#### 功能15：批量上传账单

一次性上传多个客户的多份账单。

1. **在客户页面找"批量上传"**
   - 点击"批量上传账单"按钮

2. **选择多个PDF文件**
   - 按住Ctrl键，一次选择多个PDF
   - 比如：张三7月、8月、9月的账单
   - 点击"全部上传"

3. **等待批量处理**
   - 系统会逐个处理
   - 显示进度："已处理 2/5 个文件"

**预期效果**：
- ✅ 一次性上传多份账单
- ✅ 节省时间，不用一个个上传
- ✅ 处理完成后显示成功数量

---

---

## 银行贷款会计系统操作指南

这个系统是给**会计人员**用的，帮公司做账，符合银行审批要求。

### 🏢 第一次使用：系统设置

#### 步骤1：访问会计系统

1. **打开浏览器**
   - 输入：`http://你的域名:8000`
   - 或者在信用卡系统里点"会计系统"链接

2. **看到API文档页面**
   - 这是一个专业的API系统
   - 页面上有"FastAPI"标志
   - 左侧有所有功能的列表

**预期效果**：
- ✅ 看到Swagger API文档界面（白色背景，绿色按钮）
- ✅ 看到很多API端点（/api/companies, /api/import/bank-statement等）
- ✅ 这个页面是给程序员看的，但我们也可以直接用

---

#### 步骤2：创建第一个公司

会计系统支持多租户，每个公司的数据完全隔离。

1. **找到"Companies"分组**
   - 在API文档页面左侧菜单
   - 点击展开"Companies"

2. **点击"POST /api/companies"**
   - 点击绿色的"Try it out"按钮

3. **填写公司信息**
   - 在JSON编辑框里填写：
   ```json
   {
     "company_code": "GZ001",
     "company_name": "光子有限公司",
     "tax_id": "202401234567",
     "address": "吉隆坡",
     "contact_email": "finance@gz.com",
     "contact_phone": "0123456789"
   }
   ```
   - 点击蓝色的"Execute"按钮

4. **查看返回结果**
   - 往下滚动，看到"Response body"
   - 里面有个`"id": 1`，这就是公司ID

**预期效果**：
- ✅ 返回状态码：200（成功）
- ✅ 返回的JSON包含`id`, `company_code`, `company_name`
- ✅ 公司已创建成功，可以开始做账

---

#### 步骤3：创建用户账号

给会计人员创建登录账号。

1. **找到"Authentication"分组**
   - 点击"POST /api/auth/register"

2. **点击"Try it out"**
   - 填写注册信息：
   ```json
   {
     "company_id": 1,
     "username": "accountant01",
     "email": "accountant@gz.com",
     "password": "Password123!",
     "full_name": "王会计",
     "role": "accountant"
   }
   ```
   - 点击"Execute"

**预期效果**：
- ✅ 返回：`{"message": "注册成功"}`
- ✅ 用户已创建，可以用来登录

---

#### 步骤4：登录获取Token

做任何操作前，需要先登录。

1. **找到"POST /api/auth/login"**
   - 填写登录信息：
   ```json
   {
     "username": "accountant01",
     "password": "Password123!",
     "company_id": 1
   }
   ```
   - 点击"Execute"

2. **复制返回的Token**
   - 返回结果里有`"token": "eyJhbGciOi..."`
   - 复制这一串token

3. **设置全局认证**
   - 页面最顶部有个绿色按钮"Authorize"
   - 点击它
   - 在弹出框输入：`Bearer <您的token>`
   - 比如：`Bearer eyJhbGci...`
   - 点击"Authorize"

**预期效果**：
- ✅ 登录成功
- ✅ 获得一个24小时有效的token
- ✅ 现在可以调用需要权限的API

---

### 📥 第二部分：上传银行月结单

这是会计系统的核心功能！

#### 步骤5：上传第一份银行月结单

1. **准备CSV文件**
   - 从您的网银下载月结单
   - 格式要求：
   ```csv
   Date,Description,Debit,Credit,Balance,Reference
   2025-01-05,客户A转账,0.00,5000.00,25000.00,TXN001
   2025-01-10,支付供应商B,3000.00,0.00,22000.00,TXN002
   2025-01-15,收到销售款,0.00,8000.00,30000.00,TXN003
   ```

2. **找到"POST /api/v2/import/bank-statement"**
   - 这是V2版本（更安全、更准确）

3. **点击"Try it out"**
   - 填写参数：
     - `company_id`: `1`
     - `bank_name`: `Maybank`
     - `account_number`: `1234567890`
     - `statement_month`: `2025-01`
     - `file`: 点击"Choose File"，选择您的CSV

4. **点击"Execute"上传**

5. **等待处理（重要！）**
   - 系统会做7步处理：
     1. 封存原件（保存PDF到数据库）
     2. 计算文件hash（防止重复上传）
     3. 解析CSV内容
     4. 保存逐行记录
     5. **行数对账验证**（确保没漏交易）
     6. 创建会计分录
     7. 生成凭证号

**预期效果**：
- ✅ 如果成功，返回：
  ```json
  {
    "success": true,
    "imported": 3,
    "matched": 2,
    "message": "成功导入3笔银行流水，自动匹配2笔"
  }
  ```
- ✅ 如果行数不匹配，返回：
  ```json
  {
    "success": false,
    "partial_success": true,
    "message": "行数对账失败：PDF有45行，数据库只有43行",
    "raw_document_id": 1
  }
  ```
  - 这种情况下，文件已保护，但没入账
  - 会自动进入"异常中心"

---

#### 步骤6：查看上传的银行流水

1. **找到"GET /api/bank-statements"**
   - 点击"Try it out"
   - 填写参数：
     - `company_id`: `1`
     - `month`: `2025-01`（可选，筛选月份）
   - 点击"Execute"

2. **查看返回结果**
   - 会列出所有银行流水
   - 每笔显示：
     - 日期、描述、借方金额、贷方金额
     - 是否已匹配（`matched: true/false`）

**预期效果**：
- ✅ 看到所有上传的银行交易
- ✅ 已匹配的交易有`matched: true`标记
- ✅ 未匹配的需要手动处理

---

### 📊 第三部分：生成财务报表

会计做账的最终目的是出报表给银行。

#### 功能1：生成应收账款账龄报告（AR Aging）

银行最看重的报告之一！

1. **找到"GET /api/reports/ar-aging/view"**
   - 点击"Try it out"
   - 填写参数：
     - `company_id`: `1`
     - `as_of_date`: `2025-01-31`（截止日期）
   - 点击"Execute"

2. **查看报告内容**
   - 返回JSON格式的报告：
   ```json
   {
     "customers": [
       {
         "customer_name": "客户A",
         "total": 50000,
         "aging_0_30": 20000,
         "aging_31_60": 15000,
         "aging_61_90": 10000,
         "aging_90_plus": 5000
       }
     ],
     "grand_total": 50000
   }
   ```

**预期效果**：
- ✅ 看到每个客户欠多少钱
- ✅ 按账龄分类：0-30天、31-60天、61-90天、90天以上
- ✅ 这个报告可以直接给银行

---

#### 功能2：生成应付账款账龄报告（AP Aging）

查看公司欠供应商多少钱。

1. **找到"GET /api/reports/ap-aging/view"**
   - 操作和AR Aging一样
   - 只是查的是应付账款

**预期效果**：
- ✅ 看到欠每个供应商多少钱
- ✅ 按账龄分类
- ✅ 帮助管理现金流

---

#### 功能3：生成利润表（P&L）

1. **找到"GET /api/reports/pnl"**
   - 填写参数：
     - `company_id`: `1`
     - `start_date`: `2025-01-01`
     - `end_date`: `2025-01-31`
   - 点击"Execute"

2. **查看利润表**
   - 返回：
   ```json
   {
     "revenue": 100000,
     "expenses": 60000,
     "net_profit": 40000,
     "profit_margin": "40%"
   }
   ```

**预期效果**：
- ✅ 看到收入、支出、净利润
- ✅ 自动计算利润率
- ✅ 符合会计准则

---

#### 功能4：生成资产负债表（Balance Sheet）

1. **找到"GET /api/reports/balance-sheet"**
   - 填写参数：
     - `company_id`: `1`
     - `as_of_date`: `2025-01-31`
   - 点击"Execute"

2. **查看资产负债表**
   - 返回：
   ```json
   {
     "assets": {
       "current_assets": 150000,
       "fixed_assets": 50000,
       "total": 200000
     },
     "liabilities": {
       "current_liabilities": 80000,
       "long_term_liabilities": 20000,
       "total": 100000
     },
     "equity": 100000
   }
   ```

**预期效果**：
- ✅ 资产 = 负债 + 权益（会计恒等式）
- ✅ 数字100%准确
- ✅ 符合银行贷款审批要求

---

#### 功能5：生成银行贷款申请包（Bank Package PDF）

这是一个超级报告，包含所有银行需要的东西！

1. **找到"GET /api/reports/pdf/bank-package"**
   - 填写参数：
     - `company_id`: `1`
     - `period`: `2025-01`
   - 点击"Execute"

2. **下载PDF**
   - 系统生成一个专业PDF
   - 包含：
     - 封面页（公司信息）
     - 利润表
     - 资产负债表
     - AR账龄报告
     - AP账龄报告
     - 银行对账单汇总

**预期效果**：
- ✅ 得到一个完整的PDF文件
- ✅ 可以直接提交给银行
- ✅ 符合银行审批格式要求

---

### 📤 第四部分：导出数据

#### 功能6：导出会计分录CSV

1. **找到"GET /export/journal/csv"**
   - 填写参数：
     - `company_id`: `1`
     - `period`: `2025-01`
   - 点击"Execute"

2. **下载CSV文件**
   - 文件包含所有会计分录
   - 格式：
   ```csv
   分录号,日期,科目代码,科目名称,摘要,借方金额,贷方金额
   JE-001,2025-01-05,1001,银行存款,收到客户款,5000.00,0.00
   JE-001,2025-01-05,1101,应收账款,收到客户款,0.00,5000.00
   ```

**预期效果**：
- ✅ 导出完整的分录数据
- ✅ 可以导入其他会计软件
- ✅ 只包含已验证的数据（invalid数据会自动过滤）

---

### 🔧 第五部分：高级功能

#### 功能7：自动记账规则

设置规则，让系统自动生成会计分录。

1. **找到"POST /api/posting-rules/"**
   - 点击"Try it out"
   - 填写规则：
   ```json
   {
     "company_id": 1,
     "rule_name": "客户A收款规则",
     "pattern_type": "keyword",
     "pattern": "客户A转账",
     "debit_account": "1001",
     "credit_account": "1101",
     "description_template": "收到客户A款项"
   }
   ```
   - 点击"Execute"

2. **规则生效**
   - 以后上传银行流水时
   - 系统看到"客户A转账"就自动生成分录

**预期效果**：
- ✅ 规则保存成功
- ✅ 下次上传自动匹配
- ✅ 节省手动做账时间

---

#### 功能8：异常中心

查看所有数据异常。

1. **找到"GET /api/exceptions"**
   - 填写参数：
     - `company_id`: `1`
     - `status`: `open`（只看未解决的）
   - 点击"Execute"

2. **查看异常列表**
   - 显示5种异常：
     - `pdf_parse`：PDF解析失败
     - `ocr_error`：OCR识别错误
     - `customer_mismatch`：客户匹配失败
     - `supplier_mismatch`：供应商匹配失败
     - `posting_error`：记账失败

3. **处理异常**
   - 找到具体异常的ID
   - 调用`POST /api/exceptions/{id}/resolve`解决

**预期效果**：
- ✅ 所有异常集中管理
- ✅ 按严重程度排序（high > medium > low）
- ✅ 可以批量处理

---

#### 功能9：审计日志

查看谁做了什么操作。

1. **找到"GET /api/audit-logs/"**
   - 填写参数：
     - `company_id`: `1`
     - `entity_type`: `bank_statement`（可选）
     - `start_date`: `2025-01-01`
     - `end_date`: `2025-01-31`
   - 点击"Execute"

2. **查看日志**
   - 显示所有操作记录：
   ```json
   {
     "timestamp": "2025-01-15 10:30:00",
     "user": "accountant01",
     "action": "upload",
     "entity_type": "bank_statement",
     "entity_id": 123,
     "status": "success"
   }
   ```

**预期效果**：
- ✅ 看到所有操作历史
- ✅ 谁上传了什么文件
- ✅ 谁修改了什么数据
- ✅ 符合审计要求

---

#### 功能10：文件管理

查看公司上传的所有文件。

1. **找到"GET /api/files/list/{company_id}"**
   - 填写`company_id`: `1`
   - 点击"Execute"

2. **查看文件列表**
   - 显示所有文件：
     - 文件名
     - 文件类型（bank_statement, invoice, receipt）
     - 上传日期
     - 文件大小

3. **下载文件**
   - 调用`GET /api/files/download`
   - 传入`file_path`
   - 下载原始文件

**预期效果**：
- ✅ 所有文件集中存储
- ✅ 按公司隔离（多租户安全）
- ✅ 可以随时下载原件

---

### 🎯 第六部分：数据完整性验证

这是系统的核心保障！确保100%数据准确。

#### 功能11：查看原始文档验证状态

1. **上传文件后，检查验证状态**
   - 每个上传的文件都有`validation_status`字段
   - 3种状态：
     - `passed`：验证通过 ✅
     - `failed`：验证失败 ❌
     - `pending`：等待验证 ⏳

2. **如果验证失败**
   - 系统会在异常中心创建记录
   - 异常类型：`ingest_validation_failed`
   - 错误信息：比如"行数不匹配：PDF有45行，数据库只有43行"

3. **处理失败的文件**
   - 查看异常详情
   - 检查原始PDF
   - 重新上传或手动修正

**预期效果**：
- ✅ 每个文件都经过验证
- ✅ 行数不匹配会被拦截
- ✅ 原始文件已保护，不会丢失

---

#### 功能12：导出数据时的自动过滤

当您导出CSV或PDF报告时：

1. **系统自动过滤invalid数据**
   - 只导出`validation_status='passed'`的记录
   - 验证失败的数据不会进入报告

2. **查看过滤统计**
   - 导出API会返回：
   ```json
   {
     "total_records": 100,
     "valid_records": 95,
     "filtered_out": 5
   }
   ```

**预期效果**：
- ✅ 报告中的数据100%可信
- ✅ 不会因为脏数据导致报表错误
- ✅ 符合银行审批要求

---

---

## 常见问题解答

### Q1：我上传了PDF，但系统说"解析失败"，怎么办？

**答**：
1. 检查PDF是否是扫描件（图片PDF）
   - 如果是扫描件，需要先OCR识别
   - 系统支持OCR，但准确率可能不是100%

2. 检查PDF格式是否标准
   - 有些银行的PDF格式特殊
   - 联系管理员添加该银行的解析规则

3. 手动上传CSV
   - 您可以把PDF内容复制到Excel
   - 保存为CSV格式
   - 用CSV上传功能

---

### Q2：为什么我的交易分类不准确？

**答**：
系统根据关键词自动分类，比如：
- "Starbucks" → 餐饮
- "Shell" → 交通
- "Lazada" → 购物

如果分类错误：
1. 在交易列表中手动修改分类
2. 联系管理员添加新的分类规则
3. 系统会学习您的修改，下次更准确

---

### Q3：OWNER和INFINITE是什么意思？

**答**：
这是针对马来西亚客户的特殊功能：

- **OWNER**：客户自己的消费和还款
  - 比如您自己去Starbucks喝咖啡
  
- **INFINITE**：供应商的消费（会收1%手续费）
  - 比如您帮公司代付款
  - 7个配置的供应商会自动识别

系统会自动分开统计，月底算账很清楚。

---

### Q4：如何确保数据100%准确？

**答**：
系统有4层保护机制：

1. **数据库层**：raw_line_id外键，确保每笔交易都关联到原始PDF
2. **业务逻辑层**：DataIntegrityValidator服务，验证数据完整性
3. **验证状态追踪**：validation_status字段，标记验证结果
4. **权限控制**：API key默认只能上传，导出需要额外授权

所以您可以放心，系统不会丢数据、不会虚构数据。

---

### Q5：我可以同时管理多个公司吗？

**答**：
可以！会计系统支持多租户：

1. 创建多个公司（POST /api/companies）
2. 每个公司有独立的company_id
3. 上传数据时指定company_id
4. 数据完全隔离，不会混淆

---

### Q6：如何备份数据？

**答**：

**信用卡系统（5000端口）**：
- 数据存在`db/smart_loan_manager.db`
- 复制这个文件就是备份

**会计系统（8000端口）**：
- 数据存在PostgreSQL数据库
- 用数据库的备份工具

**原始文件**：
- 所有上传的PDF都保存在`static/uploads/`
- 定期备份这个文件夹

---

### Q7：系统支持哪些银行？

**答**：

目前支持15家马来西亚主要银行：
1. Maybank
2. CIMB
3. Public Bank
4. RHB
5. Hong Leong Bank
6. AmBank
7. UOB
8. OCBC
9. HSBC
10. Standard Chartered
11. Citibank
12. Affin Bank
13. Alliance Bank
14. Bank Islam
15. MBSB Bank

如果您的银行不在列表中，请联系管理员添加。

---

### Q8：如何联系技术支持？

**答**：
- 邮箱：在环境变量`ADMIN_EMAIL`中配置
- WhatsApp：在环境变量`WHATSAPP_ADMIN_TO`中配置
- 系统会自动发送通知给管理员

---

### Q9：系统是否支持中文？

**答**：
是的！系统支持中英双语：
- 界面可以切换语言
- PDF报告支持中文
- 客户可以选择语言偏好

---

### Q10：数据会被其他人看到吗？

**答**：
不会！系统有严格的数据隔离：

**信用卡系统**：
- 每个客户只能看到自己的数据
- 管理员可以看到所有客户（用于服务）

**会计系统**：
- 每个公司的数据完全隔离
- 通过company_id区分
- API key绑定到具体公司

---

## 🎉 结语

恭喜！您已经学会了整个系统的所有功能！

**记住**：
1. **信用卡系统（5000端口）**：给客户用，管理个人财务
2. **会计系统（8000端口）**：给会计用，管理公司账目

如果有任何问题，随时查看这份手册。

祝您使用愉快！ 😊

---

**版本**：v1.0.0  
**更新日期**：2025年1月  
**作者**：智能财务管理系统团队