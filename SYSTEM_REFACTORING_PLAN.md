# 系统瘦身+收紧改造计划

## 📋 改造总览

### 目标
将"功能全但有点厚"的系统瘦身，明确5000和8000端口的功能边界，收紧权限控制。

## ✅ 已完成

### 1. 安全&一致性
- [x] ✅ **Task 1**: 关闭5000端口/admin公开访问
  - 创建 `auth/admin_auth_helper.py` 统一认证模块
  - 所有/admin路由添加 `@require_admin_or_accountant` 装饰器
  - 调用8000端口的 `/api/auth/me` 验证用户身份和角色
  - 只允许 admin, accountant 角色访问管理页面

## 🚧 进行中/待实施

### 2. API Key权限收紧（简单，先做）
- [ ] **Task 11**: 修改 `accounting_app/routes/api_key_management.py`
  - `POST /api/api-keys/` 添加角色检查：只 admin 可创建
  - 客户端隐藏"创建API Key"按钮

### 3. Swagger文档保护（简单，先做）
- [ ] **Task 12**: 修改 `accounting_app/main.py`
  - 添加 `/docs` 和 `/redoc` 路由保护
  - 需要登录后才能访问API文档

### 4. 导出功能分级（中等）
- [ ] **Task 3**: 修改 `app.py` 和 `accounting_app/routes/`
  - PDF下载：保留给所有角色
  - CSV/Excel导出：添加 `@require_admin_or_accountant`
  - 删除客户侧的"导出全部交易"按钮

### 5. 高级分析功能收起（中等）
- [ ] **Task 4**: 添加环境变量控制
  - 创建 `FEATURE_ADVANCED_ANALYTICS=false` 开关
  - 修改模板，Beta功能默认隐藏
  - 路由：`/advanced-analytics/<customer_id>` 添加开关判断

### 6. 客户等级系统收起（中等）
- [ ] **Task 5**: 添加环境变量控制
  - 创建 `FEATURE_CUSTOMER_TIER=false` 开关
  - 模板中tier相关UI默认隐藏

### 7. 首页客户列表权限过滤（中等）
- [ ] **Task 7**: 修改 `/` 路由
  - 检查当前用户角色
  - 普通客户只看自己的数据
  - admin看全部客户

### 8. 收据OCR改为人工确认（中等）
- [ ] **Task 10**: 修改 `services/receipt_matcher.py`
  - 禁用自动匹配逻辑
  - 改为"待确认"状态
  - UI显示待人工确认列表

### 9. 批量上传合并到8000（复杂）
- [ ] **Task 6**: 
  - 保留 `accounting_app/routes/bank_import_v2.py` 的批量上传
  - 删除 `app.py` 中的批量上传路由
  - 5000端口的批量上传改为调用8000 API

### 10. 统一文件路径（复杂）
- [ ] **Task 8**: 
  - 定义 `FILES_BASE_DIR=/files` 环境变量
  - 修改所有文件上传逻辑统一调用8000 API
  - `Flask上传 → POST 8000 → 统一存储`

### 11. 统一认证来源（复杂）
- [ ] **Task 2**:
  - 修改所有上传操作，必须包含 company_id + user_id
  - Flask上传前调用8000验证
  - 无验证数据进入staging，不直接入库

### 12. 优化上传失败提示（简单）
- [ ] **Task 9**:
  - 修改错误提示文案
  - "文件已保存但未通过验证，请到异常中心处理"

### 13. 更新文档（简单）
- [ ] **Task 13**: 修改 `系统操作手册_白话版.md`
  - 权限说明：admin页面不再是公开的
  - 批量上传说明：转交8000处理
  - 异常消费说明：最终以会计确认为准

### 14. 测试验证（最后）
- [ ] **Task 14**:
  - 重启两个workflow
  - 测试权限控制
  - 测试功能边界

## 📊 功能边界最终版

### 5000端口（信用卡系统）- 客户侧
只做4件事：
1. 客户资料 + 卡资料管理
2. 上传账单 + 验证 + 展示
3. 简单报告给客户看（月度PDF）
4. 把原件丢给8000存档

### 8000端口（会计系统）- 专业侧
才做这些：
1. 文件封存 + 行数验证
2. 自动分录 + Aging + 报表
3. 导出给SQL/AutoCount/UBS
4. 管理报告 / Bank Package
5. 异常中心 + 审计日志

## 🎯 实施优先级

### 阶段1：安全收紧（优先）
1. ✅ Admin页面权限
2. API Key只admin创建
3. Swagger文档保护

### 阶段2：功能精简（次要）
4. 导出功能分级
5. 高级分析Beta化
6. 客户等级系统开关
7. 收据OCR人工确认

### 阶段3：架构调整（复杂但必要）
8. 批量上传合并
9. 文件路径统一
10. 认证来源统一

### 阶段4：体验优化（最后）
11. 提示文案优化
12. 文档同步更新
13. 全面测试

## 📝 注意事项

1. **不要破坏现有功能**：改造时保持向后兼容
2. **环境变量优先**：用开关控制新特性，不要硬删除代码
3. **测试先行**：每个阶段完成后立即测试
4. **文档同步**：代码改了，文档也要改

## 🔧 技术债务

1. Flask session + FastAPI token 双认证体系 → 需统一
2. 文件上传路径混乱 → 需统一到8000
3. 5000和8000各有一套批量上传 → 需合并
4. 权限控制不统一 → 需统一到FastAPI RBAC

---

**版本**: v1.0  
**更新时间**: 2025-01-02  
**负责人**: Agent
