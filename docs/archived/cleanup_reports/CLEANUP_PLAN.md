# 🧹 系统清理与优化详细方案

## 📊 审计发现总结

### 当前系统状态
- **客户数**: 5
- **信用卡**: 19张
- **信用卡账单**: 109条
- **储蓄账户**: 3个
- **储蓄月结单**: 45条（包含13条重复）
- **交易记录**: 1,098条

### 发现的问题
1. ✅ **信用卡账单**: 无重复（良好）
2. ⚠️ **储蓄账户月结单**: 13组重复（GX Bank 2024-07 至 2025-07）
3. ⚠️ **孤立文件**: 138个无数据库记录的文件
4. ⚠️ **文件存储混乱**: 分散在多个目录

---

## 方案1：清理重复储蓄账户月结单

### 问题详情
所有重复均为客户ID=1的GX Bank账户，每个月重复上传2次：

| 月份 | 重复ID | 文件路径 |
|------|--------|----------|
| 2024-07 | 160, 173 | JUL 2024_1761028205600.pdf |
| 2024-08 | 161, 174 | AUG 2024_1761028205600.pdf |
| 2024-09 | 162, 175 | SEPT 2024_1761028205601.pdf |
| ... | ... | ... |
| 2025-07 | 172, 185 | JULY 2025_1761028221047.pdf |

**共13个月，26条记录，需要删除13条旧记录**

### 清理策略
```sql
-- 保留每个月ID最大的记录（最新上传）
-- 删除每个月ID较小的记录（旧的重复）
DELETE FROM savings_statements 
WHERE id IN (160,161,162,163,164,165,166,167,168,169,170,171,172);
```

### 预期结果
- ✅ 删除13条重复记录
- ✅ 每个月只保留1条最新记录
- ✅ 文件不会被删除（仍在磁盘上）
- ✅ 释放数据库空间

---

## 方案2：删除孤立文件

### 问题详情
发现138个文件存在于文件系统但数据库无记录，主要类型：

#### 测试文件（约13个）
```
static/uploads/20251008_100738_CIMB_Test_Statement.pdf
static/uploads/20251008_100743_CIMB_Test_Statement.pdf
static/uploads/maybank_statement_test.pdf
...
```

#### 临时报告文件（约5个）
```
static/uploads/report_1_20251008_191908.pdf
static/uploads/report_1_20251009_103558.pdf
...
```

#### 其他临时上传文件（约120个）
```
static/uploads/20251013_153147_UOB 13:05:2025.pdf
static/customer_files/...
...
```

### 清理策略
```python
# 扫描所有PDF文件
# 检查数据库中是否有对应的file_path记录
# 如果没有 → 移动到backup文件夹（不直接删除，以防万一）
# 7天后确认无问题再永久删除
```

### 预期结果
- ✅ 清理138个孤立文件
- ✅ 释放约5-10 MB磁盘空间
- ✅ 先备份到 `static/backup_cleanup/` 
- ✅ 可以随时恢复（安全第一）

---

## 方案3：统一文件存储结构（未来实施）

### 当前存储混乱
```
static/
├── uploads/           (193 PDF, 混乱)
├── customer_files/    (17 PDF, 不统一)
├── reports/           (6 PDF)
├── monthly_reports/   (1 PDF)
└── exports/           (Excel files)
```

### 建议新架构
```
static/uploads/customers/{customer_code}/
├── credit_cards/
│   ├── {bank_name}/
│   │   └── {YYYY-MM}/
│   │       └── {BankName}_{Last4}_{YYYY-MM-DD}.pdf
├── savings/
│   ├── {bank_name}/
│   │   └── {YYYY-MM}/
│   │       └── {BankName}_{AccountNum}_{YYYY-MM-DD}.pdf
├── receipts/
│   ├── payment_receipts/
│   │   └── {YYYY-MM-DD}_{Merchant}_{Amount}.jpg
│   └── merchant_receipts/
│       └── {YYYY-MM-DD}_{Merchant}_{Amount}.jpg
└── invoices/
    └── {YYYY-MM}/
        └── Invoice_{Number}_{Date}.pdf
```

### 迁移步骤（未来）
1. 创建新的目录结构
2. 编写迁移脚本，移动所有文件
3. 更新数据库中的file_path字段
4. 添加数据库唯一性约束
5. 验证所有链接正常
6. 删除旧目录

### 优势
✅ **清晰隔离** - 每个客户独立文件夹  
✅ **易于备份** - 直接复制客户文件夹  
✅ **易于查找** - 路径即分类  
✅ **可扩展** - 支持未来新类型文件  
✅ **防止混乱** - 强制规范命名  

---

## 🎯 执行顺序

### 阶段1：立即执行（安全清理）
1. ✅ 清理13条重复储蓄账户月结单
2. ✅ 删除138个孤立文件（先备份）

### 阶段2：未来优化（需要更多时间）
3. 🔄 实施统一文件存储架构
4. 🔄 添加数据库唯一性约束
5. 🔄 自动化文件管理系统

---

## ⚠️ 安全措施

1. **备份优先** - 所有删除操作前先备份
2. **分步执行** - 不一次性大批量删除
3. **验证机制** - 每步完成后验证系统正常
4. **可回滚** - 保留7天恢复期

---

## 📝 预计效果

### 数据库优化
- 减少13条冗余记录
- 提升查询速度
- 减少存储占用

### 文件系统优化
- 释放5-10 MB空间
- 清理测试文件
- 目录更整洁

### 长期收益
- 文件管理标准化
- 数据查找更快速
- 系统维护更容易
