{% extends "base.html" %}

{% block title %}{{ t('ctos_personal_consent__') }}{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 40px 60px; background: #000000;">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%); padding: 32px; border-radius: 16px; border: 2px solid #FF007F; margin-bottom: 40px; box-shadow: 0 8px 32px rgba(255, 0, 127, 0.2);">
                <div class="d-flex align-items-center">
                    <i class="bi bi-file-earmark-lock2-fill" style="font-size: 48px; color: #FF007F; margin-right: 24px;"></i>
                    <div>
                        <h1 style="color: #FFFFFF; font-size: 32px; margin: 0;">{{ t('ctos_personal_consent') }}</h1>
                        <p style="color: rgba(255, 255, 255, 0.7); margin: 8px 0 0 0; font-size: 16px;">{{ t('__credit_report_authorization') }}</p>
                    </div>
                </div>
            </div>

            <form id="ctosPersonalForm" method="POST" action="{{ url_for('ctos_personal_submit') }}" enctype="multipart/form-data">
                <div class="row">
                    <!-- 左侧：表单输入区 -->
                    <div class="col-lg-7">
                        <!-- 模块A: 个人资料 -->
                        <div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid #322446; margin-bottom: 24px;">
                            <h3 style="color: #FF007F; margin-bottom: 20px; font-size: 20px;">
                                <i class="bi bi-person-badge me-2"></i>{{ t('__personal_information') }}
                            </h3>
                            
                            <div class="mb-3">
                                <label class="form-label" style="color: #FFFFFF;">{{ t('full_name_as_per_ic') }}<span style="color: #FF007F;">*</span></label>
                                <input type="text" name="full_name" class="form-control" required 
                                       style="background: #0d0d0d; border: 1px solid #322446; color: #FFFFFF; border-radius: 8px; padding: 12px;"
                                       placeholder="{{ t('enter_your_full_name') }}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="color: #FFFFFF;">{{ t('ic_number_nric') }}<span style="color: #FF007F;">*</span></label>
                                <input type="text" name="ic_number" class="form-control" required 
                                       pattern="[0-9]{6}-[0-9]{2}-[0-9]{4}"
                                       style="background: #0d0d0d; border: 1px solid #322446; color: #FFFFFF; border-radius: 8px; padding: 12px;"
                                       placeholder="{{ t('xxxxxxxxxxxx') }}">
                                <small style="color: rgba(255, 255, 255, 0.5);">{{ t('format_900101011234') }}</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="color: #FFFFFF;">{{ t('phone_number') }}<span style="color: #FF007F;">*</span></label>
                                <input type="tel" name="phone" class="form-control" required 
                                       style="background: #0d0d0d; border: 1px solid #322446; color: #FFFFFF; border-radius: 8px; padding: 12px;"
                                       placeholder="+60123456789">
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="color: #FFFFFF;">{{ t('email_address') }}<span style="color: #FF007F;">*</span></label>
                                <input type="email" name="email" class="form-control" required 
                                       style="background: #0d0d0d; border: 1px solid #322446; color: #FFFFFF; border-radius: 8px; padding: 12px;"
                                       placeholder="{{ t('youremailexamplecom') }}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="color: #FFFFFF;">{{ t('residential_address') }}<span style="color: #FF007F;">*</span></label>
                                <textarea name="address" class="form-control" rows="3" required 
                                          style="background: #0d0d0d; border: 1px solid #322446; color: #FFFFFF; border-radius: 8px; padding: 12px;"
                                          placeholder="{{ t('enter_your_complete_address') }}"></textarea>
                            </div>
                        </div>

                        <!-- {{ t('d_ic') }}上传 -->
                        <div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid #322446; margin-bottom: 24px;">
                            <h3 style="color: #FF007F; margin-bottom: 20px; font-size: 20px;">
                                <i class="bi bi-credit-card-2-front me-2"></i>IC Document Upload
                            </h3>
                            
                            <div class="mb-3">
                                <label class="form-label" style="color: #FFFFFF;">{{ t('ic_front') }}<span style="color: #FF007F;">*</span></label>
                                <input type="file" name="ic_front" class="form-control" accept="image/*,application/pdf" required
                                       style="background: #0d0d0d; border: 1px solid #322446; color: #FFFFFF; border-radius: 8px; padding: 12px;">
                            </div>

                            <div class="mb-3">
                                <label class="form-label" style="color: #FFFFFF;">{{ t('ic_back') }}<span style="color: #FF007F;">*</span></label>
                                <input type="file" name="ic_back" class="form-control" accept="image/*,application/pdf" required
                                       style="background: #0d0d0d; border: 1px solid #322446; color: #FFFFFF; border-radius: 8px; padding: 12px;">
                            </div>
                        </div>

                        <!-- 模块C: 电子签名 -->
                        <div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid #322446; margin-bottom: 24px;">
                            <h3 style="color: #FF007F; margin-bottom: 20px; font-size: 20px;">
                                <i class="bi bi-pen me-2"></i>Electronic Signature
                            </h3>
                            
                            <div style="border: 2px dashed #322446; border-radius: 8px; background: #0d0d0d; padding: 16px; text-align: center;">
                                <canvas id="signaturePad" width="600" height="200" style="border: 1px solid #FF007F; border-radius: 4px; cursor: crosshair; background: #FFFFFF;"></canvas>
                                <input type="hidden" name="signature_data" id="signatureData">
                                <div class="mt-3">
                                    <button type="button" class="btn btn-sm" onclick="clearSignature()" 
                                            style="background: #322446; color: #FFFFFF; border: none; padding: 8px 16px; border-radius: 8px;">
                                        <i class="bi bi-eraser me-1"></i>Clear Signature
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：预览和说明 -->
                    <div class="col-lg-5">
                        <!-- {{ t('b_ctosconsent') }}文本 -->
                        <div style="background: #1a1a1a; padding: 24px; border-radius: 16px; border: 1px solid #322446; margin-bottom: 24px;">
                            <h3 style="color: #FF007F; margin-bottom: 16px; font-size: 18px;">
                                <i class="bi bi-shield-check me-2"></i>CTOS Consent Statement
                            </h3>
                            
                            <div style="background: #0d0d0d; padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto; color: rgba(255, 255, 255, 0.8); font-size: 14px; line-height: 1.6;">
                                <p><strong style="color: #FF007F;">{{ t('consent_to_obtain_credit_report') }}</strong></p>
                                
                                <p>{{ t('i_hereby_authorize') }}<strong>{{ t('infinite_gz_sdn_bhd') }}</strong>{{ t('to_obtain_my_personal_credit_report_from_ctos_data_systems_sdn_bhd_ctos_for_the_purpose_of') }}</p>
                                
                                <ul style="padding-left: 20px;">
                                    <li>{{ t('credit_assessment_and_loan_application_processing') }}</li>
                                    <li>{{ t('financial_risk_evaluation') }}</li>
                                    <li>{{ t('compliance_with_banking_regulations') }}</li>
                                </ul>
                                
                                <p>{{ t('i_understand_that') }}</p>
                                <ul style="padding-left: 20px;">
                                    <li>{{ t('the_credit_report_will_contain_my_credit_history_payment_records_and_outstanding_commitments') }}</li>
                                    <li>{{ t('this_information_will_be_used_strictly_for_the_stated_purposes') }}</li>
                                    <li>{{ t('my_personal_data_will_be_handled_in_accordance_with_pdpa_2010') }}</li>
                                    <li>{{ t('this_consent_is_valid_for_12_months_from_the_date_of_signature') }}</li>
                                </ul>
                                
                                <p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #322446;">
                                    <strong>{{ t('authorized_by') }}</strong>{{ t('infinite_gz_sdn_bhd') }}<br>
                                    <strong>{{ t('date_1') }}</strong> {{ current_date }}<br>
                                    <strong>{{ t('purpose') }}</strong> Loan Eligibility Assessment
                                </p>
                            </div>

                            <div class="form-check mt-3" style="padding-left: 0;">
                                <input class="form-check-input" type="checkbox" name="consent_agree" id="consentAgree" required
                                       style="width: 20px; height: 20px; margin-right: 12px; accent-color: #FF007F;">
                                <label class="form-check-label" for="consentAgree" style="color: #FFFFFF; font-size: 15px;">
                                    <strong style="color: #FF007F;">✓</strong> I have read and agree to authorize CTOS credit report access
                                </label>
                            </div>
                        </div>

                        <!-- 信息卡片 -->
                        <div style="background: linear-gradient(135deg, #1a0a0f 0%, #0d0d0d 100%); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 0, 127, 0.3);">
                            <p style="color: rgba(255, 255, 255, 0.7); font-size: 13px; margin: 0; line-height: 1.6;">
                                <i class="bi bi-info-circle me-2" style="color: #FF007F;"></i>
                                Your personal information and credit report will be handled with strict confidentiality in accordance with Malaysian data protection laws.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 提交按钮 -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-lg" 
                            style="background: linear-gradient(135deg, #FF007F 0%, #E6006F 100%); color: #FFFFFF; border: none; padding: 16px 48px; border-radius: 12px; font-size: 18px; font-weight: 600; box-shadow: 0 8px 24px rgba(255, 0, 127, 0.3);">
                        <i class="bi bi-check-circle me-2"></i>Submit Consent & Generate PDF
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
// Initialize signature pad
const canvas = document.getElementById('signaturePad');
const signaturePad = new SignaturePad(canvas, {
    backgroundColor: 'rgb(255, 255, 255)',
    penColor: 'rgb(0, 0, 0)'
});

function clearSignature() {
    signaturePad.clear();
}

// Form submission handler
document.getElementById('ctosPersonalForm').addEventListener('submit', function(e) {
    if (signaturePad.isEmpty()) {
        e.preventDefault();
        alert('Please provide your signature before submitting.');
        return false;
    }
    
    // Save signature as base64
    const signatureData = signaturePad.toDataURL('image/png');
    document.getElementById('signatureData').value = signatureData;
});

// Responsive canvas
window.addEventListener('resize', function() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext('2d').scale(ratio, ratio);
    signaturePad.clear();
});
</script>

<style>
.form-control:focus {
    background: #0d0d0d !important;
    border-color: #FF007F !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 0, 127, 0.25) !important;
    color: #FFFFFF !important;
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.3);
}
</style>
{% endblock %}
