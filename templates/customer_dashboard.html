{% extends "base.html" %}

{% block title %}{{ customer.name }} - {{ t('nav_dashboard') }}{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Page Header -->
    <div class="section-header">
        <h1 class="section-title">{{ customer.name }}</h1>
        <p class="section-subtitle">{{ t('dashboard_subtitle') }}</p>
    </div>

    <!-- Stats Overview -->
    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <div class="stat-card">
                <div class="stat-value">RM {{ "{:,.2f}".format(customer.monthly_income) }}</div>
                <div class="stat-label">{{ t('monthly_income') }}</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stat-card">
                <div class="stat-value">RM {{ "{:,.2f}".format(total_spending) }}</div>
                <div class="stat-label">{{ t('total_spending') }}</div>
            </div>
        </div>
    </div>

    <!-- Credit Cards Section -->
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 style="color: var(--text-primary); margin: 0;">{{ t('credit_cards') }}</h3>
            <a href="{{ url_for('add_credit_card', customer_id=customer.id) }}" 
               class="btn-white-glow" 
               style="padding: 0.75rem 1.5rem; font-size: 0.95rem;">
                <i class="bi bi-plus-circle"></i> {{ t('add_new_card') }}
            </a>
        </div>
        
        {% if cards %}
        <div class="row g-4">
            {% for card in cards %}
            <div class="col-12">
                <div class="professional-card" style="padding: 2rem;">
                    <!-- Card Header -->
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <div class="d-flex align-items-center">
                            <div style="width: 60px; height: 60px; background: var(--accent-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1.25rem; font-size: 1.8rem; color: var(--text-primary);">
                                {{ card.bank_name[0] }}
                            </div>
                            <div>
                                <h4 style="margin: 0; color: var(--text-primary); font-weight: 700;">{{ card.bank_name }}</h4>
                                <div class="mt-1">
                                    <small style="color: var(--text-secondary); font-size: 0.95rem;">****{{ card.card_number_last4 }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-3">
                            <div class="text-end">
                                <small style="color: var(--text-secondary); display: block;">{{ t('credit_limit') }}</small>
                                <span style="color: var(--text-primary); font-weight: 700; font-size: 1.1rem;">RM {{ "{:,.2f}".format(card.credit_limit) }}</span>
                            </div>
                            <div class="text-end">
                                <small style="color: var(--text-secondary); display: block;">{{ t('due_date') }}</small>
                                <span class="badge-professional badge-primary-pro" style="font-size: 0.9rem;">{{ t('day') }} {{ card.due_date }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 12-Month Timeline -->
                    {% if card.timeline %}
                    {% with timeline=card.timeline, coverage_percentage=card.coverage_percentage %}
                    {% include 'components/card_timeline_12months.html' %}
                    {% endwith %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- æ²¡æœ‰ä¿¡ç”¨å¡æ—¶æ˜¾ç¤ºæç¤º -->
        <div class="professional-card text-center py-5">
            <div style="font-size: 3rem; color: rgba(255,122,67,0.3); margin-bottom: 1rem;">
                <i class="bi bi-credit-card-2-front"></i>
            </div>
            <h4 style="color: rgba(255,255,255,0.9); margin-bottom: 1rem;" data-i18n="no_credit_cards">{{ t('no_credit_cards') }}</h4>
            <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;" data-i18n="add_first_card_desc">
                {{ t('add_first_card_desc') }}
            </p>
            <a href="{{ url_for('add_credit_card', customer_id=customer.id) }}" 
               class="btn-white-glow" 
               style="padding: 1rem 2rem; font-size: 1.1rem;">
                <i class="bi bi-plus-circle"></i> <span data-i18n="add_new_card">{{ t('add_new_card') }}</span>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Monthly Ledger Section (8-Item Calculation) -->
    {% if monthly_ledgers %}
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 style="color: var(--text-primary); margin: 0;">
                <i class="bi bi-calculator"></i> æœˆåº¦è´¢åŠ¡è´¦æœ¬ / Monthly Financial Ledger
            </h3>
            <small style="color: var(--text-secondary);">åŒè½¨è´¦æœ¬ç³»ç»Ÿï¼šå®¢æˆ· + INFINITE</small>
        </div>
        
        {% for ledger in monthly_ledgers %}
        <div class="professional-card mb-4" style="padding: 2rem;">
            <!-- Card Header -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h4 style="margin: 0; color: var(--text-primary); font-weight: 700;">
                        {{ ledger.card.bank_name }} ****{{ ledger.card.card_number_last4 }}
                    </h4>
                    <small style="color: var(--text-secondary);">{{ ledger.month }} æœˆåº¦è´¦æœ¬</small>
                </div>
                <span class="badge-professional badge-primary-pro" style="font-size: 1rem;">
                    <i class="bi bi-calendar3"></i> {{ ledger.month }}
                </span>
            </div>
            
            <div class="divider-professional mb-4"></div>
            
            <!-- Customer Ledger (å®¢æˆ·è´¦æœ¬) -->
            <div class="mb-4">
                <h5 style="color: var(--accent-primary); margin-bottom: 1.5rem; font-weight: 600;">
                    <i class="bi bi-person-circle"></i> å®¢æˆ·è´¦æœ¬ / Customer Ledger
                </h5>
                <div class="row g-4">
                    <div class="col-md-3 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(212,175,55,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                                <i class="bi bi-1-circle"></i> Previous Balance<br>ä¸Šæœˆä½™é¢
                            </small>
                            <div style="color: var(--text-primary); font-weight: 700; font-size: 1.1rem;">
                                RM {{ "{:,.2f}".format(ledger.customer.previous_balance) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(212,175,55,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                                <i class="bi bi-2-circle"></i> Total Spend<br>å®¢æˆ·æ€»æ¶ˆè´¹
                            </small>
                            <div style="color: #FF7A43; font-weight: 700; font-size: 1.1rem;">
                                RM {{ "{:,.2f}".format(ledger.customer.total_spend) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(212,175,55,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                                <i class="bi bi-3-circle"></i> Total Payments<br>å®¢æˆ·æ€»ä»˜æ¬¾
                            </small>
                            <div style="color: #4CAF50; font-weight: 700; font-size: 1.1rem;">
                                RM {{ "{:,.2f}".format(ledger.customer.total_payments) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div style="background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(255,122,67,0.1)); padding: 1rem; border-radius: 8px; border: 2px solid var(--accent-primary);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                                <i class="bi bi-4-circle-fill"></i> Rolling Balance<br>å®¢æˆ·ç´¯è®¡ä½™é¢
                            </small>
                            <div style="color: var(--accent-primary); font-weight: 700; font-size: 1.2rem;">
                                RM {{ "{:,.2f}".format(ledger.customer.rolling_balance) }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calculation Formula -->
                <div style="margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(212,175,55,0.05); border-radius: 6px; border-left: 3px solid var(--accent-primary);">
                    <small style="color: var(--text-secondary); font-family: 'Courier New', monospace;">
                        <i class="bi bi-calculator"></i> è®¡ç®—å…¬å¼: 
                        <span style="color: var(--text-primary);">ä¸Šæœˆä½™é¢ ({{ "{:,.2f}".format(ledger.customer.previous_balance) }}) + æœ¬æœˆæ¶ˆè´¹ ({{ "{:,.2f}".format(ledger.customer.total_spend) }}) - æœ¬æœˆä»˜æ¬¾ ({{ "{:,.2f}".format(ledger.customer.total_payments) }}) = <strong style="color: var(--accent-primary);">ä½™é¢ RM {{ "{:,.2f}".format(ledger.customer.rolling_balance) }}</strong></span>
                    </small>
                </div>
            </div>
            
            <div class="divider-professional my-4"></div>
            
            <!-- INFINITE Ledger (INFINITEè´¦æœ¬) -->
            <div>
                <h5 style="color: var(--accent-secondary); margin-bottom: 1.5rem; font-weight: 600;">
                    <i class="bi bi-building"></i> INFINITE è´¦æœ¬ / INFINITE Ledger
                </h5>
                <div class="row g-4">
                    <div class="col-md-2 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-1-circle"></i> Previous<br>ä¸Šæœˆä½™é¢
                            </small>
                            <div style="color: var(--text-primary); font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.previous_balance) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-5-circle"></i> Total Spend<br>æ€»æ¶ˆè´¹
                            </small>
                            <div style="color: #FF7A43; font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.total_spend) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-tag"></i> Fee (1%)<br>æ‰‹ç»­è´¹
                            </small>
                            <div style="color: #FFC107; font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.supplier_fee) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-6-circle"></i> Payments<br>æ€»ä»˜æ¬¾
                            </small>
                            <div style="color: #4CAF50; font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.total_payments) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(255,122,67,0.1)); padding: 1rem; border-radius: 8px; border: 2px solid var(--accent-secondary);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-7-circle-fill"></i> Balance<br>ç´¯è®¡ä½™é¢
                            </small>
                            <div style="color: var(--accent-secondary); font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.rolling_balance) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-8-circle"></i> Transfers<br>è½¬è´¦
                            </small>
                            <div style="color: #2196F3; font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.transfers) }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- INFINITE Formula -->
                <div style="margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(139,92,246,0.05); border-radius: 6px; border-left: 3px solid var(--accent-secondary);">
                    <small style="color: var(--text-secondary); font-family: 'Courier New', monospace;">
                        <i class="bi bi-calculator"></i> è®¡ç®—å…¬å¼: 
                        <span style="color: var(--text-primary);">ä¸Šæœˆä½™é¢ ({{ "{:,.2f}".format(ledger.infinite.previous_balance) }}) + æœ¬æœˆæ¶ˆè´¹ ({{ "{:,.2f}".format(ledger.infinite.total_spend) }}) - æœ¬æœˆä»˜æ¬¾ ({{ "{:,.2f}".format(ledger.infinite.total_payments) }}) = <strong style="color: var(--accent-secondary);">ä½™é¢ RM {{ "{:,.2f}".format(ledger.infinite.rolling_balance) }}</strong></span>
                    </small>
                </div>
                
                <!-- Supplier Info -->
                <div style="margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(255,193,7,0.05); border-radius: 6px;">
                    <small style="color: var(--text-secondary);">
                        <i class="bi bi-shop"></i> <strong>ä¾›åº”å•†æ¸…å• (Suppliers):</strong> 7SL, DINAS, RAUB SYC HAINAN, AI SMART TECH, HUAWEI, PASAR RAYA, PUCHONG HERBS
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- Info Box -->
        <div class="alert" style="background: rgba(212,175,55,0.1); border: 1px solid var(--accent-primary); color: var(--text-primary); border-radius: 8px; padding: 1.25rem;">
            <div class="d-flex align-items-start">
                <i class="bi bi-info-circle-fill" style="color: var(--accent-primary); font-size: 1.5rem; margin-right: 1rem; margin-top: 0.25rem;"></i>
                <div>
                    <h6 style="color: var(--accent-primary); margin-bottom: 0.75rem; font-weight: 600;">
                        åŒè½¨è´¦æœ¬ç³»ç»Ÿè¯´æ˜ / Dual-Ledger System Explanation
                    </h6>
                    <p style="margin-bottom: 0.5rem; color: var(--text-secondary); line-height: 1.6;">
                        <strong style="color: var(--text-primary);">å®¢æˆ·è´¦æœ¬ï¼ˆ1-4é¡¹ï¼‰ï¼š</strong>è®°å½•å®¢æˆ·æœ¬åå’ŒKENG CHOWå…¬å¸çš„æ‰€æœ‰äº¤æ˜“å’Œè¿˜æ¬¾<br>
                        <strong style="color: var(--text-primary);">INFINITEè´¦æœ¬ï¼ˆ5-8é¡¹ï¼‰ï¼š</strong>è®°å½•7ä¸ªä¾›åº”å•†çš„æ¶ˆè´¹ï¼ˆå«1%æ‰‹ç»­è´¹ï¼‰ã€å…¶ä»–ä»˜æ¬¾ã€æ»šåŠ¨ä½™é¢ã€ä»¥åŠè½¬è´¦åˆ°å®¢æˆ·ç§äººæˆ·å£çš„é‡‘é¢
                    </p>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                        ğŸ’¡ <strong>ç¬¬8é¡¹è½¬è´¦</strong>ä»å‚¨è“„è´¦æˆ·ç³»ç»Ÿè‡ªåŠ¨æå–ï¼Œæ˜¾ç¤ºè¯¥æœˆä»½è½¬ç»™å®¢æˆ·æˆ·å£çš„æ€»é‡‘é¢ï¼Œç”¨äºBuild Profileå’Œä¿¡ç”¨å¡è¿˜æ¬¾ã€‚
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="mb-5">
        <h3 class="mb-4" style="color: var(--text-primary);">{{ t('quick_actions') }}</h3>
        <div class="row g-4">
            <div class="col-md-4">
                <a href="{{ url_for('search_transactions', customer_id=customer.id) }}" class="btn-professional-outline w-100 py-3 text-center" style="text-decoration: none;">
                    <div>{{ t('search_filter') }}</div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="{{ url_for('batch_upload', customer_id=customer.id) }}" class="btn-professional-outline w-100 py-3 text-center" style="text-decoration: none;">
                    <div>{{ t('batch_upload') }}</div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="{{ url_for('export_transactions', customer_id=customer.id, format='excel') }}" class="btn-professional-outline w-100 py-3 text-center" style="text-decoration: none;">
                    <div>{{ t('export_data') }}</div>
                </a>
            </div>
            <div class="col-md-3">
                <a href="{{ url_for('customer_monthly_reports', customer_id=customer.id) }}" class="btn-professional-outline w-100 py-3 text-center" style="text-decoration: none;">
                    <div><i class="bi bi-file-earmark-bar-graph"></i> Monthly Reports / æœˆåº¦æŠ¥è¡¨</div>
                </a>
            </div>
            <div class="col-12 mt-3">
                <a href="{{ url_for('financial_advisory', customer_id=customer.id) }}" class="btn-white-glow w-100 py-3" style="text-decoration: none;">
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="text-center">
                            <div style="font-size: 1.1rem; font-weight: bold;"><i class="bi bi-stars"></i> {{ t('financial_advisory_service') }}</div>
                            <small>{{ t('advisory_subtitle') }}</small>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Recent Statements -->
    {% if statements %}
    <div>
        <h3 class="mb-4" style="color: var(--text-primary);">Recent Statements</h3>
        <div class="professional-card">
            <table class="table-professional">
                <thead>
                    <tr>
                        <th>{{ t('date') }}</th>
                        <th>Bank</th>
                        <th>{{ t('total') }}</th>
                        <th>{{ t('status') }}</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stmt in statements[:5] %}
                    <tr>
                        <td style="white-space: nowrap;">{{ stmt.statement_date }}</td>
                        <td style="white-space: nowrap;">{{ stmt.bank_name }}</td>
                        <td style="color: var(--text-primary); font-weight: 600; white-space: nowrap;">RM {{ "{:,.2f}".format(stmt.statement_total) }}</td>
                        <td style="white-space: nowrap;">
                            {% if stmt.is_confirmed %}
                                <span class="badge-professional badge-success-pro">Confirmed</span>
                            {% else %}
                                <span class="badge-professional badge-primary-pro">Pending</span>
                            {% endif %}
                        </td>
                        <td style="white-space: nowrap;">
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('validate', statement_id=stmt.id) }}" class="btn-professional-outline" style="padding: 0.4rem 1rem; font-size: 0.85rem;">{{ t('view') }}</a>
                                {% if stmt.is_confirmed %}
                                <a href="{{ url_for('statement_comparison', statement_id=stmt.id) }}" class="btn-professional" style="padding: 0.4rem 1rem; font-size: 0.85rem;">
                                    <i class="bi bi-layout-split"></i> Comparison / å¯¹æ¯”
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
