{% extends "base.html" %}

{% block title %}{{ customer.name }} - {{ t('nav_dashboard') }}{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Page Header -->
    <div class="section-header">
        <h1 class="section-title">{{ customer.name }}</h1>
        <p class="section-subtitle">{{ t('dashboard_subtitle') }}</p>
    </div>

    <!-- Stats Overview -->
    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <div class="stat-card">
                <div class="stat-value">RM {{ "{:,.2f}".format(customer.monthly_income) }}</div>
                <div class="stat-label">{{ t('monthly_income') }}</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stat-card">
                <div class="stat-value">RM {{ "{:,.2f}".format(total_spending) }}</div>
                <div class="stat-label">{{ t('total_spending') }}</div>
            </div>
        </div>
    </div>

    <!-- Credit Cards Section -->
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 style="color: var(--text-primary); margin: 0;">{{ t('credit_cards') }}</h3>
            <a href="{{ url_for('add_credit_card', customer_id=customer.id) }}" 
               class="btn-white-glow" 
               style="padding: 0.75rem 1.5rem; font-size: 0.95rem;">
                <i class="bi bi-plus-circle"></i> {{ t('add_new_card') }}
            </a>
        </div>
        
        {% if cards %}
        <div class="row g-4">
            {% for card in cards %}
            <div class="col-12">
                <div class="professional-card" style="padding: 2rem;">
                    <!-- Card Header -->
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <div class="d-flex align-items-center">
                            <div style="width: 60px; height: 60px; background: var(--accent-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1.25rem; font-size: 1.8rem; color: var(--text-primary);">
                                {{ card.bank_name[0] }}
                            </div>
                            <div>
                                <h4 style="margin: 0; color: var(--text-primary); font-weight: 700;">{{ card.bank_name }}</h4>
                                <div class="mt-1">
                                    <small style="color: var(--text-secondary); font-size: 0.95rem;">****{{ card.card_number_last4 }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-3">
                            <div class="text-end">
                                <small style="color: var(--text-secondary); display: block;">{{ t('credit_limit') }}</small>
                                <span style="color: var(--text-primary); font-weight: 700; font-size: 1.1rem;">RM {{ "{:,.2f}".format(card.credit_limit) }}</span>
                            </div>
                            <div class="text-end">
                                <small style="color: var(--text-secondary); display: block;">{{ t('due_date') }}</small>
                                <span class="badge-professional badge-primary-pro" style="font-size: 0.9rem;">{{ t('day') }} {{ card.due_date }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 12-Month Timeline -->
                    {% if card.timeline %}
                    {% with timeline=card.timeline, coverage_percentage=card.coverage_percentage %}
                    {% include 'components/card_timeline_12months.html' %}
                    {% endwith %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Ê≤°Êúâ‰ø°Áî®Âç°Êó∂ÊòæÁ§∫ÊèêÁ§∫ -->
        <div class="professional-card text-center py-5">
            <div style="font-size: 3rem; color: rgba(255,122,67,0.3); margin-bottom: 1rem;">
                <i class="bi bi-credit-card-2-front"></i>
            </div>
            <h4 style="color: rgba(255,255,255,0.9); margin-bottom: 1rem;" data-i18n="{{ t('no_credit_cards_1') }}">{{ t('no_credit_cards') }}</h4>
            <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;" data-i18n="{{ t('add_first_card_desc_1') }}">
                {{ t('add_first_card_desc') }}
            </p>
            <a href="{{ url_for('add_credit_card', customer_id=customer.id) }}" 
               class="btn-white-glow" 
               style="padding: 1rem 2rem; font-size: 1.1rem;">
                <i class="bi bi-plus-circle"></i> <span data-i18n="{{ t('add_new_card_1') }}">{{ t('add_new_card') }}</span>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Monthly Ledger Section (8-Item Calculation) -->
    {% if monthly_ledgers %}
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 style="color: var(--text-primary); margin: 0;">
                <i class="bi bi-calculator"></i> {{ t('__monthly_financial_ledger') }}
            </h3>
            <small style="color: var(--text-secondary);">{{ t('__infinite') }}</small>
        </div>
        
        {% for ledger in monthly_ledgers %}
        <div class="professional-card mb-4" style="padding: 2rem;">
            <!-- Card Header -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h4 style="margin: 0; color: var(--text-primary); font-weight: 700;">
                        {{ ledger.card.bank_name }} ****{{ ledger.card.card_number_last4 }}
                    </h4>
                    <small style="color: var(--text-secondary);">{{ ledger.month }} ÊúàÂ∫¶Ë¥¶Êú¨</small>
                </div>
                <span class="badge-professional badge-primary-pro" style="font-size: 1rem;">
                    <i class="bi bi-calendar3"></i> {{ ledger.month }}
                </span>
            </div>
            
            <div class="divider-professional mb-4"></div>
            
            <!-- {{ t('customer_ledger_') }}) -->
            <div class="mb-4">
                <h5 style="color: var(--accent-primary); margin-bottom: 1.5rem; font-weight: 600;">
                    <i class="bi bi-person-circle"></i> {{ t('__customer_ledger') }}
                </h5>
                <div class="row g-4">
                    <div class="col-md-3 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(212,175,55,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                                <i class="bi bi-1-circle"></i>{{ t('previous_balance') }}<br>‰∏äÊúà‰ΩôÈ¢ù
                            </small>
                            <div style="color: var(--text-primary); font-weight: 700; font-size: 1.1rem;">
                                RM {{ "{:,.2f}".format(ledger.customer.previous_balance) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(212,175,55,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                                <i class="bi bi-2-circle"></i>{{ t('total_spend') }}<br>ÂÆ¢Êà∑ÊÄªÊ∂àË¥π
                            </small>
                            <div style="color: #FF7A43; font-weight: 700; font-size: 1.1rem;">
                                RM {{ "{:,.2f}".format(ledger.customer.total_spend) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(212,175,55,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                                <i class="bi bi-3-circle"></i>{{ t('total_payments') }}<br>ÂÆ¢Êà∑ÊÄª‰ªòÊ¨æ
                            </small>
                            <div style="color: #4CAF50; font-weight: 700; font-size: 1.1rem;">
                                RM {{ "{:,.2f}".format(ledger.customer.total_payments) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div style="background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(255,122,67,0.1)); padding: 1rem; border-radius: 8px; border: 2px solid var(--accent-primary);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                                <i class="bi bi-4-circle-fill"></i>{{ t('customerdashboard_text_389') }}<br>ÂÆ¢Êà∑Á¥ØËÆ°‰ΩôÈ¢ù
                            </small>
                            <div style="color: var(--accent-primary); font-weight: 700; font-size: 1.2rem;">
                                RM {{ "{:,.2f}".format(ledger.customer.rolling_balance) }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Calculation Formula -->
                <div style="margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(212,175,55,0.05); border-radius: 6px; border-left: 3px solid var(--accent-primary);">
                    <small style="color: var(--text-secondary); font-family: 'Courier New', monospace;">
                        <i class="bi bi-calculator"></i> ËÆ°ÁÆóÂÖ¨Âºè: 
                        <span style="color: var(--text-primary);">‰∏äÊúà‰ΩôÈ¢ù ({{ "{:,.2f}".format(ledger.customer.previous_balance) }}) + Êú¨ÊúàÊ∂àË¥π ({{ "{:,.2f}".format(ledger.customer.total_spend) }}) - Êú¨Êúà‰ªòÊ¨æ ({{ "{:,.2f}".format(ledger.customer.total_payments) }}) = <strong style="color: var(--accent-primary);">{{ t('_rm_3') }} {{ "{:,.2f}".format(ledger.customer.rolling_balance) }}</strong></span>
                    </small>
                </div>
            </div>
            
            <div class="divider-professional my-4"></div>
            
            <!-- {{ t('infinite_ledger_infinite') }}) -->
            <div>
                <h5 style="color: var(--accent-secondary); margin-bottom: 1.5rem; font-weight: 600;">
                    <i class="bi bi-building"></i> {{ t('infinite__1') }} / INFINITE Ledger
                </h5>
                <div class="row g-4">
                    <div class="col-md-2 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-1-circle"></i>{{ t('previous') }}<br>‰∏äÊúà‰ΩôÈ¢ù
                            </small>
                            <div style="color: var(--text-primary); font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.previous_balance) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-5-circle"></i>{{ t('total_spend') }}<br>ÊÄªÊ∂àË¥π
                            </small>
                            <div style="color: #FF7A43; font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.total_spend) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-tag"></i>{{ t('fee_1') }}<br>ÊâãÁª≠Ë¥π
                            </small>
                            <div style="color: #FFC107; font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.supplier_fee) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-6-circle"></i>{{ t('payments') }}<br>ÊÄª‰ªòÊ¨æ
                            </small>
                            <div style="color: #4CAF50; font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.total_payments) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(255,122,67,0.1)); padding: 1rem; border-radius: 8px; border: 2px solid var(--accent-secondary);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-7-circle-fill"></i>{{ t('balance') }}<br>Á¥ØËÆ°‰ΩôÈ¢ù
                            </small>
                            <div style="color: var(--accent-secondary); font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.rolling_balance) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border: 1px solid rgba(139,92,246,0.2);">
                            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                <i class="bi bi-8-circle"></i>{{ t('transfers') }}<br>ËΩ¨Ë¥¶
                            </small>
                            <div style="color: #2196F3; font-weight: 700; font-size: 1rem;">
                                RM {{ "{:,.2f}".format(ledger.infinite.transfers) }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- INFINITE Formula -->
                <div style="margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(139,92,246,0.05); border-radius: 6px; border-left: 3px solid var(--accent-secondary);">
                    <small style="color: var(--text-secondary); font-family: 'Courier New', monospace;">
                        <i class="bi bi-calculator"></i> ËÆ°ÁÆóÂÖ¨Âºè: 
                        <span style="color: var(--text-primary);">‰∏äÊúà‰ΩôÈ¢ù ({{ "{:,.2f}".format(ledger.infinite.previous_balance) }}) + Êú¨ÊúàÊ∂àË¥π ({{ "{:,.2f}".format(ledger.infinite.total_spend) }}) - Êú¨Êúà‰ªòÊ¨æ ({{ "{:,.2f}".format(ledger.infinite.total_payments) }}) = <strong style="color: var(--accent-secondary);">{{ t('_rm_3') }} {{ "{:,.2f}".format(ledger.infinite.rolling_balance) }}</strong></span>
                    </small>
                </div>
                
                <!-- Supplier Info -->
                <div style="margin-top: 1rem; padding: 0.75rem 1rem; background: rgba(255,193,7,0.05); border-radius: 6px;">
                    <small style="color: var(--text-secondary);">
                        <i class="bi bi-shop"></i> <strong>{{ t('_suppliers') }}</strong> 7SL, DINAS, RAUB SYC HAINAN, AI SMART TECH, HUAWEI, PASAR RAYA, PUCHONG HERBS
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- Info Box -->
        <div class="alert" style="background: rgba(212,175,55,0.1); border: 1px solid var(--accent-primary); color: var(--text-primary); border-radius: 8px; padding: 1.25rem;">
            <div class="d-flex align-items-start">
                <i class="bi bi-info-circle-fill" style="color: var(--accent-primary); font-size: 1.5rem; margin-right: 1rem; margin-top: 0.25rem;"></i>
                <div>
                    <h6 style="color: var(--accent-primary); margin-bottom: 0.75rem; font-weight: 600;">
                        {{ t('__dualledger_system_explanation') }}
                    </h6>
                    <p style="margin-bottom: 0.5rem; color: var(--text-secondary); line-height: 1.6;">
                        <strong style="color: var(--text-primary);">{{ t('14') }}</strong>{{ t('keng_chow') }}<br>
                        <strong style="color: var(--text-primary);">{{ t('infinite58') }}</strong>ËÆ∞ÂΩï7‰∏™‰æõÂ∫îÂïÜÁöÑÊ∂àË¥πÔºàÂê´1%ÊâãÁª≠Ë¥πÔºâ„ÄÅÂÖ∂‰ªñ‰ªòÊ¨æ„ÄÅÊªöÂä®‰ΩôÈ¢ù„ÄÅ‰ª•ÂèäËΩ¨Ë¥¶Âà∞ÂÆ¢Êà∑ÁßÅ‰∫∫Êà∑Âè£ÁöÑÈáëÈ¢ù
                    </p>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                        üí° <strong>{{ t('8_1') }}</strong>{{ t('build_profile_1') }}Âíå‰ø°Áî®Âç°ËøòÊ¨æ„ÄÇ
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="mb-5">
        <h3 class="mb-4" style="color: var(--text-primary);">{{ t('quick_actions') }}</h3>
        <div class="row g-4">
            <div class="col-md-4">
                <a href="{{ url_for('search_transactions', customer_id=customer.id) }}" class="btn-professional-outline w-100 py-3 text-center" style="text-decoration: none;">
                    <div>{{ t('search_filter') }}</div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="{{ url_for('batch_upload', customer_id=customer.id) }}" class="btn-professional-outline w-100 py-3 text-center" style="text-decoration: none;">
                    <div>{{ t('batch_upload') }}</div>
                </a>
            </div>
            <div class="col-md-4">
                <a href="{{ url_for('export_transactions', customer_id=customer.id, format='excel') }}" class="btn-professional-outline w-100 py-3 text-center" style="text-decoration: none;">
                    <div>{{ t('export_data') }}</div>
                </a>
            </div>
            <div class="col-md-3">
                <a href="{{ url_for('customer_monthly_reports', customer_id=customer.id) }}" class="btn-professional-outline w-100 py-3 text-center" style="text-decoration: none;">
                    <div><i class="bi bi-file-earmark-bar-graph"></i>{{ t('monthly_reports__') }}</div>
                </a>
            </div>
            <div class="col-12 mt-3">
                <a href="{{ url_for('financial_advisory', customer_id=customer.id) }}" class="btn-white-glow w-100 py-3" style="text-decoration: none;">
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="text-center">
                            <div style="font-size: 1.1rem; font-weight: bold;"><i class="bi bi-stars"></i> {{ t('financial_advisory_service') }}</div>
                            <small>{{ t('advisory_subtitle') }}</small>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Recent Statements -->
    {% if statements %}
    <div>
        <h3 class="mb-4" style="color: var(--text-primary);">{{ t('recent_statements') }}</h3>
        <div class="professional-card">
            <table class="table-professional">
                <thead>
                    <tr>
                        <th>{{ t('date') }}</th>
                        <th>{{ t('bank') }}</th>
                        <th>{{ t('total') }}</th>
                        <th>{{ t('status') }}</th>
                        <th>{{ t('actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stmt in statements[:5] %}
                    <tr>
                        <td style="white-space: nowrap;">{{ stmt.statement_date }}</td>
                        <td style="white-space: nowrap;">{{ stmt.bank_name }}</td>
                        <td style="color: var(--text-primary); font-weight: 600; white-space: nowrap;">RM {{ "{:,.2f}".format(stmt.statement_total) }}</td>
                        <td style="white-space: nowrap;">
                            {% if stmt.is_confirmed %}
                                <span class="badge-professional badge-success-pro">{{ t('confirmed') }}</span>
                            {% else %}
                                <span class="badge-professional badge-primary-pro">{{ t('validation_pending') }}</span>
                            {% endif %}
                        </td>
                        <td style="white-space: nowrap;">
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('validate', statement_id=stmt.id) }}" class="btn-professional-outline" style="padding: 0.4rem 1rem; font-size: 0.85rem;">{{ t('view') }}</a>
                                {% if stmt.is_confirmed %}
                                <a href="{{ url_for('statement_comparison', statement_id=stmt.id) }}" class="btn-professional" style="padding: 0.4rem 1rem; font-size: 0.85rem;">
                                    <i class="bi bi-layout-split"></i> {{ t('comparison__') }}
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
