{% extends "layout.html" %}

{% block title %}{{ t('__file_manager_1') }}{% endblock %}

{% block extra_css %}
<style>
    /* {{ t('_____btnpattern') }}-1 {
        background-color: #FF007F;
        color: white;
        font-weight: bold;
        border: 2px solid white;
    }
    .btn-pattern-1:hover {
        background-color: #CC0066;
        color: white;
    }
    
    .btn-pattern-2 {
        background-color: #322446;
        color: white;
        font-weight: bold;
        border: 2px solid white;
    }
    .btn-pattern-2:hover {
        background-color: #241832;
        color: white;
    }
    
    .btn-pattern-5 {
        background-color: #D3D3D3;
        color: #FF007F;
        font-weight: bold;
        border: 2px solid #000000;
    }
    .btn-pattern-5:hover {
        background-color: #C0C0C0;
        color: #FF007F;
    }
    
    /* {{ t('badge__') }} */
    .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.85rem;
    }
    
    .badge-parsed {
        background-color: #322446;
        color: white;
    }
    
    .badge-failed {
        background-color: #FF007F;
        color: white;
    }
    
    .badge-uploaded {
        background-color: #D3D3D3;
        color: #322446;
    }
    
    .badge-passed {
        background-color: #322446;
        color: white;
    }
    
    .badge-pending {
        background-color: #D3D3D3;
        color: #322446;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{{ t('__file_manager') }}</h2>
    <a href="http://localhost:8000/accounting" class="btn btn-pattern-1" data-i18n="upload_new_file">
        {{ t('upload_new_file') }}
    </a>
</div>

<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>{{ t('id') }}</th>
                <th>{{ t('__file_name') }}</th>
                <th>{{ t('__company') }}</th>
                <th>{{ t('__month_1') }}</th>
                <th>{{ t('__status') }}</th>
                <th>{{ t('__validation') }}</th>
                <th>{{ t('__upload_time') }}</th>
                <th>{{ t('__next_action') }}</th>
            </tr>
        </thead>
        <tbody id="files-table-body">
            {% for file in files %}
            <tr class="{% if loop.index0 == 0 %}row--highlight{% endif %}" data-file-id="{{ file.id }}">
                <td>{{ file.id }}</td>
                <td>
                    <a href="/files/detail/{{ file.id }}" style="color: #FF007F; font-weight: bold;">
                        {{ file.file_name }}
                    </a>
                </td>
                <td>{{ file.company_name or 'N/A' }}</td>
                <td>{{ file.statement_month or 'N/A' }}</td>
                <td>
                    <span class="badge badge-{{ file.status }}">
                        {{ file.status }}
                    </span>
                </td>
                <td>
                    <span class="badge badge-{{ file.validation_status }}">
                        {{ file.validation_status }}
                    </span>
                </td>
                <td>{{ file.created_at }}</td>
                <td class="next-action-cell" data-status="{{ file.status }}" data-validation="{{ file.validation_status }}" data-file-id="{{ file.id }}">
                    <!-- {{ t('nextactionbutton_') }} -->
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if not files %}
<div class="alert alert-info text-center" style="background-color: #D3D3D3; color: #322446; border: 2px solid #FF007F;">
    {{ t('__no_files_uploaded_yet') }}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Next action button renderer
document.addEventListener('DOMContentLoaded', function() {
    const t = (key, fallback) => window.i18n?.translate(key) || fallback || key;
    const cells = document.querySelectorAll('.next-action-cell');
    
    cells.forEach(cell => {
        const status = cell.dataset.status;
        const validation = cell.dataset.validation;
        const fileId = cell.dataset.fileId;
        
        // Determine button text and action based on status
        let buttonText = t('view_details', '查看详情');
        let buttonUrl = `/files/detail/${fileId}`;
        let buttonClass = 'btn-pattern-5';
        
        if (status === 'uploaded' && validation === 'pending') {
            buttonText = t('go_validate', '去验证');
            buttonClass = 'btn-pattern-5';
        } else if (status === 'parsed' && validation === 'passed') {
            buttonText = t('generate_report', '生成报表');
            buttonClass = 'btn-pattern-1';
        } else if (status === 'failed' || validation === 'failed') {
            buttonText = t('view_exceptions', '查看异常');
            buttonClass = 'btn-pattern-2';
        } else if (status === 'duplicate') {
            buttonText = t('set_as_primary_statement', '设为主账单');
            buttonClass = 'btn-pattern-1';
        }
        
        // Create button element
        const button = document.createElement('a');
        button.href = buttonUrl;
        button.className = `btn btn-sm ${buttonClass}`;
        button.textContent = buttonText;
        
        cell.appendChild(button);
    });
});
</script>
{% endblock %}
