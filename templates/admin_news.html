{% extends "base.html" %}

{% block title %}新闻管理 - 管理员{% endblock %}

{% block content %}
<div class="container-professional">
    <div class="header-section-pro">
        <h1 class="title-pro-h1">
            <span class="gradient-text-silver">新闻管理中心</span>
            <div class="title-underline-silver"></div>
        </h1>
        <p class="subtitle-pro">审核和发布银行最新消息</p>
    </div>

    <!-- 统计卡片 -->
    <div class="stats-grid-professional">
        <div class="stat-card-professional">
            <div class="stat-value-pro">{{ pending_count }}</div>
            <div class="stat-label-pro">待审核</div>
            <div class="corner-accent-silver bottom-right"></div>
        </div>
        <div class="stat-card-professional">
            <div class="stat-value-pro">{{ approved_today }}</div>
            <div class="stat-label-pro">今日已发布</div>
            <div class="corner-accent-silver bottom-right"></div>
        </div>
        <div class="stat-card-professional">
            <div class="stat-value-pro">{{ total_news }}</div>
            <div class="stat-label-pro">总新闻数</div>
            <div class="corner-accent-silver bottom-right"></div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="action-section" style="margin: 2rem 0;">
        <button class="btn-professional btn-primary-pro" onclick="fetchLatestNews()">
            <i class="bi bi-arrow-clockwise"></i>
            获取最新新闻
        </button>
        <button class="btn-professional btn-secondary-pro" onclick="location.href='/banking_news'">
            <i class="bi bi-eye"></i>
            查看已发布新闻
        </button>
    </div>

    <!-- 待审核新闻列表 -->
    <div class="section-card-professional" style="margin-top: 2rem;">
        <h2 class="section-title-pro-h2">待审核新闻</h2>
        
        {% if pending_news %}
        <div class="news-grid-professional">
            {% for news in pending_news %}
            <div class="news-card-professional" id="news-{{ news.id }}">
                <div class="card-frame-silver">
                    <div class="corner-l top-left"></div>
                    <div class="corner-l top-right"></div>
                    <div class="corner-l bottom-left"></div>
                    <div class="corner-l bottom-right"></div>
                </div>
                
                <div class="news-header-pro">
                    <span style="color: var(--text-primary); font-weight: 600;">{{ news.bank_name or '未分类' }}</span>
                    <span class="badge-professional badge-warning-pro">{{ news.category or 'GENERAL' }}</span>
                </div>
                
                <h5 style="color: var(--text-primary); margin: 1rem 0;">{{ news.title }}</h5>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">{{ news.content }}</p>
                
                {% if news.source_url %}
                <div style="margin-bottom: 1rem;">
                    <a href="{{ news.source_url }}" target="_blank" style="color: var(--accent-primary); font-size: 0.875rem;">
                        <i class="bi bi-link-45deg"></i> 来源链接
                    </a>
                </div>
                {% endif %}
                
                <div class="news-meta-pro">
                    <span><i class="bi bi-calendar3"></i> {{ news.effective_date }}</span>
                    <span><i class="bi bi-clock"></i> {{ news.created_at[:10] }}</span>
                </div>
                
                <div class="divider-professional"></div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn-professional btn-primary-pro" onclick="approveNews({{ news.id }})" style="flex: 1;">
                        <i class="bi bi-check-circle"></i> 发布
                    </button>
                    <button class="btn-professional btn-secondary-pro" onclick="rejectNews({{ news.id }})" style="flex: 1;">
                        <i class="bi bi-x-circle"></i> 拒绝
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
            <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.5;"></i>
            <p style="margin-top: 1rem;">暂无待审核新闻</p>
            <button class="btn-professional btn-primary-pro" onclick="fetchLatestNews()" style="margin-top: 1rem;">
                获取最新新闻
            </button>
        </div>
        {% endif %}
    </div>
</div>

<style>
.news-grid-professional {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.action-section {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.badge-warning-pro {
    background: rgba(251, 191, 36, 0.1);
    color: #FCD34D;
    border: 1px solid rgba(251, 191, 36, 0.2);
}
</style>

<script>
function approveNews(newsId) {
    if (!confirm('确定要发布这条新闻吗？')) return;
    
    fetch(`/admin/news/approve/${newsId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`news-${newsId}`).style.opacity = '0.5';
            setTimeout(() => location.reload(), 500);
        } else {
            alert('操作失败：' + data.error);
        }
    })
    .catch(error => {
        alert('操作失败：' + error);
    });
}

function rejectNews(newsId) {
    if (!confirm('确定要拒绝这条新闻吗？')) return;
    
    fetch(`/admin/news/reject/${newsId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`news-${newsId}`).style.opacity = '0.5';
            setTimeout(() => location.reload(), 500);
        } else {
            alert('操作失败：' + data.error);
        }
    })
    .catch(error => {
        alert('操作失败：' + error);
    });
}

function fetchLatestNews() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 搜索中...';
    
    fetch('/admin/news/fetch', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`成功获取 ${data.count} 条新闻！`);
            location.reload();
        } else {
            alert('获取失败：' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 获取最新新闻';
        }
    })
    .catch(error => {
        alert('获取失败：' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 获取最新新闻';
    });
}
</script>
{% endblock %}
