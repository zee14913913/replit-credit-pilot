{% extends "base.html" %}

{% block title %}{{ t('client_detail') }} - {{ client.customer.name }} - {{ t('company_name') }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Back Button -->
    <div class="row mb-3">
        <div class="col-12">
            <a href="/admin/portfolio" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> {{ t('back_to_portfolio') }}
            </a>
        </div>
    </div>

    <!-- Client Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="gradient-text">{{ client.customer.name }}</h1>
            <p class="text-secondary">
                <i class="bi bi-envelope"></i> {{ client.customer.email }} |
                <i class="bi bi-telephone"></i> {{ client.customer.phone }} |
                <i class="bi bi-cash"></i> {{ t('monthly_income') }}: RM {{ "{:,.2f}".format(client.customer.monthly_income or 0) }}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <h3 class="text-muted">{{ t('client_id') }}: {{ client.customer.id }}</h3>
        </div>
    </div>

    <!-- Financial Metrics Summary -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-success">
                <div class="card-body">
                    <h6 class="text-secondary">{{ t('total_savings') }}</h6>
                    <h3 class="text-success">RM {{ "{:,.2f}".format(client.metrics.total_savings) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-info">
                <div class="card-body">
                    <h6 class="text-secondary">{{ t('gz_revenue_50') }}</h6>
                    <h3 class="text-info">RM {{ "{:,.2f}".format(client.metrics.gz_revenue) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <h6 class="text-secondary">{{ t('client_keeps_50') }}</h6>
                    <h3 class="text-primary">RM {{ "{:,.2f}".format(client.metrics.customer_keeps) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-{{ 'danger' if client.metrics.dsr > 70 else ('warning' if client.metrics.dsr > 50 else 'success') }}">
                <div class="card-body">
                    <h6 class="text-secondary">{{ t('dsr') }}</h6>
                    <h3 class="text-{{ 'danger' if client.metrics.dsr > 70 else ('warning' if client.metrics.dsr > 50 else 'success') }}">
                        {{ "{:.1f}".format(client.metrics.dsr) }}%
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Cards -->
    {% if client.credit_cards %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5><i class="bi bi-credit-card"></i> {{ t('credit_cards') }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for card in client.credit_cards %}
                        <div class="col-md-6 mb-3">
                            <div class="card border-{{ 'danger' if card.current_balance > card.credit_limit else ('warning' if card.utilization > 80 else 'success') }}">
                                <div class="card-body">
                                    <h6>{{ card.card_name }}</h6>
                                    <p class="mb-1"><small>{{ card.bank_name }}</small></p>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar bg-{{ 'danger' if card.utilization > 100 else ('warning' if card.utilization > 80 else 'success') }}" 
                                             style="width: {{ min(card.utilization, 100) }}%">
                                            {{ "{:.1f}".format(card.utilization) }}%
                                        </div>
                                    </div>
                                    <p class="mb-0">
                                        {{ t('balance') }}: RM {{ "{:,.2f}".format(card.current_balance) }} / 
                                        {{ t('limit') }}: RM {{ "{:,.2f}".format(card.credit_limit) }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Advisory Workflow Timeline -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5><i class="bi bi-diagram-3"></i> {{ t('advisory_workflow_status') }}</h5>
                </div>
                <div class="card-body">
                    <!-- Proposals -->
                    <h6 class="text-primary">1. {{ t('optimization_proposals') }}</h6>
                    {% if client.workflow.proposals %}
                    <div class="table-responsive mb-4">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>{{ t('type') }}</th>
                                    <th>{{ t('details') }}</th>
                                    <th>{{ t('expected_savings') }}</th>
                                    <th>{{ t('status') }}</th>
                                    <th>{{ t('created') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for proposal in client.workflow.proposals %}
                                <tr>
                                    <td style="white-space: nowrap;">{{ proposal.suggestion_type }}</td>
                                    <td style="white-space: nowrap;">{{ proposal.details[:100] }}...</td>
                                    <td style="white-space: nowrap;" class="text-success">RM {{ "{:,.2f}".format(proposal.expected_annual_savings or 0) }}</td>
                                    <td style="white-space: nowrap;">
                                        <span class="badge bg-{{ 'success' if proposal.status == 'accepted' else ('warning' if proposal.status == 'proposed' else 'secondary') }}">
                                            {{ proposal.status }}
                                        </span>
                                    </td>
                                    <td style="white-space: nowrap;">{{ proposal.created_at }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">{{ t('no_proposals_yet') }}</p>
                    {% endif %}

                    <!-- Consultations -->
                    <h6 class="text-info">2. {{ t('consultation_requests') }}</h6>
                    {% if client.workflow.consultations %}
                    <div class="table-responsive mb-4">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>{{ t('service_type') }}</th>
                                    <th>{{ t('preferred_time') }}</th>
                                    <th>{{ t('status') }}</th>
                                    <th>{{ t('outcome') }}</th>
                                    <th>{{ t('created') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for consult in client.workflow.consultations %}
                                <tr>
                                    <td style="white-space: nowrap;">{{ consult.service_type }}</td>
                                    <td style="white-space: nowrap;">{{ consult.preferred_time }}</td>
                                    <td style="white-space: nowrap;">
                                        <span class="badge bg-{{ 'success' if consult.status == 'completed' else ('warning' if consult.status == 'scheduled' else 'secondary') }}">
                                            {{ consult.status }}
                                        </span>
                                    </td>
                                    <td style="white-space: nowrap;">{{ consult.consultation_outcome or t('n_a') }}</td>
                                    <td style="white-space: nowrap;">{{ consult.created_at }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">{{ t('no_consultations_yet') }}</p>
                    {% endif %}

                    <!-- Contracts -->
                    <h6 class="text-success">3. {{ t('service_contracts') }}</h6>
                    {% if client.workflow.contracts %}
                    <div class="table-responsive mb-4">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>{{ t('services') }}</th>
                                    <th>{{ t('expected_savings') }}</th>
                                    <th>{{ t('fee_rate') }}</th>
                                    <th>{{ t('status') }}</th>
                                    <th>{{ t('created') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contract in client.workflow.contracts %}
                                <tr>
                                    <td style="white-space: nowrap;">{{ contract.services_agreed }}</td>
                                    <td style="white-space: nowrap;" class="text-success">RM {{ "{:,.2f}".format(contract.expected_annual_savings or 0) }}</td>
                                    <td style="white-space: nowrap;">{{ contract.fee_percentage }}%</td>
                                    <td style="white-space: nowrap;">
                                        <span class="badge bg-{{ 'success' if contract.status == 'active' else ('info' if contract.status == 'signed' else 'secondary') }}">
                                            {{ contract.status }}
                                        </span>
                                    </td>
                                    <td style="white-space: nowrap;">{{ contract.created_at }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">{{ t('no_contracts_yet') }}</p>
                    {% endif %}

                    <!-- Payment on Behalf -->
                    <h6 class="text-warning">4. {{ t('payment_on_behalf_records') }}</h6>
                    {% if client.workflow.payments %}
                    <div class="table-responsive mb-4">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>{{ t('payment_type') }}</th>
                                    <th>{{ t('amount') }}</th>
                                    <th>{{ t('recipient') }}</th>
                                    <th>{{ t('date') }}</th>
                                    <th>{{ t('status') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in client.workflow.payments %}
                                <tr>
                                    <td style="white-space: nowrap;">{{ payment.payment_type }}</td>
                                    <td style="white-space: nowrap;" class="text-primary">RM {{ "{:,.2f}".format(payment.amount) }}</td>
                                    <td style="white-space: nowrap;">{{ payment.recipient_name }}</td>
                                    <td style="white-space: nowrap;">{{ payment.payment_date }}</td>
                                    <td style="white-space: nowrap;">
                                        <span class="badge bg-{{ 'success' if payment.status == 'completed' else ('warning' if payment.status == 'pending' else 'danger') }}">
                                            {{ payment.status }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">{{ t('no_payment_records_yet') }}</p>
                    {% endif %}

                    <!-- Fee Calculations -->
                    <h6 class="text-danger">5. {{ t('success_fee_calculations') }}</h6>
                    {% if client.workflow.fee_calculations %}
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>{{ t('service_period') }}</th>
                                    <th>{{ t('actual_savings') }}</th>
                                    <th>{{ t('client_keeps_50') }}</th>
                                    <th>{{ t('gz_fee_50') }}</th>
                                    <th>{{ t('fee_paid') }}</th>
                                    <th>{{ t('date') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for fee in client.workflow.fee_calculations %}
                                <tr>
                                    <td style="white-space: nowrap;">{{ fee.service_period }}</td>
                                    <td style="white-space: nowrap;" class="text-success"><strong>RM {{ "{:,.2f}".format(fee.actual_savings_achieved or 0) }}</strong></td>
                                    <td style="white-space: nowrap;" class="text-primary">RM {{ "{:,.2f}".format((fee.actual_savings_achieved or 0) * 0.5) }}</td>
                                    <td style="white-space: nowrap;" class="text-info"><strong>RM {{ "{:,.2f}".format(fee.our_fee_50_percent or 0) }}</strong></td>
                                    <td style="white-space: nowrap;">
                                        {% if fee.fee_paid %}
                                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> {{ t('paid') }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ t('pending') }}</span>
                                        {% endif %}
                                    </td>
                                    <td style="white-space: nowrap;">{{ fee.calculation_date }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">{{ t('no_fee_calculations_yet') }}</p>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>

    <!-- Cognee AI Memory Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm" style="border: 2px solid #FF007F;">
                <div class="card-header" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
                    <h5 class="text-white mb-0">
                        <i class="bi bi-brain" style="color: #FF007F;"></i> Cognee AI 客户记忆
                    </h5>
                </div>
                <div class="card-body" style="background: #0d0d1a;">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-white mb-3"><i class="bi bi-plus-circle me-2" style="color: #FF007F;"></i>添加客户备注</h6>
                            <div class="mb-3">
                                <textarea id="customerMemory" class="form-control" rows="3" 
                                          placeholder="记录客户偏好、重要备注或沟通记录..."
                                          style="background: #1a1a2e; border: 1px solid #322446; color: #fff;"></textarea>
                            </div>
                            <button type="button" class="btn" id="addMemoryBtn" 
                                    style="background: linear-gradient(135deg, #FF007F 0%, #FF1493 100%); color: #fff; border: none;">
                                <i class="bi bi-plus-lg me-2"></i>添加记忆
                            </button>
                            <div id="memoryAddResult" class="mt-2" style="display: none;"></div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-white mb-3"><i class="bi bi-search me-2" style="color: #FF007F;"></i>查询客户记忆</h6>
                            <div class="input-group mb-3">
                                <input type="text" id="memorySearch" class="form-control" 
                                       placeholder="搜索关键词..."
                                       style="background: #1a1a2e; border: 1px solid #322446; color: #fff;">
                                <button class="btn" type="button" id="searchMemoryBtn"
                                        style="background: #322446; border: 1px solid #FF007F; color: #fff;">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                            <div id="memorySearchResults" style="max-height: 200px; overflow-y: auto;">
                                <p class="text-white-50 text-center mb-0"><small>输入关键词搜索客户相关记忆</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
const COGNEE_API = '/accounting/cognee';
const customerName = "{{ client.customer.name }}";
const customerId = "{{ client.customer.id }}";

document.getElementById('addMemoryBtn').addEventListener('click', async () => {
    const content = document.getElementById('customerMemory').value.trim();
    if (!content) {
        showResult('memoryAddResult', '请输入备注内容', 'warning');
        return;
    }
    
    const fullContent = `客户: ${customerName} (ID: ${customerId})\n${content}`;
    
    try {
        const response = await fetch(`${COGNEE_API}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: fullContent, dataset_name: 'creditpilot_customers' })
        });
        const data = await response.json();
        
        if (data.success) {
            showResult('memoryAddResult', '记忆添加成功！', 'success');
            document.getElementById('customerMemory').value = '';
        } else {
            showResult('memoryAddResult', '添加失败: ' + (data.detail || '未知错误'), 'danger');
        }
    } catch (error) {
        showResult('memoryAddResult', '请求失败: ' + error.message, 'danger');
    }
});

document.getElementById('searchMemoryBtn').addEventListener('click', searchMemory);
document.getElementById('memorySearch').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchMemory();
});

async function searchMemory() {
    const query = document.getElementById('memorySearch').value.trim();
    if (!query) return;
    
    const searchQuery = `${customerName} ${query}`;
    document.getElementById('memorySearchResults').innerHTML = '<div class="text-center text-white-50"><div class="spinner-border spinner-border-sm"></div> 搜索中...</div>';
    
    try {
        const response = await fetch(`${COGNEE_API}/search`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: searchQuery, search_type: 'INSIGHTS' })
        });
        const data = await response.json();
        
        if (data.success && data.results && data.results.length > 0) {
            let html = '';
            data.results.forEach((result, i) => {
                html += `<div class="p-2 mb-2" style="background: #1a1a2e; border-radius: 8px; border-left: 3px solid #FF007F;">
                    <small class="text-white" style="white-space: pre-wrap;">${result}</small>
                </div>`;
            });
            document.getElementById('memorySearchResults').innerHTML = html;
        } else {
            document.getElementById('memorySearchResults').innerHTML = '<p class="text-white-50 text-center mb-0"><small>未找到相关记忆</small></p>';
        }
    } catch (error) {
        document.getElementById('memorySearchResults').innerHTML = `<p class="text-danger text-center mb-0"><small>搜索失败: ${error.message}</small></p>`;
    }
}

function showResult(elementId, message, type) {
    const element = document.getElementById(elementId);
    element.style.display = 'block';
    element.className = `alert alert-${type} py-2`;
    element.innerHTML = `<small>${message}</small>`;
    setTimeout(() => { element.style.display = 'none'; }, 4000);
}
</script>
{% endblock %}
