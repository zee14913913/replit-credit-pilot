<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ç®¡ç† - ä¼šè®¡ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #FF007F;
            margin-bottom: 1rem;
            font-size: 2.5rem;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #FF007F;
            color: white;
        }
        
        .btn-primary:hover {
            background: #cc0066;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #322446;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a3668;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #322446;
        }
        
        .stat-label {
            color: #999;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            color: #FF007F;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .files-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 2rem;
            border: 2px solid #322446;
        }
        
        .section-title {
            color: #FF007F;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #322446;
            padding-bottom: 0.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        
        th {
            background: #322446;
            color: #fff;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #333;
        }
        
        tr:hover {
            background: #2d2d2d;
        }
        
        /* æ–°æ–‡ä»¶é«˜äº® */
        .new-file-row {
            background: linear-gradient(90deg, rgba(255,0,127,0.2) 0%, rgba(50,36,70,0.1) 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255,0,127,0.5); }
            50% { box-shadow: 0 0 15px rgba(255,0,127,0.8); }
        }
        
        .file-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .type-statement {
            background: #322446;
            color: #fff;
        }
        
        .type-report {
            background: #FF007F;
            color: #fff;
        }
        
        /* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin: 0 4px;
        }
        
        .status-active {
            background: #00ff00;
            color: #000;
        }
        
        .status-processing {
            background: #ffaa00;
            color: #000;
        }
        
        .status-failed {
            background: #ff0000;
            color: #fff;
        }
        
        .status-archived {
            background: #666;
            color: #fff;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            margin: 0 4px;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        
        .empty {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-size: 1.2rem;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            overflow: auto;
        }
        
        .modal-content {
            background: #1a1a1a;
            margin: 2% auto;
            padding: 2rem;
            border: 2px solid #FF007F;
            border-radius: 12px;
            width: 90%;
            max-width: 1400px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #322446;
        }
        
        .modal-title {
            color: #FF007F;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .close {
            color: #999;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close:hover {
            color: #FF007F;
        }
        
        .file-viewer {
            background: #000;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #322446;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .csv-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .csv-table th {
            background: #FF007F;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .csv-table td {
            padding: 8px;
            border-bottom: 1px solid #333;
            color: #fff;
        }
        
        .csv-table tr:hover {
            background: #2d2d2d;
        }
    </style>
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Toasté€šçŸ¥ç»„ä»¶ -->
    <script src="/static/js/toast.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æ–‡ä»¶ç®¡ç†ä¸­å¿ƒ</h1>
        
        <div class="header-actions">
            <a href="/" class="btn btn-secondary">â† è¿”å›é¦–é¡µ</a>
            <button onclick="document.getElementById('fileUpload').click()" class="btn btn-primary">ğŸ“¤ æ™ºèƒ½ä¸Šä¼ CSV/PDF</button>
            <button onclick="refreshFiles()" class="btn btn-primary">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            <a href="/accounting_test_results" class="btn btn-primary">ğŸ§ª è¿è¡Œæ–°æµ‹è¯•</a>
        </div>
        
        <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
        <input type="file" id="fileUpload" accept=".csv,.pdf" style="display: none;" onchange="handleFileUpload(event)">
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š æœˆç»“å•æ–‡ä»¶</div>
                <div class="stat-value" id="statements-count">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ“ æµ‹è¯•æŠ¥å‘Š</div>
                <div class="stat-value" id="reports-count">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ’¾ æ€»å­˜å‚¨ç©ºé—´</div>
                <div class="stat-value" id="total-size">-- MB</div>
            </div>
        </div>
        
        <div class="files-section">
            <h2 class="section-title">ğŸ“‚ æ‰€æœ‰æ–‡ä»¶</h2>
            <div id="files-list" class="loading">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</div>
        </div>
    </div>
    
    <!-- æ–‡ä»¶æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="fileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">æ–‡ä»¶æŸ¥çœ‹</div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody" class="file-viewer">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>
    
    
    <script>
        // PDFè½¬CSVæ ¸å¿ƒå‡½æ•°
        async function convertPDFToCSV(file) {
            try {
                // è¯»å–PDFæ–‡ä»¶
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let allRows = [];
                let headers = null;
                
                // éå†æ‰€æœ‰é¡µé¢
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    
                    // æŒ‰Yåæ ‡åˆ†ç»„æ–‡æœ¬é¡¹ï¼ˆè¯†åˆ«è¡Œï¼‰
                    const lines = {};
                    textContent.items.forEach(item => {
                        const y = Math.round(item.transform[5]);
                        if (!lines[y]) lines[y] = [];
                        lines[y].push({
                            x: item.transform[4],
                            text: item.str.trim()
                        });
                    });
                    
                    // æ’åºå¹¶åˆå¹¶æ¯è¡Œ
                    Object.keys(lines).sort((a, b) => b - a).forEach(y => {
                        const lineItems = lines[y].sort((a, b) => a.x - b.x);
                        const lineText = lineItems.map(item => item.text).join(' ');
                        
                        // å°è¯•è¯†åˆ«è¡¨æ ¼è¡Œï¼ˆåŒ…å«æ—¥æœŸã€é‡‘é¢ç­‰ï¼‰
                        if (lineText.match(/\d{2}[/-]\d{2}[/-]\d{4}|\d{4}[/-]\d{2}[/-]\d{2}/)) {
                            // å¯èƒ½æ˜¯äº¤æ˜“è¡Œ
                            const parts = lineText.split(/\s{2,}/);
                            if (parts.length >= 3) {
                                allRows.push(parts);
                            }
                        } else if (lineText.match(/Date|Transaction|Debit|Credit|Balance/i) && !headers) {
                            // å¯èƒ½æ˜¯è¡¨å¤´
                            headers = lineText.split(/\s{2,}/);
                        }
                    });
                }
                
                // å¦‚æœæ²¡æ‰¾åˆ°è¡¨å¤´ï¼Œä½¿ç”¨é»˜è®¤è¡¨å¤´
                if (!headers || headers.length === 0) {
                    headers = ['Date', 'Description', 'Debit', 'Credit', 'Balance'];
                }
                
                // ç”ŸæˆCSVï¼ˆ100%ä¿ç•™åŸå§‹æ•°æ®ï¼Œä¸åšä»»ä½•ä¿®æ”¹ï¼‰
                let csvContent = headers.join(',') + '\n';
                allRows.forEach(row => {
                    // ä»…è¿›è¡ŒCSVæ ¼å¼è½¬ä¹‰ï¼Œå®Œå…¨ä¿ç•™åŸå§‹å†…å®¹ï¼ˆåŒ…æ‹¬ç©ºæ ¼ï¼‰
                    const cleanedRow = row.map(cell => {
                        let value = (cell || '').toString();
                        // å¦‚æœåŒ…å«é€—å·æˆ–å¼•å·ï¼Œéœ€è¦ç”¨å¼•å·åŒ…å›´ï¼ˆCSVæ ‡å‡†æ ¼å¼è¦æ±‚ï¼‰
                        if (value.includes(',') || value.includes('"')) {
                            value = '"' + value.replace(/"/g, '""') + '"';
                        }
                        return value;
                    });
                    csvContent += cleanedRow.join(',') + '\n';
                });
                
                return {
                    success: true,
                    csvContent: csvContent,
                    rowCount: allRows.length,
                    headers: headers
                };
                
            } catch (error) {
                console.error('PDFè½¬æ¢å¤±è´¥:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        async function loadFiles() {
            try {
                // ä½¿ç”¨ç»Ÿä¸€æ–‡ä»¶APIï¼ˆå·²æŒ‰created_at DESCæ’åºï¼‰
                const response = await fetch('/api/proxy/unified-files/recent?limit=50');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'åŠ è½½å¤±è´¥');
                }
                
                const files = data.files || [];
                
                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('statements-count').textContent = files.filter(f => f.module === 'bank').length;
                document.getElementById('reports-count').textContent = files.filter(f => f.module !== 'bank').length;
                
                // è®¡ç®—æ€»å¤§å°
                const totalSizeMB = files.reduce((sum, f) => sum + (f.file_size_kb || 0), 0) / 1024;
                document.getElementById('total-size').textContent = totalSizeMB.toFixed(2) + ' MB';
                
                // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                const filesList = document.getElementById('files-list');
                
                if (files.length === 0) {
                    filesList.innerHTML = '<div class="empty">æš‚æ— æ–‡ä»¶</div>';
                    return;
                }
                
                // è®¡ç®—"æ–°æ–‡ä»¶"é˜ˆå€¼ï¼ˆ5åˆ†é’Ÿå†…ä¸Šä¼ çš„æ–‡ä»¶ï¼‰
                const now = new Date();
                const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>æ¨¡å—</th>
                                <th>æ–‡ä»¶å</th>
                                <th>çŠ¶æ€</th>
                                <th>å¤§å°(KB)</th>
                                <th>ä¸Šä¼ è€…</th>
                                <th>ä¸Šä¼ æ—¶é—´</th>
                                <th>æ¥æº</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                files.forEach(file => {
                    // åˆ¤æ–­æ˜¯å¦ä¸ºæ–°æ–‡ä»¶
                    const uploadedAt = new Date(file.uploaded_at);
                    const isNew = uploadedAt > fiveMinutesAgo;
                    const rowClass = isNew ? 'new-file-row' : '';
                    
                    // çŠ¶æ€æ ‡ç­¾
                    const status = file.status || 'active';
                    const statusClass = `status-${status}`;
                    const statusText = {
                        'active': 'âœ… æ´»è·ƒ',
                        'processing': 'â³ å¤„ç†ä¸­',
                        'failed': 'âŒ å¤±è´¥',
                        'archived': 'ğŸ“¦ å½’æ¡£'
                    }[status] || status;
                    
                    // éªŒè¯çŠ¶æ€
                    const validationStatus = file.validation_status || 'pending';
                    const validationBadge = {
                        'passed': 'âœ“ é€šè¿‡',
                        'failed': 'âœ— å¤±è´¥',
                        'pending': 'â‹¯ å¾…éªŒè¯'
                    }[validationStatus] || validationStatus;
                    
                    // æ¨¡å—å›¾æ ‡
                    const moduleIcon = {
                        'bank': 'ğŸ¦',
                        'receipt': 'ğŸ§¾',
                        'ctos': 'ğŸ“Š',
                        'loan': 'ğŸ’°',
                        'accounting': 'ğŸ“'
                    }[file.module] || 'ğŸ“';
                    
                    // æ¥æºå¼•æ“
                    const fromEngine = file.from_engine || 'unknown';
                    const engineBadge = fromEngine === 'flask' ? 'ğŸ Flask' : 'âš¡ FastAPI';
                    
                    // æ–°æ–‡ä»¶æ ‡è®°
                    const newBadge = isNew ? '<span style="color: #FF007F; font-weight: bold; margin-left: 8px;">ğŸ†• NEW</span>' : '';
                    
                    html += `
                        <tr class="${rowClass}">
                            <td>${moduleIcon} ${file.module}</td>
                            <td>${file.file_name}${newBadge}</td>
                            <td>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                                <span class="status-badge" style="background: #322446;">${validationBadge}</span>
                            </td>
                            <td>${(file.file_size_kb || 0).toFixed(2)}</td>
                            <td>${file.uploaded_by || 'system'}</td>
                            <td>${new Date(file.uploaded_at).toLocaleString('zh-CN')}</td>
                            <td>${engineBadge}</td>
                            <td>
                                <button onclick="viewFileDetail(${file.file_id})" class="btn btn-primary btn-small">ğŸ‘ï¸ è¯¦æƒ…</button>
                                <button onclick="updateFileStatus(${file.file_id}, '${status}')" class="btn btn-secondary btn-small">âœï¸  çŠ¶æ€</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                filesList.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                document.getElementById('files-list').innerHTML = 
                    `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function downloadFile(filePath, companyId) {
            // ä½¿ç”¨queryå‚æ•°ä¼ é€’file_pathå’Œæ­£ç¡®çš„company_id
            const url = `/api/proxy/files/download?company_id=${companyId}&file_path=${encodeURIComponent(filePath)}`;
            window.location.href = url;
        }
        
        async function deleteFile(filePath, filename, companyId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const url = `/api/proxy/files/delete?company_id=${companyId}&file_path=${encodeURIComponent(filePath)}`;
                const response = await fetch(url, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    if (window.Toast) {
                        Toast.success('æ–‡ä»¶å·²åˆ é™¤');
                    } else {
                        alert('æ–‡ä»¶å·²åˆ é™¤');
                    }
                    refreshFiles();
                } else {
                    if (window.Toast) {
                        Toast.error('åˆ é™¤å¤±è´¥');
                    } else {
                        alert('åˆ é™¤å¤±è´¥');
                    }
                }
            } catch (error) {
                if (window.Toast) {
                    Toast.error('åˆ é™¤å¤±è´¥: ' + error.message);
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                }
            }
        }
        
        function refreshFiles() {
            document.getElementById('files-list').innerHTML = '<div class="loading">æ­£åœ¨åˆ·æ–°...</div>';
            loadFiles();
        }
        
        // æŸ¥çœ‹æ–‡ä»¶è¯¦æƒ…
        async function viewFileDetail(fileId) {
            const modal = document.getElementById('fileModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modal.style.display = 'block';
            modalTitle.textContent = `ğŸ“„ æ–‡ä»¶è¯¦æƒ… #${fileId}`;
            modalBody.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ–‡ä»¶è¯¦æƒ…...</div>';
            
            try {
                const response = await fetch(`/api/proxy/unified-files/detail/${fileId}`);
                const data = await response.json();
                
                if (data.status !== 'found') {
                    throw new Error(data.message || 'æ–‡ä»¶ä¸å­˜åœ¨');
                }
                
                const file = data.file;
                const html = `
                    <div style="color: #fff; line-height: 2;">
                        <h3 style="color: #FF007F; border-bottom: 2px solid #322446; padding-bottom: 10px; margin-bottom: 20px;">
                            ${file.file_name}
                        </h3>
                        <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px;">
                            <div style="color: #999;">æ–‡ä»¶ID:</div>
                            <div>${file.file_id}</div>
                            
                            <div style="color: #999;">æ¨¡å—:</div>
                            <div>${file.module}</div>
                            
                            <div style="color: #999;">çŠ¶æ€:</div>
                            <div>
                                <span class="status-badge status-${file.file_status}">${file.file_status}</span>
                                <span class="status-badge" style="background: #322446;">${file.validation_status || 'pending'}</span>
                            </div>
                            
                            <div style="color: #999;">æ–‡ä»¶è·¯å¾„:</div>
                            <div style="word-break: break-all;">${file.storage_path}</div>
                            
                            <div style="color: #999;">æ–‡ä»¶å¤§å°:</div>
                            <div>${(file.file_size_kb || 0).toFixed(2)} KB</div>
                            
                            <div style="color: #999;">ä¸Šä¼ è€…:</div>
                            <div>${file.uploaded_by}</div>
                            
                            <div style="color: #999;">ä¸Šä¼ æ—¶é—´:</div>
                            <div>${new Date(file.uploaded_at).toLocaleString('zh-CN')}</div>
                            
                            <div style="color: #999;">æ¥æºå¼•æ“:</div>
                            <div>${file.from_engine === 'flask' ? 'ğŸ Flask' : 'âš¡ FastAPI'}</div>
                        </div>
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #322446;">
                            <button onclick="closeModal()" class="btn btn-primary">å…³é—­</button>
                        </div>
                    </div>
                `;
                modalBody.innerHTML = html;
                
            } catch (error) {
                modalBody.innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ›´æ–°æ–‡ä»¶çŠ¶æ€
        async function updateFileStatus(fileId, currentStatus) {
            const newStatus = prompt(`å½“å‰çŠ¶æ€: ${currentStatus}\n\nè¯·è¾“å…¥æ–°çŠ¶æ€ (active/processing/failed/archived):`, currentStatus);
            
            if (!newStatus || newStatus === currentStatus) {
                return;
            }
            
            const validStatuses = ['active', 'processing', 'failed', 'archived'];
            if (!validStatuses.includes(newStatus)) {
                if (window.Toast) {
                    Toast.error('æ— æ•ˆçš„çŠ¶æ€å€¼ï¼');
                } else {
                    alert('æ— æ•ˆçš„çŠ¶æ€å€¼ï¼');
                }
                return;
            }
            
            const validationStatus = prompt('è¯·è¾“å…¥éªŒè¯çŠ¶æ€ (passed/failed/pending):', 'pending');
            
            try {
                const response = await fetch(`/api/proxy/unified-files/status/${fileId}?status=${newStatus}&validation_status=${validationStatus}`, {
                    method: 'PATCH'
                });
                const data = await response.json();
                
                if (data.success) {
                    if (window.Toast) {
                        Toast.success('çŠ¶æ€æ›´æ–°æˆåŠŸï¼');
                    } else {
                        alert('çŠ¶æ€æ›´æ–°æˆåŠŸï¼');
                    }
                    refreshFiles();
                } else {
                    throw new Error(data.message || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                if (window.Toast) {
                    Toast.error('æ›´æ–°å¤±è´¥: ' + error.message);
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + error.message);
                }
            }
        }
        
        async function viewFile(filePath, filename, companyId) {
            const modal = document.getElementById('fileModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modal.style.display = 'block';
            modalTitle.textContent = `ğŸ“„ ${filename}`;
            modalBody.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ–‡ä»¶å†…å®¹...</div>';
            
            try {
                const url = `/api/proxy/files/view?company_id=${companyId}&file_path=${encodeURIComponent(filePath)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.format === 'csv') {
                    // CSVæ–‡ä»¶ï¼šæ˜¾ç¤ºè¡¨æ ¼
                    let html = `
                        <div style="color: #0f0; margin-bottom: 1rem;">
                            ğŸ“Š CSVæ•°æ® | æ€»è¡Œæ•°: ${data.row_count} | åˆ—æ•°: ${data.headers.length}
                        </div>
                        <table class="csv-table">
                            <thead>
                                <tr>
                    `;
                    
                    // è¡¨å¤´
                    data.headers.forEach(header => {
                        html += `<th>${header}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    
                    // æ•°æ®è¡Œ
                    data.rows.forEach((row, idx) => {
                        html += '<tr>';
                        data.headers.forEach(header => {
                            html += `<td>${row[header] || ''}</td>`;
                        });
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    modalBody.innerHTML = html;
                    
                } else {
                    // æ–‡æœ¬æ–‡ä»¶ï¼šæ˜¾ç¤ºåŸå§‹å†…å®¹
                    modalBody.innerHTML = `
                        <div style="color: #0f0; margin-bottom: 1rem;">
                            ğŸ“ æ–‡æœ¬å†…å®¹ | æ€»è¡Œæ•°: ${data.line_count}
                        </div>
                        <div class="file-viewer" style="color: #0f0;">
                            ${data.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                        </div>
                    `;
                }
                
            } catch (error) {
                modalBody.innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function closeModal() {
            document.getElementById('fileModal').style.display = 'none';
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('fileModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹ï¼šæ”¯æŒCSVå’ŒPDF
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.pdf')) {
                if (window.Toast) {
                    Toast.error('è¯·ä¸Šä¼ CSVæˆ–PDFæ ¼å¼çš„é“¶è¡Œæœˆç»“å•æ–‡ä»¶');
                } else {
                    alert('è¯·ä¸Šä¼ CSVæˆ–PDFæ ¼å¼çš„é“¶è¡Œæœˆç»“å•æ–‡ä»¶');
                }
                return;
            }
            
            const filesList = document.getElementById('files-list');
            let uploadFile = file;
            
            // å¦‚æœæ˜¯PDFæ–‡ä»¶ï¼Œå…ˆè½¬æ¢ä¸ºCSVï¼ˆå®Œå…¨ä¿ç•™åŸå§‹æ•°æ®ï¼‰
            if (fileName.endsWith('.pdf')) {
                filesList.innerHTML = `<div class="loading">ğŸ”„ æ­£åœ¨å°†PDFè½¬æ¢ä¸ºCSVæ ¼å¼...</div>`;
                
                const conversionResult = await convertPDFToCSV(file);
                
                if (!conversionResult.success) {
                    const errorMsg = `PDFè½¬æ¢å¤±è´¥: ${conversionResult.error}ã€‚å»ºè®®ï¼š1. ç¡®ä¿PDFæ˜¯æ–‡æœ¬æ ¼å¼ï¼ˆéæ‰«æä»¶ï¼‰ 2. æˆ–ç›´æ¥ä»ç½‘é“¶ä¸‹è½½CSVæ ¼å¼æœˆç»“å•`;
                    if (window.Toast) {
                        Toast.error(errorMsg);
                    } else {
                        alert('âŒ ' + errorMsg);
                    }
                    loadFiles();
                    event.target.value = '';
                    return;
                }
                
                // åˆ›å»ºCSV Fileå¯¹è±¡ï¼ˆ100%ä¿ç•™åŸå§‹æ•°æ®ï¼‰
                const csvBlob = new Blob([conversionResult.csvContent], { type: 'text/csv' });
                uploadFile = new File([csvBlob], fileName.replace('.pdf', '.csv'), { type: 'text/csv' });
                
                filesList.innerHTML = `<div class="loading">âœ… PDFå·²è½¬æ¢ä¸ºCSV (${conversionResult.rowCount}è¡Œ)\nğŸ“¤ æ­£åœ¨æ™ºèƒ½åˆ†æå¹¶ä¸Šä¼ ...</div>`;
            } else {
                filesList.innerHTML = `<div class="loading">ğŸ“¤ æ­£åœ¨æ™ºèƒ½åˆ†æCSVæ–‡ä»¶å¹¶ä¸Šä¼ ...</div>`;
            }
            
            // ç»Ÿä¸€ä¸Šä¼ æµç¨‹ï¼ˆCSVå’ŒPDFè½¬æ¢åçš„CSVä½¿ç”¨ç›¸åŒéªŒè¯æœºåˆ¶ï¼‰
            const formData = new FormData();
            formData.append('file', uploadFile);
            
            try {
                const response = await fetch('/api/proxy/files/smart-upload?company_id={{ company_id }}', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const successMsg = `ä¸Šä¼ æˆåŠŸï¼${result.identified_info.bank_name} - ${result.identified_info.statement_month} | å¯¼å…¥ ${result.imported} ç¬”äº¤æ˜“ï¼Œè‡ªåŠ¨åŒ¹é… ${result.matched} ç¬”`;
                    
                    if (window.Toast) {
                        Toast.success(successMsg);
                    }
                    
                    // ç«‹å³åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°æ–‡ä»¶
                    window.location.reload();
                } else {
                    // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                    let errorMessage = `ä¸Šä¼ å¤±è´¥ï¼š${result.message}`;
                    
                    if (result.analysis && result.analysis.analysis) {
                        errorMessage += ` | åˆ†æ: ${result.analysis.analysis.join(', ')}`;
                    }
                    
                    if (result.suggestion) {
                        errorMessage += ` | å»ºè®®: ${result.suggestion}`;
                    }
                    
                    if (window.Toast) {
                        Toast.error(errorMessage);
                    } else {
                        alert('âŒ ' + errorMessage);
                    }
                    loadFiles();
                }
            } catch (error) {
                if (window.Toast) {
                    Toast.error(`ä¸Šä¼ å¤±è´¥: ${error.message}`);
                } else {
                    alert(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`);
                }
                loadFiles();
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ–‡ä»¶åˆ—è¡¨
        loadFiles();
    </script>
</body>
</html>
