<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ç®¡ç† - ä¼šè®¡ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #FF007F;
            margin-bottom: 1rem;
            font-size: 2.5rem;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #FF007F;
            color: white;
        }
        
        .btn-primary:hover {
            background: #cc0066;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #322446;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a3668;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #322446;
        }
        
        .stat-label {
            color: #999;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            color: #FF007F;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .files-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 2rem;
            border: 2px solid #322446;
        }
        
        .section-title {
            color: #FF007F;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #322446;
            padding-bottom: 0.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        
        th {
            background: #322446;
            color: #fff;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #333;
        }
        
        tr:hover {
            background: #2d2d2d;
        }
        
        .file-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .type-statement {
            background: #322446;
            color: #fff;
        }
        
        .type-report {
            background: #FF007F;
            color: #fff;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            margin: 0 4px;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        
        .empty {
            text-align: center;
            padding: 3rem;
            color: #666;
            font-size: 1.2rem;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            overflow: auto;
        }
        
        .modal-content {
            background: #1a1a1a;
            margin: 2% auto;
            padding: 2rem;
            border: 2px solid #FF007F;
            border-radius: 12px;
            width: 90%;
            max-width: 1400px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #322446;
        }
        
        .modal-title {
            color: #FF007F;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .close {
            color: #999;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close:hover {
            color: #FF007F;
        }
        
        .file-viewer {
            background: #000;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #322446;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .csv-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .csv-table th {
            background: #FF007F;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .csv-table td {
            padding: 8px;
            border-bottom: 1px solid #333;
            color: #fff;
        }
        
        .csv-table tr:hover {
            background: #2d2d2d;
        }
    </style>
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æ–‡ä»¶ç®¡ç†ä¸­å¿ƒ</h1>
        
        <div class="header-actions">
            <a href="/" class="btn btn-secondary">â† è¿”å›é¦–é¡µ</a>
            <button onclick="document.getElementById('fileUpload').click()" class="btn btn-primary">ğŸ“¤ æ™ºèƒ½ä¸Šä¼ CSV/PDF</button>
            <button onclick="refreshFiles()" class="btn btn-primary">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            <a href="/accounting_test_results" class="btn btn-primary">ğŸ§ª è¿è¡Œæ–°æµ‹è¯•</a>
        </div>
        
        <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
        <input type="file" id="fileUpload" accept=".csv,.pdf" style="display: none;" onchange="handleFileUpload(event)">
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-label">ğŸ“Š æœˆç»“å•æ–‡ä»¶</div>
                <div class="stat-value" id="statements-count">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ“ æµ‹è¯•æŠ¥å‘Š</div>
                <div class="stat-value" id="reports-count">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ’¾ æ€»å­˜å‚¨ç©ºé—´</div>
                <div class="stat-value" id="total-size">-- MB</div>
            </div>
        </div>
        
        <div class="files-section">
            <h2 class="section-title">ğŸ“‚ æ‰€æœ‰æ–‡ä»¶</h2>
            <div id="files-list" class="loading">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</div>
        </div>
    </div>
    
    <!-- æ–‡ä»¶æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="fileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">æ–‡ä»¶æŸ¥çœ‹</div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody" class="file-viewer">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>
    
    <!-- PDFè½¬CSVé¢„è§ˆéªŒè¯æ¨¡æ€æ¡† -->
    <div id="pdfPreviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">âš ï¸ PDFè½¬CSVç»“æœéªŒè¯ï¼ˆå¿…é¡»äººå·¥ç¡®è®¤ï¼‰</div>
                <span class="close" onclick="closePDFPreview()">&times;</span>
            </div>
            <div style="background: #2d2d2d; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h3 style="color: #FF007F; margin-bottom: 1rem;">ğŸ” æ•°æ®å®Œæ•´æ€§éªŒè¯</h3>
                <div style="color: #fff; line-height: 1.8;">
                    <p><strong style="color: #FF007F;">â— é‡è¦æç¤ºï¼š</strong>PDFè½¬CSVæ˜¯è‡ªåŠ¨è½¬æ¢ï¼Œ<strong>å¿…é¡»100%éªŒè¯å‡†ç¡®æ€§</strong></p>
                    <p>â€¢ <strong>æ£€æŸ¥äº‹é¡¹ï¼š</strong>æ— åˆ å‡ã€æ— æ·»åŠ ã€æ— æ›´æ”¹</p>
                    <p>â€¢ <strong>éªŒè¯æ–¹æ³•ï¼š</strong>å¯¹æ¯”ä¸‹æ–¹é¢„è§ˆè¡¨æ ¼ä¸åŸPDFæ–‡ä»¶</p>
                    <p>â€¢ <strong>å»ºè®®æ“ä½œï¼š</strong>ç‚¹å‡»"ä¸‹è½½CSV"ç”¨Excelæ‰“å¼€éªŒè¯</p>
                    <p>â€¢ <strong>ç¡®è®¤åï¼š</strong>ç‚¹å‡»"ç¡®è®¤ä¸Šä¼ "æ‰ä¼šå¯¼å…¥ç³»ç»Ÿ</p>
                </div>
            </div>
            
            <div style="background: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div>
                        <span style="color: #999;">ğŸ“„ åŸæ–‡ä»¶ï¼š</span>
                        <span style="color: #FF007F; font-weight: bold;" id="previewOriginalFile">--</span>
                    </div>
                    <div>
                        <span style="color: #999;">ğŸ“Š è¯†åˆ«è¡Œæ•°ï¼š</span>
                        <span style="color: #FF007F; font-weight: bold;" id="previewRowCount">--</span>
                    </div>
                    <div>
                        <span style="color: #999;">ğŸ“‹ è¯†åˆ«åˆ—æ•°ï¼š</span>
                        <span style="color: #FF007F; font-weight: bold;" id="previewColCount">--</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <button onclick="downloadConvertedCSV()" class="btn btn-primary">ğŸ“¥ ä¸‹è½½CSVæ–‡ä»¶ï¼ˆä¾›äººå·¥éªŒè¯ï¼‰</button>
            </div>
            
            <div style="max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem; border: 2px solid #322446; border-radius: 8px;">
                <table class="csv-table" id="previewTable">
                    <thead id="previewTableHeader"></thead>
                    <tbody id="previewTableBody"></tbody>
                </table>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button onclick="confirmUploadCSV()" class="btn btn-primary" style="font-size: 1.2rem; padding: 16px 32px;">âœ… æˆ‘å·²éªŒè¯ï¼Œç¡®è®¤ä¸Šä¼ </button>
                <button onclick="closePDFPreview()" class="btn btn-secondary" style="font-size: 1.2rem; padding: 16px 32px;">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡å­˜å‚¨è½¬æ¢ç»“æœ
        let convertedCSVData = null;
        let originalPDFName = null;
        
        // PDFè½¬CSVæ ¸å¿ƒå‡½æ•°
        async function convertPDFToCSV(file) {
            try {
                // è¯»å–PDFæ–‡ä»¶
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let allRows = [];
                let headers = null;
                
                // éå†æ‰€æœ‰é¡µé¢
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    
                    // æŒ‰Yåæ ‡åˆ†ç»„æ–‡æœ¬é¡¹ï¼ˆè¯†åˆ«è¡Œï¼‰
                    const lines = {};
                    textContent.items.forEach(item => {
                        const y = Math.round(item.transform[5]);
                        if (!lines[y]) lines[y] = [];
                        lines[y].push({
                            x: item.transform[4],
                            text: item.str.trim()
                        });
                    });
                    
                    // æ’åºå¹¶åˆå¹¶æ¯è¡Œ
                    Object.keys(lines).sort((a, b) => b - a).forEach(y => {
                        const lineItems = lines[y].sort((a, b) => a.x - b.x);
                        const lineText = lineItems.map(item => item.text).join(' ');
                        
                        // å°è¯•è¯†åˆ«è¡¨æ ¼è¡Œï¼ˆåŒ…å«æ—¥æœŸã€é‡‘é¢ç­‰ï¼‰
                        if (lineText.match(/\d{2}[/-]\d{2}[/-]\d{4}|\d{4}[/-]\d{2}[/-]\d{2}/)) {
                            // å¯èƒ½æ˜¯äº¤æ˜“è¡Œ
                            const parts = lineText.split(/\s{2,}/);
                            if (parts.length >= 3) {
                                allRows.push(parts);
                            }
                        } else if (lineText.match(/Date|Transaction|Debit|Credit|Balance/i) && !headers) {
                            // å¯èƒ½æ˜¯è¡¨å¤´
                            headers = lineText.split(/\s{2,}/);
                        }
                    });
                }
                
                // å¦‚æœæ²¡æ‰¾åˆ°è¡¨å¤´ï¼Œä½¿ç”¨é»˜è®¤è¡¨å¤´
                if (!headers || headers.length === 0) {
                    headers = ['Date', 'Description', 'Debit', 'Credit', 'Balance'];
                }
                
                // ç”ŸæˆCSV
                let csvContent = headers.join(',') + '\n';
                allRows.forEach(row => {
                    // æ¸…ç†å¹¶è½¬ä¹‰CSVå­—æ®µ
                    const cleanedRow = row.map(cell => {
                        let cleaned = (cell || '').toString().trim();
                        // ç§»é™¤Excelå…¬å¼å‰ç¼€
                        cleaned = cleaned.replace(/^=+/, '');
                        // å¦‚æœåŒ…å«é€—å·æˆ–å¼•å·ï¼Œéœ€è¦ç”¨å¼•å·åŒ…å›´
                        if (cleaned.includes(',') || cleaned.includes('"')) {
                            cleaned = '"' + cleaned.replace(/"/g, '""') + '"';
                        }
                        return cleaned;
                    });
                    csvContent += cleanedRow.join(',') + '\n';
                });
                
                return {
                    success: true,
                    csvContent: csvContent,
                    rowCount: allRows.length,
                    headers: headers
                };
                
            } catch (error) {
                console.error('PDFè½¬æ¢å¤±è´¥:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        async function loadFiles() {
            try {
                const response = await fetch('/api/proxy/files/list');
                const data = await response.json();
                
                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('statements-count').textContent = data.statements_count;
                document.getElementById('reports-count').textContent = data.reports_count;
                
                // è·å–å­˜å‚¨ä¿¡æ¯
                const storageResponse = await fetch('/api/proxy/files/storage-info');
                const storageData = await storageResponse.json();
                document.getElementById('total-size').textContent = storageData.total_size_mb + ' MB';
                
                // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                const filesList = document.getElementById('files-list');
                
                if (data.files.length === 0) {
                    filesList.innerHTML = '<div class="empty">æš‚æ— æ–‡ä»¶</div>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ç±»å‹</th>
                                <th>æ–‡ä»¶å</th>
                                <th>å¤§å°</th>
                                <th>ä¿®æ”¹æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.files.forEach(file => {
                    const typeClass = file.type === 'bank_statement' ? 'type-statement' : 'type-report';
                    const typeName = file.type === 'bank_statement' ? 'ğŸ“Š æœˆç»“å•' : 'ğŸ“ æŠ¥å‘Š';
                    
                    html += `
                        <tr>
                            <td><span class="file-type ${typeClass}">${typeName}</span></td>
                            <td>${file.filename}</td>
                            <td>${file.size_mb} MB</td>
                            <td>${file.modified_at}</td>
                            <td>
                                <button onclick="viewFile('${file.type}', '${file.filename}')" class="btn btn-primary btn-small">ğŸ‘ï¸ æŸ¥çœ‹</button>
                                <button onclick="downloadFile('${file.type}', '${file.filename}')" class="btn btn-primary btn-small">ğŸ“¥ ä¸‹è½½</button>
                                <button onclick="deleteFile('${file.type}', '${file.filename}')" class="btn btn-secondary btn-small">ğŸ—‘ï¸ åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                filesList.innerHTML = html;
                
            } catch (error) {
                document.getElementById('files-list').innerHTML = 
                    `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function downloadFile(type, filename) {
            window.location.href = `/api/proxy/files/download/${type}/${filename}`;
        }
        
        async function deleteFile(type, filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/proxy/files/delete/${type}/${filename}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('æ–‡ä»¶å·²åˆ é™¤');
                    refreshFiles();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        function refreshFiles() {
            document.getElementById('files-list').innerHTML = '<div class="loading">æ­£åœ¨åˆ·æ–°...</div>';
            loadFiles();
        }
        
        async function viewFile(type, filename) {
            const modal = document.getElementById('fileModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modal.style.display = 'block';
            modalTitle.textContent = `ğŸ“„ ${filename}`;
            modalBody.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ–‡ä»¶å†…å®¹...</div>';
            
            try {
                const response = await fetch(`/api/proxy/files/view/${type}/${filename}`);
                const data = await response.json();
                
                if (data.format === 'csv') {
                    // CSVæ–‡ä»¶ï¼šæ˜¾ç¤ºè¡¨æ ¼
                    let html = `
                        <div style="color: #0f0; margin-bottom: 1rem;">
                            ğŸ“Š CSVæ•°æ® | æ€»è¡Œæ•°: ${data.row_count} | åˆ—æ•°: ${data.headers.length}
                        </div>
                        <table class="csv-table">
                            <thead>
                                <tr>
                    `;
                    
                    // è¡¨å¤´
                    data.headers.forEach(header => {
                        html += `<th>${header}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    
                    // æ•°æ®è¡Œ
                    data.rows.forEach((row, idx) => {
                        html += '<tr>';
                        data.headers.forEach(header => {
                            html += `<td>${row[header] || ''}</td>`;
                        });
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    modalBody.innerHTML = html;
                    
                } else {
                    // æ–‡æœ¬æ–‡ä»¶ï¼šæ˜¾ç¤ºåŸå§‹å†…å®¹
                    modalBody.innerHTML = `
                        <div style="color: #0f0; margin-bottom: 1rem;">
                            ğŸ“ æ–‡æœ¬å†…å®¹ | æ€»è¡Œæ•°: ${data.line_count}
                        </div>
                        <div class="file-viewer" style="color: #0f0;">
                            ${data.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                        </div>
                    `;
                }
                
            } catch (error) {
                modalBody.innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        function closeModal() {
            document.getElementById('fileModal').style.display = 'none';
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('fileModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹ï¼šæ”¯æŒCSVå’ŒPDF
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.pdf')) {
                alert('è¯·ä¸Šä¼ CSVæˆ–PDFæ ¼å¼çš„é“¶è¡Œæœˆç»“å•æ–‡ä»¶');
                return;
            }
            
            const filesList = document.getElementById('files-list');
            
            // å¦‚æœæ˜¯PDFæ–‡ä»¶ï¼Œå…ˆè½¬æ¢ä¸ºCSVå¹¶æ˜¾ç¤ºé¢„è§ˆ
            if (fileName.endsWith('.pdf')) {
                filesList.innerHTML = `<div class="loading">ğŸ”„ æ­£åœ¨å°†PDFè½¬æ¢ä¸ºCSVæ ¼å¼...</div>`;
                
                const conversionResult = await convertPDFToCSV(file);
                
                if (!conversionResult.success) {
                    alert(`âŒ PDFè½¬æ¢å¤±è´¥: ${conversionResult.error}\n\nå»ºè®®ï¼š\n1. ç¡®ä¿PDFæ˜¯æ–‡æœ¬æ ¼å¼ï¼ˆéæ‰«æä»¶ï¼‰\n2. æˆ–ç›´æ¥ä»ç½‘é“¶ä¸‹è½½CSVæ ¼å¼æœˆç»“å•`);
                    loadFiles();
                    event.target.value = '';
                    return;
                }
                
                // å­˜å‚¨è½¬æ¢ç»“æœåˆ°å…¨å±€å˜é‡
                originalPDFName = file.name;
                convertedCSVData = conversionResult;
                
                // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†ä¾›ç”¨æˆ·éªŒè¯
                showPDFPreview(conversionResult, file.name);
                
                // æ¢å¤æ–‡ä»¶åˆ—è¡¨
                loadFiles();
            } else {
                // CSVæ–‡ä»¶ç›´æ¥ä¸Šä¼ 
                filesList.innerHTML = `<div class="loading">ğŸ“¤ æ­£åœ¨æ™ºèƒ½åˆ†æCSVæ–‡ä»¶å¹¶ä¸Šä¼ ...</div>`;
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/api/proxy/files/smart-upload?company_id=1', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        let message = `âœ… ${result.message}\n\n`;
                        message += `ğŸ“Š æ™ºèƒ½è¯†åˆ«ç»“æœï¼š\n`;
                        message += `â€¢ é“¶è¡Œ: ${result.identified_info.bank_name}\n`;
                        message += `â€¢ è´¦å·: ${result.identified_info.account_number}\n`;
                        message += `â€¢ æœˆä»½: ${result.identified_info.statement_month}\n`;
                        message += `â€¢ å¯¼å…¥äº¤æ˜“: ${result.imported} ç¬”\n`;
                        message += `â€¢ è‡ªåŠ¨åŒ¹é…: ${result.matched} ç¬”\n\n`;
                        message += `ğŸ“ æ–‡ä»¶å·²ä¿å­˜è‡³:\n${result.file_saved}`;
                        
                        alert(message);
                        refreshFiles();
                    } else {
                        alert(`âŒ ä¸Šä¼ å¤±è´¥ï¼š${result.message}`);
                        loadFiles();
                    }
                } catch (error) {
                    alert(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`);
                    loadFiles();
                }
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }
        
        // æ˜¾ç¤ºPDFè½¬CSVé¢„è§ˆæ¨¡æ€æ¡†
        function showPDFPreview(conversionResult, originalFileName) {
            const modal = document.getElementById('pdfPreviewModal');
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('previewOriginalFile').textContent = originalFileName;
            document.getElementById('previewRowCount').textContent = conversionResult.rowCount;
            document.getElementById('previewColCount').textContent = conversionResult.headers.length;
            
            // ç”Ÿæˆé¢„è§ˆè¡¨æ ¼
            const headerRow = document.getElementById('previewTableHeader');
            const bodyRows = document.getElementById('previewTableBody');
            
            // æ¸…ç©º
            headerRow.innerHTML = '';
            bodyRows.innerHTML = '';
            
            // æ·»åŠ è¡¨å¤´
            let headerHTML = '<tr>';
            conversionResult.headers.forEach(header => {
                headerHTML += `<th>${header}</th>`;
            });
            headerHTML += '</tr>';
            headerRow.innerHTML = headerHTML;
            
            // è§£æCSVå†…å®¹å¹¶æ˜¾ç¤º
            const csvLines = conversionResult.csvContent.split('\n');
            for (let i = 1; i < csvLines.length; i++) {
                const line = csvLines[i].trim();
                if (!line) continue;
                
                const cells = parseCSVLine(line);
                let rowHTML = '<tr>';
                cells.forEach(cell => {
                    rowHTML += `<td>${cell}</td>`;
                });
                rowHTML += '</tr>';
                bodyRows.innerHTML += rowHTML;
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'block';
        }
        
        // ç®€å•CSVè¡Œè§£æï¼ˆå¤„ç†å¼•å·ï¼‰
        function parseCSVLine(line) {
            const cells = [];
            let currentCell = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    cells.push(currentCell);
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            cells.push(currentCell);
            
            return cells;
        }
        
        // ä¸‹è½½è½¬æ¢åçš„CSVæ–‡ä»¶
        function downloadConvertedCSV() {
            if (!convertedCSVData) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„CSVæ•°æ®');
                return;
            }
            
            const blob = new Blob([convertedCSVData.csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', originalPDFName.replace('.pdf', '_è½¬æ¢.csv'));
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ç¡®è®¤ä¸Šä¼ CSV
        async function confirmUploadCSV() {
            if (!convertedCSVData) {
                alert('æ²¡æœ‰å¯ä¸Šä¼ çš„CSVæ•°æ®');
                return;
            }
            
            const filesList = document.getElementById('files-list');
            filesList.innerHTML = `<div class="loading">âœ… éªŒè¯é€šè¿‡\nğŸ“¤ æ­£åœ¨ä¸Šä¼ åˆ°ç³»ç»Ÿ...</div>`;
            
            // å…³é—­æ¨¡æ€æ¡†
            closePDFPreview();
            
            // åˆ›å»ºCSV Fileå¯¹è±¡
            const csvBlob = new Blob([convertedCSVData.csvContent], { type: 'text/csv' });
            const csvFile = new File([csvBlob], originalPDFName.replace('.pdf', '.csv'), { type: 'text/csv' });
            
            const formData = new FormData();
            formData.append('file', csvFile);
            
            try {
                const response = await fetch('/api/proxy/files/smart-upload?company_id=1', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = `âœ… ${result.message}\n\n`;
                    message += `ğŸ“Š æ™ºèƒ½è¯†åˆ«ç»“æœï¼š\n`;
                    message += `â€¢ é“¶è¡Œ: ${result.identified_info.bank_name}\n`;
                    message += `â€¢ è´¦å·: ${result.identified_info.account_number}\n`;
                    message += `â€¢ æœˆä»½: ${result.identified_info.statement_month}\n`;
                    message += `â€¢ å¯¼å…¥äº¤æ˜“: ${result.imported} ç¬”\n`;
                    message += `â€¢ è‡ªåŠ¨åŒ¹é…: ${result.matched} ç¬”\n\n`;
                    message += `ğŸ“ æ–‡ä»¶å·²ä¿å­˜è‡³:\n${result.file_saved}`;
                    message += `\n\nğŸ’¡ æç¤º: PDFå·²é€šè¿‡äººå·¥éªŒè¯åè½¬æ¢å¯¼å…¥`;
                    
                    alert(message);
                    refreshFiles();
                } else {
                    alert(`âŒ ä¸Šä¼ å¤±è´¥ï¼š${result.message}`);
                    loadFiles();
                }
            } catch (error) {
                alert(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`);
                loadFiles();
            }
            
            // æ¸…ç©ºå…¨å±€å˜é‡
            convertedCSVData = null;
            originalPDFName = null;
        }
        
        // å…³é—­PDFé¢„è§ˆæ¨¡æ€æ¡†
        function closePDFPreview() {
            document.getElementById('pdfPreviewModal').style.display = 'none';
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ–‡ä»¶åˆ—è¡¨
        loadFiles();
    </script>
</body>
</html>
