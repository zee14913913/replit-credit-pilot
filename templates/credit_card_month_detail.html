{% extends "base.html" %}

{% block title %}{{ data.year_month }} 月度详情 - {{ data.customer.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="bi bi-calendar-check"></i> 
                {{ data.customer.name }} - {{ data.year_month }} 月度详细账单
            </h2>
            <p class="text-muted">
                <i class="bi bi-info-circle"></i> 
                完整的计算过程和原始凭证
            </p>
        </div>
        <div>
            <a href="{{ url_for('browse_credit_card_excel_files', customer_id=data.customer.id) }}" 
               class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> 返回文件浏览
            </a>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- 第一部分：月度汇总统计 -->
    <!-- ============================================================ -->
    <div class="card calculation-card mb-4">
        <div class="card-header calculation-header">
            <h5><i class="bi bi-calculator"></i> 月度汇总统计</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-bordered detail-table">
                        <thead>
                            <tr>
                                <th colspan="2" class="text-center bg-gradient-pink">基本信息</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="fw-bold">银行数量</td>
                                <td>{{ data.statistics.bank_count }} 家银行</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">交易总数</td>
                                <td>{{ data.statistics.total_transactions }} 笔</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-bordered detail-table">
                        <thead>
                            <tr>
                                <th colspan="2" class="text-center bg-gradient-pink">余额信息</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="fw-bold">上月余额</td>
                                <td class="amount-positive">RM {{ "%.2f"|format(data.statistics.total_previous_balance) }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">本月余额</td>
                                <td class="amount-positive">RM {{ "%.2f"|format(data.statistics.total_closing_balance) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- 第二部分：双账本分类 (OWNER vs INFINITE GZ) -->
    <!-- ============================================================ -->
    <div class="card calculation-card mb-4">
        <div class="card-header calculation-header">
            <h5><i class="bi bi-diagram-3"></i> 双账本分类 (OWNER vs INFINITE GZ)</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- OWNER 账本 -->
                <div class="col-md-6">
                    <h6 class="section-subtitle">
                        <i class="bi bi-person-circle text-info"></i> OWNER 账本
                    </h6>
                    <table class="table table-bordered detail-table">
                        <thead>
                            <tr>
                                <th>项目</th>
                                <th class="text-end">金额 (RM)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>OWNER 消费 (Expenses)</strong></td>
                                <td class="text-end amount-negative">{{ "%.2f"|format(data.statistics.total_owner_expenses) }}</td>
                            </tr>
                            <tr>
                                <td><strong>OWNER 付款 (Payments)</strong></td>
                                <td class="text-end amount-positive">{{ "%.2f"|format(data.statistics.total_owner_payments) }}</td>
                            </tr>
                            <tr class="table-danger">
                                <td><strong>1% 刷卡机费用 (Card Processing Fee)</strong></td>
                                <td class="text-end amount-fee">{{ "%.2f"|format(data.statistics.card_processing_fee) }}</td>
                            </tr>
                            <tr class="table-warning">
                                <td><strong>OWNER 应付总额 (Total Due)</strong></td>
                                <td class="text-end fw-bold amount-negative">
                                    {{ "%.2f"|format(data.statistics.owner_outstanding_balance) }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="alert alert-info mt-2">
                        <i class="bi bi-info-circle"></i>
                        <small>
                            <strong>说明：</strong>刷卡机费用是银行征收的1%手续费，由客户OWNER承担。<br>
                            <strong>应付总额 = OWNER消费 + 1%刷卡机费用 - OWNER付款</strong>
                        </small>
                    </div>
                </div>

                <!-- INFINITE GZ 账本 -->
                <div class="col-md-6">
                    <h6 class="section-subtitle">
                        <i class="bi bi-building text-warning"></i> INFINITE GZ 账本
                    </h6>
                    <table class="table table-bordered detail-table">
                        <thead>
                            <tr>
                                <th>项目</th>
                                <th class="text-end">金额 (RM)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>GZ 消费 (Supplier刷卡)</strong></td>
                                <td class="text-end amount-negative">{{ "%.2f"|format(data.statistics.total_gz_expenses) }}</td>
                            </tr>
                            <tr>
                                <td><strong>GZ 付款 (Payments)</strong></td>
                                <td class="text-end amount-positive">{{ "%.2f"|format(data.statistics.total_gz_payments) }}</td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>GZ 应付余额 (Outstanding)</strong></td>
                                <td class="text-end fw-bold">
                                    {{ "%.2f"|format(data.statistics.gz_outstanding_balance) }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="alert alert-warning mt-2">
                        <i class="bi bi-exclamation-triangle"></i>
                        <small>
                            <strong>注意：</strong>GZ应付余额不包含1%刷卡机费用（该费用由OWNER承担）。<br>
                            <strong>GZ应付 = GZ消费 - GZ付款</strong>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- 第三部分：银行账单明细 -->
    <!-- ============================================================ -->
    <div class="card calculation-card mb-4">
        <div class="card-header calculation-header">
            <h5><i class="bi bi-bank2"></i> 各银行账单明细</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered detail-table">
                    <thead>
                        <tr class="bg-gradient-purple">
                            <th>银行</th>
                            <th class="text-end">上月余额</th>
                            <th class="text-end">本月余额</th>
                            <th class="text-end">Owner 消费</th>
                            <th class="text-end">Owner 付款</th>
                            <th class="text-end">GZ 消费</th>
                            <th class="text-end">GZ 付款</th>
                            <th class="text-center">交易数</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stmt in data.monthly_statements %}
                        <tr>
                            <td class="fw-bold">{{ stmt.bank_name }}</td>
                            <td class="text-end">{{ "%.2f"|format(stmt.previous_balance) }}</td>
                            <td class="text-end">{{ "%.2f"|format(stmt.closing_balance) }}</td>
                            <td class="text-end amount-negative">{{ "%.2f"|format(stmt.owner_expenses) }}</td>
                            <td class="text-end amount-positive">{{ "%.2f"|format(stmt.owner_payments) }}</td>
                            <td class="text-end amount-negative">{{ "%.2f"|format(stmt.gz_expenses) }}</td>
                            <td class="text-end amount-positive">{{ "%.2f"|format(stmt.gz_payments) }}</td>
                            <td class="text-center">{{ stmt.transaction_count }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-secondary fw-bold">
                            <td>合计</td>
                            <td class="text-end">{{ "%.2f"|format(data.statistics.total_previous_balance) }}</td>
                            <td class="text-end">{{ "%.2f"|format(data.statistics.total_closing_balance) }}</td>
                            <td class="text-end amount-negative">{{ "%.2f"|format(data.statistics.total_owner_expenses) }}</td>
                            <td class="text-end amount-positive">{{ "%.2f"|format(data.statistics.total_owner_payments) }}</td>
                            <td class="text-end amount-negative">{{ "%.2f"|format(data.statistics.total_gz_expenses) }}</td>
                            <td class="text-end amount-positive">{{ "%.2f"|format(data.statistics.total_gz_payments) }}</td>
                            <td class="text-center">{{ data.statistics.total_transactions }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- 第四部分：30+ 分类统计 -->
    <!-- ============================================================ -->
    <div class="card calculation-card mb-4">
        <div class="card-header calculation-header">
            <h5><i class="bi bi-tags"></i> 交易分类统计（30+ 分类）</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered detail-table">
                    <thead>
                        <tr class="bg-gradient-pink">
                            <th>分类名称</th>
                            <th class="text-center">交易笔数</th>
                            <th class="text-end">总金额 (RM)</th>
                            <th class="text-center">占比</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set total_amount = data.transactions|sum(attribute='amount') %}
                        {% for category, stats in data.statistics.category_breakdown.items()|sort(attribute='1.total_amount', reverse=True) %}
                        <tr>
                            <td><strong>{{ category }}</strong></td>
                            <td class="text-center">{{ stats.count }}</td>
                            <td class="text-end">{{ "%.2f"|format(stats.total_amount) }}</td>
                            <td class="text-center">
                                {% set percentage = (stats.total_amount / total_amount * 100) if total_amount > 0 else 0 %}
                                <span class="badge bg-info">{{ "%.1f"|format(percentage) }}%</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- 第五部分：7 家 Supplier 明细 -->
    <!-- ============================================================ -->
    {% if data.supplier_breakdown %}
    <div class="card calculation-card mb-4">
        <div class="card-header calculation-header">
            <h5><i class="bi bi-building-fill-check"></i> Supplier 明细（7 家公司）</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for supplier, info in data.supplier_breakdown.items() %}
                <div class="col-md-6 mb-3">
                    <div class="supplier-card">
                        <div class="supplier-header">
                            <i class="bi bi-shop"></i>
                            <strong>{{ supplier }}</strong>
                        </div>
                        <div class="supplier-stats">
                            <div class="row">
                                <div class="col-6">
                                    <div class="stat-label">交易笔数</div>
                                    <div class="stat-value">{{ info.count }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-label">总金额</div>
                                    <div class="stat-value">RM {{ "%.2f"|format(info.total_amount) }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ============================================================ -->
    <!-- 新增：按银行分组的交易明细（可编辑）- Mac VBA 92%准确度需手动修正 -->
    <!-- ============================================================ -->
    {% for bank in data.bank_groups %}
    <div class="card calculation-card mb-4 bank-section">
        <div class="card-header" style="background: linear-gradient(135deg, #FF007F 0%, #322446 100%); color: white; border-bottom: 3px solid #FF007F;">
            <h5 class="mb-0">
                <i class="bi bi-bank2"></i> 
                {{ bank.bank_name }} - 交易明细（共 {{ bank.transactions|length }} 笔）
            </h5>
        </div>
        <div class="card-body">
            <!-- 提示信息 -->
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Mac VBA 92%准确度：</strong>请对照下方的原始PDF账单，检查并修正交易记录的8%差错。您可以直接编辑表格、添加遗漏交易或删除错误行。
            </div>
            
            <!-- 操作按钮 -->
            <div class="mb-3 text-end">
                <button type="button" class="btn btn-success btn-sm add-bank-row-btn" data-bank="{{ bank.bank_name }}">
                    <i class="bi bi-plus-circle"></i> 添加行
                </button>
                <button type="button" class="btn btn-warning btn-sm save-bank-btn" data-bank="{{ bank.bank_name }}">
                    <i class="bi bi-save"></i> 保存此银行的修改
                </button>
            </div>
            
            <!-- 可编辑交易表格 -->
            <div class="table-responsive">
                <table class="table table-bordered editable-table bank-transactions-table" data-bank="{{ bank.bank_name }}">
                    <thead>
                        <tr class="bg-gradient-purple">
                            <th style="width: 5%">#</th>
                            <th style="width: 15%">交易日期</th>
                            <th style="width: 35%">描述</th>
                            <th style="width: 12%">金额 (RM)</th>
                            <th style="width: 18%">分类</th>
                            <th style="width: 10%">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in bank.transactions %}
                        <tr data-transaction-id="{{ txn.id }}" data-bank="{{ bank.bank_name }}">
                            <td class="text-center">{{ loop.index }}</td>
                            <td>
                                <input type="date" class="form-control form-control-sm editable-field" 
                                       data-field="transaction_date" value="{{ txn.transaction_date }}">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm editable-field" 
                                       data-field="description" value="{{ txn.description }}">
                            </td>
                            <td>
                                <input type="number" step="0.01" class="form-control form-control-sm editable-field" 
                                       data-field="amount" value="{{ txn.amount }}">
                            </td>
                            <td>
                                <select class="form-select form-select-sm editable-field" data-field="category">
                                    <option value="{{ txn.category }}" selected>{{ txn.category }}</option>
                                    <option value="OWNER_EXPENSE">OWNER_EXPENSE</option>
                                    <option value="OWNER_PAYMENT">OWNER_PAYMENT</option>
                                    <option value="GZ_EXPENSE">GZ_EXPENSE</option>
                                    <option value="GZ_PAYMENT">GZ_PAYMENT</option>
                                    <option value="DINING">DINING</option>
                                    <option value="GROCERIES">GROCERIES</option>
                                    <option value="TRANSPORT">TRANSPORT</option>
                                    <option value="UTILITIES">UTILITIES</option>
                                    <option value="SHOPPING">SHOPPING</option>
                                    <option value="HEALTHCARE">HEALTHCARE</option>
                                    <option value="ENTERTAINMENT">ENTERTAINMENT</option>
                                    <option value="TRAVEL">TRAVEL</option>
                                    <option value="FUEL">FUEL</option>
                                    <option value="PARKING">PARKING</option>
                                    <option value="INSURANCE">INSURANCE</option>
                                    <option value="TELCO">TELCO</option>
                                    <option value="SUPPLIER_7SL">SUPPLIER_7SL</option>
                                    <option value="SUPPLIER_DINAS">SUPPLIER_DINAS</option>
                                    <option value="SUPPLIER_RAUB_SYC">SUPPLIER_RAUB_SYC</option>
                                    <option value="SUPPLIER_AI_SMART">SUPPLIER_AI_SMART</option>
                                    <option value="SUPPLIER_HUAWEI">SUPPLIER_HUAWEI</option>
                                    <option value="SUPPLIER_PASAR_RAYA">SUPPLIER_PASAR_RAYA</option>
                                    <option value="SUPPLIER_PUCHONG_HERBS">SUPPLIER_PUCHONG_HERBS</option>
                                    <option value="UNCATEGORIZED">UNCATEGORIZED</option>
                                </select>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm delete-row-btn" title="删除此行">
                                    <i class="bi bi-dash-circle"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 原始PDF凭证（供核对使用） -->
            <div class="mt-4">
                <h6 class="text-primary">
                    <i class="bi bi-file-pdf"></i> 原始PDF账单（用于核对上方交易的准确性）
                </h6>
                <hr>
                
                {% if bank.credit_card_pdfs %}
                <div class="mb-3">
                    <strong>信用卡账单：</strong>
                    <div class="row mt-2">
                        {% for pdf in bank.credit_card_pdfs %}
                        <div class="col-md-6 mb-2">
                            <div class="pdf-card">
                                <div class="pdf-icon">
                                    <i class="bi bi-file-pdf-fill text-danger"></i>
                                </div>
                                <div class="pdf-info">
                                    <div class="pdf-name">{{ pdf.filename }}</div>
                                    <div class="pdf-meta">{{ pdf.size_mb }} MB</div>
                                </div>
                                <div class="pdf-actions">
                                    <a href="/{{ pdf.path }}" class="btn btn-sm btn-outline-danger" target="_blank">
                                        <i class="bi bi-download"></i> 查看
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 未找到该银行的原始PDF账单
                </div>
                {% endif %}
                
                {% if bank.bank_statement_pdf %}
                <div class="mb-3">
                    <strong>GZ Bank List（银行流水）：</strong>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <div class="pdf-card">
                                <div class="pdf-icon">
                                    <i class="bi bi-file-pdf-fill text-success"></i>
                                </div>
                                <div class="pdf-info">
                                    <div class="pdf-name">{{ bank.bank_statement_pdf.filename }}</div>
                                    <div class="pdf-meta">{{ bank.bank_statement_pdf.size_mb }} MB</div>
                                </div>
                                <div class="pdf-actions">
                                    <a href="/{{ bank.bank_statement_pdf.path }}" class="btn btn-sm btn-outline-success" target="_blank">
                                        <i class="bi bi-download"></i> 查看
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}

</div>

<!-- 自定义样式 -->
<style>
.calculation-card {
    border: 2px solid #322446;
    border-radius: 12px;
    overflow: hidden;
}

.calculation-header {
    background: linear-gradient(135deg, #FF007F 0%, #322446 100%);
    color: white;
    border-bottom: 3px solid #FF007F;
    padding: 16px 20px;
}

.calculation-header h5 {
    margin: 0;
    font-weight: 600;
}

.detail-table {
    margin-bottom: 0;
}

.detail-table th {
    background-color: #322446;
    color: white;
    font-weight: 600;
    padding: 16px 18px;
    border: 1px solid #444;
}

.detail-table td {
    padding: 14px 18px;
    border: 1px solid #ddd;
}

.detail-table tbody tr:hover {
    background-color: rgba(255, 0, 127, 0.05);
}

.bg-gradient-pink {
    background: linear-gradient(135deg, #FF007F 0%, #ff3399 100%) !important;
    color: white !important;
}

.bg-gradient-purple {
    background: linear-gradient(135deg, #322446 0%, #553377 100%) !important;
    color: white !important;
}

.amount-positive {
    color: #28a745;
    font-weight: 600;
}

.amount-negative {
    color: #dc3545;
    font-weight: 600;
}

.amount-fee {
    color: #FF007F;
    font-weight: 600;
}

.section-subtitle {
    color: #322446;
    border-bottom: 2px solid #FF007F;
    padding-bottom: 8px;
    margin-bottom: 16px;
}

.supplier-card {
    border: 2px solid #322446;
    border-radius: 8px;
    overflow: hidden;
}

.supplier-header {
    background: linear-gradient(135deg, #322446 0%, #553377 100%);
    color: white;
    padding: 12px 16px;
    font-weight: 600;
}

.supplier-stats {
    padding: 16px;
    background: #f8f9fa;
}

.stat-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 18px;
    font-weight: 700;
    color: #FF007F;
}

.pdf-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    border: 2px solid #dc3545;
    border-radius: 8px;
    background: white;
}

.pdf-icon i {
    font-size: 42px;
}

.pdf-info {
    flex: 1;
}

.pdf-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
}

.pdf-meta {
    font-size: 13px;
    color: #666;
}

.pdf-actions {
    display: flex;
    gap: 8px;
}

.editable-table input, 
.editable-table select {
    border: 1px solid #ddd;
}

.editable-table input:focus, 
.editable-table select:focus {
    border-color: #FF007F;
    box-shadow: 0 0 0 0.2rem rgba(255, 0, 127, 0.25);
}

.editable-table tbody tr.new-row {
    background-color: #e7f3ff;
}

.editable-table tbody tr.modified-row {
    background-color: #fff3cd;
}

.editable-table tbody tr.deleted-row {
    background-color: #f8d7da;
    text-decoration: line-through;
    opacity: 0.6;
}
</style>

<script>
// 全局变量
let customerId = {{ data.customer.id }};
let yearMonth = '{{ data.year_month }}';
let nextNewId = -1; // 新行使用负数ID

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 为每个银行的"添加行"按钮绑定事件
    document.querySelectorAll('.add-bank-row-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const bankName = this.getAttribute('data-bank');
            addNewRowToBank(bankName);
        });
    });
    
    // 为每个银行的"保存"按钮绑定事件
    document.querySelectorAll('.save-bank-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const bankName = this.getAttribute('data-bank');
            saveBankChanges(bankName);
        });
    });
    
    // 删除行按钮（全局委托事件）
    document.body.addEventListener('click', function(e) {
        if (e.target.closest('.delete-row-btn')) {
            deleteRow(e.target.closest('.delete-row-btn'));
        }
    });
    
    // 监听输入变化，标记已修改行
    document.querySelectorAll('.bank-transactions-table').forEach(table => {
        table.addEventListener('input', function(e) {
            if (e.target.classList.contains('editable-field')) {
                const row = e.target.closest('tr');
                if (!row.classList.contains('new-row')) {
                    row.classList.add('modified-row');
                }
            }
        });
    });
});

// 为指定银行添加新行
function addNewRowToBank(bankName) {
    const table = document.querySelector(`.bank-transactions-table[data-bank="${bankName}"]`);
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const rowCount = tbody.querySelectorAll('tr').length + 1;
    const today = new Date().toISOString().split('T')[0];
    
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-transaction-id', nextNewId);
    newRow.setAttribute('data-bank', bankName);
    newRow.classList.add('new-row');
    
    newRow.innerHTML = `
        <td class="text-center">${rowCount}</td>
        <td>
            <input type="date" class="form-control form-control-sm editable-field" 
                   data-field="transaction_date" value="${today}">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm editable-field" 
                   data-field="description" value="" placeholder="交易描述">
        </td>
        <td>
            <input type="number" step="0.01" class="form-control form-control-sm editable-field" 
                   data-field="amount" value="0.00">
        </td>
        <td>
            <select class="form-select form-select-sm editable-field" data-field="category">
                <option value="UNCATEGORIZED" selected>UNCATEGORIZED</option>
                <option value="OWNER_EXPENSE">OWNER_EXPENSE</option>
                <option value="OWNER_PAYMENT">OWNER_PAYMENT</option>
                <option value="GZ_EXPENSE">GZ_EXPENSE</option>
                <option value="GZ_PAYMENT">GZ_PAYMENT</option>
                <option value="DINING">DINING</option>
                <option value="GROCERIES">GROCERIES</option>
                <option value="TRANSPORT">TRANSPORT</option>
                <option value="UTILITIES">UTILITIES</option>
                <option value="SHOPPING">SHOPPING</option>
                <option value="HEALTHCARE">HEALTHCARE</option>
                <option value="ENTERTAINMENT">ENTERTAINMENT</option>
                <option value="TRAVEL">TRAVEL</option>
                <option value="FUEL">FUEL</option>
                <option value="PARKING">PARKING</option>
                <option value="INSURANCE">INSURANCE</option>
                <option value="TELCO">TELCO</option>
                <option value="SUPPLIER_7SL">SUPPLIER_7SL</option>
                <option value="SUPPLIER_DINAS">SUPPLIER_DINAS</option>
                <option value="SUPPLIER_RAUB_SYC">SUPPLIER_RAUB_SYC</option>
                <option value="SUPPLIER_AI_SMART">SUPPLIER_AI_SMART</option>
                <option value="SUPPLIER_HUAWEI">SUPPLIER_HUAWEI</option>
                <option value="SUPPLIER_PASAR_RAYA">SUPPLIER_PASAR_RAYA</option>
                <option value="SUPPLIER_PUCHONG_HERBS">SUPPLIER_PUCHONG_HERBS</option>
            </select>
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-danger btn-sm delete-row-btn" title="删除此行">
                <i class="bi bi-dash-circle"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(newRow);
    nextNewId--;
    
    // 提示
    showToast('success', `已为 ${bankName} 添加新行，请填写内容后保存`);
}

// 删除行
function deleteRow(btn) {
    const row = btn.closest('tr');
    const txnId = row.getAttribute('data-transaction-id');
    
    if (confirm('确定要删除这条交易记录吗？')) {
        // 如果是新添加的行（负数ID），直接删除
        if (parseInt(txnId) < 0) {
            row.remove();
            renumberRows();
        } else {
            // 如果是已存在的行，标记为删除
            row.classList.add('deleted-row');
        }
        showToast('warning', '已标记删除，请点击"保存修改"确认');
    }
}

// 保存指定银行的更改
async function saveBankChanges(bankName) {
    const table = document.querySelector(`.bank-transactions-table[data-bank="${bankName}"]`);
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr[data-transaction-id]');
    
    const changes = {
        customer_id: customerId,
        year_month: yearMonth,
        bank_name: bankName,
        updated: [],
        deleted: [],
        created: []
    };
    
    rows.forEach(row => {
        const txnId = parseInt(row.getAttribute('data-transaction-id'));
        
        // 已删除的行
        if (row.classList.contains('deleted-row')) {
            if (txnId > 0) {  // 只删除已存在的行
                changes.deleted.push(txnId);
            }
            return;
        }
        
        // 收集行数据
        const rowData = {
            transaction_date: row.querySelector('[data-field="transaction_date"]').value,
            bank_name: bankName,
            description: row.querySelector('[data-field="description"]').value,
            amount: parseFloat(row.querySelector('[data-field="amount"]').value),
            category: row.querySelector('[data-field="category"]').value
        };
        
        // 新添加的行
        if (txnId < 0) {
            changes.created.push(rowData);
        }
        // 已修改的行
        else if (row.classList.contains('modified-row')) {
            changes.updated.push({
                id: txnId,
                ...rowData
            });
        }
    });
    
    // 检查是否有更改
    if (changes.updated.length === 0 && changes.deleted.length === 0 && changes.created.length === 0) {
        showToast('info', `${bankName} 没有需要保存的更改`);
        return;
    }
    
    // 发送到后端
    const saveBtn = document.querySelector(`.save-bank-btn[data-bank="${bankName}"]`);
    try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 保存中...';
        
        const response = await fetch('/credit-card/transactions/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(changes)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showToast('success', `${bankName} 保存成功！更新 ${result.updated_count} 条，删除 ${result.deleted_count} 条，新增 ${result.created_count} 条`);
            // 刷新页面以显示最新数据
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast('error', `${bankName} 保存失败：` + (result.message || '未知错误'));
        }
    } catch (error) {
        showToast('error', `${bankName} 保存失败：` + error.message);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-save"></i> 保存此银行的修改';
    }
}

// Toast提示
function showToast(type, message) {
    const colors = {
        success: '#28a745',
        error: '#dc3545',
        warning: '#ffc107',
        info: '#17a2b8'
    };
    
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || '#333'};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 9999;
        font-size: 14px;
        max-width: 400px;
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

{% endblock %}
