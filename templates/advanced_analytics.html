{% extends "base.html" %}

{% block title %}{{ t('__advanced_analytics') }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="gradient-text">
                <i class="bi bi-graph-up-arrow"></i>
                <span data-i18n="advanced_financial_analytics">{{ t('advanced_financial_analytics') }}</span>
            </h1>
            <p class="text-secondary">
                <span data-i18n="ai_powered_financial_health">{{ t('ai_powered_financial_health') }}</span>
            </p>
        </div>
    </div>

    <!-- 财务健康评分卡 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h3 class="text-secondary">
                        <span data-i18n="financial_health_score">{{ t('financial_health_score') }}</span>
                    </h3>
                    <div class="display-1 my-4 
                        {% if health_score.total_score >= 80 %}text-success
                        {% elif health_score.total_score >= 60 %}text-warning
                        {% else %}text-danger{% endif %}">
                        {{ health_score.total_score }}
                    </div>
                    <h4>
                        <span class="badge bg-{{ health_score.rating.color }}">
                            {{ health_score.rating.grade }} - {{ health_score.rating.label }}
                        </span>
                    </h4>
                </div>
            </div>
        </div>

        <!-- 客户等级 -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h3 class="text-secondary">
                        <span data-i18n="customer_tier">{{ t('customer_tier') }}</span>
                    </h3>
                    <div class="display-3 my-4">
                        {% if tier_info.current_tier == 'Platinum' %}
                            <i class="bi bi-gem text-info"></i>
                        {% elif tier_info.current_tier == 'Gold' %}
                            <i class="bi bi-star-fill text-warning"></i>
                        {% else %}
                            <i class="bi bi-shield-fill text-secondary"></i>
                        {% endif %}
                    </div>
                    <h4>{{ tier_info.current_tier }}</h4>
                    {% if tier_info.fee_discount > 0 %}
                    <p class="text-success">
                        <i class="bi bi-tag-fill"></i>
                        {{ (tier_info.fee_discount * 100)|int }}% <span data-i18n="fee_discount">{{ t('fee_discount') }}</span>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 异常警告 -->
        <div class="col-md-4">
            <div class="card shadow-sm border-{{ 'danger' if anomalies.critical_count > 0 else ('warning' if anomalies.warning_count > 0 else 'success') }}">
                <div class="card-body text-center">
                    <h3 class="text-secondary">
                        <span data-i18n="anomaly_detection">{{ t('anomaly_detection') }}</span>
                    </h3>
                    <div class="display-4 my-4 text-{{ 'danger' if anomalies.critical_count > 0 else ('warning' if anomalies.warning_count > 0 else 'success') }}">
                        <i class="bi bi-{% if anomalies.total_anomalies > 0 %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
                    </div>
                    <h4>
                        {{ anomalies.total_anomalies }}
                        <span data-i18n="anomalies">{{ t('anomalies') }}</span>
                    </h4>
                    {% if anomalies.critical_count > 0 %}
                    <p class="text-danger mb-0">
                        <i class="bi bi-exclamation-circle-fill"></i>
                        {{ anomalies.critical_count }} <span data-i18n="critical">{{ t('critical') }}</span>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 现金流预测图表 -->
    {% if cashflow_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4>
                        <i class="bi bi-graph-up"></i>
                        <span data-i18n="cashflow_prediction_12_months">{{ t('cashflow_prediction_12_months') }}</span>
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>
                            <span data-i18n="optimization_benefit">{{ t('optimization_benefit') }}</span>
                        </strong>
                        RM {{ cashflow_data.comparison.total_improvement|abs }}
                        ({{ cashflow_data.comparison.improvement_percentage|abs }}%)
                    </div>
                    <canvas id="cashflowChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 评分明细 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4>
                        <i class="bi bi-clipboard-data"></i>
                        <span data-i18n="score_breakdown">{{ t('score_breakdown') }}</span>
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for dimension, score in health_score.score_breakdown.items() %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                {% if dimension == 'payment_timeliness' %}
                                    <span data-i18n="payment_timeliness">{{ t('payment_timeliness') }}</span>
                                {% elif dimension == 'dsr' %}
                                    <span data-i18n="dsr_1">{{ t('dsr_1') }}</span>
                                {% elif dimension == 'utilization' %}
                                    <span data-i18n="utilization_rate">{{ t('utilization_rate') }}</span>
                                {% elif dimension == 'category_health' %}
                                    <span data-i18n="category_health">{{ t('category_health') }}</span>
                                {% else %}
                                    <span data-i18n="financial_stability">{{ t('financial_stability') }}</span>
                                {% endif %}
                            </label>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-{{ 'success' if score >= 80 else ('warning' if score >= 60 else 'danger') }}" 
                                     role="progressbar" 
                                     style="width: {{ score }}%"
                                     aria-valuenow="{{ score }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ score }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 优化建议 -->
    {% if health_score.optimization_suggestions %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4>
                        <i class="bi bi-lightbulb"></i>
                        <span data-i18n="optimization_suggestions">{{ t('optimization_suggestions') }}</span>
                    </h4>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for suggestion in health_score.optimization_suggestions %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ suggestion.area }}</h5>
                                {% if suggestion.potential_saving > 0 %}
                                <span class="badge bg-success">
                                    <span data-i18n="save">{{ t('save') }}</span> RM {{ suggestion.potential_saving }}
                                </span>
                                {% endif %}
                            </div>
                            <p class="mb-1">{{ suggestion.suggestion }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 个性化推荐 -->
    {% if recommendations.recommendations %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4>
                        <i class="bi bi-stars"></i>
                        <span data-i18n="personalized_recommendations">{{ t('personalized_recommendations') }}</span>
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for rec in recommendations.recommendations %}
                        <div class="col-md-6 mb-3">
                            <div class="card border-{{ 'primary' if rec.priority == 'high' else 'secondary' }}">
                                <div class="card-body">
                                    <h5 class="card-title">{{ rec.title }}</h5>
                                    <p class="card-text">{{ rec.description }}</p>
                                    {% if rec.potential_saving > 0 %}
                                    <p class="text-success mb-2">
                                        <i class="bi bi-piggy-bank"></i>
                                        <span data-i18n="potential_saving">{{ t('potential_saving') }}</span>
                                        RM {{ rec.potential_saving }}
                                    </p>
                                    {% endif %}
                                    <button class="btn-white-glow" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                        <i class="bi bi-arrow-right-circle"></i> {{ rec.action }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 异常列表 -->
    {% if anomalies.anomalies %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-danger">
                <div class="card-header bg-danger text-white">
                    <h4>
                        <i class="bi bi-exclamation-triangle"></i>
                        <span data-i18n="detected_anomalies">{{ t('detected_anomalies') }}</span>
                    </h4>
                </div>
                <div class="card-body">
                    {% for anomaly in anomalies.anomalies %}
                    <div class="alert alert-{{ 'danger' if anomaly.severity == 'critical' else 'warning' }}">
                        <h5>
                            <i class="bi bi-{{ 'exclamation-circle-fill' if anomaly.severity == 'critical' else 'exclamation-triangle' }}"></i>
                            {{ anomaly.title }}
                        </h5>
                        <p>{{ anomaly.description }}</p>
                        <p class="mb-0">
                            <strong><span data-i18n="action_required">{{ t('action_required') }}</span></strong>
                            {{ anomaly.action_required }}
                        </p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 等级权益 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4>
                        <i class="bi bi-award"></i>
                        {{ tier_info.current_tier }} <span data-i18n="tier_benefits">{{ t('tier_benefits') }}</span>
                    </h4>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for benefit in tier_info.tier_benefits %}
                        <li class="list-group-item">
                            <i class="bi bi-check-circle-fill text-success"></i>
                            {{ benefit }}
                        </li>
                        {% endfor %}
                    </ul>

                    {% if tier_info.next_tier_requirements %}
                    <div class="mt-4">
                        <h5>
                            <span data-i18n="upgrade_to">{{ t('upgrade_to') }}</span>
                            {{ tier_info.next_tier_requirements.next_tier }}
                        </h5>
                        <p class="text-secondary">
                            <span data-i18n="estimated">{{ t('estimated') }}</span>
                            {{ tier_info.next_tier_requirements.estimated_months_to_upgrade }}
                            <span data-i18n="months_to_upgrade">{{ t('months_to_upgrade') }}</span>
                        </p>
                        {% for gap in tier_info.next_tier_requirements.gaps %}
                        <div class="mb-2">
                            <small>{{ gap.metric }}: {{ gap.current }} → {{ gap.required }}</small>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" 
                                     style="width: {{ (gap.current / gap.required * 100)|int }}%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
{% if cashflow_data %}
// {{ t('const_ctx__documentgetelementbyid') }}('cashflowChart');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ cashflow_data.labels|tojson }},
        datasets: {{ cashflow_data.datasets|tojson }}
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'RM ' + value.toLocaleString();
                    }
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
