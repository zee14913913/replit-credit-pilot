{% extends "layout.html" %}

{% block title %}{{ t('file_detail_title') }} - {{ file.file_name }}{% endblock %}

{% block extra_css %}
<style>
    /* {{ t('__strict_3color_palette_____btnpattern') }}-1 {
        background-color: #FF007F;
        color: white;
        font-weight: bold;
        border: 2px solid white;
        padding: 0.5rem 1.2rem;
    }
    .btn-pattern-1:hover {
        background-color: #322446;
        color: white;
    }
    
    .btn-pattern-2 {
        background-color: #322446;
        color: white;
        font-weight: bold;
        border: 2px solid white;
        padding: 0.5rem 1.2rem;
    }
    .btn-pattern-2:hover {
        background-color: #FF007F;
        color: white;
    }
    
    .btn-pattern-3 {
        background-color: #000000;
        color: white;
        font-weight: bold;
        border: 2px solid #FF007F;
        padding: 0.5rem 1.2rem;
    }
    .btn-pattern-3:hover {
        background-color: #322446;
        color: white;
    }
    
    .btn-pattern-5 {
        background-color: #FFFFFF;
        color: #FF007F;
        font-weight: bold;
        border: 2px solid #000000;
        padding: 0.5rem 1.2rem;
    }
    .btn-pattern-5:hover {
        background-color: #322446;
        color: #FFFFFF;
    }
    
    /* {{ t('badge') }} */
    .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.85rem;
    }
    
    .badge-parsed {
        background-color: #322446;
        color: white;
    }
    
    .badge-failed {
        background-color: #FF007F;
        color: white;
    }
    
    .badge-uploaded {
        background-color: #FFFFFF;
        color: #322446;
    }
    
    .badge-passed {
        background-color: #322446;
        color: white;
    }
    
    .badge-pending {
        background-color: #FFFFFF;
        color: #322446;
    }
    
    .badge-duplicate {
        background-color: #FF007F;
        color: white;
    }
    
    /* {{ t('_____alertduplicate') }} {
        background-color: white;
        color: #322446;
        border: 3px solid #FF007F;
        padding: 1.5rem;
        border-radius: 8px;
    }
    
    .alert-duplicate h5 {
        color: #FF007F;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/files/list" class="btn btn-pattern-5">
        {{ t('back_to_list') }}
    </a>
</div>

<!-- 重复月份警告 -->
{% if file.status == 'duplicate' or duplicate_warning %}
<div class="alert alert-duplicate mb-4">
    <h5>{{ t('duplicate_warning_title') }}</h5>
    <p>{{ t('duplicate_warning_text') }} <strong>{{ duplicate_count or t('fallback_na') }}</strong>{{ t('duplicate_warning_actions') }}</p>
    <ul>
        <li>{{ t('set_as_primary') }}</li>
        <li>{{ t('keep_as_backup') }}</li>
        <li>{{ t('delete_this_file') }}</li>
    </ul>
</div>
{% endif %}

<!-- 文件信息卡片 -->
<div class="card bg-dark text-white mb-4" style="border: 2px solid #322446;">
    <div class="card-header" style="background-color: #322446; border-bottom: 2px solid white;">
        <h4 style="margin: 0;">{{ t('file_information') }}</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>{{ t('file_name') }}：</strong> {{ file.file_name }}</p>
                <p><strong>{{ t('raw_document_id') }}：</strong> {{ file.id }}</p>
                <p><strong>{{ t('company_id') }}：</strong> {{ file.company_id }}</p>
                <p><strong>{{ t('file_size') }}：</strong> {{ (file.file_size / 1024) | round(2) }} KB</p>
            </div>
            <div class="col-md-6">
                <p><strong>{{ t('status') }}：</strong> 
                    <span class="badge badge-{{ file.status }}">{{ t('status_' + file.status) }}</span>
                </p>
                <p><strong>{{ t('validation_status') }}：</strong> 
                    <span class="badge badge-{{ file.validation_status }}">{{ t('validation_' + file.validation_status) }}</span>
                </p>
                <p><strong>{{ t('upload_time') }}：</strong> {{ file.created_at }}</p>
                <p><strong>{{ t('file_hash') }}：</strong> <code style="color: #aaa;">{{ file.file_hash[:16] }}...</code></p>
            </div>
        </div>
    </div>
</div>

<!-- 可执行操作区 -->
<div class="card bg-dark text-white mb-4" style="border: 2px solid #FF007F;">
    <div class="card-header" style="background-color: #FF007F; border-bottom: 2px solid white;">
        <h4 style="margin: 0;">{{ t('available_actions') }}</h4>
    </div>
    <div class="card-body">
        <!-- {{ t('phase_110_7javascript') }}） -->
        <div class="d-flex gap-2 flex-wrap" id="action-buttons-container">
            <span style="color: #999;">{{ t('loading') }}...</span>
        </div>
    </div>
</div>

<!-- 原始文件信息 -->
<div class="card bg-dark text-white" style="border: 2px solid #322446;">
    <div class="card-header" style="background-color: #322446; border-bottom: 2px solid white;">
        <h4 style="margin: 0;">{{ t('raw_file_info') }}</h4>
    </div>
    <div class="card-body">
        <p><strong>{{ t('storage_path') }}：</strong></p>
        <code style="color: #aaa; display: block; background: #000; padding: 10px; border-radius: 5px; border: 1px solid #FF007F;">
            {{ file.storage_path }}
        </code>
        
        <p class="mt-3"><strong>{{ t('module') }}：</strong> {{ file.module or t('fallback_na') }}</p>
        <p><strong>{{ t('source_engine') }}：</strong> {{ file.source_engine or t('fallback_na') }}</p>
        
        {% if raw_lines_count %}
        <p><strong>{{ t('raw_lines_count') }}：</strong> {{ raw_lines_count }} {{ t('lines') }}</p>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Phase 1-10: 7-State Machine Mapping (client-side)
const STATUS_NEXT_ACTIONS = {
    "uploaded": ["validate", "view_original"],
    "active": ["generate_report", "download_original"],
    "failed": ["view_exceptions", "reprocess", "download_original"],
    "duplicate": ["set_as_primary", "view_other_files", "download_original"],
    "validated": ["generate_report", "download_original"],
    "posted": ["view_report", "download_original"],
    "archived": ["download_original"]
};

// Action button configuration (action → {label, btnClass, handler})
const ACTION_CONFIG = {
    "validate": {
        label: "{{ t('validate_file') }}",
        btnClass: "btn-pattern-1",
        handler: "executeAction('validate')"
    },
    "view_original": {
        label: "{{ t('view_original') }}",
        btnClass: "btn-pattern-5",
        handler: "viewOriginal()"
    },
    "generate_report": {
        label: "{{ t('generate_report') }}",
        btnClass: "btn-pattern-1",
        handler: "executeAction('generate_report')"
    },
    "download_original": {
        label: "{{ t('download_original') }}",
        btnClass: "btn-pattern-5",
        handler: "downloadFile()"
    },
    "view_exceptions": {
        label: "{{ t('view_exceptions') }}",
        btnClass: "btn-pattern-2",
        handler: "viewExceptions()"
    },
    "reprocess": {
        label: "{{ t('retry_processing') }}",
        btnClass: "btn-pattern-2",
        handler: "executeAction('reprocess')"
    },
    "set_as_primary": {
        label: "{{ t('set_primary_statement') }}",
        btnClass: "btn-pattern-1",
        handler: "executeAction('set_primary')"
    },
    "view_other_files": {
        label: "{{ t('view_other_files') }}",
        btnClass: "btn-pattern-5",
        handler: "viewOtherFiles()"
    },
    "view_report": {
        label: "{{ t('view_report') }}",
        btnClass: "btn-pattern-1",
        handler: "viewReport()"
    }
};

// i18n translations for JS
const i18nStrings = {
    alertBackendNotImplemented: "{{ t('alert_backend_not_implemented') }}",
    alertFileId: "{{ t('alert_file_id') }}",
    alertDownloadFunction: "{{ t('alert_download_function') }}",
    alertDownloadEndpoint: "{{ t('alert_download_endpoint') }}",
    confirmDeleteFile: "{{ t('confirm_delete_file') }}",
    alertDeleteNotImplemented: "{{ t('alert_delete_not_implemented') }}"
};

// Dynamically render action buttons based on file status
function renderActionButtons() {
    const fileStatus = "{{ file.status }}";
    const container = document.getElementById('action-buttons-container');
    
    const nextActions = STATUS_NEXT_ACTIONS[fileStatus] || ["download_original"];
    
    let buttonsHTML = '';
    nextActions.forEach(action => {
        const config = ACTION_CONFIG[action];
        if (config) {
            buttonsHTML += `
                <button class="btn ${config.btnClass}" onclick="${config.handler}">
                    ${config.label}
                </button>
            `;
        }
    });
    
    // Always add delete button
    buttonsHTML += `
        <button class="btn btn-pattern-3" onclick="deleteFile()">
            {{ t('delete_file') }}
        </button>
    `;
    
    container.innerHTML = buttonsHTML;
}

function executeAction(action) {
    const fileId = {{ file.id }};
    alert(i18nStrings.alertBackendNotImplemented + action + i18nStrings.alertFileId + fileId);
}

function downloadFile() {
    const filePath = "{{ file.storage_path }}";
    alert(i18nStrings.alertDownloadFunction + filePath + i18nStrings.alertDownloadEndpoint);
}

function deleteFile() {
    if (confirm(i18nStrings.confirmDeleteFile)) {
        alert(i18nStrings.alertDeleteNotImplemented);
    }
}

function viewOriginal() {
    alert('查看原始文件功能待实现');
}

function viewExceptions() {
    window.location.href = '/files/exceptions/{{ file.id }}';
}

function viewOtherFiles() {
    window.location.href = '/files/list';
}

function viewReport() {
    alert('查看报表功能待实现');
}

// Initialize buttons on page load
document.addEventListener('DOMContentLoaded', function() {
    renderActionButtons();
});
</script>
{% endblock %}
