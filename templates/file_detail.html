{% extends "layout.html" %}

{% block title %}{{ t('file_detail_title') }} - {{ file.file_name }}{% endblock %}

{% block extra_css %}
<style>
    /* 按钮颜色组合模式 - STRICT 3-COLOR PALETTE */
    .btn-pattern-1 {
        background-color: #FF007F;
        color: white;
        font-weight: bold;
        border: 2px solid white;
        padding: 0.5rem 1.2rem;
    }
    .btn-pattern-1:hover {
        background-color: #322446;
        color: white;
    }
    
    .btn-pattern-2 {
        background-color: #322446;
        color: white;
        font-weight: bold;
        border: 2px solid white;
        padding: 0.5rem 1.2rem;
    }
    .btn-pattern-2:hover {
        background-color: #FF007F;
        color: white;
    }
    
    .btn-pattern-3 {
        background-color: #000000;
        color: white;
        font-weight: bold;
        border: 2px solid #FF007F;
        padding: 0.5rem 1.2rem;
    }
    .btn-pattern-3:hover {
        background-color: #322446;
        color: white;
    }
    
    .btn-pattern-5 {
        background-color: #FFFFFF;
        color: #FF007F;
        font-weight: bold;
        border: 2px solid #000000;
        padding: 0.5rem 1.2rem;
    }
    .btn-pattern-5:hover {
        background-color: #322446;
        color: #FFFFFF;
    }
    
    /* Badge颜色 */
    .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.85rem;
    }
    
    .badge-parsed {
        background-color: #322446;
        color: white;
    }
    
    .badge-failed {
        background-color: #FF007F;
        color: white;
    }
    
    .badge-uploaded {
        background-color: #FFFFFF;
        color: #322446;
    }
    
    .badge-passed {
        background-color: #322446;
        color: white;
    }
    
    .badge-pending {
        background-color: #FFFFFF;
        color: #322446;
    }
    
    .badge-duplicate {
        background-color: #FF007F;
        color: white;
    }
    
    /* 警告框 */
    .alert-duplicate {
        background-color: white;
        color: #322446;
        border: 3px solid #FF007F;
        padding: 1.5rem;
        border-radius: 8px;
    }
    
    .alert-duplicate h5 {
        color: #FF007F;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/files/list" class="btn btn-pattern-5">
        {{ t('back_to_list') }}
    </a>
</div>

<!-- 重复月份警告 -->
{% if file.status == 'duplicate' or duplicate_warning %}
<div class="alert alert-duplicate mb-4">
    <h5>{{ t('duplicate_warning_title') }}</h5>
    <p>{{ t('duplicate_warning_text') }} <strong>{{ duplicate_count or t('fallback_na') }}</strong>{{ t('duplicate_warning_actions') }}</p>
    <ul>
        <li>{{ t('set_as_primary') }}</li>
        <li>{{ t('keep_as_backup') }}</li>
        <li>{{ t('delete_this_file') }}</li>
    </ul>
</div>
{% endif %}

<!-- 文件信息卡片 -->
<div class="card bg-dark text-white mb-4" style="border: 2px solid #322446;">
    <div class="card-header" style="background-color: #322446; border-bottom: 2px solid white;">
        <h4 style="margin: 0;">{{ t('file_information') }}</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>{{ t('file_name') }}：</strong> {{ file.file_name }}</p>
                <p><strong>{{ t('raw_document_id') }}：</strong> {{ file.id }}</p>
                <p><strong>{{ t('company_id') }}：</strong> {{ file.company_id }}</p>
                <p><strong>{{ t('file_size') }}：</strong> {{ (file.file_size / 1024) | round(2) }} KB</p>
            </div>
            <div class="col-md-6">
                <p><strong>{{ t('status') }}：</strong> 
                    <span class="badge badge-{{ file.status }}">{{ t('status_' + file.status) }}</span>
                </p>
                <p><strong>{{ t('validation_status') }}：</strong> 
                    <span class="badge badge-{{ file.validation_status }}">{{ t('validation_' + file.validation_status) }}</span>
                </p>
                <p><strong>{{ t('upload_time') }}：</strong> {{ file.created_at }}</p>
                <p><strong>{{ t('file_hash') }}：</strong> <code style="color: #aaa;">{{ file.file_hash[:16] }}...</code></p>
            </div>
        </div>
    </div>
</div>

<!-- 可执行操作区 -->
<div class="card bg-dark text-white mb-4" style="border: 2px solid #FF007F;">
    <div class="card-header" style="background-color: #FF007F; border-bottom: 2px solid white;">
        <h4 style="margin: 0;">{{ t('available_actions') }}</h4>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2 flex-wrap" id="action-buttons-container">
            {% if file.status == 'uploaded' and file.validation_status == 'pending' %}
                <button class="btn btn-pattern-1" onclick="executeAction('validate')">
                    {{ t('validate_file') }}
                </button>
            {% elif file.status == 'parsed' and file.validation_status == 'passed' %}
                <button class="btn btn-pattern-1" onclick="executeAction('generate_report')">
                    {{ t('generate_report') }}
                </button>
            {% elif file.status == 'failed' or file.validation_status == 'failed' %}
                <a href="/files/exceptions/{{ file.id }}" class="btn btn-pattern-2">
                    {{ t('view_exceptions') }}
                </a>
                <button class="btn btn-pattern-2" onclick="executeAction('retry')">
                    {{ t('retry_processing') }}
                </button>
            {% elif file.status == 'duplicate' %}
                <button class="btn btn-pattern-1" onclick="executeAction('set_primary')">
                    {{ t('set_primary_statement') }}
                </button>
                <button class="btn btn-pattern-5" onclick="executeAction('keep_backup')">
                    {{ t('keep_backup') }}
                </button>
            {% endif %}
            
            <!-- 通用操作 -->
            <button class="btn btn-pattern-5" onclick="downloadFile()">
                {{ t('download_original') }}
            </button>
            <button class="btn btn-pattern-3" onclick="deleteFile()">
                {{ t('delete_file') }}
            </button>
        </div>
    </div>
</div>

<!-- 原始文件信息 -->
<div class="card bg-dark text-white" style="border: 2px solid #322446;">
    <div class="card-header" style="background-color: #322446; border-bottom: 2px solid white;">
        <h4 style="margin: 0;">{{ t('raw_file_info') }}</h4>
    </div>
    <div class="card-body">
        <p><strong>{{ t('storage_path') }}：</strong></p>
        <code style="color: #aaa; display: block; background: #000; padding: 10px; border-radius: 5px; border: 1px solid #FF007F;">
            {{ file.storage_path }}
        </code>
        
        <p class="mt-3"><strong>{{ t('module') }}：</strong> {{ file.module or t('fallback_na') }}</p>
        <p><strong>{{ t('source_engine') }}：</strong> {{ file.source_engine or t('fallback_na') }}</p>
        
        {% if raw_lines_count %}
        <p><strong>{{ t('raw_lines_count') }}：</strong> {{ raw_lines_count }} {{ t('lines') }}</p>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// i18n translations for JS
const i18nStrings = {
    alertBackendNotImplemented: "{{ t('alert_backend_not_implemented') }}",
    alertFileId: "{{ t('alert_file_id') }}",
    alertDownloadFunction: "{{ t('alert_download_function') }}",
    alertDownloadEndpoint: "{{ t('alert_download_endpoint') }}",
    confirmDeleteFile: "{{ t('confirm_delete_file') }}",
    alertDeleteNotImplemented: "{{ t('alert_delete_not_implemented') }}"
};

function executeAction(action) {
    const fileId = {{ file.id }};
    
    if (['validate', 'generate_report', 'retry', 'set_primary', 'keep_backup'].includes(action)) {
        alert(i18nStrings.alertBackendNotImplemented + action + i18nStrings.alertFileId + fileId);
        return;
    }
    
    console.log('Executing action:', action, 'for file:', fileId);
}

function downloadFile() {
    const filePath = "{{ file.storage_path }}";
    alert(i18nStrings.alertDownloadFunction + filePath + i18nStrings.alertDownloadEndpoint);
}

function deleteFile() {
    if (confirm(i18nStrings.confirmDeleteFile)) {
        alert(i18nStrings.alertDeleteNotImplemented);
    }
}
</script>
{% endblock %}
