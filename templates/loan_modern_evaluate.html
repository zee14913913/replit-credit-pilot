{% extends "base.html" %}

{% block title %}Modern Loan Evaluation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="text-center mb-5">
                <h1 class="galaxy-gradient-text mb-3">
                    <i class="bi bi-graph-up-arrow me-2"></i>Modern Loan Evaluation
                </h1>
                <p class="fs-5" style="color: #FF007F; font-weight: 700;">
                    Advanced Risk Assessment | DTI 路 FOIR 路 CCRIS Analysis
                </p>
            </div>

            <!-- Features Card -->
            <div class="galaxy-card mb-5">
                <div class="card-body">
                    <div class="section-header mb-4">
                        <h5 class="galaxy-gradient-text mb-3">
                            <i class="bi bi-stars me-2"></i>Modern Engine Features
                        </h5>
                        <div class="title-divider"></div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-calculator text-golden fs-4 me-3"></i>
                                <div>
                                    <h6 class="text-white mb-1">{{ t('dti_and_foir_analysis') }}</h6>
                                    <small class="text-silver-pearl">{{ t('debttoincome_and_fixed_obligation_to_income_ratio') }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-bar-chart-line text-golden fs-4 me-3"></i>
                                <div>
                                    <h6 class="text-white mb-1">{{ t('ccris_risk_scoring') }}</h6>
                                    <small class="text-silver-pearl">{{ t('credit_bureau_risk_bucket_classification_06') }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-trophy text-golden fs-4 me-3"></i>
                                <div>
                                    <h6 class="text-white mb-1">{{ t('ai_risk_grading') }}</h6>
                                    <small class="text-silver-pearl">{{ t('risk_grade_a1e_with_approval_probability') }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Mode Toggle -->
            <div class="galaxy-card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white mb-1">{{ t('data_collection_mode') }}</h6>
                            <small class="text-silver-pearl">{{ t('choose_how_to_provide_loan_application_data') }}</small>
                        </div>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="data_mode_toggle" id="mode_manual" value="{{ t('manual') }}" checked>
                            <label class="btn btn-outline-light" for="mode_manual">
                                <i class="bi bi-pencil-square me-1"></i>Manual Input
                            </label>
                            
                            <input type="radio" class="btn-check" name="data_mode_toggle" id="mode_auto" value="{{ t('auto') }}">
                            <label class="btn btn-outline-light" for="mode_auto">
                                <i class="bi bi-cpu me-1"></i>Auto Enrichment
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evaluation Form -->
            <div class="galaxy-card">
                <div class="card-body">
                    <div class="section-header mb-5">
                        <h5 class="galaxy-gradient-text mb-3">
                            <i class="bi bi-person-badge-fill me-2"></i>Loan Application Details
                        </h5>
                        <div class="title-divider"></div>
                    </div>
                    
                    <form id="modernLoanForm" action="/loan-evaluate/submit" method="post">
                        <input type="hidden" name="data_mode" id="data_mode_input" value="{{ t('manual') }}">
                        
                        <div class="row g-4">
                            <!-- Customer ID -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-hash me-2"></i>Customer ID
                                </label>
                                <input type="number" name="customer_id" class="form-control galaxy-input" required min="1" placeholder="{{ t('enter_customer_id') }}">
                                <small class="text-golden">
                                    <i class="bi bi-info-circle me-1"></i>System will auto-fetch income data if available
                                </small>
                            </div>

                            <!-- Monthly Income -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-cash-stack me-2"></i>Monthly Income (RM)
                                </label>
                                <input type="number" name="income" class="form-control galaxy-input" step="0.01" min="0" placeholder="{{ t('optional__autofetched_from_income_documents') }}">
                                <small class="text-silver-pearl">
                                    <i class="bi bi-lightbulb me-1"></i>Leave blank to use uploaded income documents
                                </small>
                            </div>

                            <!-- Monthly Commitment -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-credit-card-2-back me-2"></i>{{ t('monthly_debt_commitment_rm') }}<span class="text-danger">*</span>
                                </label>
                                <input type="number" name="monthly_commitment" class="form-control galaxy-input" required step="0.01" min="0" placeholder="{{ t('total_monthly_loan_repayments') }}">
                                <small class="text-golden">
                                    <i class="bi bi-shield-check me-1"></i>From CTOS report
                                </small>
                            </div>

                            <!-- CCRIS Bucket -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-bar-chart me-2"></i>CCRIS Bucket
                                </label>
                                <select name="ccris_bucket" class="form-select galaxy-input">
                                    <option value="">{{ t('autodetect') }}</option>
                                    <option value="0">{{ t('bucket_0_excellent__no_arrears') }}</option>
                                    <option value="1">{{ t('bucket_1_1_month_arrears') }}</option>
                                    <option value="2">{{ t('bucket_2_2_months_arrears') }}</option>
                                    <option value="3">{{ t('bucket_3_3_months_arrears') }}</option>
                                    <option value="4">{{ t('bucket_4_4_months_arrears') }}</option>
                                    <option value="5">{{ t('bucket_5_5_months_arrears') }}</option>
                                    <option value="6">{{ t('bucket_6_6_months_arrears') }}</option>
                                </select>
                            </div>

                            <!-- Credit Score -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-star-fill me-2"></i>Credit Score
                                </label>
                                <input type="number" name="credit_score" class="form-control galaxy-input" min="300" max="850" placeholder="{{ t('300850_optional') }}">
                                <small class="text-silver-pearl">
                                    <i class="bi bi-info-circle me-1"></i>CTOS/CCRIS score, leave blank for auto-estimate
                                </small>
                            </div>

                            <!-- Age -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-calendar-check me-2"></i>Age
                                </label>
                                <input type="number" name="age" class="form-control galaxy-input" min="18" max="100" placeholder="18-100">
                            </div>

                            <!-- Employment Years -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-briefcase me-2"></i>Employment Years
                                </label>
                                <input type="number" name="employment_years" class="form-control galaxy-input" step="0.5" min="0" placeholder="{{ t('years_in_current_employment') }}">
                            </div>

                            <!-- Job Type -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-building me-2"></i>Job Type
                                </label>
                                <select name="job_type" class="form-select galaxy-input">
                                    <option value="">{{ t('autodetect') }}</option>
                                    <option value="{{ t('permanent') }}">{{ t('permanent_employee') }}</option>
                                    <option value="{{ t('government_1') }}">{{ t('government') }}</option>
                                    <option value="{{ t('glc') }}">{{ t('glc_governmentlinked_company') }}</option>
                                    <option value="{{ t('mnc') }}">{{ t('mnc_multinational_corporation') }}</option>
                                    <option value="{{ t('sme') }}">{{ t('sme_employee') }}</option>
                                    <option value="{{ t('self_employed') }}">{{ t('selfemployed') }}</option>
                                    <option value="{{ t('contract') }}">{{ t('contract_worker') }}</option>
                                </select>
                            </div>

                            <!-- Target Bank -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-bank2 me-2"></i>Target Bank (Optional)
                                </label>
                                <input type="text" name="target_bank" class="form-control galaxy-input" placeholder="{{ t('eg_maybank_cimb_leave_blank_for_all_banks') }}">
                                <small class="text-golden">
                                    <i class="bi bi-filter me-1"></i>Filter products by specific bank
                                </small>
                            </div>

                            <!-- Submit Button -->
                            <div class="col-12 text-center pt-5 mt-4">
                                <button type="submit" class="btn btn-lg px-5 py-3 galaxy-shimmer white-glow-btn" style="font-size: 1.2rem;">
                                    <i class="bi bi-graph-up-arrow me-2"></i>
                                    Run Modern Risk Assessment
                                </button>
                                <div class="mt-3">
                                    <small class="text-silver-pearl">
                                        <i class="bi bi-shield-check me-1"></i>
                                        Powered by Malaysian Banking Standards (DTI 路 FOIR 路 CCRIS)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Back Button -->
            <div class="text-center mt-4">
                <a href="{{ url_for('loan_matcher') }}" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-2"></i>Back to Loan Matcher
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Data mode toggle handler
document.querySelectorAll('input[name="data_mode_toggle"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('data_mode_input').value = this.value;
        
        // Visual feedback
        const modeInfo = document.createElement('div');
        modeInfo.className = 'alert alert-info mt-3';
        modeInfo.innerHTML = '<i class="bi bi-info-circle me-2"></i>' + 
            (this.value === 'auto' 
                ? 'Auto mode: System will intelligently fill missing fields based on customer data and statistical models.' 
                : 'Manual mode: All fields must be provided manually.');
        
        const existingInfo = document.querySelector('.alert-info');
        if (existingInfo) existingInfo.remove();
        
        this.closest('.galaxy-card').after(modeInfo);
        setTimeout(() => modeInfo.remove(), 5000);
    });
});
</script>

<style>
.btn-check:checked + .btn-outline-light {
    background: linear-gradient(135deg, #FF007F, #D4AF37);
    color: white;
    font-weight: 700;
}
</style>
{% endblock %}
