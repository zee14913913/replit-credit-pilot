{% extends "base.html" %}

{% block title %}è´¢åŠ¡å’¨è¯¢æœåŠ¡ - {{ customer.name }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-2">ğŸ’¡ è´¢åŠ¡ä¼˜åŒ–å’¨è¯¢æœåŠ¡</h1>
            <p class="text-silver">ä¸ºæ‚¨é‡èº«å®šåˆ¶çš„ä¿¡ç”¨å¡æ¨èå’Œè´¢åŠ¡ä¼˜åŒ–æ–¹æ¡ˆ</p>
        </div>
    </div>

    <!-- Success Fee Policy Banner -->
    <div class="alert alert-success mb-4">
        <h5>ğŸ’ æˆ‘ä»¬çš„æ‰¿è¯ºï¼šæˆåŠŸæ”¶è´¹æ”¿ç­–</h5>
        <p class="mb-2"><strong>æ— æ”¶ç›Šï¼Œä¸æ”¶è´¹ï¼</strong> å¦‚æœæˆ‘ä»¬çš„ä¼˜åŒ–æ–¹æ¡ˆæœªèƒ½ä¸ºæ‚¨èŠ‚çœæˆ–èµšå–ä»»ä½•æ”¶ç›Šï¼Œæˆ‘ä»¬å°†ä¸æ”¶å–ä»»ä½•è´¹ç”¨ã€‚</p>
        <p class="mb-0"><strong>50%æ”¶ç›Šåˆ†æˆï¼š</strong> åªæœ‰å½“æˆ‘ä»¬æˆåŠŸä¸ºæ‚¨èŠ‚çœè´¹ç”¨æˆ–åˆ›é€ æ”¶ç›Šæ—¶ï¼Œæˆ‘ä»¬æ‰æ”¶å–æ€»æ”¶ç›Šçš„50%ä½œä¸ºæœåŠ¡è´¹ç”¨ã€‚</p>
    </div>

    <!-- Credit Card Recommendations -->
    <div class="row mb-5">
        <div class="col-12">
            <h3 class="mb-4">ğŸ¯ æ™ºèƒ½ä¿¡ç”¨å¡æ¨è</h3>
            <p class="text-silver mb-3">æ ¹æ®æ‚¨çš„æ¶ˆè´¹ä¹ æƒ¯ï¼Œæˆ‘ä»¬ä¸ºæ‚¨æ¨èä»¥ä¸‹ä¿¡ç”¨å¡ï¼ŒåŠ©æ‚¨è·å–æ›´å¤šç§¯åˆ†å’Œç¦åˆ©ï¼š</p>
            
            {% if card_recommendations %}
                <div class="row g-4">
                    {% for rec in card_recommendations %}
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h5 class="text-champagne">{{ rec.bank_name }} {{ rec.card_name }}</h5>
                                        <p class="mb-2">{{ rec.reasoning }}</p>
                                        <p class="text-silver mb-0">{{ rec.special_promotions }}</p>
                                    </div>
                                    <div class="col-md-4 text-md-end">
                                        <div class="badge badge-success mb-2" style="font-size: 1rem;">åŒ¹é…åº¦: {{ rec.match_score|int }}%</div>
                                        <h4 class="text-jade mb-1">RM {{ "%.2f"|format(rec.estimated_monthly_benefit) }}/æœˆ</h4>
                                        <p class="text-silver mb-0">å¹´åº¦å‡€æ”¶ç›Š: RM {{ "%.2f"|format(rec.annual_benefit) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    æ‚¨ç›®å‰ä½¿ç”¨çš„ä¿¡ç”¨å¡å·²ç»å¾ˆé€‚åˆæ‚¨çš„æ¶ˆè´¹ä¹ æƒ¯ã€‚ç»§ç»­ä¿æŒï¼
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Financial Optimization Suggestions -->
    <div class="row mb-5">
        <div class="col-12">
            <h3 class="mb-4">ğŸ’° è´¢åŠ¡ä¼˜åŒ–å»ºè®®</h3>
            <p class="text-silver mb-3">åŸºäºé©¬æ¥è¥¿äºšå›½å®¶é“¶è¡Œ(BNM)æœ€æ–°æ”¿ç­–å’Œå„å¤§é“¶è¡Œæœ€æ–°åˆ©ç‡ï¼Œæˆ‘ä»¬ä¸ºæ‚¨æä¾›ä»¥ä¸‹ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
            
            {% if optimizations %}
                {% for opt in optimizations %}
                <div class="card mb-4">
                    <div class="card-header">
                        {% if opt.optimization_type == 'debt_consolidation' %}
                            ğŸ”„ å€ºåŠ¡æ•´åˆæ–¹æ¡ˆ
                        {% elif opt.optimization_type == 'balance_transfer' %}
                            ğŸ’³ ä½™é¢è½¬ç§»æ–¹æ¡ˆ
                        {% else %}
                            ğŸ¦ è´·æ¬¾å†èèµ„æ–¹æ¡ˆ
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <h5 class="text-champagne mb-3">ä¼˜åŒ–å‰ vs ä¼˜åŒ–åå¯¹æ¯”ï¼š</h5>
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>é¡¹ç›®</th>
                                            <th class="text-center">ä¼˜åŒ–å‰</th>
                                            <th class="text-center">ä¼˜åŒ–å</th>
                                            <th class="text-center text-success">èŠ‚çœ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>æœˆä¾›</td>
                                            <td class="text-center">RM {{ "%.2f"|format(opt.current_monthly_payment) }}</td>
                                            <td class="text-center">RM {{ "%.2f"|format(opt.optimized_monthly_payment) }}</td>
                                            <td class="text-center text-success fw-bold">RM {{ "%.2f"|format(opt.monthly_savings) }}</td>
                                        </tr>
                                        <tr>
                                            <td>åˆ©ç‡</td>
                                            <td class="text-center">{{ "%.2f"|format(opt.current_interest_rate) }}%</td>
                                            <td class="text-center">{{ "%.2f"|format(opt.optimized_interest_rate) }}%</td>
                                            <td class="text-center text-success fw-bold">{{ "%.2f"|format(opt.current_interest_rate - opt.optimized_interest_rate) }}%</td>
                                        </tr>
                                        <tr>
                                            <td>æ€»æˆæœ¬ (3å¹´)</td>
                                            <td class="text-center">RM {{ "%.2f"|format(opt.current_total_cost) }}</td>
                                            <td class="text-center">RM {{ "%.2f"|format(opt.optimized_total_cost) }}</td>
                                            <td class="text-center text-success fw-bold">RM {{ "%.2f"|format(opt.total_savings) }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="alert alert-success">
                            <h6 class="mb-2">â­ é‡‡ç”¨æ­¤æ–¹æ¡ˆçš„æ”¶ç›Šï¼š</h6>
                            <ul class="mb-0">
                                <li>æ¯æœˆèŠ‚çœ: <strong>RM {{ "%.2f"|format(opt.monthly_savings) }}</strong></li>
                                <li>3å¹´æ€»èŠ‚çœ: <strong>RM {{ "%.2f"|format(opt.total_savings) }}</strong></li>
                                <li>é¢å¤–å¥½å¤„: {{ opt.additional_benefits }}</li>
                            </ul>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>æ¨èé“¶è¡Œ:</strong> {{ opt.recommended_bank }}</p>
                                <p class="mb-1"><strong>æ¨èäº§å“:</strong> {{ opt.recommended_product }}</p>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <form method="POST" action="{{ url_for('request_consultation', customer_id=customer.id) }}">
                                    <input type="hidden" name="optimization_id" value="{{ opt.id }}">
                                    <input type="hidden" name="request_type" value="optimization">
                                    <button type="submit" class="btn btn-primary">
                                        ğŸ“ æˆ‘æƒ³äº†è§£è¯¦æƒ…
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info">
                    æ‚¨ç›®å‰çš„è´¢åŠ¡çŠ¶å†µè‰¯å¥½ï¼Œæš‚æ— éœ€ä¼˜åŒ–ã€‚ç»§ç»­ä¿æŒè‰¯å¥½çš„è´¢åŠ¡ç®¡ç†ï¼
                </div>
            {% endif %}
        </div>
    </div>

    <!-- General Consultation Request -->
    <div class="row">
        <div class="col-12">
            <div class="card card-glass">
                <div class="card-body text-center py-5">
                    <h4 class="mb-3">ğŸ’¬ éœ€è¦ä¸€å¯¹ä¸€ä¸“ä¸šå’¨è¯¢ï¼Ÿ</h4>
                    <p class="text-silver mb-4">æˆ‘ä»¬çš„è´¢åŠ¡é¡¾é—®å›¢é˜Ÿéšæ—¶ä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–çš„è´¢åŠ¡è§„åˆ’å»ºè®®</p>
                    <form method="POST" action="{{ url_for('request_consultation', customer_id=customer.id) }}" class="row g-3 justify-content-center">
                        <div class="col-md-6">
                            <select name="request_type" class="form-select" required>
                                <option value="">é€‰æ‹©å’¨è¯¢ç±»å‹...</option>
                                <option value="full_optimization">å®Œæ•´è´¢åŠ¡ä¼˜åŒ–æ–¹æ¡ˆ</option>
                                <option value="card_recommendation">ä¿¡ç”¨å¡æ¨èå’¨è¯¢</option>
                                <option value="loan_restructure">è´·æ¬¾é‡ç»„å’¨è¯¢</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select name="contact_method" class="form-select" required>
                                <option value="email">Emailè”ç³»</option>
                                <option value="phone">ç”µè¯è”ç³»</option>
                                <option value="whatsapp">WhatsAppè”ç³»</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <textarea name="message" class="form-control" rows="3" placeholder="è¯·ç®€è¿°æ‚¨çš„éœ€æ±‚æˆ–é—®é¢˜ï¼ˆå¯é€‰ï¼‰"></textarea>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-success w-100">
                                âœ‰ï¸ æäº¤å’¨è¯¢è¯·æ±‚
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
