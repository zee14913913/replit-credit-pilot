{% extends "base.html" %}

{% block title %}{{ t('report_center') }} - CreditPilot{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- È°µÈù¢Ê†áÈ¢ò -->
    <div class="section-header">
        <h1 class="section-title" style="color: var(--primary-pink); font-weight: 700;">
            {{ t('report_center') }}
        </h1>
        <p class="section-subtitle">{{ t('batch_export_and_download') }}</p>
    </div>

    <!-- Á≠õÈÄâÂô®Âç°Áâá - Áõ¥Êé•ÂµåÂÖ•ÁâàÊú¨ÔºàËß£ÂÜ≥ÁºìÂ≠òÈóÆÈ¢òÔºâ-->
    <div class="professional-card mb-4" style="padding: 35px !important;">
        <h4 style="color: var(--primary-pink); font-weight: 700; margin-bottom: 28px; font-size: 1.4rem;">
            <i class="bi bi-funnel-fill me-2"></i>{{ t('filter_conditions') }}
        </h4>
        
        <!-- Á≠õÈÄâË°®Âçï - Ë∂ÖÂÆΩÁâàÊú¨ -->
        <form id="filterForm" class="row g-4" style="width: 100%;">
            <!-- ÂÆ¢Êà∑Á≠õÈÄâ -->
            <div class="col-md-4" style="padding: 0 15px;">
                <label class="form-label" style="font-weight: 700; color: #FF007F; font-size: 1.1rem; margin-bottom: 12px; display: block;">
                    <i class="bi bi-person-circle me-2"></i>{{ t('customer') }}
                </label>
                <select class="form-select" id="filterCustomer" name="customer_id" 
                        style="background: rgba(255,255,255,0.05) !important; 
                               border: 2px solid #FF007F !important; 
                               color: white !important; 
                               font-size: 1.05rem !important; 
                               padding: 18px 20px !important; 
                               border-radius: 12px !important;
                               min-height: 58px !important;
                               width: 100% !important;">
                    <option value="">üîç {{ t('all_customers') }}</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                    {% endfor %}
                </select>
                <small class="text-muted d-block mt-2" style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                    {{ t('select_customer_to_view_reports') }}
                </small>
            </div>
            
            <!-- Ë¥¶Êà∑Á±ªÂûãÁ≠õÈÄâ -->
            <div class="col-md-4" style="padding: 0 15px;">
                <label class="form-label" style="font-weight: 700; color: #FF007F; font-size: 1.1rem; margin-bottom: 12px; display: block;">
                    <i class="bi bi-wallet2 me-2"></i>{{ t('account_type') }}
                </label>
                <select class="form-select" id="filterAccount" name="account_type" 
                        style="background: rgba(255,255,255,0.05) !important; 
                               border: 2px solid #FF007F !important; 
                               color: white !important; 
                               font-size: 1.05rem !important; 
                               padding: 18px 20px !important; 
                               border-radius: 12px !important;
                               min-height: 58px !important;
                               width: 100% !important;">
                    <option value="">üîç {{ t('all_accounts') }}</option>
                    <option value="credit_card">üí≥ {{ t('credit_card') }}</option>
                    <option value="savings">üè¶ {{ t('savings_account') }}</option>
                    <option value="loan">üè† {{ t('loan_account') }}</option>
                </select>
                <small class="text-muted d-block mt-2" style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                    {{ t('filter_reports_by_account_type') }}
                </small>
            </div>
            
            <!-- Êó•ÊúüËåÉÂõ¥Á≠õÈÄâ -->
            <div class="col-md-4" style="padding: 0 15px;">
                <label class="form-label" style="font-weight: 700; color: #FF007F; font-size: 1.1rem; margin-bottom: 12px; display: block;">
                    <i class="bi bi-calendar-range me-2"></i>{{ t('date_range') }}
                </label>
                <div class="row g-2">
                    <div class="col-6">
                        <input type="date" class="form-control" id="filterDateFrom" name="date_from" 
                               placeholder="ÂºÄÂßãÊó•Êúü"
                               style="background: rgba(255,255,255,0.05) !important; 
                                      border: 2px solid #322446 !important; 
                                      color: white !important; 
                                      font-size: 1rem !important; 
                                      padding: 16px 14px !important; 
                                      border-radius: 12px !important;
                                      min-height: 58px !important;">
                    </div>
                    <div class="col-6">
                        <input type="date" class="form-control" id="filterDateTo" name="date_to" 
                               placeholder="ÁªìÊùüÊó•Êúü"
                               style="background: rgba(255,255,255,0.05) !important; 
                                      border: 2px solid #322446 !important; 
                                      color: white !important; 
                                      font-size: 1rem !important; 
                                      padding: 16px 14px !important; 
                                      border-radius: 12px !important;
                                      min-height: 58px !important;">
                    </div>
                </div>
                <small class="text-muted d-block mt-2" style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                    {{ t('select_report_date_range') }}
                </small>
            </div>
            
            <!-- Êìç‰ΩúÊåâÈíÆÁªÑ -->
            <div class="col-12" style="margin-top: 25px;">
                <div class="d-flex gap-3 justify-content-end">
                    <button type="button" class="btn-professional-outline" onclick="resetFilter()" 
                            style="padding: 16px 36px !important; 
                                   font-size: 1.05rem !important; 
                                   border-radius: 12px !important;
                                   min-width: 140px;">
                        <i class="bi bi-arrow-clockwise me-2"></i>{{ t('reset_filter') }}
                    </button>
                    <button type="submit" class="btn-professional" 
                            style="padding: 16px 44px !important; 
                                   font-size: 1.05rem !important; 
                                   border-radius: 12px !important; 
                                   min-width: 180px;">
                        <i class="bi bi-funnel-fill me-2"></i>{{ t('apply_filter') }}
                    </button>
                </div>
            </div>
        </form>
        
        <script>
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const params = new URLSearchParams(formData);
            window.location.href = '/reports/center?' + params.toString();
        });
        
        function resetFilter() {
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterAccount').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            window.location.href = '/reports/center';
        }
        </script>
    </div>

    <!-- ÊâπÈáèÊìç‰ΩúÂå∫Ôºà‰∏ªÂç°Áâá - Â∏¶Â§ßÂûãÂõæÊ†áÔºâ -->
    <div class="professional-card mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <i class="bi bi-bar-chart-line-fill" 
                   style="font-size: 2.5rem; color: var(--primary-pink); margin-right: 12px; vertical-align: middle;"></i>
                <h4 style="color: var(--primary-pink); font-weight: 700; margin: 0;">{{ t('batch_export_center') }}</h4>
            </div>
            <div class="d-flex gap-2">
                <button class="btn-professional-outline btn-sm" onclick="exportSelected('PDF')">{{ t('export_pdf') }}</button>
                <button class="btn-professional-outline btn-sm" onclick="exportSelected('Excel')">{{ t('export_excel') }}</button>
                <button class="btn-professional btn-sm" onclick="exportSelected('CSV')">{{ t('export_csv') }}</button>
            </div>
        </div>

        <!-- Êï∞ÊçÆÂàóË°® -->
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th style="width: 50px;"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                        <th>{{ t('customer') }}</th>
                        <th>{{ t('bank') }} - {{ t('statement_date') }}</th>
                        <th>{{ t('statement_total') }}</th>
                        <th>{{ t('minimum_payment') }}</th>
                        <th>{{ t('due_date') }}</th>
                        <th>{{ t('status') }}</th>
                    </tr>
                </thead>
                <tbody id="reportData">
                    {% for record in records %}
                    <tr>
                        <td><input type="checkbox" class="record-checkbox" value="{{ record.id }}"></td>
                        <td style="font-weight: 600;">{{ record.customer_name }}</td>
                        <td style="font-weight: 600; color: var(--primary-pink);">
                            {{ record.bank_abbr }} - {{ record.statement_date_formatted }}
                        </td>
                        <td style="color: var(--primary-pink); font-weight: 600;">RM {{ "{:,.2f}".format(record.amount) }}</td>
                        <td style="color: #FFD700; font-weight: 600;">
                            {% if record.minimum_payment is not none %}
                                RM {{ "{:,.2f}".format(record.minimum_payment) }}
                            {% else %}
                                <span style="color: rgba(255,255,255,0.4);">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.date_to is not none %}
                                {{ record.date_to }}
                            {% else %}
                                <span style="color: rgba(255,255,255,0.4);">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.status == 'confirmed' %}
                                <span class="badge-success-pro">{{ t('confirmed') }}</span>
                            {% else %}
                                <span class="badge-pink-custom">{{ t('pending') }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">{{ t('no_data_available') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ÂØºÂá∫ËøõÂ∫¶Âç°Áâá -->
    <div class="professional-card">
        <h4 style="color: var(--primary-pink); font-weight: 700; margin-bottom: 20px;">{{ t('export_history') }}</h4>
        <div id="exportHistory">
            {% for task in export_tasks %}
                {% include "components/export_progress_card.html" %}
            {% else %}
            <div class="text-center text-muted py-4">{{ t('no_export_history') }}</div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// ÂÖ®ÈÄâ/ÂèçÈÄâ
function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.record-checkbox');
    const selectAll = document.getElementById('selectAll');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

// ÊâπÈáèÂØºÂá∫
function exportSelected(format) {
    const checkboxes = document.querySelectorAll('.record-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('{{ t('please_select_records') }}');
        return;
    }
    
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    fetch('/api/reports/export', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            record_ids: ids,
            export_format: format
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('{{ t('export_started') }}: ' + format);
            location.reload();
        } else {
            alert('{{ t('export_failed') }}: ' + data.message);
        }
    });
}

// Âà∑Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï
function refreshHistory() {
    location.reload();
}
</script>
{% endblock %}
