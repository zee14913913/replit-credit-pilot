{% extends "base.html" %}

{% block title %}{{ t('report_center') }} - CreditPilot{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="section-header">
        <h1 class="section-title" style="color: var(--primary-pink); font-weight: 700;">
            {{ t('report_center') }}
        </h1>
        <p class="section-subtitle">{{ t('batch_export_and_download') }}</p>
    </div>

    <!-- ç­›é€‰å™¨å¡ç‰‡ - ç›´æ¥åµŒå…¥ç‰ˆæœ¬ï¼ˆè§£å†³ç¼“å­˜é—®é¢˜ï¼‰-->
    <div class="professional-card mb-4" style="padding: 35px !important;">
        <h4 style="color: var(--primary-pink); font-weight: 700; margin-bottom: 28px; font-size: 1.4rem;">
            <i class="bi bi-funnel-fill me-2"></i>{{ t('filter_conditions') }}
        </h4>
        
        <!-- ç­›é€‰è¡¨å• - è¶…å®½ç‰ˆæœ¬ -->
        <form id="filterForm" class="row g-4" style="width: 100%;">
            <!-- å®¢æˆ·ç­›é€‰ -->
            <div class="col-md-4" style="padding: 0 15px;">
                <label class="form-label" style="font-weight: 700; color: #FF007F; font-size: 1.1rem; margin-bottom: 12px; display: block;">
                    <i class="bi bi-person-circle me-2"></i>{{ t('customer') }}
                </label>
                <select class="form-select" id="filterCustomer" name="customer_id" 
                        style="background: rgba(255,255,255,0.05) !important; 
                               border: 2px solid #FF007F !important; 
                               color: white !important; 
                               font-size: 1.05rem !important; 
                               padding: 18px 20px !important; 
                               border-radius: 12px !important;
                               min-height: 58px !important;
                               width: 100% !important;">
                    <option value="">ğŸ” {{ t('all_customers') }}</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                    {% endfor %}
                </select>
                <small class="text-muted d-block mt-2" style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                    é€‰æ‹©ç‰¹å®šå®¢æˆ·ä»¥æŸ¥çœ‹å…¶æŠ¥è¡¨è®°å½•
                </small>
            </div>
            
            <!-- è´¦æˆ·ç±»å‹ç­›é€‰ -->
            <div class="col-md-4" style="padding: 0 15px;">
                <label class="form-label" style="font-weight: 700; color: #FF007F; font-size: 1.1rem; margin-bottom: 12px; display: block;">
                    <i class="bi bi-wallet2 me-2"></i>è´¦æˆ·ç±»å‹
                </label>
                <select class="form-select" id="filterAccount" name="account_type" 
                        style="background: rgba(255,255,255,0.05) !important; 
                               border: 2px solid #FF007F !important; 
                               color: white !important; 
                               font-size: 1.05rem !important; 
                               padding: 18px 20px !important; 
                               border-radius: 12px !important;
                               min-height: 58px !important;
                               width: 100% !important;">
                    <option value="">ğŸ” {{ t('all_accounts') }}</option>
                    <option value="credit_card">ğŸ’³ {{ t('credit_card') }}</option>
                    <option value="savings">ğŸ¦ {{ t('savings_account') }}</option>
                    <option value="loan">ğŸ  {{ t('loan_account') }}</option>
                </select>
                <small class="text-muted d-block mt-2" style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                    æŒ‰è´¦æˆ·ç±»å‹ç­›é€‰æŠ¥è¡¨æ•°æ®
                </small>
            </div>
            
            <!-- æ—¥æœŸèŒƒå›´ç­›é€‰ -->
            <div class="col-md-4" style="padding: 0 15px;">
                <label class="form-label" style="font-weight: 700; color: #FF007F; font-size: 1.1rem; margin-bottom: 12px; display: block;">
                    <i class="bi bi-calendar-range me-2"></i>æ—¥æœŸèŒƒå›´
                </label>
                <div class="row g-2">
                    <div class="col-6">
                        <input type="date" class="form-control" id="filterDateFrom" name="date_from" 
                               placeholder="å¼€å§‹æ—¥æœŸ"
                               style="background: rgba(255,255,255,0.05) !important; 
                                      border: 2px solid #322446 !important; 
                                      color: white !important; 
                                      font-size: 1rem !important; 
                                      padding: 16px 14px !important; 
                                      border-radius: 12px !important;
                                      min-height: 58px !important;">
                    </div>
                    <div class="col-6">
                        <input type="date" class="form-control" id="filterDateTo" name="date_to" 
                               placeholder="ç»“æŸæ—¥æœŸ"
                               style="background: rgba(255,255,255,0.05) !important; 
                                      border: 2px solid #322446 !important; 
                                      color: white !important; 
                                      font-size: 1rem !important; 
                                      padding: 16px 14px !important; 
                                      border-radius: 12px !important;
                                      min-height: 58px !important;">
                    </div>
                </div>
                <small class="text-muted d-block mt-2" style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                    é€‰æ‹©æŠ¥è¡¨æ•°æ®çš„èµ·æ­¢æ—¥æœŸ
                </small>
            </div>
            
            <!-- æ“ä½œæŒ‰é’®ç»„ -->
            <div class="col-12" style="margin-top: 25px;">
                <div class="d-flex gap-3 justify-content-end">
                    <button type="button" class="btn-professional-outline" onclick="resetFilter()" 
                            style="padding: 16px 36px !important; 
                                   font-size: 1.05rem !important; 
                                   border-radius: 12px !important;
                                   min-width: 140px;">
                        <i class="bi bi-arrow-clockwise me-2"></i>é‡ç½®ç­›é€‰
                    </button>
                    <button type="submit" class="btn-professional" 
                            style="padding: 16px 44px !important; 
                                   font-size: 1.05rem !important; 
                                   border-radius: 12px !important; 
                                   min-width: 180px;">
                        <i class="bi bi-funnel-fill me-2"></i>{{ t('apply_filter') }}
                    </button>
                </div>
            </div>
        </form>
        
        <script>
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const params = new URLSearchParams(formData);
            window.location.href = '/reports/center?' + params.toString();
        });
        
        function resetFilter() {
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterAccount').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            window.location.href = '/reports/center';
        }
        </script>
    </div>

    <!-- æ‰¹é‡æ“ä½œåŒºï¼ˆä¸»å¡ç‰‡ - å¸¦å¤§å‹å›¾æ ‡ï¼‰ -->
    <div class="professional-card mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <i class="bi bi-bar-chart-line-fill" 
                   style="font-size: 2.5rem; color: var(--primary-pink); margin-right: 12px; vertical-align: middle;"></i>
                <h4 style="color: var(--primary-pink); font-weight: 700; margin: 0;">{{ t('batch_export_center') }}</h4>
            </div>
            <div class="d-flex gap-2">
                <button class="btn-professional-outline btn-sm" onclick="exportSelected('PDF')">{{ t('export_pdf') }}</button>
                <button class="btn-professional-outline btn-sm" onclick="exportSelected('Excel')">{{ t('export_excel') }}</button>
                <button class="btn-professional btn-sm" onclick="exportSelected('CSV')">{{ t('export_csv') }}</button>
            </div>
        </div>

        <!-- æ•°æ®åˆ—è¡¨ -->
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                        <th>{{ t('customer') }}</th>
                        <th>{{ t('account') }}</th>
                        <th>{{ t('date_range') }}</th>
                        <th>{{ t('amount') }}</th>
                        <th>{{ t('status') }}</th>
                    </tr>
                </thead>
                <tbody id="reportData">
                    {% for record in records %}
                    <tr>
                        <td><input type="checkbox" class="record-checkbox" value="{{ record.id }}"></td>
                        <td>{{ record.customer_name }}</td>
                        <td>{{ record.account_name }}</td>
                        <td>{{ record.date_from }} ~ {{ record.date_to }}</td>
                        <td style="color: var(--primary-pink); font-weight: 600;">RM {{ "{:,.2f}".format(record.amount) }}</td>
                        <td>
                            {% if record.status == 'confirmed' %}
                                <span class="badge-success-pro">{{ t('confirmed') }}</span>
                            {% else %}
                                <span class="badge-pink-custom">{{ t('pending') }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">{{ t('no_data_available') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- å¯¼å‡ºè¿›åº¦å¡ç‰‡ -->
    <div class="professional-card">
        <h4 style="color: var(--primary-pink); font-weight: 700; margin-bottom: 20px;">{{ t('export_history') }}</h4>
        <div id="exportHistory">
            {% for task in export_tasks %}
                {% include "components/export_progress_card.html" %}
            {% else %}
            <div class="text-center text-muted py-4">{{ t('no_export_history') }}</div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// å…¨é€‰/åé€‰
function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.record-checkbox');
    const selectAll = document.getElementById('selectAll');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

// æ‰¹é‡å¯¼å‡º
function exportSelected(format) {
    const checkboxes = document.querySelectorAll('.record-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('{{ t("please_select_records") }}');
        return;
    }
    
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    fetch('/api/reports/export', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            record_ids: ids,
            export_format: format
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('{{ t("export_started") }}: ' + format);
            location.reload();
        } else {
            alert('{{ t("export_failed") }}: ' + data.message);
        }
    });
}

// åˆ·æ–°å†å²è®°å½•
function refreshHistory() {
    location.reload();
}
</script>
{% endblock %}
