{% extends "base.html" %}

{% block title %}添加分期计划{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-calendar-plus"></i> 添加分期计划
        </h1>
        <p class="page-subtitle">手动录入信用卡分期付款信息</p>
    </div>

    <!-- 信用卡信息 -->
    <div class="content-card mb-4">
        <h5 class="section-title">
            <i class="bi bi-credit-card-2-front"></i> 信用卡信息
        </h5>
        <div class="card-info-grid">
            <div class="info-item">
                <span class="info-label">客户:</span>
                <span class="info-value">{{ card.customer_name }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">卡类型:</span>
                <span class="info-value">{{ card.card_type }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">银行:</span>
                <span class="info-value">{{ card.bank_name }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">卡号:</span>
                <span class="info-value">**** **** **** {{ card.card_number_last4 }}</span>
            </div>
        </div>
    </div>

    <!-- 分期计划表单 -->
    <div class="content-card">
        <h5 class="section-title">
            <i class="bi bi-clipboard-data"></i> 分期计划详情
        </h5>
        
        <form method="POST" action="{{ url_for('add_instalment', card_id=card.id) }}" id="instalmentForm">
            <div class="row">
                <!-- 分期类型 -->
                <div class="col-md-6 mb-3">
                    <label class="form-label">分期类型 <span class="text-danger">*</span></label>
                    <select class="form-control" name="instalment_type" required>
                        <option value="">请选择分期类型</option>
                        <option value="Balance Transfer">Balance Transfer (余额转账)</option>
                        <option value="Flexi">Flexi (灵活分期)</option>
                        <option value="Shopping Instalment">Shopping Instalment (购物分期)</option>
                        <option value="Cash Advance">Cash Advance (现金预借)</option>
                        <option value="Other">其他</option>
                    </select>
                </div>

                <!-- 产品名称 -->
                <div class="col-md-6 mb-3">
                    <label class="form-label">产品名称 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="product_name" 
                           placeholder="例如: iPhone 15 Pro, 家具购买等" required>
                </div>

                <!-- 商家名称 -->
                <div class="col-md-6 mb-3">
                    <label class="form-label">商家名称（可选）</label>
                    <input type="text" class="form-control" name="merchant_name" 
                           placeholder="例如: Apple Store, IKEA等">
                </div>

                <!-- 本金金额 -->
                <div class="col-md-6 mb-3">
                    <label class="form-label">本金金额 (RM) <span class="text-danger">*</span></label>
                    <input type="number" step="0.01" class="form-control" name="principal_amount" 
                           id="principalAmount" placeholder="例如: 5000.00" required>
                </div>

                <!-- 利率 -->
                <div class="col-md-6 mb-3">
                    <label class="form-label">年利率 (%) </label>
                    <input type="number" step="0.01" class="form-control" name="interest_rate" 
                           id="interestRate" value="0" placeholder="例如: 18.00">
                    <small class="form-text text-muted">如果是0%利率分期，填写0</small>
                </div>

                <!-- 分期期数 -->
                <div class="col-md-6 mb-3">
                    <label class="form-label">分期期数（月）<span class="text-danger">*</span></label>
                    <select class="form-control" name="tenure_months" id="tenureMonths" required>
                        <option value="">请选择期数</option>
                        <option value="3">3个月</option>
                        <option value="6">6个月</option>
                        <option value="12">12个月</option>
                        <option value="18">18个月</option>
                        <option value="24">24个月</option>
                        <option value="36">36个月</option>
                        <option value="48">48个月</option>
                    </select>
                </div>

                <!-- 开始日期 -->
                <div class="col-md-6 mb-3">
                    <label class="form-label">开始日期 <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" name="start_date" 
                           id="startDate" required>
                </div>
            </div>

            <!-- 计算预览 -->
            <div class="calculation-preview mt-4 mb-4" id="calculationPreview" style="display: none;">
                <h6 class="preview-title">
                    <i class="bi bi-calculator"></i> 自动计算预览
                </h6>
                <div class="preview-grid">
                    <div class="preview-item">
                        <span class="preview-label">总利息:</span>
                        <span class="preview-value" id="previewInterest">RM 0.00</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">总金额:</span>
                        <span class="preview-value" id="previewTotal">RM 0.00</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">每月还款:</span>
                        <span class="preview-value" id="previewMonthly">RM 0.00</span>
                    </div>
                    <div class="preview-item">
                        <span class="preview-label">结束日期:</span>
                        <span class="preview-value" id="previewEndDate">-</span>
                    </div>
                </div>
            </div>

            <!-- 按钮 -->
            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    <i class="bi bi-check-circle"></i> 保存分期计划
                </button>
                <a href="{{ url_for('admin_customers_cards') }}" class="btn-secondary">
                    <i class="bi bi-x-circle"></i> 取消
                </a>
            </div>
        </form>
    </div>
</div>

<style>
.card-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    padding: 1.5rem;
    background: rgba(20, 20, 20, 0.5);
    border-radius: 8px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.info-label {
    color: #9CA3AF;
    font-size: 0.85rem;
    font-weight: 500;
}

.info-value {
    color: #E5E5E5;
    font-size: 1.1rem;
    font-weight: 600;
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #E5E5E5;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-title i {
    color: #60A5FA;
}

.calculation-preview {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(96, 165, 250, 0.1) 100%);
    border: 1px solid rgba(96, 165, 250, 0.3);
    border-radius: 12px;
    padding: 1.5rem;
}

.preview-title {
    color: #93C5FD;
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.preview-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(30, 30, 30, 0.5);
    border-radius: 8px;
}

.preview-label {
    color: #9CA3AF;
    font-size: 0.9rem;
}

.preview-value {
    color: #FFFFFF;
    font-weight: 600;
    font-size: 1.1rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.btn-primary, .btn-secondary {
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
    color: white;
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
}

.btn-secondary {
    background: rgba(192, 192, 192, 0.1);
    color: #E5E5E5;
    border: 1px solid rgba(192, 192, 192, 0.3);
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.15);
    color: #FFFFFF;
}
</style>

<script>
// 自动计算功能
document.addEventListener('DOMContentLoaded', function() {
    const principalInput = document.getElementById('principalAmount');
    const interestInput = document.getElementById('interestRate');
    const tenureInput = document.getElementById('tenureMonths');
    const startDateInput = document.getElementById('startDate');
    const preview = document.getElementById('calculationPreview');

    function calculateInstalment() {
        const principal = parseFloat(principalInput.value) || 0;
        const interestRate = parseFloat(interestInput.value) || 0;
        const tenure = parseInt(tenureInput.value) || 0;
        const startDate = startDateInput.value;

        if (principal > 0 && tenure > 0) {
            // 计算总利息
            const totalInterest = principal * (interestRate / 100) * (tenure / 12);
            const totalAmount = principal + totalInterest;
            const monthlyPayment = totalAmount / tenure;

            // 计算结束日期
            let endDate = '-';
            if (startDate) {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setMonth(end.getMonth() + tenure);
                endDate = end.toISOString().split('T')[0];
            }

            // 更新预览
            document.getElementById('previewInterest').textContent = `RM ${totalInterest.toFixed(2)}`;
            document.getElementById('previewTotal').textContent = `RM ${totalAmount.toFixed(2)}`;
            document.getElementById('previewMonthly').textContent = `RM ${monthlyPayment.toFixed(2)}`;
            document.getElementById('previewEndDate').textContent = endDate;

            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }

    principalInput.addEventListener('input', calculateInstalment);
    interestInput.addEventListener('input', calculateInstalment);
    tenureInput.addEventListener('change', calculateInstalment);
    startDateInput.addEventListener('change', calculateInstalment);
});
</script>
{% endblock %}
