{% extends "base.html" %}

{% block title %}Upload Income Document{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1 class="mb-4" style="color: #FF007F;">
                <i class="bi bi-file-earmark-text"></i> Upload Income Document
            </h1>
            
            <div class="card" style="background: rgba(0,0,0,0.7); border: 2px solid #322446;">
                <div class="card-body p-4">
                    <form id="incomeUploadForm" enctype="multipart/form-data">
                        <!-- 客户选择 -->
                        <div class="mb-4">
                            <label class="form-label" style="color: rgba(255,255,255,0.9); font-weight: 600;">
                                <i class="bi bi-person"></i> Customer
                            </label>
                            <select name="customer_id" id="customer_id" class="form-select bg-dark text-white" required
                                    style="border: 2px solid rgba(255,0,127,0.3);">
                                <option value="">{{ t('select_customer_1') }}</option>
                            </select>
                        </div>
                        
                        <!-- 文件类型 -->
                        <div class="mb-4">
                            <label class="form-label" style="color: rgba(255,255,255,0.9); font-weight: 600;">
                                <i class="bi bi-file-earmark-medical"></i> Document Type
                            </label>
                            <select name="document_type" id="document_type" class="form-select bg-dark text-white" required
                                    style="border: 2px solid rgba(255,0,127,0.3);">
                                <option value="salary_slip">{{ t('salary_slip__payslip') }}</option>
                                <option value="tax_return">{{ t('income_tax_return_ea_form') }}</option>
                                <option value="epf">{{ t('epf_statement') }}</option>
                                <option value="bank_inflow">{{ t('bank_statement_income_focus') }}</option>
                            </select>
                            <small class="text-muted">
                                Select the type of income proof document
                            </small>
                        </div>
                        
                        <!-- 收入月份 -->
                        <div class="mb-4">
                            <label class="form-label" style="color: rgba(255,255,255,0.9); font-weight: 600;">
                                <i class="bi bi-calendar3"></i> Income Month
                            </label>
                            <input type="month" name="document_month" id="document_month" 
                                   class="form-control bg-dark text-white" required
                                   style="border: 2px solid rgba(255,0,127,0.3);">
                            <small class="text-muted">
                                The month this document represents (e.g., 2025-01 for January 2025)
                            </small>
                        </div>
                        
                        <!-- 文件上传 -->
                        <div class="mb-4">
                            <label class="form-label" style="color: rgba(255,255,255,0.9); font-weight: 600;">
                                <i class="bi bi-cloud-upload"></i> Select File
                            </label>
                            <input type="file" name="file" id="file" class="form-control bg-dark text-white" 
                                   accept=".pdf,.jpg,.jpeg,.png" required
                                   style="border: 2px solid rgba(255,0,127,0.3);">
                            <small class="text-muted">
                                Supported formats: PDF, JPG, PNG (Max 10MB)
                            </small>
                        </div>
                        
                        <!-- OCR 提示 -->
                        <div class="alert" style="background: rgba(255,0,127,0.1); border: 2px solid rgba(255,0,127,0.3); color: #FF007F;">
                            <h6><i class="bi bi-magic"></i>{{ t('smart_ocr_features') }}</h6>
                            <ul class="mb-0" style="color: rgba(255,255,255,0.9);">
                                <li>{{ t('automatic_income_amount_extraction') }}</li>
                                <li>{{ t('multilanguage_support_english__chinese') }}</li>
                                <li>{{ t('document_text_recognition') }}</li>
                                <li>{{ t('confidence_scoring') }}</li>
                            </ul>
                        </div>
                        
                        <!-- 按钮 -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-lg" 
                                    style="background: linear-gradient(135deg, #FF007F, #FF4DA6); color: white; font-weight: 700;">
                                <i class="bi bi-upload"></i> Upload Document
                            </button>
                            <a href="{{ url_for('income_home') }}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back
                            </a>
                        </div>
                    </form>
                    
                    <!-- 上传进度 -->
                    <div id="uploadProgress" class="mt-4" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" 
                                 style="width: 100%; background: #FF007F;">
                                Processing OCR...
                            </div>
                        </div>
                    </div>
                    
                    <!-- 上传结果 -->
                    <div id="uploadResult" class="mt-4" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 加载客户列表
    fetch('/api/customers/list')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('customer_id');
            data.customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (${customer.email})`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading customers:', error);
        });
    
    // 设置默认月份为当前月
    const now = new Date();
    const currentMonth = now.toISOString().slice(0, 7);
    document.getElementById('document_month').value = currentMonth;
    
    // 处理表单提交
    document.getElementById('incomeUploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const progressDiv = document.getElementById('uploadProgress');
        const resultDiv = document.getElementById('uploadResult');
        
        // 显示进度条
        progressDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        
        try {
            const response = await fetch('/api/income-documents/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            // 隐藏进度条
            progressDiv.style.display = 'none';
            
            if (response.ok && result.status === 'success') {
                // 显示成功结果
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle"></i>{{ t('upload_successful') }}</h5>
                        <hr>
                        <p><strong>{{ t('customer_1') }}</strong>{{ t('resultcustomer_name') }}</p>
                        <p><strong>{{ t('document_type_1') }}</strong>{{ t('resultdocument_type') }}</p>
                        <p><strong>{{ t('month_1') }}</strong>{{ t('resultdocument_month') }}</p>
                        <hr>
                        <h6 style="color: #FF007F;"><i class="bi bi-magic"></i>{{ t('ocr_results') }}</h6>
                        <p><strong>{{ t('income_detected_1') }}</strong>{{ t('rm_resultocr_resultincome_detectedtofixed2') }}</p>
                        <p><strong>{{ t('confidence_1') }}</strong>{{ t('resultocr_resultconfidence__100tofixed1') }}</p>
                        <p><strong>{{ t('method') }}</strong>{{ t('resultocr_resultmethod') }}</p>
                        <p><strong>{{ t('text_length') }}</strong>{{ t('resultocr_resulttext_length_characters') }}</p>
                        <hr>
                        <a href="/income" class="btn btn-primary">{{ t('view_all_documents') }}</a>
                    </div>
                `;
                resultDiv.style.display = 'block';
                
                // 重置表单
                this.reset();
                document.getElementById('document_month').value = currentMonth;
            } else {
                // 显示错误
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle"></i>{{ t('upload_failed') }}</h5>
                        <p>{{ t('resultdetail__resultmessage__unknown_error') }}</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
            }
        } catch (error) {
            progressDiv.style.display = 'none';
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i>{{ t('error') }}</h5>
                    <p>{{ t('errormessage') }}</p>
                </div>
            `;
            resultDiv.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
