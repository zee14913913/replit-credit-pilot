{% extends "base.html" %}

{% block title %}{{ t('upload_income_document') }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1 class="mb-4" style="color: #FF007F;">
                <i class="bi bi-file-earmark-text"></i> {{ t('upload_income_document') }}
            </h1>
            
            <div class="card" style="background: rgba(0,0,0,0.7); border: 2px solid #322446;">
                <div class="card-body p-4">
                    <form id="incomeUploadForm" enctype="multipart/form-data">
                        <!-- 客户选择 -->
                        <div class="mb-4">
                            <label class="form-label" style="color: rgba(255,255,255,0.9); font-weight: 600;">
                                <i class="bi bi-person"></i> {{ t('customer') }}
                            </label>
                            <select name="customer_id" id="customer_id" class="form-select bg-dark text-white" required
                                    style="border: 2px solid rgba(255,0,127,0.3);">
                                <option value="">{{ t('select_customer_1') }}</option>
                            </select>
                        </div>
                        
                        <!-- 文件类型 -->
                        <div class="mb-4">
                            <label class="form-label" style="color: rgba(255,255,255,0.9); font-weight: 600;">
                                <i class="bi bi-file-earmark-medical"></i> {{ t('document_type') }}
                            </label>
                            <select name="document_type" id="document_type" class="form-select bg-dark text-white" required
                                    style="border: 2px solid rgba(255,0,127,0.3);">
                                <option value="{{ t('salary_slip_1') }}">{{ t('salary_slip__payslip') }}</option>
                                <option value="{{ t('tax_return_1') }}">{{ t('income_tax_return_ea_form') }}</option>
                                <option value="{{ t('epf') }}">{{ t('epf_statement') }}</option>
                                <option value="{{ t('bank_inflow') }}">{{ t('bank_statement_income_focus') }}</option>
                            </select>
                            <small class="text-muted">
                                {{ t('select_income_proof_type') }}
                            </small>
                        </div>
                        
                        <!-- 收入月份 -->
                        <div class="mb-4">
                            <label class="form-label" style="color: rgba(255,255,255,0.9); font-weight: 600;">
                                <i class="bi bi-calendar3"></i> {{ t('income_month') }}
                            </label>
                            <input type="month" name="document_month" id="document_month" 
                                   class="form-control bg-dark text-white" required
                                   style="border: 2px solid rgba(255,0,127,0.3);">
                            <small class="text-muted">
                                {{ t('month_this_document_represents') }}
                            </small>
                        </div>
                        
                        <!-- 文件上传 -->
                        <div class="mb-4">
                            <label class="form-label" style="color: rgba(255,255,255,0.9); font-weight: 600;">
                                <i class="bi bi-cloud-upload"></i> {{ t('select_file') }}
                            </label>
                            <input type="file" name="file" id="file" class="form-control bg-dark text-white" 
                                   accept=".pdf,.jpg,.jpeg,.png" required
                                   style="border: 2px solid rgba(255,0,127,0.3);">
                            <small class="text-muted">
                                {{ t('supported_formats_pdf_jpg_png') }}
                            </small>
                        </div>
                        
                        <!-- {{ t('ocr_') }} -->
                        <div class="alert" style="background: rgba(255,0,127,0.1); border: 2px solid rgba(255,0,127,0.3); color: #FF007F;">
                            <h6><i class="bi bi-magic"></i>{{ t('smart_ocr_features') }}</h6>
                            <ul class="mb-0" style="color: rgba(255,255,255,0.9);">
                                <li>{{ t('automatic_income_amount_extraction') }}</li>
                                <li>{{ t('multilanguage_support_english__chinese') }}</li>
                                <li>{{ t('document_text_recognition') }}</li>
                                <li>{{ t('confidence_scoring') }}</li>
                            </ul>
                        </div>
                        
                        <!-- 按钮 -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-lg" 
                                    style="background: linear-gradient(135deg, #FF007F, #FF4DA6); color: white; font-weight: 700;">
                                <i class="bi bi-upload"></i> {{ t('upload_document') }}
                            </button>
                            <a href="{{ url_for('income_home') }}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> {{ t('back') }}
                            </a>
                        </div>
                    </form>
                    
                    <!-- 上传进度 -->
                    <div id="uploadProgress" class="mt-4" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" 
                                 style="width: 100%; background: #FF007F;">
                                {{ t('processing_ocr') }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 上传结果 -->
                    <div id="uploadResult" class="mt-4" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load customer list
    fetch('/api/customers/list')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('customer_id');
            data.customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (${customer.email})`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading customers:', error);
        });
    
    // Set default month to current month
    const now = new Date();
    const currentMonth = now.toISOString().slice(0, 7);
    document.getElementById('document_month').value = currentMonth;
    
    // Handle form submission
    document.getElementById('incomeUploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const t = (key, fallback) => window.i18n ? window.i18n.translate(key) : fallback;
        const formData = new FormData(this);
        const progressDiv = document.getElementById('uploadProgress');
        const resultDiv = document.getElementById('uploadResult');
        
        // Show progress
        progressDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        
        try {
            const response = await fetch('/api/income-documents/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            // Hide progress bar
            progressDiv.style.display = 'none';
            
            if (response.ok && result.status === 'success') {
                // Success message
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle"></i> ${t('upload_successful', 'Upload Successful!')}</h5>
                        <hr>
                        <p><strong>${t('customer', 'Customer')}:</strong> ${result.customer_name}</p>
                        <p><strong>${t('document_type', 'Document Type')}:</strong> ${result.document_type}</p>
                        <p><strong>${t('month', 'Month')}:</strong> ${result.document_month}</p>
                        <hr>
                        <h6 style="color: #FF007F;"><i class="bi bi-magic"></i> ${t('ocr_results', 'OCR Results')}</h6>
                        <p><strong>${t('income_detected', 'Income Detected')}:</strong> RM ${result.ocr_result.income_detected.toFixed(2)}</p>
                        <p><strong>${t('confidence', 'Confidence')}:</strong> ${(result.ocr_result.confidence * 100).toFixed(1)}%</p>
                        <p><strong>${t('method', 'Method')}:</strong> ${result.ocr_result.method}</p>
                        <p><strong>${t('text_length', 'Text Length')}:</strong> ${result.ocr_result.text_length} ${t('characters', 'characters')}</p>
                        <hr>
                        <a href="/income" class="btn btn-primary">${t('view_all_documents', 'View All Documents')}</a>
                    </div>
                `;
                resultDiv.style.display = 'block';
                
                // Reset form and set month back to current
                this.reset();
                document.getElementById('document_month').value = currentMonth;
            } else {
                // Error message
                console.error('Upload failed:', result.detail || result.message);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle"></i> ${t('upload_failed', 'Upload Failed')}</h5>
                        <p>${t('upload_error_message', 'An error occurred during upload. Please check the file and try again.')}</p>
                    </div>
                `;
                resultDiv.style.display = 'block';
            }
        } catch (error) {
            console.error('Upload exception:', error);
            progressDiv.style.display = 'none';
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> ${t('error', 'Error')}</h5>
                    <p>${t('network_error_message', 'Network error occurred. Please check your connection and try again.')}</p>
                </div>
            `;
            resultDiv.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
