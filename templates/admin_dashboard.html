{% extends "base.html" %}

{% block title %}{{ t('admin_dashboard') }} - {{ t('company_name') }}{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 98%; padding: 2rem;">
    <div class="section-header">
        <h1 class="section-title" style="color: #FF007F; font-weight: 700;">üìä {{ t('admin_dashboard') }}</h1>
        <p class="section-description" style="color: #FF007F;">{{ t('system_overview_subtitle') }}</p>
    </div>

    <!-- System Summary -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">{{ customers|length }}</div>
                <div class="stat-label">{{ t('total_customers') }}</div>
                <div class="stat-corner"></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">{{ statement_count }}</div>
                <div class="stat-label">{{ t('total_statements') }}</div>
                <div class="stat-corner"></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">{{ txn_count }}</div>
                <div class="stat-label">{{ t('total_transactions') }}</div>
                <div class="stat-corner"></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">{{ active_cards }}</div>
                <div class="stat-label">{{ t('active_cards') }}</div>
                <div class="stat-corner"></div>
            </div>
        </div>
    </div>

    <!-- Owner's Financial Statistics -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 0, 127, 0.1) 0%, rgba(0, 0, 0, 0.95) 100%); border: 1px solid #FF007F;">
                <div class="stat-value" style="color: #FF007F;">RM {{ "{:,.0f}".format(total_owner_expenses) }}</div>
                <div class="stat-label">üí≥ Own's Expenses</div>
                <div class="stat-corner" style="background: #FF007F;"></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 0, 127, 0.1) 0%, rgba(0, 0, 0, 0.95) 100%); border: 1px solid #FF007F;">
                <div class="stat-value" style="color: #FF007F;">RM {{ "{:,.0f}".format(abs(total_owner_payments)) }}</div>
                <div class="stat-label">üí∞ Own's Payment</div>
                <div class="stat-corner" style="background: #FF007F;"></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 0, 127, 0.1) 0%, rgba(0, 0, 0, 0.95) 100%); border: 1px solid #FF007F;">
                <div class="stat-value" style="color: #FF007F;">RM {{ "{:,.0f}".format(total_owner_balance) }}</div>
                <div class="stat-label">üìä Own's OS Bal</div>
                <div class="stat-corner" style="background: #FF007F;"></div>
            </div>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('invoices_home') }}" style="text-decoration: none;">
                <div class="stat-card" style="background: linear-gradient(135deg, rgba(255, 0, 127, 0.1) 0%, rgba(0, 0, 0, 0.95) 100%); border: 1px solid #FF007F; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(255,0,127,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div class="stat-value" style="color: #FF007F;">{{ invoices_count }}</div>
                    <div class="stat-label">üìã Supplier Invoices</div>
                    <div class="stat-corner" style="background: #FF007F;"></div>
                </div>
            </a>
        </div>
    </div>

    <!-- GZ's Financial Statistics -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.3) 0%, rgba(0, 0, 0, 0.95) 100%); border: 1px solid #322446;">
                <div class="stat-value" style="color: #322446;">RM {{ "{:,.0f}".format(total_gz_expenses) }}</div>
                <div class="stat-label" style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">üè¢ GZ's Expenses</div>
                <div class="stat-corner" style="background: #322446;"></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.3) 0%, rgba(0, 0, 0, 0.95) 100%); border: 1px solid #322446;">
                <div class="stat-value" style="color: #322446;">RM {{ "{:,.0f}".format(abs(total_gz_payments)) }}</div>
                <div class="stat-label" style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">üíµ GZ's Payment</div>
                <div class="stat-corner" style="background: #322446;"></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.3) 0%, rgba(0, 0, 0, 0.95) 100%); border: 1px solid #322446;">
                <div class="stat-value" style="color: #322446;">RM {{ "{:,.0f}".format(total_gz_balance) }}</div>
                <div class="stat-label" style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">üìà GZ's OS Bal</div>
                <div class="stat-corner" style="background: #322446;"></div>
            </div>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('invoices_home') }}" style="text-decoration: none;">
                <div class="stat-card" style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.3) 0%, rgba(0, 0, 0, 0.95) 100%); border: 1px solid #322446; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 20px rgba(50,36,70,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div class="stat-value" style="color: #322446;">RM {{ "{:,.2f}".format(invoices_total) }}</div>
                    <div class="stat-label" style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">üíº Total Invoices Amount</div>
                    <div class="stat-corner" style="background: #322446;"></div>
                </div>
            </a>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mb-5">
        <div class="col-md-12">
            <div class="content-card">
                <h3 class="card-title" style="color: #FF007F; font-weight: 700;">{{ t('quick_actions') }}</h3>
                <div class="d-flex gap-3 mt-3 flex-wrap">
                    <a href="{{ url_for('admin_customers_cards') }}" class="btn-white-glow"><i class="bi bi-credit-card-2-front"></i> {{ t('customers_credit_cards_management') }}</a>
                    <a href="{{ url_for('receipts_home') }}" class="btn-white-glow"><i class="bi bi-receipt"></i> Receipts Management</a>
                    <a href="{{ url_for('invoices_home') }}" class="btn-white-glow"><i class="bi bi-file-earmark-text"></i> Supplier Invoices</a>
                    <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-danger">{{ t('logout') }}</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Card Statements Card -->
    <div class="row g-4 mb-5">
        <div class="col-12">
            <div class="statement-card" style="border: 2px solid #FF007F;">
                <div class="card-header-custom" style="background: linear-gradient(135deg, rgba(255, 0, 127, 0.1) 0%, rgba(0, 0, 0, 0.95) 100%); border-bottom: 2px solid #FF007F;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem;">
                        <h3 class="card-title-custom" style="color: #FFFEF0; text-shadow: 0 0 10px rgba(255,254,240,0.4); font-weight: 700; margin: 0;">
                            <i class="bi bi-credit-card"></i> {{ t('credit_card_statements') }}
                        </h3>
                        <button id="exportCCTable" class="btn btn-sm" style="background: #FF007F; color: white; border: none;">
                            <i class="bi bi-download"></i> Export Excel
                        </button>
                    </div>
                </div>
                <div class="card-body-custom" style="padding: 0;">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover elegant-table" style="margin: 0; width: 100%; table-layout: auto; font-size: 0.95rem;">
                            <thead style="background: rgba(255, 0, 127, 0.1); border-bottom: 2px solid #FF007F;">
                                <tr>
                                    <th>{{ t('month_of_statement') }}</th>
                                    <th>{{ t('name') }}</th>
                                    <th>{{ t('bank') }}</th>
                                    <th style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">PRE BAL</th>
                                    <th>{{ t('due_date') }}</th>
                                    <th>{{ t('owner_expenses') }}</th>
                                    <th>{{ t('infinite_expenses') }}</th>
                                    <th>{{ t('owner_payments') }}</th>
                                    <th>{{ t('infinite_payments') }}</th>
                                    <th>{{ t('owner_os_bal') }}</th>
                                    <th>{{ t('infinite_os_bal') }}</th>
                                    <th style="text-align: center; color: #FFFFFF; text-shadow: 0 0 8px rgba(255,255,255,0.3);">{{ t('actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if cc_statements %}
                                    {% for stmt in cc_statements %}
                                    <tr class="hover-glow-row">
                                        <td style="font-weight: 600; color: #FFFFFF; text-shadow: 0 0 8px rgba(255,255,255,0.3);">{{ stmt['statement_date'][:7] }}</td>
                                        <td style="font-weight: 600;">{{ stmt['customer_name'] }}</td>
                                        <td style="font-weight: 600; color: #FFFFFF; text-shadow: 0 0 8px rgba(255,255,255,0.3);">{{ stmt['bank_abbr'] }}</td>
                                        <td style="font-weight: 600; color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">RM {{ "{:,.2f}".format(stmt['prev_bal']) }}</td>
                                        <td>{{ stmt['due_date'] if stmt['due_date'] else '-' }}</td>
                                        <td style="font-weight: 700; color: #FF007F; text-shadow: 0 0 6px rgba(255,255,255,0.25);">RM {{ "{:,.2f}".format(stmt['owner_expenses']) }}</td>
                                        <td style="font-weight: 700; color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">RM {{ "{:,.2f}".format(stmt['infinite_expenses']) }}</td>
                                        <td style="font-weight: 700; color: #FF007F; text-shadow: 0 0 6px rgba(255,255,255,0.25);">RM {{ "{:,.2f}".format(abs(stmt['owner_payments'])) }}</td>
                                        <td style="font-weight: 700; color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">RM {{ "{:,.2f}".format(abs(stmt['infinite_payments'])) }}</td>
                                        <td style="font-weight: 700; color: #FF007F; text-shadow: 0 0 6px rgba(255,255,255,0.25);">
                                            RM {{ "{:,.2f}".format(stmt['owner_os_bal']) }}
                                        </td>
                                        <td style="font-weight: 700; color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">
                                            RM {{ "{:,.2f}".format(stmt['infinite_os_bal']) }}
                                        </td>
                                        <td style="text-align: center;">
                                            <a href="{{ url_for('monthly_statement_detail', monthly_statement_id=stmt['statement_id']) }}" 
                                               class="btn btn-sm btn-view-details"
                                               style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); 
                                                      border: 2px solid #FF007F; 
                                                      color: #FFFFFF;
                                                      text-shadow: 0 0 8px rgba(255,255,255,0.3);
                                                      font-weight: 600;
                                                      padding: 0.25rem 0.75rem;">
                                                {{ t('view_details') }}
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="12" style="text-align: center; padding: 3rem; color: #999;">
                                            {{ t('no_cc_statements_found') }}
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bank Account Statements Card -->
    <div class="row g-4 mb-5">
        <div class="col-12">
            <div class="statement-card" style="border: 2px solid #322446;">
                <div class="card-header-custom" style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.3) 0%, rgba(0, 0, 0, 0.95) 100%); border-bottom: 2px solid #322446;">
                    <h3 class="card-title-custom" style="color: #FFFEF0; text-shadow: 0 0 10px rgba(255,254,240,0.4); font-weight: 700; margin: 0; padding: 1.5rem;">
                        <i class="bi bi-bank"></i> {{ t('bank_account_statements') }}
                    </h3>
                </div>
                <div class="card-body-custom" style="padding: 0;">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover elegant-table" style="margin: 0; width: 100%; table-layout: auto; font-size: 0.95rem;">
                            <thead style="background: rgba(50, 36, 70, 0.3); border-bottom: 2px solid #322446;">
                                <tr>
                                    <th style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ t('month_of_statement') }}</th>
                                    <th style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ t('name') }}</th>
                                    <th style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ t('bank') }}</th>
                                    <th style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ t('monthly_credit') }}</th>
                                    <th style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ t('monthly_debit') }}</th>
                                    <th style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ t('closing_bal') }}</th>
                                    <th style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ t('cc_sum_payment') }}</th>
                                    <th style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ t('total_transfer') }}</th>
                                    <th style="text-align: center; color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ t('actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if sa_statements %}
                                    {% for stmt in sa_statements %}
                                    <tr class="hover-glow-row">
                                        <td style="font-weight: 600; color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ stmt['statement_date'][:7] }}</td>
                                        <td style="font-weight: 600; color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ stmt['customer_name'] }}</td>
                                        <td style="font-weight: 600; color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">{{ stmt['bank_abbr'] }}</td>
                                        <td style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">RM {{ "{:,.2f}".format(stmt['monthly_credit']) }}</td>
                                        <td style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">RM {{ "{:,.2f}".format(stmt['monthly_debit']) }}</td>
                                        <td style="font-weight: 600; color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">RM {{ "{:,.2f}".format(stmt['closing_bal'] if stmt['closing_bal'] else 0) }}</td>
                                        <td style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">RM {{ "{:,.2f}".format(stmt['cc_sum_payment']) }}</td>
                                        <td style="color: #FFFEF0; text-shadow: 0 0 8px rgba(255,254,240,0.3);">RM {{ "{:,.2f}".format(stmt['total_transfer']) }}</td>
                                        <td style="text-align: center;">
                                            <a href="{{ url_for('savings_verify_statement', statement_id=stmt['statement_id']) }}" 
                                               class="btn btn-sm btn-view-details"
                                               style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); 
                                                      border: 2px solid #322446; 
                                                      color: #FFFEF0;
                                                      text-shadow: 0 0 8px rgba(255,254,240,0.3);
                                                      font-weight: 600;
                                                      padding: 0.25rem 0.75rem;">
                                                {{ t('view_details') }}
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="9" style="text-align: center; padding: 3rem; color: #999;">
                                            {{ t('no_sa_statements_found') }}
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-card {
    background: linear-gradient(135deg, rgba(15, 15, 15, 0.95) 0%, rgba(26, 26, 26, 0.95) 100%);
    border: 1px solid rgba(192, 192, 192, 0.2);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.stat-value {
    font-family: 'Montserrat', sans-serif;
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #FFFFFF 0%, rgba(192, 192, 192, 0.9) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #A1A1AA;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stat-corner {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, transparent 50%, rgba(255, 255, 255, 0.05) 50%);
}

.statement-card {
    background: #000000;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}

.elegant-table {
    background: #000000;
}

.elegant-table thead th {
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.9rem;
    padding: 1.2rem;
    border: none;
    white-space: nowrap;
}

.elegant-table tbody td {
    padding: 1rem 1.2rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    vertical-align: middle;
    white-space: nowrap;
}

.hover-glow-row {
    transition: all 0.3s ease;
}

.hover-glow-row:hover {
    background: rgba(255, 255, 255, 0.03) !important;
    transform: translateX(5px);
}

.btn-view-details {
    transition: all 0.3s ease;
    white-space: nowrap;
}

.btn-view-details:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 0, 127, 0.4);
}

.datatable-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background: rgba(255, 255, 255, 0.02);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.datatable-pagination {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.datatable-pagination button {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.datatable-pagination button:hover:not(:disabled) {
    background: rgba(255, 0, 127, 0.2);
    border-color: #FF007F;
}

.datatable-pagination button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.datatable-pagination button.active {
    background: #FF007F;
    border-color: #FF007F;
}
</style>

<script>
// Simple DataTable Implementation with Pagination and Export
class SimpleDataTable {
    constructor(tableId, options = {}) {
        this.table = document.getElementById(tableId);
        this.currentPage = 1;
        this.rowsPerPage = options.rowsPerPage || 25;
        this.rows = [];
        this.init();
    }

    init() {
        if (!this.table) return;
        
        // Get all rows except header
        const tbody = this.table.querySelector('tbody');
        if (!tbody) return;
        
        this.rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Add controls
        this.addControls();
        
        // Display first page
        this.displayPage(1);
    }

    addControls() {
        const wrapper = this.table.closest('.table-responsive');
        if (!wrapper) return;

        const controls = document.createElement('div');
        controls.className = 'datatable-controls';
        controls.innerHTML = `
            <div>
                <span style="color: #999;">Show: </span>
                <select id="${this.table.id}_pageSize" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 0.25rem 0.5rem; border-radius: 4px;">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="-1">All</option>
                </select>
                <span style="color: #999; margin-left: 1rem;">entries</span>
            </div>
            <div id="${this.table.id}_pagination" class="datatable-pagination"></div>
        `;
        
        wrapper.insertBefore(controls, this.table);

        // Page size change handler
        document.getElementById(`${this.table.id}_pageSize`).addEventListener('change', (e) => {
            this.rowsPerPage = parseInt(e.target.value);
            this.currentPage = 1;
            this.displayPage(1);
        });
    }

    displayPage(page) {
        const totalRows = this.rows.length;
        const totalPages = this.rowsPerPage === -1 ? 1 : Math.ceil(totalRows / this.rowsPerPage);
        
        this.currentPage = Math.max(1, Math.min(page, totalPages));

        // Hide all rows first
        this.rows.forEach(row => row.style.display = 'none');

        // Show rows for current page
        if (this.rowsPerPage === -1) {
            // Show all
            this.rows.forEach(row => row.style.display = '');
        } else {
            const start = (this.currentPage - 1) * this.rowsPerPage;
            const end = start + this.rowsPerPage;
            
            for (let i = start; i < end && i < totalRows; i++) {
                this.rows[i].style.display = '';
            }
        }

        // Update pagination buttons
        this.updatePagination(totalPages);
    }

    updatePagination(totalPages) {
        const paginationDiv = document.getElementById(`${this.table.id}_pagination`);
        if (!paginationDiv) return;

        let html = '';
        
        // Previous button
        html += `<button ${this.currentPage === 1 ? 'disabled' : ''} onclick="window.${this.table.id}_dt.displayPage(${this.currentPage - 1})">‚Äπ Prev</button>`;
        
        // Page numbers
        const maxButtons = 5;
        let startPage = Math.max(1, this.currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);
        
        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<button class="${i === this.currentPage ? 'active' : ''}" onclick="window.${this.table.id}_dt.displayPage(${i})">${i}</button>`;
        }
        
        // Next button
        html += `<button ${this.currentPage === totalPages ? 'disabled' : ''} onclick="window.${this.table.id}_dt.displayPage(${this.currentPage + 1})">Next ‚Ä∫</button>`;
        
        paginationDiv.innerHTML = html;
    }
}

// Export to Excel (CSV format)
function exportTableToExcel(tableId, filename = 'export.csv') {
    const table = document.getElementById(tableId);
    if (!table) return;

    const rows = table.querySelectorAll('tr');
    const csv = [];

    rows.forEach(row => {
        const cols = row.querySelectorAll('td, th');
        const rowData = [];
        
        cols.forEach(col => {
            // Clean text and handle special characters
            let text = col.innerText || col.textContent;
            text = text.replace(/"/g, '""'); // Escape quotes
            
            // Skip "View Details" buttons
            if (!text.includes('View Details')) {
                rowData.push(`"${text}"`);
            }
        });
        
        if (rowData.length > 0) {
            csv.push(rowData.join(','));
        }
    });

    // Create download link
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize datatables
    window.ccStatementsTable_dt = new SimpleDataTable('ccStatementsTable', { rowsPerPage: 25 });
    
    // Export button handlers
    document.getElementById('exportCCTable')?.addEventListener('click', function() {
        exportTableToExcel('ccStatementsTable', 'Credit_Card_Statements.csv');
    });
});
</script>
{% endblock %}
