<div id="ai-chatbox" style="position:fixed;bottom:40px;right:40px;z-index:9999;">
  <button id="chat-toggle" style="background:#ff007f;color:#fff;border:none;border-radius:999px;padding:12px 18px;font-weight:700;box-shadow:0 0 18px rgba(255,0,127,0.6);">
    智能顾问
  </button>
  <div id="chat-window" style="display:none;width:340px;height:460px;background:#111;border:1px solid #ff007f;border-radius:16px;padding:10px;color:#fff;">
    <div id="chat-log" style="height:360px;overflow-y:auto;font-size:14px;line-height:1.5;"></div>
    <div style="display:flex;gap:6px;margin-top:6px;">
      <input id="chat-input" placeholder="输入您的问题..." 
             style="flex:1;padding:8px;border-radius:10px;border:none;color:#fff;background:#222;">
      <button id="sys-analyze" 
              style="background:#ff007f;border:none;border-radius:10px;padding:8px 10px;color:#fff;">
        系统分析
      </button>
    </div>
  </div>
</div>

<script>
const toggle=document.getElementById("chat-toggle");
const win=document.getElementById("chat-window");
const log=document.getElementById("chat-log");
const input=document.getElementById("chat-input");
const analyze=document.getElementById("sys-analyze");

toggle.onclick=()=>{
  win.style.display=win.style.display==="none"||win.style.display===""?"block":"none";
};

async function send(msg,endpoint){
  log.innerHTML+=`<div><b>用户：</b>${msg}</div>`;
  try{
    const r=await fetch(endpoint,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({query:msg})
    });
    const d=await r.json();
    log.innerHTML+=`<div style='color:#ff007f;'><b>AI：</b>${d.reply||d.analysis||d.error}</div>`;
  }catch(e){
    log.innerHTML+=`<div style='color:#ff4444;'>错误：${e.message}</div>`;
  }
  log.scrollTop=log.scrollHeight;
}

input.addEventListener("keypress",e=>{
  if(e.key==="Enter"&&input.value.trim()!==""){
    send(input.value,"/api/ai-assistant/query");
    input.value="";
  }
});

analyze.onclick=()=>send("请分析整个系统的资金健康状况","/api/ai-assistant/analyze-system");
</script>
