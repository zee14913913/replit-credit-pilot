<!-- AIæ™ºèƒ½åŠ©æ‰‹èŠå¤©çª—å£ -->
<div id="ai-chatbox" style="position:fixed;bottom:40px;right:40px;z-index:9999;">
  <!-- è§¦å‘æŒ‰é’® -->
  <button id="chat-toggle" 
    style="background:#ff007f;color:#fff;border:none;border-radius:999px;padding:14px 22px;font-weight:700;box-shadow:0 0 20px rgba(255,0,127,0.7);cursor:pointer;transition:all 0.3s;font-size:15px;">
    ğŸ’¬ æ™ºèƒ½é¡¾é—®
  </button>
  
  <!-- èŠå¤©çª—å£ -->
  <div id="chat-window" 
    style="display:none;width:380px;height:520px;background:#1a1a1a;border:2px solid #ff007f;border-radius:18px;padding:16px;color:#fff;box-shadow:0 8px 32px rgba(0,0,0,0.5);margin-bottom:10px;">
    
    <!-- æ ‡é¢˜æ  -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #ff007f;">
      <h4 style="margin:0;color:#ff007f;font-size:16px;">ğŸ¤– CreditPilot æ™ºèƒ½é¡¾é—®</h4>
      <button id="chat-close" 
        style="background:transparent;border:none;color:#fff;cursor:pointer;font-size:18px;">âœ•</button>
    </div>
    
    <!-- å¯¹è¯æ—¥å¿—åŒºåŸŸ -->
    <div id="chat-log" 
      style="height:360px;overflow-y:auto;font-size:13px;line-height:1.6;padding:8px;background:#0a0a0a;border-radius:8px;margin-bottom:12px;">
      <div style="color:#888;text-align:center;padding:20px;">
        æ¬¢è¿ä½¿ç”¨æ™ºèƒ½è´¢åŠ¡é¡¾é—®ï¼<br>
        æ‚¨å¯ä»¥è¯¢é—®å…³äºå‚¨è“„è´¦æˆ·ã€ä¿¡ç”¨å¡ã€è´·æ¬¾çš„ä»»ä½•é—®é¢˜ã€‚
      </div>
    </div>
    
    <!-- å¿«æ·æŒ‰é’® -->
    <div style="display:flex;gap:6px;margin-bottom:10px;">
      <button id="sys-analyze" 
        style="flex:1;background:#322446;border:none;border-radius:10px;padding:10px;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:background 0.3s;">
        ğŸ“Š ç³»ç»Ÿåˆ†æ
      </button>
      <button id="clear-chat" 
        style="background:#444;border:none;border-radius:10px;padding:10px 12px;color:#fff;cursor:pointer;font-size:12px;">
        ğŸ—‘ï¸
      </button>
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div style="display:flex;gap:8px;">
      <input id="chat-input" 
        placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
        style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid #322446;color:#fff;background:#222;font-size:13px;"
        autocomplete="off">
      <button id="chat-send" 
        style="background:#ff007f;border:none;border-radius:10px;padding:10px 16px;color:#fff;cursor:pointer;font-weight:600;">
        å‘é€
      </button>
    </div>
    
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="chat-loading" style="display:none;text-align:center;margin-top:10px;color:#ff007f;font-size:12px;">
      <span class="spinner">â³</span> AIæ­£åœ¨æ€è€ƒ...
    </div>
  </div>
</div>

<style>
/* æŒ‰é’®æ‚¬åœæ•ˆæœ */
#chat-toggle:hover {
  transform: scale(1.05);
  box-shadow: 0 0 30px rgba(255,0,127,0.9);
}

#sys-analyze:hover {
  background: #ff007f;
}

#chat-send:hover {
  background: #cc0066;
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
#chat-log::-webkit-scrollbar {
  width: 6px;
}

#chat-log::-webkit-scrollbar-track {
  background: #1a1a1a;
}

#chat-log::-webkit-scrollbar-thumb {
  background: #ff007f;
  border-radius: 3px;
}

/* æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
.user-message {
  background: #322446;
  padding: 8px 12px;
  border-radius: 12px;
  margin: 8px 0;
  max-width: 80%;
  margin-left: auto;
  text-align: right;
}

.ai-message {
  background: #1a3a3a;
  padding: 8px 12px;
  border-radius: 12px;
  margin: 8px 0;
  max-width: 80%;
  border-left: 3px solid #ff007f;
}

.system-message {
  background: #2a2a2a;
  padding: 8px 12px;
  border-radius: 12px;
  margin: 8px 0;
  text-align: center;
  font-size: 12px;
  color: #888;
}

.spinner {
  display: inline-block;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>

<script>
// AIèŠå¤©çª—å£é€»è¾‘
(function() {
  const toggle = document.getElementById("chat-toggle");
  const win = document.getElementById("chat-window");
  const closeBtn = document.getElementById("chat-close");
  const log = document.getElementById("chat-log");
  const input = document.getElementById("chat-input");
  const sendBtn = document.getElementById("chat-send");
  const analyze = document.getElementById("sys-analyze");
  const clear = document.getElementById("clear-chat");
  const loading = document.getElementById("chat-loading");
  
  // åˆ‡æ¢èŠå¤©çª—å£æ˜¾ç¤º
  toggle.onclick = () => {
    if (win.style.display === "none") {
      win.style.display = "block";
      input.focus();
    } else {
      win.style.display = "none";
    }
  };
  
  closeBtn.onclick = () => {
    win.style.display = "none";
  };
  
  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°æ—¥å¿—
  function addUserMessage(msg) {
    const div = document.createElement('div');
    div.className = 'user-message';
    div.innerHTML = `<b>æ‚¨ï¼š</b> ${escapeHtml(msg)}`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }
  
  // æ·»åŠ AIæ¶ˆæ¯åˆ°æ—¥å¿—
  function addAIMessage(msg) {
    const div = document.createElement('div');
    div.className = 'ai-message';
    div.innerHTML = `<b>AIï¼š</b> ${formatMessage(msg)}`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }
  
  // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
  function addSystemMessage(msg) {
    const div = document.createElement('div');
    div.className = 'system-message';
    div.textContent = msg;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }
  
  // HTMLè½¬ä¹‰
  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
  }
  
  // æ ¼å¼åŒ–æ¶ˆæ¯ï¼ˆæ”¯æŒæ¢è¡Œï¼‰
  function formatMessage(text) {
    return escapeHtml(text).replace(/\n/g, '<br>');
  }
  
  // å‘é€æ¶ˆæ¯åˆ°AI
  async function sendMessage(msg, endpoint) {
    if (!msg || !msg.trim()) {
      addSystemMessage('è¯·è¾“å…¥é—®é¢˜');
      return;
    }
    
    addUserMessage(msg);
    loading.style.display = 'block';
    
    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      });
      
      const data = await response.json();
      
      if (data.error) {
        addAIMessage(`âŒ é”™è¯¯: ${data.error}`);
      } else {
        const reply = data.reply || data.analysis || 'æœªæ”¶åˆ°å›å¤';
        addAIMessage(reply);
      }
    } catch (error) {
      addAIMessage(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
    } finally {
      loading.style.display = 'none';
    }
  }
  
  // å‘é€æŒ‰é’®ç‚¹å‡»
  sendBtn.onclick = () => {
    const msg = input.value.trim();
    if (msg) {
      sendMessage(msg, '/api/ai-assistant/query');
      input.value = '';
    }
  };
  
  // å›è½¦å‘é€
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const msg = input.value.trim();
      if (msg) {
        sendMessage(msg, '/api/ai-assistant/query');
        input.value = '';
      }
    }
  });
  
  // ç³»ç»Ÿåˆ†ææŒ‰é’®
  analyze.onclick = () => {
    addSystemMessage('æ­£åœ¨ç”Ÿæˆå…¨å±€è´¢åŠ¡åˆ†ææŠ¥å‘Š...');
    sendMessage('è¯·åˆ†ææ•´ä¸ªç³»ç»Ÿçš„è´¢åŠ¡çŠ¶å†µ', '/api/ai-assistant/analyze-system');
  };
  
  // æ¸…ç©ºå¯¹è¯
  clear.onclick = () => {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºå¯¹è¯è®°å½•å—ï¼Ÿ')) {
      log.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">å¯¹è¯å·²æ¸…ç©º</div>';
    }
  };
})();
</script>
