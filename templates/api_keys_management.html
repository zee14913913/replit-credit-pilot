{% extends "base.html" %}

{% block title %}{{ t('api_5') }} - {{ t('system_name') }}{% endblock %}

{% block content %}
<div class="galaxy-container">
    <div class="galaxy-header">
        <h1 class="galaxy-title">
            <i class="bi bi-key-fill"></i> {{ t('api_5') }}
        </h1>
        <p class="galaxy-subtitle">{{ t('api') }}</p>
    </div>

    <!-- {{ t('api_10') }}密钥按钮 -->
    <div class="mb-4">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createApiKeyModal">
            <i class="bi bi-plus-circle"></i> <span data-i18n="create_new_key">{{ t('create_new_key') }}</span>
        </button>
        <button class="btn btn-outline-secondary ms-2" onclick="refreshApiKeys()">
            <i class="bi bi-arrow-clockwise"></i> <span data-i18n="refresh">{{ t('refresh') }}</span>
        </button>
    </div>

    <!-- {{ t('api_11') }} -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="bi bi-list-ul"></i> <span data-i18n="key_list">{{ t('key_list') }}</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="showInactive" onchange="refreshApiKeys()">
                <label class="form-check-label" for="showInactive" data-i18n="show_revoked_keys">
                    {{ t('show_revoked_keys') }}
                </label>
            </div>

            <div id="apiKeysContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{{ t('auto_text_66') }}</span>
                    </div>
                    <p class="mt-2">{{ t('api_1') }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- {{ t('api_10') }}密钥模态框 -->
<div class="modal fade" id="createApiKeyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-key-fill"></i> <span data-i18n="create_api_key_modal_title">{{ t('create_api_key_modal_title') }}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createApiKeyForm">
                    <div class="mb-3">
                        <label for="keyName" class="form-label">{{ t('__10') }}</label>
                        <input type="text" class="form-control" id="keyName" required 
                               placeholder="{{ t('production_api_key') }}">
                        <div class="form-text">{{ t('auto_text_294') }}</div>
                    </div>

                    <div class="mb-3">
                        <label for="keyEnvironment" class="form-label">{{ t('__11') }}</label>
                        <select class="form-select" id="keyEnvironment" required>
                            <option value="{{ t('live_2') }}">{{ t('live') }}</option>
                            <option value="{{ t('test_2') }}" selected>{{ t('test') }}</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><span data-i18n="permissions">{{ t('permissions') }}</span> * <small class="text-muted">{{ t('auto_text_297') }}</small></label>
                        <div class="border rounded p-3">
                            <!-- 补充改进④：默认权限 - 上传 -->
                            <div class="bg-light p-2 mb-2 rounded">
                                <strong data-i18n="default_permission">{{ t('default_permission') }}</strong>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{ t('uploadbank_statements') }}" id="perm0" checked disabled>
                                <label class="form-check-label" for="perm0">
                                    <i class="bi bi-upload"></i> <span data-i18n="upload_bank_statement">{{ t('upload_bank_statement') }}</span> <span class="badge bg-success">{{ t('auto_text_300') }}</span>
                                </label>
                            </div>
                            
                            <hr class="my-2">
                            
                            <!-- 补充改进④：需要单独授权的权限 - 导出 -->
                            <div class="bg-light p-2 mb-2 rounded">
                                <strong data-i18n="requires_authorization">{{ t('requires_authorization') }}</strong>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{ t('exportbank_statements') }}" id="perm1">
                                <label class="form-check-label" for="perm1">
                                    <i class="bi bi-download"></i> <span data-i18n="export_bank_statement">{{ t('export_bank_statement') }}</span> <span class="badge bg-warning">{{ t('auto_text_303') }}</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{ t('exportinvoices') }}" id="perm2">
                                <label class="form-check-label" for="perm2">
                                    <i class="bi bi-download"></i> <span data-i18n="export_invoice">{{ t('export_invoice') }}</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{ t('exportjournal_entries') }}" id="perm3">
                                <label class="form-check-label" for="perm3">
                                    <i class="bi bi-download"></i> <span data-i18n="export_journal_entry">{{ t('export_journal_entry') }}</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{ t('readaudit_logs') }}" id="perm4">
                                <label class="form-check-label" for="perm4">
                                    <i class="bi bi-eye"></i> <span data-i18n="read_audit_log">{{ t('read_audit_log') }}</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> <span data-i18n="key_default_upload_only">{{ t('key_default_upload_only') }}</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="rateLimit" class="form-label">{{ t('auto_text_308') }}</label>
                        <input type="number" class="form-control" id="rateLimit" value="60" min="1" max="1000" required>
                        <div class="form-text">{{ t('auto_text_309') }}</div>
                    </div>

                    <div class="mb-3">
                        <label for="expiresInDays" class="form-label">{{ t('auto_text_310') }}</label>
                        <input type="number" class="form-control" id="expiresInDays" placeholder="{{ t('auto_text_367') }}" min="1">
                        <div class="form-text">{{ t('auto_text_311') }}</div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>{{ t('auto_text_312') }}</strong><span data-i18n="key_shown_once">{{ t('key_shown_once') }}</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('auto_text_314') }}</button>
                <button type="button" class="btn btn-primary" onclick="createApiKey()">
                    <i class="bi bi-plus-circle"></i> <span data-i18n="create_key_button">{{ t('create_key_button') }}</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- {{ t('api_14') }}密钥模态框 -->
<div class="modal fade" id="showApiKeyModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle-fill"></i> {{ t('api_8') }}
                </h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>{{ t('auto_text_317') }}</strong><span data-i18n="key_shown_only_this_time">{{ t('key_shown_only_this_time') }}</span>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">{{ t('api_2') }}</label>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace" id="newApiKey" readonly>
                        <button class="btn btn-outline-primary" onclick="copyApiKey()">
                            <i class="bi bi-clipboard"></i> <span data-i18n="copy_button">{{ t('copy_button') }}</span>
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ t('auto_text_320') }}</label>
                    <p id="newApiKeyName" class="mb-0"></p>
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ t('auto_text_321') }}</label>
                    <p id="newApiKeyEnv" class="mb-0"></p>
                </div>

                <div class="mb-3">
                    <label class="form-label">{{ t('auto_text_322') }}</label>
                    <p id="newApiKeyRate" class="mb-0"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="refreshApiKeys()">
                    <span data-i18n="saved_and_close">{{ t('saved_and_close') }}</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- {{ t('api_15') }}密钥模态框 -->
<div class="modal fade" id="revokeApiKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-x-circle-fill"></i> {{ t('api_15') }}密钥
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><span data-i18n="confirm_revoke_key">{{ t('confirm_revoke_key') }}</span> <strong id="revokeKeyName"></strong> 吗？</p>
                <p class="text-danger">{{ t('api_3') }}</p>

                <div class="mb-3">
                    <label for="revokeReason" class="form-label">{{ t('__13') }}</label>
                    <textarea class="form-control" id="revokeReason" rows="3" required 
                              placeholder="{{ t('auto_text_368') }}"></textarea>
                    <div class="form-text">{{ t('auto_text_328') }}</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('auto_text_314') }}</button>
                <button type="button" class="btn btn-danger" onclick="confirmRevokeApiKey()">
                    <i class="bi bi-x-circle"></i> <span data-i18n="confirm_revoke_button">{{ t('confirm_revoke_button') }}</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// {{ t('let_currentrevokekeyid__null_api_base_url_') }}递，支持生产环境配置)
// 使用tojson过滤器确保安全的JSON编码
const API_BASE_URL = {{ api_base_url|tojson }};

// {{ t('apidocumentaddeventlistener') }}('DOMContentLoaded', function() {
    refreshApiKeys();
});

// {{ t('apiasync_function_refreshapikeys') }}() {
    const container = document.getElementById('apiKeysContainer');
    const includeInactive = document.getElementById('showInactive').checked;
    
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">{{ t('auto_text_66') }}</span>
            </div>
            <p class="mt-2">{{ t('api_1') }}</p>
        </div>
    `;

    try {
        const response = await fetch(`${API_BASE_URL || ''}/api/api-keys/?include_inactive=${includeInactive}`, {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const keys = await response.json();

        if (keys.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-key" style="font-size: 3rem;"></i>
                    <p class="mt-3">{{ t('api_4') }}</p>
                    <p>{{ t('auto_text_331') }}</p>
                </div>
            `;
            return;
        }

        // {{ t('________let_html') }} = '<div class="table-responsive"><table class="table table-hover">';
        html += `
            <thead class="table-dark">
                <tr>
                    <th>{{ t('auto_text_334') }}</th>
                    <th>{{ t('auto_text_335') }}</th>
                    <th>{{ t('auto_text_336') }}</th>
                    <th>{{ t('auto_text_337') }}</th>
                    <th>{{ t('auto_text_338') }}</th>
                    <th>{{ t('auto_text_339') }}</th>
                    <th>{{ t('auto_text_340') }}</th>
                    <th>{{ t('auto_text_341') }}</th>
                    <th>{{ t('auto_text_342') }}</th>
                </tr>
            </thead>
            <tbody>
        `;

        keys.forEach(key => {
            const statusBadge = key.is_active 
                ? '<span class="badge bg-success">{{ t('auto_text_344') }}</span>' 
                : '<span class="badge bg-secondary">{{ t('auto_text_345') }}</span>{{ t('________________________const_lastused__keylast_us') }}<span class="text-muted">{{ t('auto_text_347') }}</span>{{ t('____________const_createdat__new_datekeycreated_at') }}<span class="text-muted">无</span>{{ t('____________const_envbadge__keyenvironment__live__') }}<span class="badge bg-danger">{{ t('live_1') }}</span>'
                : '<span class="badge bg-info">{{ t('test_1') }}</span>{{ t('____________const_actions__keyis_active___________') }}<button class="btn btn-sm btn-danger" onclick="showRevokeModal(${key.id}, \'${key.name}\')">
                       <i class="bi bi-x-circle"></i> <span data-i18n="revoke_button">{{ t('revoke_button') }}</span>
                   </button>`
                : '<span class="text-muted">{{ t('auto_text_345') }}</span>';

            html += `
                <tr>
                    <td><strong>{{ t('keyname') }}</strong></td>
                    <td><code class="text-primary">{{ t('keykey_prefix') }}</code></td>
                    <td>{{ t('envbadge') }}</td>
                    <td><small>{{ t('permissions') }}</small></td>
                    <td>{{ t('keyrate_limit') }}</td>
                    <td>{{ t('statusbadge') }}</td>
                    <td><small>{{ t('lastused') }}</small></td>
                    <td><small>{{ t('createdat') }}</small></td>
                    <td>{{ t('actions_2') }}</td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

    } catch (error) {
        console.error('Failed to load API keys:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>{{ t('auto_text_355') }}</strong>${error.message}
            </div>
        `;
    }
}

// {{ t('apiasync_function_createapikey') }}() {
    // {{ t('____const_permissions') }} = ['upload:bank_statements'];  // {{ t('_____________documentqueryselectorall') }}('#createApiKeyForm input[type="checkbox"]:checked:not([disabled])').forEach(checkbox => {
        if (!permissions.includes(checkbox.value)) {
            permissions.push(checkbox.value);
        }
    });

    // {{ t('uploadbank_statements____consolelog') }}('{{ t('__api') }}密钥权限:', permissions);

    const data = {
        name: document.getElementById('keyName').value,
        environment: document.getElementById('keyEnvironment').value,
        permissions: permissions,
        rate_limit: parseInt(document.getElementById('rateLimit').value),
        expires_in_days: document.getElementById('expiresInDays').value 
            ? parseInt(document.getElementById('expiresInDays').value) 
            : null
    };

    try {
        const response = await fetch(`${API_BASE_URL || ''}/api/api-keys/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || `HTTP ${response.status}`);
        }

        {{ t('const_result__await_responsejson_________') }}
        const createModal = bootstrap.Modal.getInstance(document.getElementById('createApiKeyModal'));
        {{ t('createmodalhide_________') }}
        document.getElementById('newApiKey').value = result.api_key;
        document.getElementById('newApiKeyName').textContent = result.name;
        document.getElementById('newApiKeyEnv').textContent = result.environment === 'live' ? '{{ t('live_3') }}）' : '{{ t('test_3') }}）';
        const t = (key, fallback) => window.i18n ? window.i18n.translate(key) : fallback;
        document.getElementById('newApiKeyRate').textContent = `${data.rate_limit} ${t('requests_per_minute', '请求/分钟')}`;

        const showModal = new bootstrap.Modal(document.getElementById('showApiKeyModal'));
        {{ t('showmodalshow_________') }}
        document.getElementById('createApiKeyForm').reset();

    } catch (error) {
        const t = (key, fallback) => window.i18n ? window.i18n.translate(key) : fallback;
        alert(`${t('creation_failed_prefix', '创建失败：')}${error.message}`);
    }
}

// {{ t('apifunction_copyapikey') }}() {
    const input = document.getElementById('newApiKey');
    input.select();
    document.execCommand('copy');
    
    const t = (key, fallback) => window.i18n ? window.i18n.translate(key) : fallback;
    // {{ t('____const_btn__eventtargetclosest') }}('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = `<i class="bi bi-check"></i> ${t('copied', '已复制')}`;
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-success');
    
    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-primary');
    }, 2000);
}

// {{ t('function_showrevokemodalkeyid_keyname') }}) {
    currentRevokeKeyId = keyId;
    document.getElementById('revokeKeyName').textContent = keyName;
    document.getElementById('revokeReason').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('revokeApiKeyModal'));
    modal.show();
}

// {{ t('apiasync_function_confirmrevokeapikey') }}() {
    const reason = document.getElementById('revokeReason').value.trim();
    const t = (key, fallback) => window.i18n ? window.i18n.translate(key) : fallback;
    
    if (!reason) {
        alert(t('please_fill_revoke_reason', '请填写撤销原因'));
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL || ''}/api/api-keys/${currentRevokeKeyId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ reason: reason })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || `HTTP ${response.status}`);
        }

        // {{ t('________const_modal__bootstrapmodalgetinstancedocu') }}ment.getElementById('revokeApiKeyModal'));
        {{ t('modalhide_________') }}
        refreshApiKeys();

        alert('{{ t('api_16') }}');

    } catch (error) {
        const t = (key, fallback) => window.i18n ? window.i18n.translate(key) : fallback;
        alert(`${t('revoke_failed_prefix', '撤销失败：')}${error.message}`);
    }
}
</script>

<style>
.font-monospace {
    font-family: 'Courier New', monospace;
}
</style>

{% endblock %}
