{% extends "base.html" %}

{% block title %}Monthly Reports - {{ customer.name }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="section-header">
        <h1 class="section-title">
            <i class="bi bi-file-earmark-bar-graph"></i> Monthly Statement Reports
        </h1>
        <p class="section-subtitle">月度账单汇总报表 - {{ customer.name }}</p>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-value">{{ reports|length }}</div>
                <div class="stat-label">Total Reports / 报表总数</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-value">RM {{ "{:,.2f}".format(reports|sum(attribute='total_debit')|default(0)) }}</div>
                <div class="stat-label">Total Debit / 总消费</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="stat-value">RM {{ "{:,.2f}".format(reports|sum(attribute='supplier_fees')|default(0)) }}</div>
                <div class="stat-label">Total Supplier Fees / 商家费用总计</div>
            </div>
        </div>
    </div>

    <!-- Generate New Report -->
    <div class="mb-5">
        <div class="professional-card">
            <h3 style="color: var(--text-primary); margin-bottom: 1rem;">
                <i class="bi bi-plus-circle"></i> Generate New Monthly Report / 生成新月度报表
            </h3>
            <form id="generateReportForm" method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label" style="color: var(--text-secondary);">Year / 年份</label>
                    <select id="reportYear" name="year" class="form-select" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" style="color: var(--text-secondary);">Month / 月份</label>
                    <select id="reportMonth" name="month" class="form-select" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if m == 9 %}selected{% endif %}>{{ m }}月</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn-professional w-100">
                        <i class="bi bi-play-circle"></i> Generate Report / 生成报表
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reports List -->
    <div>
        <h3 class="mb-4" style="color: var(--text-primary);">
            <i class="bi bi-list-ul"></i> All Monthly Reports / 所有月度报表
        </h3>
        
        {% if reports %}
        <div class="professional-card">
            <div class="table-responsive">
                <table class="table-professional">
                    <thead>
                        <tr>
                            <th>Period / 报表期间</th>
                            <th class="text-end">Total Debit / 消费总计</th>
                            <th class="text-end">Total Credit / 付款总计</th>
                            <th class="text-end">Instalment / 分期</th>
                            <th class="text-end">Net Amount / 净额</th>
                            <th class="text-end">DSR</th>
                            <th class="text-end">Supplier Fees / 商家费用</th>
                            <th class="text-end">Generated / 生成时间</th>
                            <th class="text-center">Actions / 操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr>
                            <td>
                                <div style="font-weight: 600; color: var(--text-primary);">
                                    {{ report.report_year }}-{{ "%02d"|format(report.report_month) }}
                                </div>
                            </td>
                            <td class="text-end" style="color: var(--text-primary);">
                                RM {{ "{:,.2f}".format(report.total_debit) }}
                            </td>
                            <td class="text-end" style="color: var(--accent-success);">
                                RM {{ "{:,.2f}".format(report.total_credit) }}
                            </td>
                            <td class="text-end" style="color: var(--text-primary);">
                                RM {{ "{:,.2f}".format(report.total_instalment) }}
                            </td>
                            <td class="text-end" style="font-weight: 600; color: {{ 'var(--text-danger)' if report.net_amount > 0 else 'var(--accent-success)' }};">
                                RM {{ "{:,.2f}".format(report.net_amount) }}
                            </td>
                            <td class="text-end">
                                <span class="badge-professional {{ 'badge-danger-pro' if report.dsr >= 70 else 'badge-success-pro' if report.dsr < 50 else 'badge-warning-pro' }}">
                                    {{ "%.1f"|format(report.dsr) }}%
                                </span>
                            </td>
                            <td class="text-end" style="color: var(--accent-success); font-weight: 600;">
                                RM {{ "{:,.2f}".format(report.supplier_fees) }}
                            </td>
                            <td class="text-end" style="color: var(--text-secondary); font-size: 0.9rem;">
                                {{ report.generated_at[:10] }}
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('download_monthly_report', report_id=report.id) }}" 
                                   class="btn-professional-sm">
                                    <i class="bi bi-download"></i> Download PDF
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="professional-card text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i>
            <p style="color: var(--text-secondary); margin-top: 1rem;">
                No monthly reports yet. Generate your first report above.<br>
                暂无月度报表，请在上方生成第一份报表。
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Back Button -->
    <div class="mt-5">
        <a href="{{ url_for('customer_dashboard', customer_id=customer.id) }}" class="btn-professional-outline">
            <i class="bi bi-arrow-left"></i> Back to Dashboard / 返回仪表板
        </a>
    </div>
</div>

<script>
// Form submission handler
document.getElementById('generateReportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const year = document.getElementById('reportYear').value;
    const month = document.getElementById('reportMonth').value;
    const customerId = {{ customer.id }};
    window.location.href = `/customer/${customerId}/generate-monthly-report/${year}/${month}`;
});
</script>
{% endblock %}
