{% extends "base.html" %}

{% block title %}Monthly Reports - {{ customer.name }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="section-header">
        <h1 class="section-title">
            <i class="bi bi-file-earmark-bar-graph"></i> Monthly Statement Reports
        </h1>
        <p class="section-subtitle">æœˆåº¦è´¦å•æ±‡æ€»æŠ¥è¡¨ - {{ customer.name }}</p>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">{{ reports|length }}</div>
                <div class="stat-label">Total Reports / æŠ¥è¡¨æ€»æ•°</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">{{ reports_by_period|length }}</div>
                <div class="stat-label">Periods / æœŸæ•°</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">RM {{ "{:,.2f}".format(reports|sum(attribute='customer_total_debit', start=0)|default(0)) }}</div>
                <div class="stat-label">Customer Debit / å®¢æˆ·æ¶ˆè´¹</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-value">RM {{ "{:,.2f}".format(reports|sum(attribute='infinite_total_debit', start=0)|default(0)) }}</div>
                <div class="stat-label">INFINITE Debit / INFINITEæ¶ˆè´¹</div>
            </div>
        </div>
    </div>

    <!-- Generate New Report -->
    <div class="mb-5">
        <div class="professional-card">
            <h3 style="color: var(--text-primary); margin-bottom: 1rem;">
                <i class="bi bi-plus-circle"></i> Generate New Monthly Report / ç”Ÿæˆæ–°æœˆåº¦æŠ¥è¡¨
            </h3>
            <form id="generateReportForm" method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label" style="color: var(--text-secondary);">Year / å¹´ä»½</label>
                    <select id="reportYear" name="year" class="form-select" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" style="color: var(--text-secondary);">Month / æœˆä»½</label>
                    <select id="reportMonth" name="month" class="form-select" style="background: var(--bg-secondary); color: var(--text-primary); border-color: var(--border-color);">
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if m == 9 %}selected{% endif %}>{{ m }}æœˆ</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn-professional w-100">
                        <i class="bi bi-play-circle"></i> Generate Report / ç”ŸæˆæŠ¥è¡¨
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reports List (Grouped by Period) -->
    <div>
        <h3 class="mb-4" style="color: var(--text-primary);">
            <i class="bi bi-list-ul"></i> All Monthly Reports / æ‰€æœ‰æœˆåº¦æŠ¥è¡¨
            <small style="color: var(--text-secondary); font-size: 0.9rem; font-weight: normal;">
                (æŒ‰æœŸé—´åˆ†ç»„ / Grouped by Period)
            </small>
        </h3>
        
        {% if reports_by_period %}
        {% for period, period_reports in reports_by_period.items() %}
        <div class="professional-card mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 style="color: var(--text-primary); margin: 0;">
                    ğŸ“… {{ period }} 
                    <span class="badge-professional badge-primary-pro">{{ period_reports|length }} cards</span>
                </h4>
            </div>
            
            <div class="table-responsive">
                <table class="table-professional">
                    <thead>
                        <tr>
                            <th>Credit Card / ä¿¡ç”¨å¡</th>
                            <th class="text-end">Customer Debit / å®¢æˆ·æ¶ˆè´¹</th>
                            <th class="text-end">Customer Credit / å®¢æˆ·ä»˜æ¬¾</th>
                            <th class="text-end">Customer Outstanding / å®¢æˆ·æœªæ¸…</th>
                            <th class="text-end">INFINITE Debit / INFINITEæ¶ˆè´¹</th>
                            <th class="text-end">INFINITE Outstanding / INFINITEæœªæ¸…</th>
                            <th class="text-end">DSR</th>
                            <th class="text-center">Actions / æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in period_reports %}
                        <tr>
                            <td style="white-space: nowrap;">
                                <div style="font-weight: 600; color: var(--text-primary);">
                                    {% if report.bank_name %}
                                        {{ report.bank_name }} ****{{ report.card_number_last4 }}
                                    {% else %}
                                        <span style="color: var(--text-secondary); font-style: italic;">Legacy Report (All Cards)</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-end" style="color: var(--text-danger); white-space: nowrap;">
                                RM {{ "{:,.2f}".format(report.customer_total_debit or report.total_debit or 0) }}
                            </td>
                            <td class="text-end" style="color: var(--accent-success); white-space: nowrap;">
                                RM {{ "{:,.2f}".format(report.customer_total_credit or report.total_credit or 0) }}
                            </td>
                            <td class="text-end" style="font-weight: 600; color: #3498db; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(report.customer_outstanding or 0) }}
                            </td>
                            <td class="text-end" style="color: #8e44ad; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(report.infinite_total_debit or 0) }}
                            </td>
                            <td class="text-end" style="font-weight: 600; color: #e67e22; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(report.infinite_outstanding or 0) }}
                            </td>
                            <td style="white-space: nowrap;" class="text-end">
                                <span class="badge-professional {{ 'badge-danger-pro' if report.dsr >= 70 else 'badge-success-pro' if report.dsr < 50 else 'badge-warning-pro' }}">
                                    {{ "%.1f"|format(report.dsr) }}%
                                </span>
                            </td>
                            <td style="white-space: nowrap;" class="text-center">
                                <a href="{{ url_for('download_monthly_report', report_id=report.id) }}" 
                                   class="btn-professional-sm">
                                    <i class="bi bi-download"></i> PDF
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <!-- Period Totals -->
                        <tr style="background: var(--bg-secondary); font-weight: 600;">
                            <td style="color: var(--text-primary); white-space: nowrap;">Period Total / æœŸé—´åˆè®¡</td>
                            <td class="text-end" style="color: var(--text-danger); white-space: nowrap;">
                                RM {{ "{:,.2f}".format(period_reports|sum(attribute='customer_total_debit', start=0)|default(0)) }}
                            </td>
                            <td class="text-end" style="color: var(--accent-success); white-space: nowrap;">
                                RM {{ "{:,.2f}".format(period_reports|sum(attribute='customer_total_credit', start=0)|default(0)) }}
                            </td>
                            <td class="text-end" style="color: #3498db; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(period_reports|sum(attribute='customer_outstanding', start=0)|default(0)) }}
                            </td>
                            <td class="text-end" style="color: #8e44ad; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(period_reports|sum(attribute='infinite_total_debit', start=0)|default(0)) }}
                            </td>
                            <td class="text-end" style="color: #e67e22; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(period_reports|sum(attribute='infinite_outstanding', start=0)|default(0)) }}
                            </td>
                            <td style="white-space: nowrap;" colspan="2"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
        
        <!-- Legend -->
        <div class="professional-card mt-4" style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3);">
            <h5 style="color: var(--text-primary); margin-bottom: 1rem;">
                <i class="bi bi-info-circle"></i> Understanding Your Reports / äº†è§£æ‚¨çš„æŠ¥è¡¨
            </h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <div style="padding: 0.75rem; background: rgba(52, 73, 94, 0.1); border-radius: 6px;">
                        <strong style="color: #3498db;">Customer Transactions / å®¢æˆ·äº¤æ˜“:</strong>
                        <p style="color: var(--text-secondary); margin: 0; margin-top: 0.5rem;">
                            Your personal expenses and payments on this card.
                            æ‚¨åœ¨æ­¤å¡ä¸Šçš„ä¸ªäººæ¶ˆè´¹å’Œä»˜æ¬¾ã€‚
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div style="padding: 0.75rem; background: rgba(142, 68, 173, 0.1); border-radius: 6px;">
                        <strong style="color: #8e44ad;">INFINITE GZ Transactions / INFINITEäº¤æ˜“:</strong>
                        <p style="color: var(--text-secondary); margin: 0; margin-top: 0.5rem;">
                            Company expenses at 7 designated suppliers and 3rd party payments.
                            å…¬å¸åœ¨7å®¶æŒ‡å®šå•†å®¶çš„æ¶ˆè´¹å’Œç¬¬ä¸‰æ–¹ä»˜æ¬¾ã€‚
                        </p>
                    </div>
                </div>
                <div class="col-12">
                    <div style="padding: 0.75rem; background: rgba(230, 126, 34, 0.1); border-radius: 6px;">
                        <strong style="color: #e67e22;">Per-Card Reports / æŒ‰å¡åˆ†ç¦»æŠ¥è¡¨:</strong>
                        <p style="color: var(--text-secondary); margin: 0; margin-top: 0.5rem;">
                            Each credit card now has a separate report - no mixing of transactions between cards!
                            æ¯å¼ ä¿¡ç”¨å¡ç°åœ¨æœ‰ç‹¬ç«‹çš„æŠ¥è¡¨ - ä¸ä¼šæ··åˆä¸åŒå¡çš„äº¤æ˜“è®°å½•ï¼
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <div class="professional-card text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i>
            <p style="color: var(--text-secondary); margin-top: 1rem;">
                No monthly reports yet. Generate your first report above.<br>
                æš‚æ— æœˆåº¦æŠ¥è¡¨ï¼Œè¯·åœ¨ä¸Šæ–¹ç”Ÿæˆç¬¬ä¸€ä»½æŠ¥è¡¨ã€‚
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Back Button -->
    <div class="mt-5">
        <a href="{{ url_for('customer_dashboard', customer_id=customer.id) }}" class="btn-professional-outline">
            <i class="bi bi-arrow-left"></i> Back to Dashboard / è¿”å›ä»ªè¡¨æ¿
        </a>
    </div>
</div>

<script>
// Form submission handler
document.getElementById('generateReportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const year = document.getElementById('reportYear').value;
    const month = document.getElementById('reportMonth').value;
    const customerId = {{ customer.id }};
    window.location.href = `/customer/${customerId}/generate-monthly-report/${year}/${month}`;
});
</script>
{% endblock %}
