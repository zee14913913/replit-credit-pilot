{% extends "base.html" %}

{% block title %}Monthly Reports - {{ customer.name }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="section-header">
        <h1 class="section-title">
            <i class="bi bi-file-earmark-bar-graph"></i> Monthly Statement Reports
        </h1>
        <p class="section-subtitle">æœˆåº¦è´¦å•æ±‡æ€»æŠ¥è¡¨ - {{ customer.name }}</p>
    </div>

    <!-- {{ t('summary_cards__') }} -->
    <div class="row g-5 mb-5">
        <div class="col-12 col-md-6 col-xl-3">
            <div style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.6) 0%, rgba(36, 25, 52, 0.8) 100%); border: 2px solid rgba(255, 0, 127, 0.4); border-radius: 20px; padding: 3rem 2rem; text-align: center; min-height: 200px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 0, 127, 0.2); transition: all 0.3s ease;">
                <div style="font-size: 3.5rem; font-weight: 800; background: linear-gradient(135deg, #FF007F 0%, #FF4DA6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem;">{{ reports|length }}</div>
                <div style="font-size: 1.2rem; color: rgba(255, 255, 255, 0.9); font-weight: 500;">{{ t('total_reports__') }}</div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.6) 0%, rgba(36, 25, 52, 0.8) 100%); border: 2px solid rgba(255, 0, 127, 0.4); border-radius: 20px; padding: 3rem 2rem; text-align: center; min-height: 200px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 0, 127, 0.2); transition: all 0.3s ease;">
                <div style="font-size: 3.5rem; font-weight: 800; background: linear-gradient(135deg, #FF007F 0%, #FF4DA6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem;">{{ reports_by_period|length }}</div>
                <div style="font-size: 1.2rem; color: rgba(255, 255, 255, 0.9); font-weight: 500;">{{ t('periods__') }}</div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.6) 0%, rgba(36, 25, 52, 0.8) 100%); border: 2px solid rgba(255, 0, 127, 0.4); border-radius: 20px; padding: 3rem 2rem; text-align: center; min-height: 200px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 0, 127, 0.2); transition: all 0.3s ease;">
                <div style="font-size: 3.5rem; font-weight: 800; background: linear-gradient(135deg, #FF007F 0%, #FF4DA6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem;">RM {{ "{:,.2f}".format(reports|sum(attribute='customer_total_debit', start=0)|default(0)) }}</div>
                <div style="font-size: 1.2rem; color: rgba(255, 255, 255, 0.9); font-weight: 500;">{{ t('customer_debit__') }}</div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.6) 0%, rgba(36, 25, 52, 0.8) 100%); border: 2px solid rgba(255, 0, 127, 0.4); border-radius: 20px; padding: 3rem 2rem; text-align: center; min-height: 200px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 0, 127, 0.2); transition: all 0.3s ease;">
                <div style="font-size: 3.5rem; font-weight: 800; background: linear-gradient(135deg, #FF007F 0%, #FF4DA6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem;">RM {{ "{:,.2f}".format(reports|sum(attribute='infinite_total_debit', start=0)|default(0)) }}</div>
                <div style="font-size: 1.2rem; color: rgba(255, 255, 255, 0.9); font-weight: 500;">{{ t('infinite_debit__infinite') }}</div>
            </div>
        </div>
    </div>

    <!-- {{ t('generate_new_report__') }} -->
    <div class="mb-5">
        <div style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.6) 0%, rgba(36, 25, 52, 0.8) 100%); border: 2px solid rgba(255, 0, 127, 0.4); border-radius: 24px; padding: 3.5rem 3rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 0, 127, 0.2);">
            <h3 style="color: #FFFFFF; margin-bottom: 2rem; font-size: 1.8rem; font-weight: 700;">
                <i class="bi bi-plus-circle"></i> {{ t('generate_new_monthly_report__') }}
            </h3>
            <form id="generateReportForm" method="get" class="row g-5">
                <div class="col-12 col-md-4">
                    <label class="form-label" style="color: rgba(255, 255, 255, 0.85); font-size: 1.2rem; font-weight: 500; margin-bottom: 0.75rem;">{{ t('year__') }}</label>
                    <select id="reportYear" name="year" class="form-select form-select-lg" style="background: rgba(30, 20, 45, 0.8); color: #FFFFFF; border: 2px solid rgba(255, 0, 127, 0.3); padding: 1rem; font-size: 1.1rem; border-radius: 12px;">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label" style="color: rgba(255, 255, 255, 0.85); font-size: 1.2rem; font-weight: 500; margin-bottom: 0.75rem;">{{ t('month__') }}</label>
                    <select id="reportMonth" name="month" class="form-select form-select-lg" style="background: rgba(30, 20, 45, 0.8); color: #FFFFFF; border: 2px solid rgba(255, 0, 127, 0.3); padding: 1rem; font-size: 1.1rem; border-radius: 12px;">
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if m == 9 %}selected{% endif %}>{{ m }}æœˆ</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn-professional w-100" style="padding: 1.2rem 2rem; font-size: 1.2rem; font-weight: 600; border-radius: 12px;">
                        <i class="bi bi-play-circle"></i> {{ t('generate_report__') }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reports List (Grouped by Period) -->
    <div>
        <h3 class="mb-4" style="color: var(--text-primary);">
            <i class="bi bi-list-ul"></i> {{ t('all_monthly_reports__') }}
            <small style="color: var(--text-secondary); font-size: 0.9rem; font-weight: normal;">
                ({{ t('__grouped_by_period_1') }})
            </small>
        </h3>
        
        {% if reports_by_period %}
        {% for period, period_reports in reports_by_period.items() %}
        <div style="background: linear-gradient(135deg, rgba(50, 36, 70, 0.6) 0%, rgba(36, 25, 52, 0.8) 100%); border: 2px solid rgba(255, 0, 127, 0.4); border-radius: 24px; padding: 3rem 2.5rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 0, 127, 0.2); margin-bottom: 3rem;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 style="color: #FFFFFF; margin: 0; font-size: 1.8rem; font-weight: 700;">
                    ğŸ“… {{ period }} 
                    <span class="badge-professional badge-primary-pro" style="font-size: 1.1rem; padding: 0.65rem 1.2rem;">{{ period_reports|length }} cards</span>
                </h4>
            </div>
            
            <div class="table-responsive">
                <table class="table-professional">
                    <thead>
                        <tr>
                            <th>{{ t('credit_card__') }}</th>
                            <th class="text-end">{{ t('customer_debit__') }}</th>
                            <th class="text-end">{{ t('customer_credit__') }}</th>
                            <th class="text-end">{{ t('customer_outstanding__') }}</th>
                            <th class="text-end">{{ t('infinite_debit__infinite') }}</th>
                            <th class="text-end">{{ t('infinite_outstanding__infinite') }}</th>
                            <th class="text-end">{{ t('dsr') }}</th>
                            <th class="text-center">{{ t('actions__') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in period_reports %}
                        <tr>
                            <td style="white-space: nowrap;">
                                <div style="font-weight: 600; color: var(--text-primary);">
                                    {% if report.bank_name %}
                                        {{ report.bank_name }} ****{{ report.card_number_last4 }}
                                    {% else %}
                                        <span style="color: var(--text-secondary); font-style: italic;">{{ t('legacy_report_all_cards') }}</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-end" style="color: var(--text-danger); white-space: nowrap;">
                                RM {{ "{:,.2f}".format(report.customer_total_debit or report.total_debit or 0) }}
                            </td>
                            <td class="text-end" style="color: var(--accent-success); white-space: nowrap;">
                                RM {{ "{:,.2f}".format(report.customer_total_credit or report.total_credit or 0) }}
                            </td>
                            <td class="text-end" style="font-weight: 600; color: #3498db; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(report.customer_outstanding or 0) }}
                            </td>
                            <td class="text-end" style="color: #8e44ad; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(report.infinite_total_debit or 0) }}
                            </td>
                            <td class="text-end" style="font-weight: 600; color: #e67e22; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(report.infinite_outstanding or 0) }}
                            </td>
                            <td style="white-space: nowrap;" class="text-end">
                                <span class="badge-professional {{ 'badge-danger-pro' if report.dsr >{{ t('_70_else_badgesuccesspro_if_reportdsr') }}< 50 else 'badge-warning-pro' }}">
                                    {{ "%.1f"|format(report.dsr) }}%
                                </span>
                            </td>
                            <td style="white-space: nowrap;" class="text-center">
                                <a href="{{ url_for('download_monthly_report', report_id=report.id) }}" 
                                   class="btn-professional-sm">
                                    <i class="bi bi-download"></i> PDF
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <!-- Period Totals -->
                        <tr style="background: var(--bg-secondary); font-weight: 600;">
                            <td style="color: var(--text-primary); white-space: nowrap;">{{ t('period_total__') }}</td>
                            <td class="text-end" style="color: var(--text-danger); white-space: nowrap;">
                                RM {{ "{:,.2f}".format(period_reports|sum(attribute='customer_total_debit', start=0)|default(0)) }}
                            </td>
                            <td class="text-end" style="color: var(--accent-success); white-space: nowrap;">
                                RM {{ "{:,.2f}".format(period_reports|sum(attribute='customer_total_credit', start=0)|default(0)) }}
                            </td>
                            <td class="text-end" style="color: #3498db; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(period_reports|sum(attribute='customer_outstanding', start=0)|default(0)) }}
                            </td>
                            <td class="text-end" style="color: #8e44ad; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(period_reports|sum(attribute='infinite_total_debit', start=0)|default(0)) }}
                            </td>
                            <td class="text-end" style="color: #e67e22; white-space: nowrap;">
                                RM {{ "{:,.2f}".format(period_reports|sum(attribute='infinite_outstanding', start=0)|default(0)) }}
                            </td>
                            <td style="white-space: nowrap;" colspan="2"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
        
        <!-- Legend -->
        <div class="professional-card mt-4" style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3);">
            <h5 style="color: var(--text-primary); margin-bottom: 1rem;">
                <i class="bi bi-info-circle"></i> {{ t('understanding_your_reports__') }}
            </h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <div style="padding: 0.75rem; background: rgba(52, 73, 94, 0.1); border-radius: 6px;">
                        <strong style="color: #3498db;">{{ t('customer_transactions__') }}</strong>
                        <p style="color: var(--text-secondary); margin: 0; margin-top: 0.5rem;">
                            {{ t('your_personal_expenses_and_payments_on_this_card___1') }}                  æ‚¨åœ¨æ­¤å¡ä¸Šçš„ä¸ªäººæ¶ˆè´¹å’Œä»˜æ¬¾ã€‚
                        </p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div style="padding: 0.75rem; background: rgba(142, 68, 173, 0.1); border-radius: 6px;">
                        <strong style="color: #8e44ad;">{{ t('infinite_gz_transactions__infinite') }}</strong>
                        <p style="color: var(--text-secondary); margin: 0; margin-top: 0.5rem;">
                            {{ t('company_expenses_at_7_designated_suppliers_and_3rd_1') }}ments.
                            å…¬å¸åœ¨7å®¶æŒ‡å®šå•†å®¶çš„æ¶ˆè´¹å’Œç¬¬ä¸‰æ–¹ä»˜æ¬¾ã€‚
                        </p>
                    </div>
                </div>
                <div class="col-12">
                    <div style="padding: 0.75rem; background: rgba(230, 126, 34, 0.1); border-radius: 6px;">
                        <strong style="color: #e67e22;">{{ t('percard_reports__') }}</strong>
                        <p style="color: var(--text-secondary); margin: 0; margin-top: 0.5rem;">
                            {{ t('each_credit_card_now_has_a_separate_report__no_mix_1') }}ansactions between cards!
                            æ¯å¼ ä¿¡ç”¨å¡ç°åœ¨æœ‰ç‹¬ç«‹çš„æŠ¥è¡¨ - ä¸ä¼šæ··åˆä¸åŒå¡çš„äº¤æ˜“è®°å½•ï¼
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <div class="professional-card text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i>
            <p style="color: var(--text-secondary); margin-top: 1rem;">
                No monthly reports yet. Generate your first report above.<br>
                æš‚æ— æœˆåº¦æŠ¥è¡¨ï¼Œè¯·åœ¨ä¸Šæ–¹ç”Ÿæˆç¬¬ä¸€ä»½æŠ¥è¡¨ã€‚
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Back Button -->
    <div class="mt-5">
        <a href="{{ url_for('customer_dashboard', customer_id=customer.id) }}" class="btn-professional-outline">
            <i class="bi bi-arrow-left"></i> {{ t('back_to_dashboard__') }}
        </a>
    </div>
</div>

<script>
// Form submission handler
document.getElementById('generateReportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const year = document.getElementById('reportYear').value;
    const month = document.getElementById('reportMonth').value;
    const customerId = {{ customer.id }};
    window.location.href = `/customer/${customerId}/generate-monthly-report/${year}/${month}`;
});
</script>
{% endblock %}
