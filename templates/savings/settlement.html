{% extends "base.html" %}

{% block title %}{{ t('settlement_report') }} - {{ settlement.customer_name }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="section-header">
        <h1 class="section-title">{{ t('settlement_report') }}</h1>
        <p class="section-subtitle">{{ t('customer_name') }}: {{ settlement.customer_name }}</p>
    </div>

    <!-- Settlement Summary Card -->
    <div class="professional-card mb-4" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(0, 0, 0, 0.4) 100%); border-left: 4px solid var(--accent-gold);">
        <div class="row g-4">
            <div class="col-md-4">
                <h5 style="color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">
                    {{ t('customer_name') }}
                </h5>
                <h2 style="color: var(--text-primary); margin: 0;">{{ settlement.customer_name }}</h2>
            </div>
            <div class="col-md-4">
                <h5 style="color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">
                    {{ t('total_prepayment_amount') }}
                </h5>
                <h2 style="color: var(--accent-gold); margin: 0;">RM {{ "{:,.2f}".format(settlement.total_amount) }}</h2>
            </div>
            <div class="col-md-4">
                <h5 style="color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem;">
                    {{ t('transaction_count') }}
                </h5>
                <h2 style="color: var(--text-primary); margin: 0;">{{ settlement.transaction_count }}</h2>
            </div>
        </div>
    </div>

    <!-- Monthly Summary -->
    {% if settlement.monthly_summary %}
    <div class="professional-card mb-4">
        <h3 style="color: var(--text-primary); margin-bottom: 1.5rem;">{{ t('monthly_summary') }}</h3>

        <div class="row g-4">
            {% for month_data in settlement.monthly_summary %}
            <div class="col-md-6 col-lg-4">
                <div class="professional-card" style="background: var(--bg-secondary); border: 1px solid rgba(212, 175, 55, 0.3);">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 style="color: var(--text-primary); margin: 0; font-size: 1.1rem;">
                            {{ month_data.month }}
                        </h4>
                        <span class="badge-professional badge-info-pro">
                            {{ month_data.transaction_count }}
                        </span>
                    </div>
                    <div style="padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; text-align: center;">
                        <small style="color: var(--text-secondary); display: block; margin-bottom: 0.3rem;">{{ t('monthly_total') }}</small>
                        <h3 style="color: var(--accent-gold); margin: 0; font-weight: 700;">
                            RM {{ "{:,.2f}".format(month_data.total_amount) }}
                        </h3>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Transaction Details -->
    <div class="professional-card">
        <h3 style="color: var(--text-primary); margin-bottom: 1rem;">{{ t('transaction_details') }}</h3>

        {% if settlement.monthly_summary %}
        <!-- Group by Month -->
        {% for month_data in settlement.monthly_summary %}
        <div class="mb-4">
            <div style="background: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 style="color: var(--text-primary); margin: 0; font-size: 1rem;">
                        {{ month_data.month }}
                    </h4>
                    <span style="color: var(--text-primary); font-weight: 600;">
                        RM {{ "{:,.2f}".format(month_data.total_amount) }} ({{ month_data.transaction_count }})
                    </span>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table-professional">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>{{ t('date') }}</th>
                            <th>{{ t('description') }}</th>
                            <th>{{ t('amount') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trans in month_data.transactions %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ trans.transaction_date }}</td>
                            <td>{{ trans.description }}</td>
                            <td>
                                <span style="color: var(--text-primary); font-weight: 600;">
                                    RM {{ "{:,.2f}".format(trans.amount) }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="background: var(--bg-secondary);">
                            <td colspan="3" style="text-align: right; font-weight: 600; color: var(--text-primary);">
                                {{ t('month_subtotal') }}:
                            </td>
                            <td>
                                <span style="color: var(--accent-gold); font-weight: 700;">
                                    RM {{ "{:,.2f}".format(month_data.total_amount) }}
                                </span>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        {% endfor %}

        <!-- Grand Total -->
        <div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(0, 0, 0, 0.5) 100%); padding: 1.5rem; border-radius: 12px; margin-top: 2rem; border: 2px solid var(--accent-gold);">
            <div class="row g-3 align-items-center">
                <div class="col-md-8">
                    <h3 style="color: var(--text-primary); margin: 0; font-size: 1.3rem;">
                        {{ t('grand_total') }}
                    </h3>
                    <small style="color: var(--text-secondary);">{{ settlement.transaction_count }} {{ t('transactions') }}</small>
                </div>
                <div class="col-md-4 text-md-end">
                    <h2 style="color: var(--accent-gold); margin: 0; font-weight: 700; font-size: 2rem;">
                        RM {{ "{:,.2f}".format(settlement.total_amount) }}
                    </h2>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Fallback: Show all transactions without grouping -->
        <div class="table-responsive">
            <table class="table-professional">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>{{ t('date') }}</th>
                        <th>{{ t('bank') }}</th>
                        <th>{{ t('description') }}</th>
                        <th>{{ t('amount') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trans in settlement.all_transactions %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ trans.transaction_date }}</td>
                        <td>
                            <span class="badge-professional badge-secondary-pro">
                                {{ trans.bank_name }}
                            </span>
                        </td>
                        <td>{{ trans.description }}</td>
                        <td>
                            <span style="color: var(--text-primary); font-weight: 600;">
                                RM {{ "{:,.2f}".format(trans.amount) }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr style="background: var(--bg-secondary);">
                        <td colspan="4" style="text-align: right; font-weight: 600; color: var(--text-primary);">
                            {{ t('total_amount_to_collect') }}:
                        </td>
                        <td>
                            <span style="color: var(--accent-gold); font-weight: 700;">
                                RM {{ "{:,.2f}".format(settlement.total_amount) }}
                            </span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Footer Info -->
    <div class="professional-card mt-4">
        <div class="row g-3">
            <div class="col-md-6">
                <small style="color: var(--text-secondary);">{{ t('report_generated') }}</small>
                <div style="color: var(--text-primary); font-weight: 600;">{{ settlement.created_at or 'N/A' }}</div>
            </div>
            <div class="col-md-6">
                <small style="color: var(--text-secondary);">{{ t('status') }}</small>
                <div>
                    <span class="badge-professional badge-warning-pro">{{ t('pending') }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="mt-4">
        <a href="{{ url_for('savings_search') }}" class="btn-professional-outline">
            {{ t('back_to_customers') }}
        </a>
    </div>
</div>
{% endblock %}
