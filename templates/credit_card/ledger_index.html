{% extends "base.html" %}

{% block title %}{{ t('cc_ledger_title') }}{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="section-header">
        <h1 class="section-title">
            {{ t('cc_ledger_title') }}
        </h1>
        <p class="section-subtitle">{{ t('cc_ledger_subtitle') }}</p>
    </div>

    <!-- 上传信用卡账单区域 -->
    <div class="professional-card mb-5" style="padding: 2.5rem 3rem; margin-top: 2rem;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 style="color: #FFFEF0; margin: 0; font-size: 1.8rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px;">
                UPLOAD CREDIT CARD STATEMENT
            </h3>
            <button class="btn-professional" onclick="toggleUploadForm()" style="background: linear-gradient(135deg, #FF007F 0%, #E6007A 100%); padding: 0.7rem 1.8rem; font-size: 1rem; font-weight: 700; border: 2px solid #FFFEF0; color: #FFFEF0;">
                <span id="upload-toggle-text">{{ t('show_upload_form') }}</span>
            </button>
        </div>
        
        <div id="upload-form-section" style="display: none;">
            <div class="divider-professional mb-5" style="margin-top: 1.5rem;"></div>
            <form method="POST" action="{{ url_for('credit_card_ledger') }}" enctype="multipart/form-data">
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label" style="color: #E8E8E8; font-weight: 600; font-size: 1.05rem; margin-bottom: 0.8rem; display: block;">
                            <i class="bi bi-credit-card-2-front" style="color: #FF007F; margin-right: 0.5rem;"></i>
                            {{ t('select_credit_card') }}
                        </label>
                        <select name="card_id" class="form-control-professional" required style="font-size: 1rem; padding: 0.9rem 1.2rem;">
                            <option value="" selected disabled>{{ t('choose_credit_card') }}</option>
                            {% for card in all_cards %}
                            <option value="{{ card.id }}">
                                {{ card.customer_name }} - {{ card.bank_name }} ****{{ card.card_number_last4 }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label" style="color: #E8E8E8; font-weight: 600; font-size: 1.05rem; margin-bottom: 0.8rem; display: block;">
                            <i class="bi bi-file-earmark-pdf" style="color: #FF007F; margin-right: 0.5rem;"></i>
                            {{ t('statement_file') }}
                        </label>
                        <div class="custom-file-upload">
                            <input type="file" name="statement_file" id="statement_file" class="file-input-hidden" accept=".pdf,.xlsx,.xls" required>
                            <button type="button" class="btn-professional-outline" onclick="document.getElementById('statement_file').click()" style="padding: 0.9rem 1.5rem; font-size: 1rem;">
                                <i class="bi bi-upload" style="margin-right: 0.5rem;"></i>
                                {{ t('choose_file') }}
                            </button>
                            <span id="file-name" style="color: #999; margin-left: 1.2rem; font-size: 0.95rem;">{{ t('no_file_chosen') }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 mt-5">
                    <button type="submit" class="btn-professional" style="background: linear-gradient(135deg, #FF007F 0%, #330066 100%); padding: 1rem 2rem; font-size: 1.1rem; font-weight: 700;">
                        <i class="bi bi-check-circle-fill" style="margin-right: 0.6rem;"></i>
                        {{ t('upload_parse_statement') }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 客户列表 - 表格布局 -->
    {% if customers %}
    <div class="table-container" style="margin-top: 3rem; margin-bottom: 3rem;">
        <div class="table-header">
            <h3 style="color: #FFFEF0; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 1px;">
                CUSTOMER LIST
            </h3>
            <span style="background: linear-gradient(135deg, #FF007F 0%, #E6007A 100%); color: #FFFEF0; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 700; text-transform: uppercase; border: 2px solid #FFFEF0;">
                {{ t('customers_count').replace('{count}', customers|length|string) }}
            </span>
        </div>
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr style="background: rgba(50, 36, 70, 0.5);">
                        <th style="width: 15%; color: #FFFEF0; font-size: 1.2rem; text-transform: uppercase; font-weight: 900; padding: 1rem 1.5rem; border: 2px solid #FF007F; letter-spacing: 0.5px;">{{ t('customer_code') }}</th>
                        <th style="width: 25%; color: #FFFEF0; font-size: 1.2rem; text-transform: uppercase; font-weight: 900; padding: 1rem 1.5rem; border: 2px solid #FF007F; letter-spacing: 0.5px;">{{ t('customer_name_1') }}</th>
                        <th style="width: 15%; text-align: center; color: #FFFEF0; font-size: 1.2rem; text-transform: uppercase; font-weight: 900; padding: 1rem 1.5rem; border: 2px solid #FF007F; letter-spacing: 0.5px;">{{ t('statement_count') }}</th>
                        <th style="width: 15%; text-align: center; color: #FFFEF0; font-size: 1.2rem; text-transform: uppercase; font-weight: 900; padding: 1rem 1.5rem; border: 2px solid #FF007F; letter-spacing: 0.5px;">{{ t('actions_1') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in customers %}
                    <tr>
                        <td style="font-weight: 700; color: #FFFEF0; font-size: 1.1rem; text-transform: uppercase; padding: 1.2rem 1.5rem;">{{ customer.code }}</td>
                        <td style="font-weight: 700; color: #FFFEF0; font-size: 1.1rem; text-transform: uppercase; padding: 1.2rem 1.5rem;">{{ customer.name }}</td>
                        <td style="text-align: center; padding: 1.2rem 1.5rem;">
                            <span style="background: #000000; color: #FFFEF0; padding: 0.4rem 1rem; border-radius: 6px; font-weight: 900; border: 2px solid #FF007F; font-size: 1.1rem;">
                                {{ customer.statement_count }}
                            </span>
                        </td>
                        <td style="text-align: center; padding: 1.2rem 1.5rem;">
                            <a href="{{ url_for('credit_card_ledger_timeline', customer_id=customer.id) }}" class="btn-view" style="text-transform: uppercase; font-size: 1rem; font-weight: 700; color: #FFFEF0;">
                                {{ t('view_timeline') }}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="professional-card text-center" style="padding: 3rem;">
        <p style="color: var(--text-secondary); margin-top: 1rem;">{{ t('no_customers_with_data') }}</p>
    </div>
    {% endif %}
</div>

<!-- Scripts -->
<script>
function toggleUploadForm() {
    const form = document.getElementById('upload-form-section');
    const toggleText = document.getElementById('upload-toggle-text');
    if (form.style.display === 'none') {
        form.style.display = 'block';
        toggleText.textContent = '{{ t("hide_upload_form") }}';
    } else {
        form.style.display = 'none';
        toggleText.textContent = '{{ t("show_upload_form") }}';
    }
}

document.getElementById('statement_file').addEventListener('change', function(e) {
    const fileName = e.target.files[0] ? e.target.files[0].name : '{{ t("no_file_chosen") }}';
    document.getElementById('file-name').textContent = fileName;
});
</script>
{% endblock %}
