{% extends "base.html" %}

{% block title %}{{ customer.name }} - Credit Card Ledger{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="section-header">
        <h1 class="section-title">
            <i class="bi bi-journal-text"></i> {{ customer.name }}
        </h1>
        <p class="section-subtitle">OWNER vs INFINITE Ledger Analysis</p>
    </div>

    <!-- Navigation Buttons -->
    <div class="mb-4">
        <a href="{{ url_for('credit_card_ledger') }}" class="btn-professional-outline">
            <i class="bi bi-arrow-left"></i> Back to All Customers
        </a>
    </div>

    <!-- 区域 1: 客户总览 (Customer Overview) -->
    <div class="professional-card mb-4">
        <h2 class="section-title mb-4">
            <i class="bi bi-person-badge"></i> Customer Overview
        </h2>
        <div class="row g-4">
            <div class="col-md-3">
                <div style="text-align: center; padding: 1.5rem; background: rgba(192, 192, 192, 0.05); border-radius: 8px;">
                    <i class="bi bi-credit-card-2-front" style="font-size: 2.5rem; color: #C0C0C0;"></i>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-top: 0.5rem;">
                        {{ cards|length }}
                    </div>
                    <small style="color: var(--text-secondary);">Credit Cards</small>
                </div>
            </div>
            <div class="col-md-3">
                <div style="text-align: center; padding: 1.5rem; background: rgba(192, 192, 192, 0.05); border-radius: 8px;">
                    <i class="bi bi-file-earmark-text" style="font-size: 2.5rem; color: #C0C0C0;"></i>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-top: 0.5rem;">
                        {% set total_statements = namespace(count=0) %}
                        {% for card in cards %}
                            {% set total_statements.count = total_statements.count + card.statements|length %}
                        {% endfor %}
                        {{ total_statements.count }}
                    </div>
                    <small style="color: var(--text-secondary);">Total Statements</small>
                </div>
            </div>
            <div class="col-md-3">
                <div style="text-align: center; padding: 1.5rem; background: rgba(192, 192, 192, 0.05); border-radius: 8px;">
                    <i class="bi bi-list-ul" style="font-size: 2.5rem; color: #87CEEB;"></i>
                    <div style="font-size: 2rem; font-weight: 700; color: #87CEEB; margin-top: 0.5rem;">
                        {{ recent_transactions|length }}
                    </div>
                    <small style="color: var(--text-secondary);">Recent Transactions</small>
                </div>
            </div>
            <div class="col-md-3">
                <div style="text-align: center; padding: 1.5rem; background: rgba(192, 192, 192, 0.05); border-radius: 8px;">
                    <i class="bi bi-shield-check" style="font-size: 2.5rem; color: #90EE90;"></i>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #90EE90; margin-top: 0.5rem;">
                        Active
                    </div>
                    <small style="color: var(--text-secondary);">Account Status</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 区域 2: 信用卡列表 (Credit Cards List) -->
    <div class="professional-card mb-4">
        <h2 class="section-title mb-4">
            <i class="bi bi-credit-card-2-back"></i> Credit Cards & Baselines
        </h2>
        <div class="row g-4">
            {% for card in cards %}
            <div class="col-md-6">
                <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(192, 192, 192, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%); border-radius: 8px; border: 1px solid rgba(192, 192, 192, 0.1);">
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem;">
                        <i class="bi bi-bank"></i> {{ card.bank_name }}
                    </h4>
                    <p style="color: var(--text-secondary); font-family: monospace; font-size: 1.1rem;">
                        **** **** **** {{ card.card_number_last4 }}
                    </p>

                    <div class="divider-professional my-3"></div>

                    <!-- Baseline Information -->
                    {% if card.baseline %}
                    <div class="mb-3">
                        <small style="color: var(--text-secondary);">First Statement Baseline:</small>
                        <div class="row g-2 mt-2">
                            <div class="col-6">
                                <div style="padding: 0.5rem; background: rgba(192, 192, 192, 0.05); border-radius: 4px;">
                                    <small style="color: #C0C0C0;">OWNER</small>
                                    <div style="color: #87CEEB; font-weight: 600;">RM {{ "{:,.2f}".format(card.baseline.owner_baseline) }}</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div style="padding: 0.5rem; background: rgba(218, 165, 32, 0.05); border-radius: 4px;">
                                    <small style="color: #DAA520;">INFINITE</small>
                                    <div style="color: #FFD700; font-weight: 600;">RM {{ "{:,.2f}".format(card.baseline.infinite_baseline) }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div style="padding: 0.75rem; background: rgba(255, 165, 0, 0.1); border-radius: 4px; border: 1px solid rgba(255, 165, 0, 0.3);">
                        <i class="bi bi-exclamation-triangle" style="color: #FFA500;"></i>
                        <small style="color: #FFA500;"> No baseline set - process first statement to initialize</small>
                    </div>
                    {% endif %}

                    <div class="divider-professional my-3"></div>

                    <!-- Card Totals -->
                    <div class="row g-2">
                        <div class="col-6">
                            <small style="color: var(--text-secondary);">Statements</small>
                            <div style="color: var(--text-primary); font-weight: 600;">{{ card.statements|length }}</div>
                        </div>
                        <div class="col-6">
                            <small style="color: var(--text-secondary);">Credit Limit</small>
                            <div style="color: var(--text-primary); font-weight: 600;">
                                {% if card.credit_limit %}
                                    RM {{ "{:,.2f}".format(card.credit_limit) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 区域 3: OWNER vs INFINITE 汇总 (Summary) -->
    <div class="professional-card mb-4">
        <h2 class="section-title mb-4">
            <i class="bi bi-pie-chart"></i> OWNER vs INFINITE Summary
        </h2>
        <div class="row g-4">
            {% for card in cards %}
            <div class="col-md-6">
                <div style="padding: 1.5rem; background: rgba(0, 0, 0, 0.3); border-radius: 8px; border: 1px solid rgba(192, 192, 192, 0.1);">
                    <h5 style="color: var(--text-primary); margin-bottom: 1.5rem;">
                        {{ card.bank_name }} ****{{ card.card_number_last4 }}
                    </h5>

                    <div class="row g-3">
                        <!-- OWNER Column -->
                        <div class="col-6">
                            <div style="padding: 1rem; background: linear-gradient(135deg, rgba(192, 192, 192, 0.1) 0%, rgba(135, 206, 235, 0.05) 100%); border-radius: 6px;">
                                <div style="color: #C0C0C0; font-size: 0.9rem; margin-bottom: 0.75rem;">
                                    <i class="bi bi-person-fill"></i> OWNER
                                </div>
                                <div style="color: #87CEEB; font-weight: 700; font-size: 1.3rem;">
                                    RM {{ "{:,.2f}".format(card.owner_expenses) }}
                                </div>
                                <small style="color: var(--text-secondary);">Expenses</small>

                                <div class="mt-2 pt-2" style="border-top: 1px solid rgba(192, 192, 192, 0.1);">
                                    <div style="color: #90EE90; font-weight: 600;">
                                        -RM {{ "{:,.2f}".format(card.owner_payments) }}
                                    </div>
                                    <small style="color: var(--text-secondary);">Payments</small>
                                </div>
                            </div>
                        </div>

                        <!-- INFINITE Column -->
                        <div class="col-6">
                            <div style="padding: 1rem; background: linear-gradient(135deg, rgba(218, 165, 32, 0.1) 0%, rgba(255, 215, 0, 0.05) 100%); border-radius: 6px;">
                                <div style="color: #DAA520; font-size: 0.9rem; margin-bottom: 0.75rem;">
                                    <i class="bi bi-infinity"></i> INFINITE
                                </div>
                                <div style="color: #FFD700; font-weight: 700; font-size: 1.3rem;">
                                    RM {{ "{:,.2f}".format(card.infinite_expenses) }}
                                </div>
                                <small style="color: var(--text-secondary);">Supplier</small>

                                <div class="mt-2 pt-2" style="border-top: 1px solid rgba(218, 165, 32, 0.1);">
                                    <div style="color: #90EE90; font-weight: 600;">
                                        -RM {{ "{:,.2f}".format(card.infinite_payments) }}
                                    </div>
                                    <small style="color: var(--text-secondary);">3rd Party</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Supplier Fees -->
                    {% if card.total_supplier_fees > 0 %}
                    <div class="mt-3" style="padding: 0.75rem; background: rgba(255, 215, 0, 0.08); border-radius: 4px; border: 1px solid rgba(218, 165, 32, 0.2);">
                        <div class="d-flex justify-content-between align-items-center">
                            <span style="color: var(--text-secondary); font-size: 0.85rem;">
                                <i class="bi bi-percent"></i> Supplier Fees (1%)
                            </span>
                            <span style="color: #DAA520; font-weight: 600;">
                                RM {{ "{:,.2f}".format(card.total_supplier_fees) }}
                            </span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 区域 4: 最近交易 (Recent Transactions) -->
    <div class="professional-card mb-4">
        <h2 class="section-title mb-4">
            <i class="bi bi-clock-history"></i> Recent Transactions (Latest 100)
        </h2>
        
        {% if recent_transactions %}
        <div class="table-responsive">
            <table class="table-professional">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Bank</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for txn in recent_transactions %}
                    <tr>
                        <td style="color: var(--text-secondary);">{{ txn.transaction_date }}</td>
                        <td>
                            <small style="color: var(--text-secondary);">{{ txn.bank_name }}</small><br>
                            <small style="color: var(--text-secondary); font-family: monospace;">****{{ txn.card_number_last4 }}</small>
                        </td>
                        <td style="max-width: 300px;">{{ txn.description }}</td>
                        <td>
                            {% if txn.transaction_type == 'credit' %}
                                <span style="color: #90EE90; font-weight: 600;">-RM {{ "{:,.2f}".format(txn.amount|abs) }}</span>
                            {% else %}
                                <span style="color: #87CEEB; font-weight: 600;">RM {{ "{:,.2f}".format(txn.amount|abs) }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if txn.transaction_type == 'credit' %}
                                <span class="badge-professional badge-success-pro">Payment</span>
                            {% else %}
                                <span class="badge-professional badge-info-pro">Expense</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if txn.category == 'owner_expense' %}
                                <span style="color: #87CEEB;"><i class="bi bi-person-fill"></i> OWNER</span>
                            {% elif txn.category == 'infinite_expense' %}
                                <span style="color: #FFD700;"><i class="bi bi-infinity"></i> INFINITE</span>
                            {% elif txn.category == 'owner_payment' %}
                                <span style="color: #90EE90;"><i class="bi bi-person-check"></i> OWNER PAY</span>
                            {% elif txn.category == 'infinite_payment' %}
                                <span style="color: #DAA520;"><i class="bi bi-people"></i> 3RD PARTY</span>
                            {% else %}
                                <span style="color: var(--text-secondary);">{{ txn.category or 'N/A' }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if txn.is_supplier %}
                                <small style="color: #DAA520;">
                                    <i class="bi bi-shop"></i> {{ txn.supplier_name }}<br>
                                    Fee: RM {{ "{:.2f}".format(txn.supplier_fee) }}
                                </small>
                            {% elif txn.payer_name %}
                                <small style="color: var(--text-secondary);">
                                    <i class="bi bi-person"></i> {{ txn.payer_name }}
                                </small>
                            {% else %}
                                <small style="color: var(--text-secondary);">-</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center" style="padding: 2rem; color: var(--text-secondary);">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <p class="mt-3">No transactions found</p>
        </div>
        {% endif %}
    </div>

    <!-- 区域 5: 账单列表 (Statements List) -->
    <div class="professional-card mb-4">
        <h2 class="section-title mb-4">
            <i class="bi bi-file-earmark-text"></i> All Statements
        </h2>
        
        {% for card in cards %}
            {% if card.statements %}
            <h5 style="color: var(--text-primary); margin-top: 1.5rem; margin-bottom: 1rem;">
                {{ card.bank_name }} ****{{ card.card_number_last4 }}
            </h5>
            <div class="table-responsive">
                <table class="table-professional">
                    <thead>
                        <tr>
                            <th>Statement Date</th>
                            <th>Previous Balance</th>
                            <th>Statement Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stmt in card.statements %}
                        <tr>
                            <td style="color: var(--text-primary); font-weight: 600;">{{ stmt.statement_date }}</td>
                            <td style="color: var(--text-secondary);">RM {{ "{:,.2f}".format(stmt.previous_balance) }}</td>
                            <td style="color: #87CEEB; font-weight: 600;">RM {{ "{:,.2f}".format(stmt.statement_total) }}</td>
                            <td>
                                <a href="{{ url_for('view_statement_file', statement_id=stmt.id) }}" class="btn-professional-outline" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;" target="_blank">
                                    <i class="bi bi-eye"></i> View PDF
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endblock %}
