{% extends "base.html" %}

{% block title %}{{ t('statement_review') }} - {{ statement.bank_name }} {{ statement.statement_date }}{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="section-header">
        <h1 class="section-title" style="color: #FF007F;">
            <i class="bi bi-clipboard-check"></i> {{ t('credit_card_statement_review') }}
        </h1>
        <p class="section-subtitle">
            {{ statement.customer_name }} - {{ statement.bank_name }} ****{{ statement.card_number_last4 }}
        </p>
    </div>

    <!-- Navigation -->
    <div class="mb-4">
        <a href="{{ url_for('credit_card_ledger') }}" class="btn-professional-outline">
            <i class="bi bi-arrow-left"></i> {{ t('back_to_all_customers') }}
        </a>
        {% if statement.is_confirmed %}
        <span class="badge" style="background: #28a745; color: white; padding: 0.5rem 1rem; margin-left: 1rem; border-radius: 8px;">
            <i class="bi bi-check-circle-fill"></i> {{ t('approved') }}
        </span>
        {% else %}
        <span class="badge" style="background: #ffc107; color: #000; padding: 0.5rem 1rem; margin-left: 1rem; border-radius: 8px;">
            <i class="bi bi-clock-fill"></i> {{ t('pending_review') }}
        </span>
        {% endif %}
    </div>

    <!-- Statement Summary Card -->
    <div class="professional-card mb-4" style="background: linear-gradient(135deg, rgba(255,0,127,0.05) 0%, rgba(0,0,0,0.95) 100%); border: 2px solid #FF007F;">
        <h3 style="color: #FF007F; margin-bottom: 1.5rem; font-weight: 700;">
            <i class="bi bi-file-earmark-text"></i> {{ t('statement_summary') }}
        </h3>
        <div class="row g-4">
            <div class="col-md-3">
                <div class="text-center p-3" style="background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,0,127,0.2);">
                    <i class="bi bi-calendar3" style="font-size: 2rem; color: #FF007F;"></i>
                    <div style="font-size: 1.3rem; font-weight: 700; color: white; margin-top: 0.5rem;">
                        {{ statement.statement_date }}
                    </div>
                    <small style="color: rgba(255,255,255,0.6);">{{ t('statement_date') }}</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3" style="background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(50,36,70,0.5);">
                    <i class="bi bi-calendar-check" style="font-size: 2rem; color: #322446;"></i>
                    <div style="font-size: 1.3rem; font-weight: 700; color: white; margin-top: 0.5rem;">
                        {{ statement.due_date or 'N/A' }}
                    </div>
                    <small style="color: rgba(255,255,255,0.6);">{{ t('due_date') }}</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3" style="background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(255,0,127,0.2);">
                    <i class="bi bi-cash-stack" style="font-size: 2rem; color: #FF007F;"></i>
                    <div style="font-size: 1.3rem; font-weight: 700; color: #FF007F; margin-top: 0.5rem;">
                        RM {{ "{:,.2f}".format(statement.statement_total) }}
                    </div>
                    <small style="color: rgba(255,255,255,0.6);">{{ t('total_amount') }}</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-3" style="background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid rgba(50,36,70,0.5);">
                    <i class="bi bi-wallet2" style="font-size: 2rem; color: #322446;"></i>
                    <div style="font-size: 1.3rem; font-weight: 700; color: white; margin-top: 0.5rem;">
                        RM {{ "{:,.2f}".format(statement.minimum_payment or 0) }}
                    </div>
                    <small style="color: rgba(255,255,255,0.6);">{{ t('minimum_payment') }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Side-by-Side Review: PDF + Transactions -->
    <div class="row g-4">
        <!-- LEFT: PDF Viewer -->
        <div class="col-lg-6">
            <div class="professional-card" style="height: 100%; min-height: 800px;">
                <h4 style="color: #FF007F; margin-bottom: 1rem; font-weight: 700;">
                    <i class="bi bi-file-pdf"></i> {{ t('original_statement_pdf') }}
                </h4>
                {% if statement.file_path %}
                <div style="width: 100%; height: calc(100% - 60px); background: #1a1a1a; border-radius: 8px; overflow: hidden; border: 2px solid #322446;">
                    <iframe 
                        src="{{ url_for('view_statement_file', statement_id=statement.statement_id) }}"
                        width="100%" 
                        height="100%" 
                        style="border: none; border-radius: 6px;"
                        title="Statement PDF">
                    </iframe>
                </div>
                {% else %}
                <div class="text-center" style="padding: 3rem; color: rgba(255,255,255,0.5);">
                    <i class="bi bi-file-earmark-x" style="font-size: 4rem;"></i>
                    <p class="mt-3">{{ t('no_pdf_file_available') }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- RIGHT: Parsed Transactions Table -->
        <div class="col-lg-6">
            <div class="professional-card" style="height: 100%; min-height: 800px; overflow-y: auto;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 style="color: #FF007F; margin: 0; font-weight: 700;">
                        <i class="bi bi-table"></i> {{ t('parsed_transactions') }}
                    </h4>
                    <span class="badge" style="background: #000; color: #FF007F; border: 2px solid #FF007F; padding: 0.5rem 1rem; font-size: 1rem; border-radius: 8px;">
                        {{ transactions|length }} {{ t('transactions') }}
                    </span>
                </div>

                {% if transactions %}
                <div class="table-responsive" style="max-height: 700px; overflow-y: auto;">
                    <table class="table table-dark table-hover" style="margin: 0;">
                        <thead style="position: sticky; top: 0; background: #1a1a1a; z-index: 10;">
                            <tr>
                                <th style="border-bottom: 2px solid #FF007F; color: #FF007F; font-weight: 700; padding: 1rem;">{{ t('date') }}</th>
                                <th style="border-bottom: 2px solid #FF007F; color: #FF007F; font-weight: 700; padding: 1rem;">{{ t('merchant_description') }}</th>
                                <th style="border-bottom: 2px solid #FF007F; color: #FF007F; font-weight: 700; padding: 1rem; text-align: right;">{{ t('amount') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for txn in transactions %}
                            <tr style="{% if loop.index % 2 == 0 %}background: rgba(255,255,255,0.02);{% endif %}">
                                <td style="padding: 0.8rem; color: rgba(255,255,255,0.7); white-space: nowrap;">
                                    {{ txn.transaction_date }}
                                </td>
                                <td style="padding: 0.8rem; color: white;">
                                    {{ txn.description }}
                                    {% if txn.category %}
                                    <br><small style="color: rgba(255,255,255,0.5);">
                                        <i class="bi bi-tag"></i> {{ txn.category }}
                                    </small>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.8rem; text-align: right; font-weight: 600; white-space: nowrap;">
                                    <span style="{% if txn.transaction_type == 'payment' %}color: #28a745;{% else %}color: #FF007F;{% endif %}">
                                        {% if txn.transaction_type == 'payment' %}-{% endif %}RM {{ "{:,.2f}".format(txn.amount|abs) }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot style="position: sticky; bottom: 0; background: #000; border-top: 3px solid #FF007F;">
                            <tr>
                                <td colspan="2" style="padding: 1rem; color: white; font-weight: 700; font-size: 1.1rem;">
                                    {{ t('total') }}
                                </td>
                                <td style="padding: 1rem; text-align: right; color: #FF007F; font-weight: 700; font-size: 1.2rem;">
                                    RM {{ "{:,.2f}".format(statement.statement_total) }}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center" style="padding: 3rem; color: rgba(255,255,255,0.5);">
                    <i class="bi bi-inbox" style="font-size: 4rem;"></i>
                    <p class="mt-3">{{ t('no_transactions_parsed') }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="professional-card mt-4" style="background: rgba(0,0,0,0.5); border: 2px solid #322446;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 style="color: white; margin: 0;">{{ t('verification_actions') }}</h5>
                <small style="color: rgba(255,255,255,0.6);">{{ t('review_accuracy_then_approve') }}</small>
            </div>
            <div class="d-flex gap-3">
                <a href="{{ url_for('credit_card_ledger_detail', statement_id=statement.statement_id) }}" 
                   class="btn-professional-outline" 
                   style="padding: 0.8rem 1.5rem; font-size: 1rem;">
                    <i class="bi bi-pencil-square"></i> {{ t('edit_transactions') }}
                </a>
                {% if not statement.is_confirmed %}
                <form method="POST" action="{{ url_for('approve_statement', statement_id=statement.statement_id) }}" style="margin: 0;">
                    <button type="submit" class="btn-professional" style="padding: 0.8rem 2rem; font-size: 1rem; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <i class="bi bi-check-circle-fill"></i> {{ t('approve_statement') }}
                    </button>
                </form>
                {% else %}
                <button class="btn-professional" disabled style="padding: 0.8rem 2rem; font-size: 1rem; background: #6c757d; cursor: not-allowed;">
                    <i class="bi bi-check-circle-fill"></i> {{ t('already_approved') }}
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
/* Custom scrollbar for transaction table */
.table-responsive::-webkit-scrollbar {
    width: 10px;
}
.table-responsive::-webkit-scrollbar-track {
    background: #1a1a1a;
    border-radius: 5px;
}
.table-responsive::-webkit-scrollbar-thumb {
    background: #FF007F;
    border-radius: 5px;
}
.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #E6007A;
}

/* Responsive adjustments */
@media (max-width: 991px) {
    .col-lg-6 .professional-card {
        min-height: 500px !important;
    }
}
</style>
{% endblock %}
