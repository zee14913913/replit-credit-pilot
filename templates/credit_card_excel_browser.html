{% extends "base.html" %}

{% block title %}<span data-i18n="credit_card_excel_files">{{ t('credit_card_excel_files') }}</span> - {{ customer_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 标题栏 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-folder2-open"></i> {{ customer_name }} - <span data-i18n="credit_card_excel_files">{{ t('credit_card_excel_files') }}</span></h2>
            <p class="text-muted">
                <i class="bi bi-info-circle"></i> 
                <span data-i18n="total">{{ t('total') }}</span> {{ months_data|length }} <span data-i18n="months_records">{{ t('months_records') }}</span>
            </p>
        </div>
        <div>
            <a href="{{ url_for('credit_card_ledger') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> <span data-i18n="back_to_ledger">{{ t('back_to_ledger') }}</span>
            </a>
        </div>
    </div>

    <!-- 月份列表 - 手风琴式展开 -->
    {% if months_data %}
    <div class="accordion" id="monthsAccordion">
        {% for month in months_data %}
        <div class="card month-card mb-3">
            <!-- 月份标题 - 可点击展开 -->
            <div class="card-header month-header" id="heading{{ loop.index }}">
                <button class="accordion-button collapsed" type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapse{{ loop.index }}"
                        aria-expanded="false" 
                        aria-controls="collapse{{ loop.index }}">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div class="month-title">
                            <i class="bi bi-calendar3"></i>
                            <strong>{{ month.display_name }}</strong>
                        </div>
                        <div class="month-stats">
                            <span class="badge bg-primary me-2">{{ month.bank_count }} <span data-i18n="banks_unit">{{ t('banks_unit') }}</span></span>
                            {% if month.summary %}
                            <span class="badge bg-success" data-i18n="includes_monthly_summary">{{ t('includes_monthly_summary') }}</span>
                            {% endif %}
                        </div>
                    </div>
                </button>
            </div>

            <!-- 月份内容 - 银行列表 -->
            <div id="collapse{{ loop.index }}" 
                 class="accordion-collapse collapse" 
                 aria-labelledby="heading{{ loop.index }}"
                 data-bs-parent="#monthsAccordion">
                <div class="card-body">
                    
                    <!-- View detailed calculation button -->
                    <div class="mb-4 text-center">
                        <a href="{{ url_for('credit_card_month_detail', customer_id=customer.id, year_month=month.year_month) }}" 
                           class="btn btn-lg btn-gradient-detail">
                            <i class="bi bi-calculator-fill"></i> 
                            <span data-i18n="view_detailed_calculation">{{ t('view_detailed_calculation') }}</span>
                            <i class="bi bi-arrow-right-circle"></i>
                        </a>
                        <div class="detail-hint" data-i18n="detail_calculation_hint">
                            {{ t('detail_calculation_hint') }}
                        </div>
                    </div>
                    
                    <!-- Monthly summary file -->
                    {% if month.summary %}
                    <div class="summary-section mb-4">
                        <h6 class="section-title">
                            <i class="bi bi-file-bar-graph-fill text-warning"></i> 
                            <span data-i18n="monthly_summary">{{ t('monthly_summary') }}</span>
                        </h6>
                        <div class="file-item summary-item">
                            <div class="file-icon">
                                <i class="bi bi-file-earmark-excel-fill text-success"></i>
                            </div>
                            <div class="file-info">
                                <div class="file-name">{{ month.summary.name }}</div>
                                <div class="file-meta">
                                    {{ (month.summary.size / 1024) | round(1) }} KB
                                    <span class="mx-2">|</span>
                                    {{ month.summary.modified }}
                                </div>
                            </div>
                            <div class="file-action">
                                <a href="{{ url_for('download_credit_card_excel_file', path=month.summary.path) }}" 
                                   class="btn btn-sm btn-warning">
                                    <i class="bi bi-download"></i> <span data-i18n="download_summary">{{ t('download_summary') }}</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Bank list -->
                    <h6 class="section-title">
                        <i class="bi bi-bank2"></i> 
                        <span data-i18n="bank_statements">{{ t('bank_statements') }}</span>（{{ month.bank_count }} <span data-i18n="banks_unit">{{ t('banks_unit') }}</span>）
                    </h6>
                    
                    <div class="banks-grid">
                        {% for bank_name, files in month.banks.items() %}
                        <div class="bank-item">
                            <div class="bank-header">
                                <i class="bi bi-building"></i>
                                <strong>{{ bank_name }}</strong>
                            </div>
                            {% for file in files %}
                            <div class="file-item">
                                <div class="file-icon">
                                    <i class="bi bi-file-earmark-excel text-success"></i>
                                </div>
                                <div class="file-info">
                                    <div class="file-name">{{ file.name }}</div>
                                    <div class="file-meta">
                                        {{ (file.size / 1024) | round(1) }} KB
                                        <span class="mx-2">|</span>
                                        {{ file.modified }}
                                    </div>
                                </div>
                                <div class="file-action">
                                    <a href="{{ url_for('download_credit_card_excel_file', path=file.path) }}" 
                                       class="btn btn-sm btn-download">
                                        <i class="bi bi-download"></i> <span data-i18n="download">{{ t('download') }}</span>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> 
        <span data-i18n="no_excel_files_yet">{{ t('no_excel_files_yet') }}</span>
    </div>
    {% endif %}

    <!-- Usage instructions -->
    <div class="alert alert-light mt-4">
        <h6><i class="bi bi-lightbulb"></i> <span data-i18n="usage_instructions">{{ t('usage_instructions') }}</span></h6>
        <ul class="mb-0">
            <li data-i18n="expand_month_to_view">{{ t('expand_month_to_view') }}</li>
            <li data-i18n="each_month_includes">{{ t('each_month_includes') }}</li>
            <li data-i18n="click_download_to_get">{{ t('click_download_to_get') }}</li>
        </ul>
    </div>
</div>

<style>
/* 月份卡片样式 */
.month-card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
}

.month-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
}

/* 月份标题 */
.month-header {
    background: linear-gradient(135deg, #FF007F 0%, #322446 100%);
    border: none;
    padding: 0;
}

.month-header .accordion-button {
    background: transparent;
    color: white;
    padding: 20px 24px;
    font-size: 16px;
    font-weight: 600;
    border: none;
    box-shadow: none;
}

.month-header .accordion-button:not(.collapsed) {
    background: transparent;
    color: white;
}

.month-header .accordion-button::after {
    filter: brightness(0) invert(1);
}

.month-header .accordion-button:focus {
    box-shadow: none;
}

.month-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

.month-title i {
    font-size: 20px;
}

.month-stats {
    display: flex;
    gap: 8px;
}

/* 卡片主体 */
.card-body {
    padding: 24px;
    background-color: #fafbfc;
}

/* 查看详细计算按钮 */
.btn-gradient-detail {
    background: linear-gradient(135deg, #FF007F 0%, #322446 100%);
    color: white;
    font-weight: 600;
    padding: 14px 32px;
    border: none;
    border-radius: 50px;
    font-size: 16px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(255, 0, 127, 0.3);
}

.btn-gradient-detail:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 0, 127, 0.4);
    color: white;
}

.detail-hint {
    margin-top: 12px;
    color: #666;
    font-size: 13px;
    font-style: italic;
}

/* 区块标题 */
.section-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e9ecef;
}

.section-title i {
    margin-right: 8px;
}

/* 月度汇总区域 */
.summary-section {
    background: white;
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.summary-item {
    border: none !important;
    background: transparent !important;
}

/* 银行网格 */
.banks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
    gap: 16px;
}

.bank-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 16px;
    transition: all 0.2s ease;
}

.bank-item:hover {
    border-color: #FF007F;
    box-shadow: 0 2px 8px rgba(255, 0, 127, 0.15);
}

.bank-header {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #322446;
    font-size: 15px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e9ecef;
}

.bank-header i {
    font-size: 18px;
    color: #FF007F;
}

/* 文件项 */
.file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 8px;
    border: 1px solid #e9ecef;
}

.file-item:last-child {
    margin-bottom: 0;
}

.file-icon {
    flex-shrink: 0;
}

.file-icon i {
    font-size: 28px;
}

.file-info {
    flex-grow: 1;
    min-width: 0;
}

.file-name {
    font-weight: 500;
    color: #2c3e50;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-meta {
    font-size: 12px;
    color: #6c757d;
    margin-top: 4px;
}

.file-action {
    flex-shrink: 0;
}

/* 下载按钮 */
.btn-download {
    background: linear-gradient(135deg, #FF007F 0%, #322446 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-download:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 0, 127, 0.3);
    color: white;
}

/* 徽章样式 */
.badge {
    padding: 6px 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* 响应式 */
@media (max-width: 768px) {
    .banks-grid {
        grid-template-columns: 1fr;
    }
    
    .month-stats {
        flex-direction: column;
        align-items: flex-end;
    }
}
</style>
{% endblock %}
