{% extends "base.html" %}

{% block title %}SME Loan Evaluation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="text-center mb-5">
                <h1 class="galaxy-gradient-text mb-3">
                    <i class="bi bi-building-fill-gear me-2"></i>SME Business Loan Evaluation
                </h1>
                <p class="fs-5" style="color: #FF007F; font-weight: 700;">
                    Advanced SME Risk Assessment | BRR · DSCR · Industry Analysis
                </p>
            </div>

            <!-- Features Card -->
            <div class="galaxy-card mb-5">
                <div class="card-body">
                    <div class="section-header mb-4">
                        <h5 class="galaxy-gradient-text mb-3">
                            <i class="bi bi-stars me-2"></i>SME Modern Engine Features
                        </h5>
                        <div class="title-divider"></div>
                    </div>
                    
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-graph-up text-golden fs-4 me-3"></i>
                                <div>
                                    <h6 class="text-white mb-1">{{ t('brr_analysis') }}</h6>
                                    <small class="text-silver-pearl">{{ t('business_revenue_ratio__core_sme_metric') }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-cash-coin text-golden fs-4 me-3"></i>
                                <div>
                                    <h6 class="text-white mb-1">{{ t('dscr_calculation') }}</h6>
                                    <small class="text-silver-pearl">{{ t('debt_service_coverage_ratio_for_cashflow') }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-pie-chart text-golden fs-4 me-3"></i>
                                <div>
                                    <h6 class="text-white mb-1">{{ t('industry_risk_scoring') }}</h6>
                                    <small class="text-silver-pearl">{{ t('sectorspecific_risk_adjustment') }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Mode Toggle -->
            <div class="galaxy-card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white mb-1">{{ t('data_collection_mode') }}</h6>
                            <small class="text-silver-pearl">{{ t('choose_how_to_provide_sme_loan_application_data') }}</small>
                        </div>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="data_mode_toggle" id="mode_manual" value="manual" checked>
                            <label class="btn btn-outline-light" for="mode_manual">
                                <i class="bi bi-pencil-square me-1"></i>Manual Input
                            </label>
                            
                            <input type="radio" class="btn-check" name="data_mode_toggle" id="mode_auto" value="auto">
                            <label class="btn btn-outline-light" for="mode_auto">
                                <i class="bi bi-cpu me-1"></i>Auto Enrichment
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evaluation Form -->
            <div class="galaxy-card">
                <div class="card-body">
                    <div class="section-header mb-5">
                        <h5 class="galaxy-gradient-text mb-3">
                            <i class="bi bi-briefcase-fill me-2"></i>SME Business Details
                        </h5>
                        <div class="title-divider"></div>
                    </div>
                    
                    <form id="smeLoanForm" action="/sme-loan-evaluate/submit" method="post">
                        <input type="hidden" name="data_mode" id="data_mode_input" value="manual">
                        
                        <div class="row g-4">
                            <!-- Customer ID -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-hash me-2"></i>Customer ID / Business ID
                                </label>
                                <input type="number" name="customer_id" class="form-control galaxy-input" required min="1" placeholder="Enter customer/business ID">
                            </div>

                            <!-- Monthly Revenue -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-currency-dollar me-2"></i>{{ t('monthly_revenue_rm') }}<span class="text-danger">*</span>
                                </label>
                                <input type="number" name="monthly_revenue" class="form-control galaxy-input" required step="0.01" min="0" placeholder="Average monthly business revenue">
                                <small class="text-golden">
                                    <i class="bi bi-info-circle me-1"></i>Based on latest financial statements
                                </small>
                            </div>

                            <!-- Monthly Commitment -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-credit-card-2-back me-2"></i>{{ t('monthly_debt_commitment_rm') }}<span class="text-danger">*</span>
                                </label>
                                <input type="number" name="monthly_commitment" class="form-control galaxy-input" required step="0.01" min="0" placeholder="Total monthly loan/debt repayments">
                                <small class="text-golden">
                                    <i class="bi bi-shield-check me-1"></i>From CTOS SME report
                                </small>
                            </div>

                            <!-- Industry -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-diagram-3 me-2"></i>Industry Sector
                                </label>
                                <select name="industry" class="form-select galaxy-input">
                                    <option value="">{{ t('autodetect') }}</option>
                                    <option value="technology">{{ t('technology__it_services') }}</option>
                                    <option value="manufacturing">{{ t('manufacturing') }}</option>
                                    <option value="retail">{{ t('retail__ecommerce') }}</option>
                                    <option value="fnb">{{ t('food_and_beverage') }}</option>
                                    <option value="construction">{{ t('construction') }}</option>
                                    <option value="professional_services">{{ t('professional_services') }}</option>
                                    <option value="healthcare">{{ t('healthcare') }}</option>
                                    <option value="education">{{ t('education') }}</option>
                                    <option value="transportation">{{ t('transportation__logistics') }}</option>
                                    <option value="agriculture">{{ t('agriculture') }}</option>
                                    <option value="real_estate">{{ t('real_estate') }}</option>
                                    <option value="other">{{ t('category_other') }}</option>
                                </select>
                                <small class="text-silver-pearl">
                                    <i class="bi bi-info-circle me-1"></i>Industry affects risk scoring
                                </small>
                            </div>

                            <!-- Years in Business -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-calendar-event me-2"></i>Years in Business
                                </label>
                                <input type="number" name="years_in_business" class="form-control galaxy-input" step="0.5" min="0" placeholder="Business operating years">
                                <small class="text-silver-pearl">
                                    <i class="bi bi-lightbulb me-1"></i>Affects stability score
                                </small>
                            </div>

                            <!-- CTOS SME Score -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-star-fill me-2"></i>CTOS SME Score
                                </label>
                                <input type="number" name="ctos_sme_score" class="form-control galaxy-input" min="300" max="850" placeholder="300-850 (Optional)">
                                <small class="text-silver-pearl">
                                    <i class="bi bi-info-circle me-1"></i>Leave blank for auto-estimate (default: 650)
                                </small>
                            </div>

                            <!-- Cashflow Variance -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-arrow-left-right me-2"></i>Cashflow Variance
                                </label>
                                <input type="number" name="cashflow_variance" class="form-control galaxy-input" step="0.01" min="0" max="1" placeholder="0.00 - 1.00">
                                <small class="text-silver-pearl">
                                    <i class="bi bi-info-circle me-1"></i>Cashflow stability (0=stable, 1=volatile). Default: 0.30
                                </small>
                            </div>

                            <!-- Target Bank -->
                            <div class="col-md-6">
                                <label class="form-label text-silver-pearl">
                                    <i class="bi bi-bank2 me-2"></i>Target Financial Institution (Optional)
                                </label>
                                <input type="text" name="target_bank" class="form-control galaxy-input" placeholder="e.g., SME Bank, CIMB (leave blank for all)">
                                <small class="text-golden">
                                    <i class="bi bi-filter me-1"></i>Filter SME products by specific institution
                                </small>
                            </div>

                            <!-- Submit Button -->
                            <div class="col-12 text-center pt-5 mt-4">
                                <button type="submit" class="btn btn-lg px-5 py-3 galaxy-shimmer white-glow-btn" style="font-size: 1.2rem;">
                                    <i class="bi bi-building-fill-gear me-2"></i>
                                    Run SME Risk Assessment
                                </button>
                                <div class="mt-3">
                                    <small class="text-silver-pearl">
                                        <i class="bi bi-shield-check me-1"></i>
                                        Powered by SME Banking Standards (BRR · DSCR · Industry Risk)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Information Box -->
            <div class="galaxy-card mt-4" style="border: 2px solid rgba(255, 0, 127, 0.3);">
                <div class="card-body">
                    <h6 class="text-white mb-3">
                        <i class="bi bi-info-circle-fill text-golden me-2"></i>SME Loan Requirements
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="text-silver-pearl small mb-1">{{ t('minimum_revenue') }}</div>
                            <div class="text-white">{{ t('rm_10000month_recommended') }}</div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-silver-pearl small mb-1">{{ t('optimal_brr') }}</div>
                            <div class="text-success">{{ t('_20_revenue_2x_commitment') }}</div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-silver-pearl small mb-1">{{ t('optimal_dscr') }}</div>
                            <div class="text-success">≥ 1.25</div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-silver-pearl small mb-1">{{ t('typical_loan_amount') }}</div>
                            <div class="text-white">{{ t('rm_50000__rm_5000000') }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back Button -->
            <div class="text-center mt-4">
                <a href="{{ url_for('loan_matcher') }}" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left me-2"></i>Back to Loan Matcher
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Data mode toggle handler
document.querySelectorAll('input[name="data_mode_toggle"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('data_mode_input').value = this.value;
        
        // Visual feedback
        const modeInfo = document.createElement('div');
        modeInfo.className = 'alert alert-info mt-3';
        modeInfo.innerHTML = '<i class="bi bi-info-circle me-2"></i>' + 
            (this.value === 'auto' 
                ? 'Auto mode: System will intelligently fill missing SME fields based on business data and industry benchmarks.' 
                : 'Manual mode: All fields must be provided manually.');
        
        const existingInfo = document.querySelector('.alert-info');
        if (existingInfo) existingInfo.remove();
        
        this.closest('.galaxy-card').after(modeInfo);
        setTimeout(() => modeInfo.remove(), 5000);
    });
});
</script>

<style>
.btn-check:checked + .btn-outline-light {
    background: linear-gradient(135deg, #FF007F, #D4AF37);
    color: white;
    font-weight: 700;
}
</style>
{% endblock %}
