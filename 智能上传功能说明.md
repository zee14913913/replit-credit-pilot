# 🎯 智能上传CSV功能 - 完整说明

## 🎉 **新功能上线！**

现在你可以**随意上传任何客户、任何银行的CSV月结单**，系统会**自动识别**并存放到正确位置！

---

## ✨ **核心能力**

### **🔍 自动识别能力**

系统会从CSV文件内容中**智能提取**以下信息：

1. **🏦 银行名称**
   - Maybank, Public Bank, CIMB, RHB, Hong Leong等15家主流银行
   - 从交易描述中识别银行关键词

2. **🔢 账号**
   - 自动识别10-16位数字账号
   - 支持带分隔符的账号格式

3. **📅 月份**
   - 分析所有交易日期
   - 自动确定该月结单所属月份

4. **💰 交易统计**
   - 总交易笔数
   - 借方/贷方总金额
   - 日期范围

5. **✅ 置信度评分**
   - 0-100%的识别准确度
   - 低于30%会提示手动确认

---

## 🚀 **使用流程**

### **步骤1：打开文件管理**
```
首页 → 📁 文件管理
```

### **步骤2：点击"📤 智能上传CSV"按钮**
在文件管理页面顶部，你会看到4个按钮：
- ← 返回首页
- **📤 智能上传CSV** ← **点这个！**
- 🔄 刷新列表
- 🧪 运行新测试

### **步骤3：选择CSV文件**
点击后会弹出文件选择器，选择任意银行月结单CSV文件。

### **步骤4：自动识别与导入**
系统会自动：
1. 📊 读取CSV内容
2. 🔍 智能分析识别信息
3. 💾 导入到数据库
4. 🤖 自动匹配会计分录
5. 📁 保存原始文件到正确位置

### **步骤5：查看识别结果**
上传完成后会显示弹窗：
```
✅ 智能识别成功！导入 10 笔交易，自动匹配 10 笔

📊 智能识别结果：
• 银行: Maybank
• 账号: 3824549009
• 月份: 2024-07
• 导入交易: 10 笔
• 自动匹配: 10 笔

📁 文件已保存至:
/home/runner/workspace/accounting_data/statements/company1_Maybank_3824549009_2024-07_20251101_104530.csv
```

---

## 🎯 **智能识别工作原理**

### **1. 银行识别**
系统会扫描交易描述，查找银行关键词：

**支持的银行（15家）：**
- Maybank
- Public Bank
- CIMB
- Hong Leong Bank
- RHB Bank
- AmBank
- UOB
- OCBC
- HSBC
- Standard Chartered
- Alliance Bank
- Affin Bank
- Bank Islam
- Bank Rakyat
- BSN

**识别方法：**
```python
# 从交易描述中查找
"June payout MAYBANK transfer" → 识别为 "Maybank"
"PUBLIC BANK deposit" → 识别为 "Public Bank"
```

---

### **2. 账号识别**
从交易描述中提取数字序列：

**识别规则：**
- 连续10-16位数字
- 支持带分隔符：`1234-5678-9012`

**示例：**
```
"Transfer from account 3824549009" → 账号: 3824549009
"Ref: 1122-3344-5566" → 账号: 112233445566
```

---

### **3. 月份识别**
分析所有交易日期，选择交易最多的月份：

**识别逻辑：**
```
交易日期分布：
2024-07-01: 2笔
2024-07-10: 5笔  ← 最多
2024-07-25: 3笔

确定月份: 2024-07
```

---

### **4. 置信度计算**
综合评分系统：

```
置信度 = 银行识别(30%) + 账号识别(30%) + 月份识别(20%) + 交易数量(20%)

示例：
✅ 银行: Maybank          +30%
✅ 账号: 3824549009       +30%
✅ 月份: 2024-07          +20%
✅ 交易: 10笔             +20%
─────────────────────────────
总置信度: 100%
```

**阈值：**
- ≥ 70%: 高可信度，自动导入
- 30-69%: 中等可信度，显示警告但仍导入
- < 30%: 低可信度，拒绝导入并提示手动指定

---

## 📁 **文件存储规则**

### **存储位置**
```
/accounting_data/statements/
```

### **文件命名规则**
```
company{公司ID}_{银行名}_{账号}_{月份}_{时间戳}.csv

示例：
company1_Maybank_3824549009_2024-07_20251101_104530.csv
│       │        │           │       │
│       │        │           │       └─ 上传时间 (年月日_时分秒)
│       │        │           └───────── 月份 (年-月)
│       │        └───────────────────── 账号
│       └────────────────────────────── 银行名称
└────────────────────────────────────── 公司ID
```

**好处：**
- ✅ 一眼看出这是哪个客户的哪个银行的哪个月份
- ✅ 同一个文件可以多次上传（时间戳不同）
- ✅ 自动分类整理
- ✅ 便于查找和管理

---

## 🔄 **完整工作流程**

### **上传前**
```
CSV文件: bank_statement.csv
├── 内容：10笔Maybank交易
├── 日期：2024-07-01 至 2024-07-31
└── 账号：3824549009
```

### **智能分析**
```
📊 正在分析...
├── 🔍 扫描交易描述 → 发现"MAYBANK"
├── 🔢 提取账号 → "3824549009"
├── 📅 分析日期 → "2024-07"
├── 💰 统计金额 → 借方 RM 61,629.03
└── ✅ 置信度 → 100%
```

### **导入数据库**
```
📥 正在导入...
├── 插入 bank_statements 表
│   ├── Transaction 1: 2024-07-01, payout, RM 2,270.83
│   ├── Transaction 2: 2024-07-02, stock, RM 4,815.45
│   └── ... (共10笔)
├── 运行自动匹配
│   ├── 生成会计分录
│   └── 匹配成功: 10/10
└── ✅ 导入完成
```

### **保存文件**
```
💾 正在保存...
├── 文件名: company1_Maybank_3824549009_2024-07_20251101_104530.csv
├── 位置: /accounting_data/statements/
└── ✅ 保存成功
```

### **返回结果**
```
✅ 智能识别成功！
├── 导入: 10 笔交易
├── 匹配: 10 笔分录
├── 识别信息: Maybank, 3824549009, 2024-07
└── 文件已保存
```

---

## 🎨 **界面设计**

### **上传按钮位置**
```
┌─────────────────────────────────────────────────────┐
│ 📁 文件管理中心                                       │
├─────────────────────────────────────────────────────┤
│ [← 返回首页] [📤 智能上传CSV] [🔄 刷新] [🧪 测试]    │ ← 这里
├─────────────────────────────────────────────────────┤
│ 📊 月结单文件: 1个                                    │
│ 📝 测试报告: 1个                                      │
│ 💾 总存储空间: 2.1 MB                                │
└─────────────────────────────────────────────────────┘
```

### **上传过程提示**
```
┌─────────────────────────────────────┐
│ 📤 正在智能分析并上传文件...        │
│                                     │
│ [进度条]                            │
└─────────────────────────────────────┘
```

### **识别结果弹窗**
```
┌─────────────────────────────────────────────────┐
│ ✅ 智能识别成功！导入 10 笔交易，自动匹配 10 笔 │
│                                                 │
│ 📊 智能识别结果：                               │
│ • 银行: Maybank                                 │
│ • 账号: 3824549009                              │
│ • 月份: 2024-07                                 │
│ • 导入交易: 10 笔                               │
│ • 自动匹配: 10 笔                               │
│                                                 │
│ 📁 文件已保存至:                                │
│ /accounting_data/statements/...                │
│                                                 │
│                           [确定]                │
└─────────────────────────────────────────────────┘
```

---

## 💡 **使用场景**

### **场景1：上传不同银行的月结单**
```
📤 上传 Maybank_July.csv
✅ 识别: Maybank, 2024-07, 10笔交易

📤 上传 PublicBank_August.csv
✅ 识别: Public Bank, 2024-08, 15笔交易

📤 上传 CIMB_September.csv
✅ 识别: CIMB, 2024-09, 20笔交易

结果：3个月结单，自动分类存储
```

### **场景2：同一客户多个银行账户**
```
📤 上传 Account_A.csv
✅ 识别: Maybank, 账号 1234567890

📤 上传 Account_B.csv
✅ 识别: Maybank, 账号 0987654321

结果：同一银行不同账号，自动区分
```

### **场景3：批量上传历史月结单**
```
📤 上传 2024-01.csv → ✅ 导入1月数据
📤 上传 2024-02.csv → ✅ 导入2月数据
📤 上传 2024-03.csv → ✅ 导入3月数据
...
📤 上传 2024-12.csv → ✅ 导入12月数据

结果：全年数据快速导入
```

---

## ⚠️ **注意事项**

### **CSV格式要求**
必须包含以下列：
```
Date, Description, Debit, Credit, Balance
```

**示例：**
```csv
Date,Description,Debit,Credit,Balance
2024-07-01,June payout INFINITE.GZ MUHSIN,2270.83,0,45000.00
2024-07-02,Stock purchase MAYBANK shares,4815.45,0,42729.17
```

### **识别失败怎么办？**
如果置信度 < 30%，系统会提示：
```
❌ 无法识别文件信息，置信度过低

建议：
1. 检查CSV格式是否正确
2. 确保有Date和Description列
3. 联系管理员手动导入
```

### **重复上传**
- ✅ 允许同一文件多次上传
- ✅ 时间戳确保文件名不重复
- ⚠️ 数据库会有重复交易（需手动清理）

---

## 🎉 **立即体验**

### **测试步骤：**

1. **刷新Webview**

2. **访问文件管理**
   ```
   首页 → 📁 文件管理
   ```

3. **点击"📤 智能上传CSV"**

4. **选择测试CSV文件**
   - 可以使用之前的 `maybank_july_2024.csv`
   - 或任何符合格式的CSV文件

5. **查看识别结果**
   - 系统会自动分析
   - 显示识别的银行、账号、月份
   - 确认导入和匹配结果

6. **在文件列表中查看**
   - 刷新列表
   - 看到新上传的文件
   - 点击"👁️ 查看"预览内容

---

## 🚀 **总结**

### **智能上传的优势：**

✅ **零手工输入**
- 不需要手动选择银行
- 不需要输入账号
- 不需要指定月份

✅ **智能识别**
- 自动从CSV内容提取信息
- 15家主流银行支持
- 置信度评分确保准确性

✅ **自动归类**
- 文件自动命名
- 自动存储到正确位置
- 便于管理和查找

✅ **一键完成**
- 上传 → 识别 → 导入 → 匹配 → 保存
- 全流程自动化
- 30秒内完成

---

**现在就试试吧！随便上传任何CSV月结单，系统会自动处理！** 🎉
