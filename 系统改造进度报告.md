# 系统瘦身+收紧改造 - 进度报告

**更新时间**：2025-01-02  
**改造目标**：将"功能全但有点厚"的系统精简，明确5000和8000端口功能边界

---

## ✅ 已完成（核心安全收紧）

### 1. 【安全】关闭5000端口/admin公开访问 ✅

**改动内容**：
- ✅ 创建 `auth/admin_auth_helper.py` 认证辅助模块
  - `verify_user_with_accounting_api()`: 调用8000端口的`/api/auth/me`验证
  - `require_admin_or_accountant` 装饰器：只允许admin/accountant访问
  - `require_admin_only` 装饰器：只允许admin访问
  
- ✅ 为所有admin路由添加权限控制（`app.py`）：
  - `/admin` → 添加 `@require_admin_or_accountant`
  - `/admin/api-keys` → 添加 `@require_admin_or_accountant`
  - `/admin/customers-cards` → 添加 `@require_admin_or_accountant`
  - `/admin/portfolio` → 添加 `@require_admin_or_accountant`
  - `/admin/portfolio/client/<int:customer_id>` → 添加 `@require_admin_or_accountant`
  - `/admin/test-generate-reports` → 添加 `@require_admin_or_accountant`
  - `/admin/test-send-reports` → 添加 `@require_admin_or_accountant`
  - `/admin/automation-status` → 添加 `@require_admin_or_accountant`
  - `/savings-admin` → 添加 `@require_admin_or_accountant`

**预期效果**：
- ❌ 未登录访问`/admin` → 自动跳转登录页
- ❌ 普通客户访问`/admin` → 提示"权限不足：此页面仅限管理员和会计人员访问"
- ✅ 只有admin和accountant角色能看到管理后台

---

### 2. 【安全】API Key创建权限收紧 ✅

**改动内容**：
- ✅ 修改 `accounting_app/routes/api_key_management.py`
  - 将权限检查从 `["admin", "accountant"]` 改为 `"admin"` only
  - 更新错误提示："权限不足：只有超级管理员可以创建API密钥（客户和会计人员请联系管理员）"

**预期效果**：
- ❌ 会计人员（accountant）无法创建API Key
- ❌ 客户（viewer）无法创建API Key  
- ✅ 只有admin可以创建和管理API Key

---

### 3. 【安全】Swagger文档添加登录验证 ✅

**改动内容**：
- ✅ 修改 `accounting_app/main.py`
  - 禁用默认公开的`/docs`和`/redoc`
  - 创建自定义的需要登录的文档路由
  - 检查`Authorization` header或`session_token` cookie
  - 未登录显示友好提示页面："API文档仅限登录用户访问"

**预期效果**：
- ❌ 未登录访问`http://localhost:8000/docs` → 显示登录提示页
- ✅ 登录后才能看到Swagger UI和ReDoc文档
- ✅ 防止API接口被公开暴露

---

## 🚧 进行中（即将完成）

### 4. 【体验】优化上传失败提示

**计划改动**：
- 修改上传失败的错误提示文案
- 从："系统说没有资料无法分析"
- 改为："我找到了您的原件，但它还没通过行数验证，请到异常中心处理后再分析"
- 明确告知用户：文件已保存（不会丢失），只是未通过验证

**待修改文件**：
- `app.py` - Flask上传相关提示
- `accounting_app/routes/bank_import_v2.py` - FastAPI上传提示
- `ingest/` 相关解析器的错误提示

---

## 📝 待实施（重要性排序）

### 高优先级（安全&体验）

#### 5. 【权限】导出功能分级
- PDF下载：保留给所有角色（已生成的snapshot）
- CSV/Excel导出：添加`@require_admin_or_accountant`
- 删除客户侧的"随手导出全部交易"按钮

#### 6. 【权限】首页客户列表权限过滤
- 修改`/`路由
- 普通客户只看自己的数据
- Admin看全部客户列表

#### 7. 【精简】收据OCR自动匹配改为人工确认
- 修改`services/receipt_matcher.py`
- 禁用自动匹配逻辑
- 改为"待人工确认"状态

---

### 中优先级（功能精简）

#### 8. 【精简】高级分析功能收起到Beta菜单
- 添加环境变量 `FEATURE_ADVANCED_ANALYTICS=false`
- 现金流预测、异常检测、财务评分默认隐藏
- 保留API接口，只是UI不显示

#### 9. 【精简】客户等级系统改为后台开关
- 添加环境变量 `FEATURE_CUSTOMER_TIER=false`
- Silver/Gold/Platinum等级默认不显示
- 保留营销配置能力

---

### 低优先级（架构优化，复杂但重要）

#### 10. 【合并】5000批量上传改为转发8000处理
- 保留`accounting_app/routes/bank_import_v2.py`的批量上传
- 删除`app.py`中的批量上传路由
- 5000端口的批量上传改为调用8000 API

#### 11. 【统一】文件路径统一到FILES_BASE_DIR
- 定义`FILES_BASE_DIR=/files`环境变量
- 所有文件上传统一调用8000 API落盘
- Flask上传 → POST 8000 → 统一存储

#### 12. 【统一】认证来源统一
- 所有上传操作必须包含`company_id` + `user_id`
- Flask上传前调用8000验证
- 无验证数据进入staging，不直接入库

---

## 📚 文档更新（最后同步）

#### 13. 更新系统操作手册
需要修改的说法：
- ❌ "（目前是公开的，没有密码保护）"
- ✅ "此页面仅管理员和会计可见，登录后自动识别角色显示对应功能。"

- ❌ "可以一次性上传多个客户的多份账单。"
- ✅ "批量上传会转交会计引擎（8000）处理，上传成功≠验证成功，请到异常中心看验证状态。"

- ❌ "系统会自动识别并分类客户的异常消费。"
- ✅ "系统会标记可能的异常消费，最终分类以会计/管理员确认为准。"

---

## 🎯 最终功能边界（目标）

### 5000端口（信用卡系统）- 客户侧
只做**4件事**：
1. ✅ 客户资料 + 卡资料管理
2. ✅ 上传账单 + 验证 + 展示
3. ✅ 简单报告给客户看（月度PDF）
4. ⏳ 把原件丢给8000存档（待实施）

### 8000端口（会计系统）- 专业侧
才做**这些**：
1. ✅ 文件封存 + 行数验证
2. ✅ 自动分录 + Aging + 报表
3. ✅ 导出给SQL/AutoCount/UBS
4. ✅ 管理报告 / Bank Package
5. ✅ 异常中心 + 审计日志
6. ✅ API密钥管理（只admin可创建）

---

## 📊 进度统计

### 总任务：14项
- ✅ **已完成**：3项（21%）
  - Task 1: Admin页面权限 ✅
  - Task 11: API Key权限收紧 ✅
  - Task 12: Swagger文档保护 ✅

- 🚧 **进行中**：1项（7%）
  - Task 9: 优化上传失败提示 🚧

- ⏳ **待实施**：10项（72%）
  - 高优先级：3项（导出分级、客户列表过滤、收据OCR）
  - 中优先级：2项（高级分析Beta、客户等级开关）
  - 低优先级：3项（批量上传合并、文件路径统一、认证统一）
  - 文档更新：1项
  - 最终测试：1项

---

## ⚠️ 技术债务记录

1. **双认证体系未统一**
   - 当前：Flask session + FastAPI token 共存
   - 未来：需统一到FastAPI RBAC

2. **文件上传路径混乱**
   - 当前：5000有自己的uploads/, 8000也有
   - 未来：全部通过8000统一管理

3. **批量上传重复逻辑**
   - 当前：5000和8000各有一套
   - 未来：只保留8000版本

---

## 🔄 下一步行动计划

### 立即执行（今天）
1. ✅ 完成Task 9: 优化上传失败提示
2. ⏳ 实施Task 3: 导出功能分级
3. ⏳ 实施Task 7: 首页客户列表权限过滤

### 本周执行
4. Task 10: 收据OCR改人工确认
5. Task 4/5: 高级分析和客户等级添加开关
6. Task 13: 更新文档

### 下周执行（复杂改造）
7. Task 6: 批量上传合并
8. Task 8: 文件路径统一
9. Task 2: 认证来源统一

### 最后
10. Task 14: 全面测试

---

## 📋 测试检查清单（Task 14）

完成所有改造后，需测试：

### 权限测试
- [ ] 未登录访问`/admin` → 跳转登录
- [ ] 客户角色访问`/admin` → 403禁止
- [ ] 会计角色尝试创建API Key → 403禁止
- [ ] 未登录访问`http://localhost:8000/docs` → 显示登录提示

### 功能测试
- [ ] Admin登录后能看到管理后台
- [ ] Admin能创建API Key
- [ ] 客户只能看到自己的数据
- [ ] PDF下载功能正常
- [ ] CSV导出只有admin/accountant能用

### 数据完整性测试
- [ ] 上传文件自动进入8000验证
- [ ] validation_status='failed'的文件不出现在报表中
- [ ] 异常中心能看到验证失败的记录

---

## 🎉 改造收益

完成所有任务后，系统将获得：

1. **更安全**：
   - 管理后台不再公开
   - API文档需要登录
   - API Key只有admin能创建

2. **更清晰**：
   - 5000端口：客户功能
   - 8000端口：专业会计功能
   - 功能边界明确，不再混乱

3. **更可控**：
   - 文件路径统一
   - 认证来源统一
   - 批量上传统一

4. **更专业**：
   - 高级功能可选（Beta）
   - 提示信息更友好
   - 错误处理更规范

---

**下一步**: 完成Task 9后，立即实施Task 3和Task 7（高优先级）

**预计完成时间**: 
- 高优先级任务：1-2天
- 中优先级任务：2-3天
- 低优先级任务：3-5天（需要架构调整）
- 总计：7-10天

---

*此报告会持续更新，直到所有14项任务完成。*
