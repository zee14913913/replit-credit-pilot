{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-2">
  <div class="card">
    <h3 style="margin-top:0">CTOS 授权与资料上传</h3>
    <form id="f" enctype="multipart/form-data" method="post" action="/ctos/submit{% if key %}?key={{key}}{% endif %}">
      <div class="grid">
        <div><label>姓名（个人）/ 公司名（企业）</label><input class="input" name="name" required></div>
        <div><label>身份证号（个人）/ 公司注册号（SSM）</label><input class="input" name="idnum" required></div>
        <div><label>邮箱</label><input class="input" name="email" required></div>
        <div><label>手机号</label><input class="input" name="phone" required></div>
        <div><label>客户类型</label>
          <select class="input" name="ctype">
            <option value="PERSONAL">PERSONAL</option>
            <option value="COMPANY">COMPANY</option>
          </select>
        </div>
        <div><label>上传身份证/公司 SSM（PDF/JPG/PNG）</label><input class="input" type="file" name="doc" accept=".pdf,.jpg,.jpeg,.png" required></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn primary" type="submit">提交授权</button>
        <a class="btn" href="/loans/page">返回 Loans</a>
      </div>
    </form>
    <pre id="out" class="code" style="margin-top:10px"></pre>
  </div>
  <div class="card">
    <h3 style="margin-top:0">说明</h3>
    <ul>
      <li>提交后系统会加密存储关键资料（Fernet）</li>
      <li>若已接通 CTOS API，将自动请求最新报告</li>
      <li>未接通时，进入人工队列，管理员可在后台处理</li>
    </ul>
    <a class="btn" href="/ctos/admin?key={{ key }}&ak={{ ak }}">管理员后台</a>
  </div>
</div>
<script>
const frm=document.getElementById('f');
frm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd=new FormData(frm);
  const res=await fetch(frm.action,{method:'POST',body:fd});
  const js=await res.json();
  document.getElementById('out').textContent=JSON.stringify(js,null,2);
});
</script>
{% endblock %}
