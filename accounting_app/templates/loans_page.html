{% extends "base.html" %}
{% block title %}Loans Intelligence Â· CreditPilot{% endblock %}
{% block head_extra %}
<style>
  :root{
    --pink:#FF007F; --card:#322446; --bg:#1a1323; --text:#fff; --muted:#999; --line:#888;
  }
  body{background:var(--bg); color:var(--text);}
  .wrap{max-width:1100px; margin:20px auto; padding:0 12px;}
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px}
  .btn{background:var(--card); color:#fff; border:1px solid #3b2b4e; border-radius:12px; padding:8px 12px; cursor:pointer}
  .btn.primary{background:var(--pink); border-color:#ff6aa7}
  .btn.ghost{background:transparent; border:1px solid #ffffff33}
  .field{display:flex; gap:8px; flex-wrap:wrap}
  .field input{background:#0f0a14; color:#fff; border:1px solid #3b2b4e; border-radius:10px; padding:8px 10px; min-width:220px}
  .card{background:linear-gradient(180deg,#322446,#281a3a); border:1px solid #3b2b4e; border-radius:16px; padding:14px; box-shadow:0 6px 18px #0006;}
  .grid{display:grid; gap:12px; grid-template-columns:1.5fr 1fr}
  .list{display:grid; gap:10px; margin-top:10px}
  .li{display:grid; gap:8px; grid-template-columns:1fr 1fr}
  .li h4{margin:0 0 6px 0}
  .meta{font-size:13px; color:#ddd}
  .pill{display:inline-block; background:#ff007f26; border:1px solid #FF007F66; color:#fff; border-radius:999px; padding:2px 8px; font-size:12px; margin-right:6px}
  .sec-title{display:flex; justify-content:space-between; align-items:center; margin:6px 0 8px}
  .badge{display:inline-flex; align-items:center; justify-content:center; min-width:20px; height:20px; padding:0 6px;
         background:var(--pink); color:#fff; border-radius:999px; font-weight:700; margin-left:6px}
  .badge.dim{opacity:.35}
  .link{color:#fff; text-decoration:none; border-bottom:1px dashed #ffffff55}
  iframe.top3{width:100%; height:240px; border:0; overflow:hidden; border-radius:16px; margin: 8px 0 14px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .li{grid-template-columns:1fr} }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="toolbar">
    <div style="font-weight:700; font-size:18px; letter-spacing:0.3px">ğŸ’¼ Loans Intelligence Center</div>
    <div style="flex:1"></div>

    <!-- Compare Basket æŒ‰é’® + è®¡æ•°å¾½æ ‡ -->
    <a href="/loans/compare/page" class="btn">Compare Basket <span id="cmpBadge" class="badge dim">0</span></a>

    <!-- å¿«æ·å·¥å…· -->
    <a class="btn" href="/loans/ranking" target="_blank">â­ Top 3 Today (JSON)</a>
    <a class="btn primary" href="/loans/ranking/pdf">ğŸ“„ å¯¼å‡º Top3 PDF</a>
  </div>

  <!-- é¡¶éƒ¨ Top-3 å¯è§†å¡ç‰‡ï¼ˆiframe æ³¨å…¥ï¼Œå†…å«"åŠ å…¥æ¯”ä»·"ï¼‰ -->
  <iframe class="top3" src="/loans/top3/cards"></iframe>

  <div class="grid">
    <!-- å·¦ä¾§ï¼šäº§å“åˆ—è¡¨ -->
    <div class="card">
      <div class="sec-title">
        <div style="font-weight:700">ğŸ“‹ äº§å“åˆ—è¡¨ï¼ˆå¯æœç´¢ï¼‰</div>
        <div class="field">
          <input id="q" placeholder="Search: product/bank/type/preferences...">
          <button id="btnSearch" class="btn primary">Search</button>
          <a class="btn" href="/loans/updates/export.csv">Export Updates CSV</a>
          <a class="btn" href="/loans/intel/export.csv">Export Intel CSV</a>
        </div>
      </div>
      <div id="list" class="list">
        <!-- JS æ¸²æŸ“ -->
      </div>
    </div>

    <!-- å³ä¾§ï¼šDSR è¯•ç®—å™¨ -->
    <div class="card">
      <div class="sec-title"><div style="font-weight:700">ğŸ§® DSR è¯•ç®—å™¨</div></div>
      <div class="field">
        <input id="income" type="number" placeholder="æœˆå‡€æ”¶å…¥ (RM)" value="8000">
        <input id="commitments" type="number" placeholder="ç°æœ‰æœˆä¾›åˆè®¡ (RM)" value="1500">
        <input id="amount" type="number" placeholder="è´·æ¬¾é‡‘é¢ (RM)" value="400000">
        <input id="rate" type="number" step="0.01" placeholder="å¹´åˆ©ç‡ (%)" value="3.75">
        <input id="tenure" type="number" placeholder="å¹´æœŸ (å¹´)" value="30">
        <button id="btnCalc" class="btn primary">ä¸€é”®è¯•ç®—</button>
      </div>
      <div id="dsrResult" class="meta" style="margin-top:8px">ç»“æœå°†æ˜¾ç¤ºåœ¨æ­¤å¤„â€¦</div>
    </div>
  </div>

</div>

<script>
  // å¾½æ ‡åˆ·æ–°ï¼ˆä¾› iframe è°ƒç”¨ï¼‰
  async function syncBadge(){
    try{
      const r = await fetch('/loans/compare/json');
      const j = await r.json();
      const n = (j && j.items) ? j.items.length : 0;
      const b = document.getElementById('cmpBadge');
      b.textContent = n;
      b.classList.toggle('dim', n===0);
    }catch(e){}
  }
  window.syncBadge = syncBadge;
  syncBadge();
  setInterval(syncBadge, 15000);

  // åŠ è½½æ•°æ®å¹¶æ¸²æŸ“
  let UPDATES=[], INTEL=[];
  async function loadData(){
    const [u,i] = await Promise.all([fetch('/loans/updates'), fetch('/loans/intel')]);
    UPDATES = await u.json(); INTEL = await i.json();
  }

  function joinIntel(product){
    const rec = INTEL.find(x=>x.product===product) || {};
    return {
      preferred_customer: rec.preferred_customer||'',
      less_preferred: rec.less_preferred||'',
      docs_required: rec.docs_required||'',
      feedback_summary: rec.feedback_summary||'',
      sentiment_score: rec.sentiment_score ?? ''
    };
  }

  function h(s){ return (s||'').replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])) }

  async function renderList(q=''){
    const box = document.getElementById('list'); box.innerHTML='';
    const kw = q.trim().toLowerCase();
    const data = UPDATES.filter(x=>{
      const t = JSON.stringify(x).toLowerCase() + JSON.stringify(joinIntel(x.product)).toLowerCase();
      return kw ? t.includes(kw) : true;
    });
    if(!data.length){
      box.innerHTML = `<div class="meta">æš‚æ— ç»“æœ</div>`;
      return;
    }
    for(const x of data){
      const intel = joinIntel(x.product);
      const left = `
        <h4>${h(x.bank)} Â· ${h(x.product)}</h4>
        <div class="meta">Type: ${h(x.type||'N/A')} Â· APR ${h(x.apr)}% Â· Updated ${h(x.pulled_at||'')}</div>
        <div style="margin-top:6px">${h(x.summary||'No description')}</div>
      `;
      const right = `
        <div class="meta">åå¥½ä¸å£ç¢‘</div>
        <div style="margin:6px 0">
          <span class="pill">Preferred: ${h(intel.preferred_customer||'â€”')}</span>
          <span class="pill">Sentiment: ${h(intel.sentiment_score||'â€”')}</span>
        </div>
        <div class="meta" title="${h(intel.docs_required||'')}">èµ„æ–™åå¥½ï¼š${h((intel.docs_required||'').slice(0,48))}${(intel.docs_required||'').length>48?'â€¦':''}</div>
        <div class="meta" title="${h(intel.feedback_summary||'')}">å£ç¢‘æ‘˜è¦ï¼š${h((intel.feedback_summary||'').slice(0,56))}${(intel.feedback_summary||'').length>56?'â€¦':''}</div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn primary add-compare" data-source="${h(x.source)}" data-product="${h(x.product)}">åŠ å…¥æ¯”ä»·</button>
          <a class="btn ghost" href="/loans/compare/page">å»å¯¹æ¯”é¡µ</a>
        </div>
      `;
      const row = document.createElement('div');
      row.className = 'li card';
      row.innerHTML = `<div>${left}</div><div>${right}</div>`;
      box.appendChild(row);
    }
    // ç»‘å®šåŠ å…¥æ¯”ä»·
    document.querySelectorAll('.add-compare').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const payload = { source: btn.dataset.source, product: btn.dataset.product };
        await fetch('/loans/compare/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        syncBadge();
        alert('å·²åŠ å…¥æ¯”ä»·ç¯®');
      });
    });
  }

  // æœç´¢
  document.getElementById('btnSearch').addEventListener('click',()=>{
    renderList(document.getElementById('q').value||'');
  });

  // DSR è¯•ç®—
  document.getElementById('btnCalc').addEventListener('click', async ()=>{
    const payload = {
      income: parseFloat(document.getElementById('income').value||0),
      commitments: parseFloat(document.getElementById('commitments').value||0),
      amount: parseFloat(document.getElementById('amount').value||0),
      rate: parseFloat(document.getElementById('rate').value||0),
      tenure_years: parseFloat(document.getElementById('tenure').value||0)
    };
    const r = await fetch('/loans/dsr/calc',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const j = await r.json();
    const s = j.status || 'â€”';
    document.getElementById('dsrResult').innerHTML = `æœˆä¾›ï¼š<b>RM ${j.monthly||'-'}</b> Â· DSRï¼š<b>${j.dsr_percent||'-'}%</b> Â· çŠ¶æ€ï¼š<b>${s}</b>`;
  });

  (async function init(){
    await loadData();
    await renderList('');
  })();
</script>

{% endblock %}
