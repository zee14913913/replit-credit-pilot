{% extends "base.html" %}
{% block title %}Loans Intelligence · INFINITE GZ SDN. BHD.{% endblock %}

{% block content %}
<div class="page">
  <!-- 顶部 -->
  <div class="header">
    <div class="header-row">
      <h1 class="title" style="margin:0;">Loans Intelligence Center</h1>
      <div class="lang">
        <a class="btn" href="?lang=en">EN</a>
        <a class="btn" href="?lang=zh">中文</a>
      </div>
    </div>
  </div>

  <!-- 主内容：整屏自适应网格 -->
  <div class="main">
    <div class="grid-auto">

      <!-- Top-3 可视卡片（iframe 隔离，零风险） -->
      <div class="card tile">
        <h2 class="section">Top-3 Today</h2>
        <p class="meta">Auto-ranking · score weighted by DSR · preference · sentiment</p>
        <iframe src="/loans/top3/cards" style="width:100%;height:460px;border:0;border-radius:12px;overflow:hidden;background:#0f0a14;"></iframe>
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" target="_blank" href="/loans/ranking">Open JSON</a>
          <a class="btn primary" target="_blank" href="/loans/ranking/pdf">Export Top-3 PDF</a>
        </div>
      </div>

      <!-- 产品列表（可搜索） -->
      <div class="card tile">
        <h2 class="section">Products</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
          <input id="q" placeholder="Search: product / bank / type / preference…" style="flex:1; min-width:260px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <button class="btn" id="searchBtn">Search</button>
          <a class="btn" href="/loans/updates/export.csv">Export Updates CSV</a>
          <a class="btn" href="/loans/intel/export.csv">Export Intel CSV</a>
          <div style="flex:1"></div>
          <div>Compare Basket <span id="cmpBadge" class="badge">0</span></div>
        </div>

        <!-- 用 grid-auto 展示产品卡，自动铺满整页 -->
        <div id="products" class="grid-auto"></div>
      </div>

      <!-- DSR 试算器 -->
      <div class="card tile">
        <h2 class="section">DSR Calculator</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <input id="income" type="number" placeholder="Monthly Net Income (RM)" value="8000" style="min-width:160px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="commitments" type="number" placeholder="Existing Monthly Commitments (RM)" value="1500" style="min-width:160px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="amount" type="number" placeholder="Loan Amount (RM)" value="400000" style="min-width:160px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="rate" type="number" step="0.01" placeholder="APR (%)" value="3.75" style="min-width:120px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="tenure" type="number" placeholder="Tenure (years)" value="30" style="min-width:120px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <button class="btn primary" id="calcBtn">Recalculate</button>
        </div>
        <div id="calcOut" class="meta" style="margin-top:10px;">Result will appear here…</div>
      </div>

    </div>
    <div class="footer-spacer"></div>
  </div>
</div>

<script>
  // ===== 工具函数 =====
  function pm(a, y, r){ const i=r/12/100, n=y*12; if(i===0) return a/n; return a*i*Math.pow(1+i,n)/(Math.pow(1+i,n)-1); }
  async function refreshBadge(){
    try{ const r=await fetch('/loans/compare/json'); const j=await r.json(); document.getElementById('cmpBadge').textContent=(j&&j.items)? j.items.length:0; }catch(e){}
  }

  // ===== 拉取数据并渲染产品卡 =====
  let UPDATES=[], INTEL=[];
  async function loadAll() {
    const [u,i] = await Promise.all([fetch('/loans/updates'), fetch('/loans/intel')]);
    UPDATES = await u.json(); INTEL = await i.json();
  }

  function matchIntel(product, bank){
    const l = INTEL.find(x => (x.product||'').toLowerCase()===String(product||'').toLowerCase() && (x.bank||x.source||'') === bank);
    return l || {};
  }

  function cardHTML(x){
    const intel = matchIntel(x.product, x.bank) || {};
    const pref = intel.preferred_customer ? `<div class="meta">Preferred: ${intel.preferred_customer}</div>` : '';
    const senti = (intel.senti || intel.sentiment_score) ? `<div class="meta">Sentiment ${intel.senti||intel.sentiment_score}</div>` : '';
    return `
      <div class="card tile">
        <h3 class="section" style="margin-bottom:6px">${x.bank} · ${x.product}</h3>
        <div class="meta">APR ${x.apr}% · Type ${x.type||'-'}</div>
        ${pref}${senti}
        <div style="margin-top:auto; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary add-compare" data-product="${x.product}">Add to Compare</button>
          <a class="btn" href="${x.link||'#'}" target="_blank">Open Source</a>
        </div>
      </div>
    `;
  }

  function renderProducts(list){
    const box = document.getElementById('products');
    if(!list.length){ box.innerHTML = `<div class="meta">No results.</div>`; return; }
    box.innerHTML = list.map(cardHTML).join('');
    document.querySelectorAll('.add-compare').forEach(b=>{
      b.addEventListener('click', async ()=>{
        await fetch('/loans/compare/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product:b.dataset.product})});
        setTimeout(refreshBadge, 350);
      });
    });
  }

  // ===== 搜索 & 初始加载 =====
  document.getElementById('searchBtn').addEventListener('click', ()=>{
    const q = (document.getElementById('q').value||'').toLowerCase().trim();
    const list = !q ? UPDATES : UPDATES.filter(x => JSON.stringify(x).toLowerCase().includes(q));
    renderProducts(list);
  });

  // ===== 试算器 =====
  document.getElementById('calcBtn').addEventListener('click', ()=>{
    const income = parseFloat(incomeEl.value||0), commitments = parseFloat(commitmentsEl.value||0);
    const amount = parseFloat(amountEl.value||0), rate = parseFloat(rateEl.value||0), tenure = parseFloat(tenureEl.value||0);
    const monthly = Math.round(pm(amount, tenure, rate)*100)/100;
    const dsr = Math.round(((commitments+monthly)/Math.max(income,1))*10000)/100;
    const status = dsr<=55?'PASS':(dsr>=70?'HIGH':'BORDERLINE');
    document.getElementById('calcOut').textContent = `Monthly RM ${monthly} · DSR ${dsr}% · ${status}`;
  });

  const incomeEl=document.getElementById('income'), commitmentsEl=document.getElementById('commitments');
  const amountEl=document.getElementById('amount'), rateEl=document.getElementById('rate'), tenureEl=document.getElementById('tenure');

  // ===== 启动 =====
  (async ()=>{
    await loadAll(); renderProducts(UPDATES); refreshBadge();
  })();
</script>
{% endblock %}
