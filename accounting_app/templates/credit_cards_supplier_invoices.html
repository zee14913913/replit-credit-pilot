{% extends "base.html" %}
{% block title %}Supplier Invoices{% endblock %}
{% block content %}
<div class="page">
  <div class="main" style="max-width: var(--page-max); margin: 0 auto;">
    <h1 class="title">Supplier Invoices · 供应商发票</h1>

    <!-- 顶部工具条：月份选择 + 预览 -->
    <div class="card" style="display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap;">
      <form method="get" style="display:flex; gap: var(--gap); align-items:center;">
        <label class="meta">Year</label>
        <input class="btn" type="number" name="y" value="{{ y }}" min="2020" max="2100" style="width:110px;">
        <label class="meta">Month</label>
        <input class="btn" type="number" name="m" value="{{ m }}" min="1" max="12" style="width:90px;">
        <button class="btn" type="submit">应用</button>
      </form>
      <div style="margin-left:auto; display:flex; gap: var(--gap); flex-wrap:wrap;">
        <a class="btn" href="/invoices/preview.pdf?layout=service&lang=en" target="_blank">Preview · Service (EN)</a>
        <a class="btn" href="/invoices/preview.pdf?layout=debit&lang=en" target="_blank">Preview · Debit (EN)</a>
        <a class="btn" href="/invoices/preview.pdf?layout=itemised&lang=en" target="_blank">Preview · Itemised (EN)</a>
        <a class="btn primary" href="/credit-cards/supplier-invoices/batch.zip?y={{ y }}&m={{ m }}">Generate All (ZIP)</a>
      </div>
    </div>

    <!-- 汇总卡片 -->
    <div class="card">
      <h2 class="section">Monthly Summary · 本月汇总</h2>
      <div class="grid-3">
        <div class="card">
          <div class="meta">INFINITE 支出</div>
          <div style="font-weight:700; font-size:18px;">RM {{ "%.2f"|format(total_infinite) }}</div>
        </div>
        <div class="card">
          <div class="meta">Service Fee 1%</div>
          <div style="font-weight:700; font-size:18px;">RM {{ "%.2f"|format(service_fee) }}</div>
        </div>
        <div class="card">
          <div class="meta">Suppliers</div>
          <div style="font-weight:700; font-size:18px;">{{ suppliers|length }}</div>
        </div>
      </div>
    </div>

    <!-- 列表 -->
    <div class="card">
      <h2 class="section">Suppliers · 供应商列表</h2>
      {% if suppliers|length == 0 %}
        <p class="meta">本月暂无供应商数据。可尝试切换月份或导入账单。</p>
      {% else %}
      <div class="table-like">
        <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr; gap: 8px; font-weight:600; margin-bottom:8px;">
          <div>Supplier</div><div>This Month Total</div><div>Service Fee 1%</div><div>Details</div><div>Invoice</div>
        </div>
        {% for s in suppliers %}
        {% set _fee = s.fee if s.fee is defined else (s.total * 0.01) %}
        {% set _num = s.number or ('INV-' ~ y ~ '-' ~ ("%04d"|format(loop.index))) %}
        <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr; gap: 8px; padding:10px; border:1px solid var(--line); border-radius: var(--radius);">
          <div>{{ s.name }}<br><span class="meta">{{ s.address or '' }}</span></div>
          <div>RM {{ "%.2f"|format(s.total) }}</div>
          <div>RM {{ "%.2f"|format(_fee) }}</div>
          <div><a class="btn" href="/credit-cards/transactions?supplier={{ s.name | urlencode }}">View Transactions</a></div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <a class="btn primary" href="/invoices/make?layout=service&number={{ _num }}&bill_to_name={{ s.name | urlencode }}&amount={{ '%.2f'|format(_fee) }}&lang=en" target="_blank">Generate</a>
            <details class="btn" style="padding:0 10px;">
              <summary>⋯</summary>
              <div style="padding:8px; display:flex; flex-direction:column; gap:6px;">
                <a class="btn" href="/invoices/make?layout=service&number={{ _num }}&bill_to_name={{ s.name | urlencode }}&amount={{ '%.2f'|format(_fee) }}&lang=zh" target="_blank">Generate (中文)</a>
                <a class="btn" href="/invoices/make?layout=itemised&number={{ _num }}&bill_to_name={{ s.name | urlencode }}&amount={{ '%.2f'|format(_fee) }}&lang=en" target="_blank">Itemised</a>
                <a class="btn" href="/invoices/make?layout=debit&number=DN-{{ y }}-{{ "%04d"|format(loop.index) }}&bill_to_name={{ s.name | urlencode }}&amount=10&lang=en" target="_blank">Debit Note</a>
              </div>
            </details>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
