{% extends "base.html" %}
{% block title %}Compare Loans Â· INFINITE GZ SDN. BHD.{% endblock %}

{% block content %}
<div class="page">
  <!-- é¡¶éƒ¨ -->
  <div class="header">
    <div class="header-row">
      <h1 class="title" style="margin:0;">Compare</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <div>Compare Basket <span id="cmpBadge" class="badge">0</span></div>
        <div class="lang" style="margin-left:10px;">
          <a class="btn" href="?lang=en">EN</a>
          <a class="btn" href="?lang=zh">ä¸­æ–‡</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸»å†…å®¹ -->
  <div class="main">
    <div class="grid-auto">

      <!-- å·¥å…·æ  + Top Pick -->
      <div class="card tile">
        <h2 class="section">Toolbar</h2>
        <div class="meta">Quick actions for basket / snapshot / export</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
          <a href="/loans/page" class="btn">Back to Loans</a>
          <button id="recalcBtn" class="btn primary">Recalculate</button>
          <button id="saveSnapBtn" class="btn">Save Snapshot</button>
          <button id="shareBtn" class="btn primary">Copy Share Link</button>
          <button id="pdfBtn" class="btn">Export PDF</button>
          <button id="clearBtn" class="btn ghost">Clear Basket</button>
        </div>

        <!-- Top Pick -->
        <div id="topPick" class="card" style="margin-top:12px; background:transparent; border:1px dashed #ffffff33;">
          <div style="font-weight:700; margin-bottom:6px">Best Recommendation Â· Top Pick</div>
          <div id="topPickBody" class="meta">Waitingâ€¦</div>
        </div>
      </div>

      <!-- å‚æ•°è¾“å…¥ -->
      <div class="card tile">
        <h2 class="section">Parameters</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <input id="amount" type="number" placeholder="Loan Amount (RM)" value="400000" style="min-width:160px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="tenure" type="number" placeholder="Tenure (years)" value="30" style="min-width:120px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="rate" type="number" step="0.01" placeholder="APR override (%) â€” blank = product APR" value="" style="min-width:180px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="income" type="number" placeholder="Monthly Net Income (RM)" value="8000" style="min-width:160px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="commitments" type="number" placeholder="Existing Monthly Commitments (RM)" value="1500" style="min-width:220px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <button id="recalcBtn2" class="btn">Apply</button>
        </div>
      </div>

      <!-- ç»“æžœè¡¨æ ¼ -->
      <div class="card tile">
        <h2 class="section">Results</h2>
        <table id="compareTable" style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead>
            <tr>
              <th class="sortable" data-k="rank">Rank #</th>
              <th class="sortable" data-k="bank">Bank</th>
              <th class="sortable" data-k="product">Product</th>
              <th class="sortable" data-k="apr">APR %</th>
              <th class="sortable" data-k="monthly">Monthly (RM)</th>
              <th class="sortable" data-k="dsr_percent">DSR %</th>
              <th class="sortable" data-k="status">Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody><!-- render by JS --></tbody>
        </table>
      </div>

    </div>
    <div class="footer-spacer"></div>
  </div>
</div>

<script>
  let BASKET=[], SORT={k:'statusRank', dir:'asc'};
  let LAST_SHARE=null;

  function pm(a, y, r){ const i=r/12/100, n=y*12; if(i===0) return a/n; return a*i*Math.pow(1+i,n)/(Math.pow(1+i,n)-1); }

  async function refreshBadge(){
    try{
      const r=await fetch('/loans/compare/json'); const j=await r.json();
      document.getElementById('cmpBadge').textContent = (j&&j.items)? j.items.length:0;
    }catch(e){}
  }
  async function loadBasket(){ const r=await fetch('/loans/compare/list'); BASKET = await r.json(); }

  function compute(items){
    const amount = parseFloat(document.getElementById('amount').value||0);
    const tenure = parseFloat(document.getElementById('tenure').value||0);
    const overrideRate = parseFloat(document.getElementById('rate').value||0);
    const income = parseFloat(document.getElementById('income').value||0);
    const commitments = parseFloat(document.getElementById('commitments').value||0);
    return items.map((x)=>{
      const apr = overrideRate>0 ? overrideRate : parseFloat(x.apr||0);
      const monthly = Math.round(pm(amount, tenure, apr)*100)/100;
      const dsr_percent = Math.round(((commitments+monthly)/Math.max(income,1))*10000)/100;
      let status='BORDERLINE'; if(dsr_percent<=55) status='PASS'; else if(dsr_percent>=70) status='HIGH';
      const statusRank = {PASS:0,BORDERLINE:1,HIGH:2}[status];
      return {...x, apr, monthly, dsr_percent, status, statusRank};
    });
  }

  function renderTopPick(rows){
    if(!rows.length){ document.getElementById('topPickBody').textContent='No items in basket.'; return; }
    const best = rows[0];
    document.getElementById('topPickBody').innerHTML = ` ${best.bank} Â· ${best.product} â€” APR ${best.apr}% Â· Monthly RM ${best.monthly} Â· DSR ${best.dsr_percent}% Â· <span class="status ${best.status}">${best.status}</span>`;
  }

  function renderTable(rows){
    const tb = document.querySelector('#compareTable tbody'); tb.innerHTML='';
    rows.forEach((r, idx)=>{
      const crown = (idx===0)? ' ðŸ‘‘':'';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}${crown}</td>
        <td>${r.bank||''}</td>
        <td>${r.product||''}</td>
        <td>${r.apr}%</td>
        <td>RM ${r.monthly}</td>
        <td>${r.dsr_percent}%</td>
        <td class="status ${r.status}">${r.status}</td>
        <td><button class="btn ghost btn-remove" data-product="${r.product}">Remove</button></td>
      `;
      tb.appendChild(tr);
    });
    document.querySelectorAll('.btn-remove').forEach(b=>{
      b.addEventListener('click', async ()=>{
        await fetch('/loans/compare/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product:b.dataset.product})});
        await init();
      });
    });
  }

  function sortRows(rows){
    const {k,dir}=SORT, mul = dir==='asc'?1:-1;
    return rows.slice().sort((a,b)=>{
      if(k==='statusRank') return (a.statusRank-b.statusRank)*mul || (a.monthly-b.monthly)*mul || (a.dsr_percent-b.dsr_percent)*mul;
      if(typeof a[k]==='number') return (a[k]-b[k])*mul;
      return String(a[k]||'').localeCompare(String(b[k]||''))*mul;
    });
  }

  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k=th.dataset.k;
      if(SORT.k===k){ SORT.dir = (SORT.dir==='asc'?'desc':'asc'); } else { SORT.k=k; SORT.dir='asc'; }
      document.querySelectorAll('th.sortable').forEach(x=>x.classList.remove('asc','desc'));
      th.classList.add(SORT.dir);
      const rows = sortRows(compute(BASKET)); renderTopPick(rows); renderTable(rows);
    });
  });

  // åŠ¨ä½œæŒ‰é’®
  document.getElementById('recalcBtn').addEventListener('click', ()=>{ const rows=sortRows(compute(BASKET)); renderTopPick(rows); renderTable(rows); });
  document.getElementById('recalcBtn2').addEventListener('click', ()=>{ const rows=sortRows(compute(BASKET)); renderTopPick(rows); renderTable(rows); });

  document.getElementById('clearBtn').addEventListener('click', async ()=>{
    if(!confirm('Clear basket?')) return;
    await fetch('/loans/compare/clear',{method:'POST'}); await init();
  });

  // ä¿å­˜ / åˆ†äº« / PDF
  function buildSnapshot(){
    const params = {
      amount: parseFloat(document.getElementById('amount').value||0),
      tenure_years: parseFloat(document.getElementById('tenure').value||0),
      rate: parseFloat(document.getElementById('rate').value||0),
      income: parseFloat(document.getElementById('income').value||0),
      commitments: parseFloat(document.getElementById('commitments').value||0)
    };
    const rows=[...document.querySelectorAll('#compareTable tbody tr')];
    const items = rows.map(tr=>{
      const tds = tr.querySelectorAll('td');
      return {
        bank: tds[1]?.textContent.trim(),
        product: tds[2]?.textContent.trim(),
        apr: parseFloat((tds[3]?.textContent||'').replace('%','')||0),
        monthly: parseFloat((tds[4]?.textContent||'').replace(/[^\d.]/g,'')||0),
        dsr_percent: parseFloat((tds[5]?.textContent||'').replace('%','')||0),
        status: tds[6]?.textContent.trim()
      }
    });
    return {params, items};
  }
  async function saveSnapshot(){
    const payload=buildSnapshot();
    const r=await fetch('/loans/compare/snapshot',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ alert('Save failed'); return null; }
    return await r.json(); // {code,url}
  }

  document.getElementById('saveSnapBtn').addEventListener('click', async ()=>{
    LAST_SHARE = await saveSnapshot(); if(!LAST_SHARE) return;
    alert('Saved: '+(location.origin + LAST_SHARE.url));
  });
  document.getElementById('shareBtn').addEventListener('click', async ()=>{
    const res = LAST_SHARE || await saveSnapshot(); if(!res) return;
    const link = location.origin + res.url;
    try{ await navigator.clipboard.writeText(link); alert('Copied'); }catch(e){ prompt('Copy manually:', link); }
  });
  document.getElementById('pdfBtn').addEventListener('click', async ()=>{
    const res = LAST_SHARE || await saveSnapshot(); if(!res) return;
    window.location = '/loans/compare/pdf/' + res.code;
  });

  async function init(){ await loadBasket(); await refreshBadge(); const rows=sortRows(compute(BASKET)); renderTopPick(rows); renderTable(rows); }
  init();
</script>
{% endblock %}
