{% extends "base.html" %}
{% block title %}Credit Cards · Receipts Matching{% endblock %}
{% block head_extra %}
<style>
  :root{ --pink:#FF007F; --card:#322446; --bg:#1a1323; --text:#fff; --line:#3b2b4e; --muted:#c9c6d3; --gap:16px; --radius:16px; --pad:14px; --page-max:1280px }
  body{ background:var(--bg); color:var(--text) }
  .page{ min-height:100vh; display:flex; flex-direction:column }
  .main{ width:100%; max-width:var(--page-max); margin:0 auto; padding:20px }
  .title{ font-size:22px; font-weight:700 }
  .toolbar{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:var(--gap) }
  .btn{ background:var(--card); color:#fff; border:1px solid var(--line); border-radius:12px; padding:8px 12px; text-decoration:none; cursor:pointer }
  .btn.primary{ background:var(--pink); border-color:#ff6aa7 }
  .btn.ghost{ background:transparent; border:1px solid #ffffff33 }
  .card{ background:linear-gradient(180deg,#322446,#281a3a); border:1px solid var(--line); border-radius:16px; padding:var(--pad); box-shadow:0 6px 18px #0006 }
  .grid-auto{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap) }
  @media (max-width:1024px){ .grid-auto{ grid-template-columns:1fr } }
  .meta{ color:var(--muted); font-size:12px }
  table{ width:100%; border-collapse:collapse }
  th,td{ border:1px solid var(--line); padding:8px; font-size:14px; vertical-align:top }
  th{ background:#271b36; text-align:left }
  .progress{ height:10px; background:#0f0a14; border:1px solid var(--line); border-radius:999px; overflow:hidden }
  .bar{ height:100%; background:var(--pink); width:0% }
  input[type=file]{ background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px; width:100% }
</style>
{% endblock %}
{% block content %}

<div class="page">
  <div class="main">

    <div class="title">Credit Cards · Receipts Matching</div>
    <div class="toolbar">
      <a class="btn" href="/credit-cards/transactions{{ '?lang=' + request.query_params.get('lang') if request.query_params.get('lang') else '' }}">Back to Transactions</a>
      <div style="flex:1"></div>
      <a class="btn ghost" href="?lang=en">EN</a>
      <a class="btn ghost" href="?lang=zh">中文</a>
    </div>

    <div class="grid-auto">
      <div class="card">
        <div style="font-weight:700; margin-bottom:8px">Coverage & Upload</div>
        <div class="meta" style="margin-bottom:6px">Upload receipt images (JPG/PNG). OCR will extract merchant/amount/date.</div>

        <form id="uploadForm" method="post" enctype="multipart/form-data" action="/credit-cards/receipts/upload">
          <input type="file" name="files" accept="image/*" multiple>
          <div style="height:10px"></div>
          <button class="btn primary" type="submit">Upload & OCR</button>
          <button class="btn" type="button" id="reScanBtn">Re-scan OCR</button>
        </form>

        <div style="height:16px"></div>
        <div class="meta">Receipt Coverage</div>
        <div class="progress"><div class="bar" id="covBar" style="width: {{ coverage_percent or 75 }}%"></div></div>
        <div class="meta" style="margin-top:6px">{{ matched_count or 45 }}/{{ total_count or 60 }} matched ({{ coverage_percent or 75 }}%)</div>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:8px">Pending Matching</div>
        <table id="pendingTable">
          <thead>
            <tr>
              <th>Transaction</th><th>Candidate Receipt</th><th>Similarity</th><th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for r in pending or [] %}
            <tr>
              <td>{{ r.tx_date }} · {{ r.tx_desc }} · RM {{ '%.2f'|format(r.tx_amount|float) }}</td>
              <td>{{ r.candidate_brief or 'N/A' }}</td>
              <td>{{ r.similarity or 'Good' }}</td>
              <td>
                <form method="post" action="/credit-cards/receipts/confirm">
                  <input type="hidden" name="tx_id" value="{{ r.tx_id }}">
                  <input type="hidden" name="receipt_id" value="{{ r.receipt_id }}">
                  <button class="btn primary" type="submit">Confirm</button>
                </form>
              </td>
            </tr>
            {% endfor %}
            {% if not pending %}
            <tr><td colspan="4" class="meta">No pending items.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="card">
      <div style="font-weight:700; margin-bottom:8px">Latest OCR Results</div>
      <table id="ocrTable">
        <thead>
          <tr><th>Merchant</th><th>Amount</th><th>Date</th><th>Confidence</th><th>Raw</th></tr>
        </thead>
        <tbody>
          {% for o in ocr_results or [] %}
          <tr>
            <td>{{ o.merchant_name }}</td>
            <td>{{ o.amount if o.amount is not none else '-' }}</td>
            <td>{{ o.date or '-' }}</td>
            <td>{{ '%.2f'|format(o.confidence|float) if o.confidence is not none else '-' }}</td>
            <td class="meta">{{ o.raw_text[:80] if o.raw_text else '-' }}</td>
          </tr>
          {% endfor %}
          {% if not ocr_results %}
          <tr><td colspan="5" class="meta">Upload receipts to see OCR output.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
  document.getElementById('reScanBtn').addEventListener('click', ()=>{
    window.location.reload();
  });
</script>

{% endblock %}
