{% extends "base.html" %}
{% block title %}Portal{% endblock %}
{% block content %}
<div class="page">
  <div class="main" style="max-width: var(--page-max); margin: 0 auto;">
    <h1 class="title">Portal</h1>

    <!-- 核心模块入口 -->
    <div class="grid-3" style="margin-top: var(--gap);">
      <a class="card tile" href="/credit-cards/transactions">
        <h2 class="section">Credit Cards</h2>
        <p class="meta">Transactions · Receipts · Supplier Invoices · Monthly</p>
        <div><span class="btn primary">Open</span></div>
      </a>

      <a class="card tile" href="/savings/accounts">
        <h2 class="section">Savings</h2>
        <p class="meta">Accounts · Upload Statements · Monthly Balances</p>
        <div><span class="btn primary">Open</span></div>
      </a>

      <a class="card tile" href="/loans/page">
        <h2 class="section">Loans</h2>
        <p class="meta">Matcher · Compare · Ranking</p>
        <div><span class="btn primary">Open</span></div>
      </a>
    </div>

    <!-- 高频操作（把一个月的动作串起来） -->
    <div class="grid-2" style="margin-top: calc(var(--gap)*1.25);">
      <div class="card">
        <h2 class="section">Operations</h2>
        <div style="display:flex; gap: var(--gap); flex-wrap:wrap;">
          <a class="btn" href="/credit-cards/supplier-invoices">本月供应商账单</a>
          <a class="btn" href="/credit-cards/supplier-invoices/batch.zip">批量生成发票 (ZIP)</a>
          <a class="btn" href="/credit-cards/receipts?filter=missing">去补缺收据</a>
          <a class="btn" href="/credit-cards/monthly-report">生成月结报告</a>
          <a class="btn" href="/savings/accounts">上传储蓄对账单</a>
        </div>
      </div>

      <div class="card">
        <h2 class="section">Month-End · 月末待办</h2>
        <p class="meta">自动汇总来自后台的统计数字</p>
        <div id="month-summary">
          <div>待匹配收据：<span id="ms-pending">—</span></div>
          <div>本月供应商：<span id="ms-suppliers">—</span></div>
          <div>预计服务费：RM <span id="ms-fee">—</span></div>
        </div>
        <div style="margin-top: var(--gap); display:flex; gap: var(--gap); flex-wrap:wrap;">
          <a class="btn primary" href="/credit-cards/receipts?filter=missing">去补收据</a>
          <a class="btn" href="/credit-cards/supplier-invoices/batch.zip">生成全部发票</a>
          <a class="btn ghost" href="/credit-cards/monthly-report">出月结报告</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // 语言记忆：URL无?lang时，读取localStorage.lang
  (function () {
    const u = new URL(window.location.href);
    if (!u.searchParams.get('lang') && localStorage.getItem('lang')) {
      u.searchParams.set('lang', localStorage.getItem('lang'));
      window.location.replace(u.toString());
    }
    const langLinks = document.querySelectorAll('.lang a[href*="?lang="]');
    langLinks.forEach(a => a.addEventListener('click', (e) => {
      const url = new URL(a.href);
      const L = url.searchParams.get('lang') || 'en';
      localStorage.setItem('lang', L);
    }));
  })();
  
  // 加载月末统计数据
  fetch('/credit-cards/month-summary')
    .then(r => r.json())
    .then(data => {
      if (data.ok) {
        document.getElementById('ms-pending').textContent = data.pending || 0;
        document.getElementById('ms-suppliers').textContent = data.suppliers || 0;
        document.getElementById('ms-fee').textContent = (data.service_fee || 0).toFixed(2);
      }
    })
    .catch(() => {});
</script>
{% endblock %}
