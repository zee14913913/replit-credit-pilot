{% extends "base.html" %}
{% block title %}Portal{% endblock %}
{% block content %}
<div class="page">
  <div class="main" style="max-width: var(--page-max); margin: 0 auto;">
    <h1 class="title">Portal</h1>

    <!-- æ ¸å¿ƒæ¨¡å—å…¥å£ -->
    <div class="grid-3" style="margin-top: var(--gap);">
      <a class="card tile" href="/credit-cards/transactions">
        <h2 class="section">Credit Cards</h2>
        <p class="meta">Transactions Â· Receipts Â· Supplier Invoices Â· Monthly</p>
        <div><span class="btn primary">Open</span></div>
      </a>

      <a class="card tile" href="/savings/accounts">
        <h2 class="section">Savings</h2>
        <p class="meta">Accounts Â· Upload Statements Â· Monthly Balances</p>
        <div><span class="btn primary">Open</span></div>
      </a>

      <a class="card tile" href="/loans/page">
        <h2 class="section">Loans</h2>
        <p class="meta">Matcher Â· Compare Â· Ranking</p>
        <div><span class="btn primary">Open</span></div>
      </a>
    </div>

    <!-- é«˜é¢‘æ“ä½œï¼ˆæŠŠä¸€ä¸ªæœˆçš„åŠ¨ä½œä¸²èµ·æ¥ï¼‰ -->
    <div class="grid-2" style="margin-top: calc(var(--gap)*1.25);">
      <div class="card">
        <h2 class="section">Operations</h2>
        <div style="display:flex; gap: var(--gap); flex-wrap:wrap;">
          <a class="btn" href="/credit-cards/supplier-invoices">æœ¬æœˆä¾›åº”å•†è´¦å•</a>
          <a class="btn" href="/credit-cards/supplier-invoices/batch.zip">æ‰¹é‡ç”Ÿæˆå‘ç¥¨ (ZIP)</a>
          <a class="btn" href="/credit-cards/receipts?filter=missing">å»è¡¥ç¼ºæ”¶æ®</a>
          <a class="btn" href="/credit-cards/monthly-report">ç”Ÿæˆæœˆç»“æŠ¥å‘Š</a>
          <a class="btn" href="/savings/accounts">ä¸Šä¼ å‚¨è“„å¯¹è´¦å•</a>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: var(--gap);">
          <h2 class="section" style="margin:0;">Month-End Â· æœˆæœ«å¾…åŠ</h2>
          <button id="refresh-summary" class="btn" style="font-size:14px;">ğŸ”„ åˆ·æ–°ç»Ÿè®¡</button>
        </div>
        <p class="meta">è‡ªåŠ¨æ±‡æ€»æ¥è‡ªåå°çš„ç»Ÿè®¡æ•°å­— Â· æ¯30ç§’è‡ªåŠ¨åˆ·æ–°</p>
        <div id="month-summary">
          <div>å¾…åŒ¹é…æ”¶æ®ï¼š<span id="ms-pending">â€”</span></div>
          <div>æœ¬æœˆä¾›åº”å•†ï¼š<span id="ms-suppliers">â€”</span></div>
          <div>é¢„è®¡æœåŠ¡è´¹ï¼šRM <span id="ms-fee">â€”</span></div>
        </div>
        <div style="margin-top: var(--gap); display:flex; gap: var(--gap); flex-wrap:wrap;">
          <a class="btn primary" href="/credit-cards/receipts?filter=missing">å»è¡¥æ”¶æ®</a>
          <button class="btn" onclick="downloadZIP(this)">ç”Ÿæˆå…¨éƒ¨å‘ç¥¨</button>
          <a class="btn ghost" href="/credit-cards/monthly-report">å‡ºæœˆç»“æŠ¥å‘Š</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // è¯­è¨€è®°å¿†ï¼šURLæ— ?langæ—¶ï¼Œè¯»å–localStorage.lang
  (function () {
    const u = new URL(window.location.href);
    if (!u.searchParams.get('lang') && localStorage.getItem('lang')) {
      u.searchParams.set('lang', localStorage.getItem('lang'));
      window.location.replace(u.toString());
    }
    const langLinks = document.querySelectorAll('.lang a[href*="?lang="]');
    langLinks.forEach(a => a.addEventListener('click', (e) => {
      const url = new URL(a.href);
      const L = url.searchParams.get('lang') || 'en';
      localStorage.setItem('lang', L);
    }));
  })();
  
  // åŠ è½½æœˆæœ«ç»Ÿè®¡æ•°æ®ï¼ˆå¸¦å®æ—¶åˆ·æ–°ï¼‰
  async function loadMonthSummary() {
    try {
      const r = await fetch('/credit-cards/month-summary');
      if (r.ok) {
        const data = await r.json();
        document.getElementById('ms-pending').textContent = data.pending || 0;
        document.getElementById('ms-suppliers').textContent = data.suppliers || 0;
        document.getElementById('ms-fee').textContent = (data.service_fee || 0).toFixed(2);
      }
    } catch (e) {
      console.warn('æœˆæœ«ç»Ÿè®¡åŠ è½½å¤±è´¥:', e);
    }
  }
  
  // åˆå§‹åŠ è½½
  loadMonthSummary();
  
  // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
  setInterval(loadMonthSummary, 30000);
  
  // æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®
  const refreshBtn = document.getElementById('refresh-summary');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      refreshBtn.disabled = true;
      refreshBtn.textContent = 'åˆ·æ–°ä¸­...';
      await loadMonthSummary();
      refreshBtn.disabled = false;
      refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°ç»Ÿè®¡';
    });
  }
  
  // æ‰¹é‡ZIPä¸‹è½½ï¼ˆå¸¦åŠ è½½çŠ¶æ€ï¼‰
  async function downloadZIP(btn) {
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'ç”Ÿæˆä¸­...';
    
    try {
      window.location.href = '/credit-cards/supplier-invoices/batch.zip';
      // ç­‰å¾…2ç§’åæ¢å¤æŒ‰é’®ï¼ˆZIPä¸‹è½½ä¸ä¼šé˜»å¡é¡µé¢ï¼‰
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = originalText;
      }, 2000);
    } catch (e) {
      alert('ç”Ÿæˆå¤±è´¥: ' + e.message);
      btn.disabled = false;
      btn.textContent = originalText;
    }
  }
</script>
{% endblock %}
