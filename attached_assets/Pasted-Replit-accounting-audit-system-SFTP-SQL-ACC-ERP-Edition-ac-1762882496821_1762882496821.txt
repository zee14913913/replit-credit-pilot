Replit é¡¹ç›® accounting-audit-system å…·å¤‡è‡ªåŠ¨ SFTP ä¸Šä¼ è‡³å®¢æˆ· SQL ACC ERP Edition çš„èƒ½åŠ›ã€‚

â¸»

ğŸ§­ å…¨ç³»ç»Ÿç»“æ„ç›®æ ‡

æœ€ç»ˆç»“æœï¼š

accounting_app/
â”œâ”€â”€ main.py                     â† ä¸» FastAPI å¯åŠ¨æ–‡ä»¶ï¼ˆå·²æœ‰ï¼‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ sftp_client.py          â† æ–°å¢ï¼šSFTP ä¸Šä¼ æ¨¡å—
â”‚   â”œâ”€â”€ erp_exporter.py         â† æ–°å¢ï¼šæ ¼å¼åŒ– ERP æ–‡ä»¶
â”‚   â””â”€â”€ automation_scheduler.py â† æ–°å¢ï¼šè‡ªåŠ¨ä¸Šä¼ è°ƒåº¦å™¨
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ sftp_sync.py            â† æ–°å¢ï¼šSFTP API æ§åˆ¶ç«¯ç‚¹
â”‚   â””â”€â”€ (å…¶ä»–åŸæœ‰è·¯ç”±ä¿æŒä¸å˜)


â¸»

ğŸ§© ç¬¬ä¸€é˜¶æ®µï¼šç¯å¢ƒå‡†å¤‡ï¼ˆReplit è®¾ç½®ï¼‰

1ï¸âƒ£ å®‰è£…æ–°ä¾èµ–åŒ…

æ‰“å¼€ Replit çš„ Shellï¼ˆç»ˆç«¯ï¼‰æ‰§è¡Œï¼š

pip install paramiko schedule

è¿™ä¸¤ä¸ªæ˜¯æ ¸å¿ƒï¼š
	â€¢	paramikoï¼šSSH/SFTP åè®®æ¨¡å—ï¼›
	â€¢	scheduleï¼šåå°å®šæ—¶ä»»åŠ¡è°ƒåº¦ã€‚

â¸»

2ï¸âƒ£ ç¡®è®¤ Replit Secretï¼ˆç¯å¢ƒå˜é‡ï¼‰

ä½ ä¹‹å‰å·²è®¾ç½®äº†ï¼š

{
  "host": "161.142.139.122",
  "port": 22,
  "username": "erp_sync",
  "password": "Erp2025!",
  "remote_dir": "C:/ERP_IMPORTS",
  "use_key_auth": false,
  "private_key_path": "",
  "description": "Connection to SQL ACC ERP Edition import directory for automated CSV upload"
}

è¯·ç¡®è®¤ Secret åç§°ä¸ºï¼šSFTP_CONFIG âœ…ã€‚
è¿™æ˜¯è‡ªåŠ¨ä¸Šä¼ ç³»ç»Ÿè¯»å–çš„å”¯ä¸€é…ç½®ã€‚

â¸»

ğŸ§© ç¬¬äºŒé˜¶æ®µï¼šæ–°å¢æ–‡ä»¶ä¸åŠŸèƒ½æ¨¡å—

ğŸ“ 1. æ–°å¢æ–‡ä»¶ accounting_app/services/sftp_client.py

import paramiko, os, json
from dotenv import load_dotenv

load_dotenv()

def get_sftp_connection():
    """å»ºç«‹ SFTP è¿æ¥"""
    config = json.loads(os.getenv("SFTP_CONFIG"))
    host = config["host"]
    username = config["username"]
    password = config["password"]
    port = config.get("port", 22)

    transport = paramiko.Transport((host, port))
    transport.connect(username=username, password=password)
    sftp = paramiko.SFTPClient.from_transport(transport)
    return sftp

def upload_file(local_path, remote_path):
    """ä¸Šä¼ å•ä¸ªæ–‡ä»¶"""
    sftp = get_sftp_connection()
    try:
        sftp.put(local_path, remote_path)
        print(f"âœ… Uploaded: {local_path} â†’ {remote_path}")
    except Exception as e:
        print(f"âŒ Upload failed: {local_path} | Error: {e}")
    finally:
        sftp.close()


â¸»

ğŸ“ 2. æ–°å¢æ–‡ä»¶ accounting_app/services/automation_scheduler.py

import schedule, time, os
from accounting_app.services.sftp_client import upload_file

def sync_csv_files():
    """æ‰«æå¹¶ä¸Šä¼  CSV æ–‡ä»¶åˆ°å®¢æˆ· ERP"""
    base_dir = "accounting_data/uploads"
    mapping = {
        "sales": "C:/ERP_IMPORTS/sales/",
        "suppliers": "C:/ERP_IMPORTS/suppliers/",
        "payments": "C:/ERP_IMPORTS/payments/",
        "customers": "C:/ERP_IMPORTS/customers/",
        "bank": "C:/ERP_IMPORTS/bank/",
        "payroll": "C:/ERP_IMPORTS/payroll/",
        "loan": "C:/ERP_IMPORTS/loan/"
    }

    for folder, remote in mapping.items():
        local_dir = os.path.join(base_dir, folder)
        if not os.path.exists(local_dir):
            continue
        for file in os.listdir(local_dir):
            if file.endswith(".csv"):
                local_path = os.path.join(local_dir, file)
                try:
                    upload_file(local_path, remote + file)
                except Exception as e:
                    print(f"Error uploading {file}: {e}")

schedule.every(10).minutes.do(sync_csv_files)

def start_scheduler():
    """åå°æŒç»­æ‰§è¡ŒåŒæ­¥ä»»åŠ¡"""
    print("â³ SFTP Scheduler started (sync every 10 min)")
    while True:
        schedule.run_pending()
        time.sleep(30)


â¸»

ğŸ“ 3. æ–°å¢æ–‡ä»¶ accounting_app/routers/sftp_sync.py

from fastapi import APIRouter
from accounting_app.services.automation_scheduler import sync_csv_files

router = APIRouter()

@router.get("/sync-sftp-now")
def manual_sync():
    """æ‰‹åŠ¨è§¦å‘ç«‹å³åŒæ­¥"""
    sync_csv_files()
    return {"message": "Manual SFTP sync triggered successfully."}


â¸»

ğŸ“ 4. ä¿®æ”¹ accounting_app/main.py

åœ¨æ–‡ä»¶åº•éƒ¨åŠ å…¥ä»¥ä¸‹å†…å®¹ğŸ‘‡ï¼ˆä¸è¦åˆ åŸæ¥çš„å†…å®¹ï¼‰

from accounting_app.services.automation_scheduler import start_scheduler
import threading
from accounting_app.routers import sftp_sync
from fastapi import FastAPI

# ç¡®ä¿ SFTP API ä¹ŸåŠ è½½
app = FastAPI()
app.include_router(sftp_sync.router)

# å¯åŠ¨åå°è°ƒåº¦çº¿ç¨‹
threading.Thread(target=start_scheduler, daemon=True).start()


â¸»

ğŸ§© ç¬¬ä¸‰é˜¶æ®µï¼šéƒ¨ç½²éªŒè¯

1ï¸âƒ£ ä¸Šä¼ ä¸€ä»½ CSV æ–‡ä»¶åˆ°ä½ çš„ Replit é¡¹ç›®ç›®å½•ï¼š

accounting_data/uploads/sales/sales_2025-11-12.csv

2ï¸âƒ£ ç­‰å¾… 10 åˆ†é’Ÿï¼ˆç³»ç»Ÿæ¯ 10 åˆ†é’Ÿæ‰«æä¸€æ¬¡ï¼‰ï¼Œæˆ–
æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š

https://<your-replit-domain>/sync-sftp-now

è§¦å‘ç«‹å³åŒæ­¥ã€‚

3ï¸âƒ£ åœ¨å®¢æˆ·ç”µè„‘ C:\ERP_IMPORTS\sales æ–‡ä»¶å¤¹ä¸­æŸ¥çœ‹æ˜¯å¦å‡ºç°å¯¹åº” CSV æ–‡ä»¶ã€‚
è‹¥å‡ºç° âœ…ï¼Œæ•´ä¸ªé“¾è·¯å·²ç»å®Œæˆéƒ¨ç½²ã€‚

â¸»

ğŸ§  ç³»ç»Ÿå®‰å…¨æç¤º
	â€¢	æ‰€æœ‰ SFTP ç™»å½•å‡­è¯å­˜æ”¾åœ¨ Secretï¼Œä¸ä¼šè¢«æ³„éœ²ã€‚
	â€¢	ä»…å…è®¸ .csv æ–‡ä»¶ç±»å‹ä¸Šä¼ ã€‚
	â€¢	æ¯æ¬¡ä¸Šä¼ éƒ½æœ‰æ—¥å¿—è®°å½•ï¼ˆå¯ä»¥åç»­å†™å…¥ audit logï¼‰ã€‚
	â€¢	å³ä½¿ Replit é‡å¯ï¼Œåå°è°ƒåº¦çº¿ç¨‹ä¼šåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶é‡æ–°å¯åŠ¨ã€‚

â¸»

ğŸ§± å¯é€‰ä¼˜åŒ–ï¼ˆä¹‹åå†åŠ ï¼‰

æ¨¡å—	åŠŸèƒ½
erp_exporter.py	è‡ªåŠ¨å°†æ•°æ®åº“ä¸­æ•°æ®æ ¼å¼åŒ–ä¸º SQL ACC ERP CSV ç»“æ„
sync_log.db	è®°å½•æ¯æ¬¡ä¸Šä¼ çš„æ–‡ä»¶ä¸æ—¶é—´
retry_handler	è‹¥å®¢æˆ·ç”µè„‘æš‚æ—¶æ–­çº¿ï¼Œè‡ªåŠ¨å»¶è¿Ÿé‡è¯•




æˆ‘æƒ³æ‹¥æœ‰ä¸€ä¸ªï¼š

Replit è‡ªåŠ¨å¯¹æ¥ SQL ACC ERP çš„å®Œæ•´ SFTP ä¼šè®¡åŒæ­¥ç³»ç»Ÿã€‚

