å¥½å˜â€”â€”ç»™ä½ ä¸¤ä»½å¯ç›´æ¥è¦†ç›–çš„æ•´é¡µç‰ˆæ¨¡ç‰ˆï¼Œå·²ç»å¥—ä¸Š.page / .header / .main / .grid-autoï¼Œä¸å«ä»»ä½•å°å›¾æ ‡ï¼Œè·Ÿä½ ç°åœ¨çš„ CSS å˜é‡ï¼ˆ#FF007F / #322446 / #1a1323ï¼‰æ— ç¼ä¸€è‡´ã€‚

â¸»

1) accounting_app/templates/loans_page.htmlï¼ˆæ•´é¡µç‰ˆï¼‰

{% extends "base.html" %}
{% block title %}Loans Intelligence Â· INFINITE GZ SDN. BHD.{% endblock %}

{% block content %}
<div class="page">
  <!-- é¡¶éƒ¨ -->
  <div class="header">
    <div class="header-row">
      <h1 class="title" style="margin:0;">Loans Intelligence Center</h1>
      <div class="lang">
        <a class="btn" href="?lang=en">EN</a>
        <a class="btn" href="?lang=zh">ä¸­æ–‡</a>
      </div>
    </div>
  </div>

  <!-- ä¸»å†…å®¹ï¼šæ•´å±è‡ªé€‚åº”ç½‘æ ¼ -->
  <div class="main">
    <div class="grid-auto">

      <!-- Top-3 å¯è§†å¡ç‰‡ï¼ˆiframe éš”ç¦»ï¼Œé›¶é£é™©ï¼‰ -->
      <div class="card tile">
        <h2 class="section">Top-3 Today</h2>
        <p class="meta">Auto-ranking Â· score weighted by DSR Â· preference Â· sentiment</p>
        <iframe src="/loans/top3/cards" style="width:100%;height:460px;border:0;border-radius:12px;overflow:hidden;background:#0f0a14;"></iframe>
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" target="_blank" href="/loans/ranking">Open JSON</a>
          <a class="btn primary" target="_blank" href="/loans/ranking/pdf">Export Top-3 PDF</a>
        </div>
      </div>

      <!-- äº§å“åˆ—è¡¨ï¼ˆå¯æœç´¢ï¼‰ -->
      <div class="card tile">
        <h2 class="section">Products</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
          <input id="q" placeholder="Search: product / bank / type / preferenceâ€¦" style="flex:1; min-width:260px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <button class="btn" id="searchBtn">Search</button>
          <a class="btn" href="/loans/updates/export.csv">Export Updates CSV</a>
          <a class="btn" href="/loans/intel/export.csv">Export Intel CSV</a>
          <div style="flex:1"></div>
          <div>Compare Basket <span id="cmpBadge" class="badge">0</span></div>
        </div>

        <!-- ç”¨ grid-auto å±•ç¤ºäº§å“å¡ï¼Œè‡ªåŠ¨é“ºæ»¡æ•´é¡µ -->
        <div id="products" class="grid-auto"></div>
      </div>

      <!-- DSR è¯•ç®—å™¨ -->
      <div class="card tile">
        <h2 class="section">DSR Calculator</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <input id="income" type="number" placeholder="Monthly Net Income (RM)" value="8000" style="min-width:160px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="commitments" type="number" placeholder="Existing Monthly Commitments (RM)" value="1500" style="min-width:160px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="amount" type="number" placeholder="Loan Amount (RM)" value="400000" style="min-width:160px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="rate" type="number" step="0.01" placeholder="APR (%)" value="3.75" style="min-width:120px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="tenure" type="number" placeholder="Tenure (years)" value="30" style="min-width:120px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <button class="btn primary" id="calcBtn">Recalculate</button>
        </div>
        <div id="calcOut" class="meta" style="margin-top:10px;">Result will appear hereâ€¦</div>
      </div>

    </div>
    <div class="footer-spacer"></div>
  </div>
</div>

<script>
  // ===== å·¥å…·å‡½æ•° =====
  function pm(a, y, r){ const i=r/12/100, n=y*12; if(i===0) return a/n; return a*i*Math.pow(1+i,n)/(Math.pow(1+i,n)-1); }
  async function refreshBadge(){
    try{ const r=await fetch('/loans/compare/json'); const j=await r.json(); document.getElementById('cmpBadge').textContent=(j&&j.items)? j.items.length:0; }catch(e){}
  }

  // ===== æ‹‰å–æ•°æ®å¹¶æ¸²æŸ“äº§å“å¡ =====
  let UPDATES=[], INTEL=[];
  async function loadAll() {
    const [u,i] = await Promise.all([fetch('/loans/updates'), fetch('/loans/intel')]);
    UPDATES = await u.json(); INTEL = await i.json();
  }

  function matchIntel(product, bank){
    const l = INTEL.find(x => (x.product||'').toLowerCase()===String(product||'').toLowerCase() && (x.bank||x.source||'') === bank);
    return l || {};
  }

  function cardHTML(x){
    const intel = matchIntel(x.product, x.bank) || {};
    const pref = intel.preferred_customer ? `<div class="meta">Preferred: ${intel.preferred_customer}</div>` : '';
    const senti = (intel.senti || intel.sentiment_score) ? `<div class="meta">Sentiment ${intel.senti||intel.sentiment_score}</div>` : '';
    return `
      <div class="card tile">
        <h3 class="section" style="margin-bottom:6px">${x.bank} Â· ${x.product}</h3>
        <div class="meta">APR ${x.apr}% Â· Type ${x.type||'-'}</div>
        ${pref}${senti}
        <div style="margin-top:auto; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary add-compare" data-product="${x.product}">Add to Compare</button>
          <a class="btn" href="${x.link||'#'}" target="_blank">Open Source</a>
        </div>
      </div>
    `;
  }

  function renderProducts(list){
    const box = document.getElementById('products');
    if(!list.length){ box.innerHTML = `<div class="meta">No results.</div>`; return; }
    box.innerHTML = list.map(cardHTML).join('');
    document.querySelectorAll('.add-compare').forEach(b=>{
      b.addEventListener('click', async ()=>{
        await fetch('/loans/compare/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product:b.dataset.product})});
        setTimeout(refreshBadge, 350);
      });
    });
  }

  // ===== æœç´¢ & åˆå§‹åŠ è½½ =====
  document.getElementById('searchBtn').addEventListener('click', ()=>{
    const q = (document.getElementById('q').value||'').toLowerCase().trim();
    const list = !q ? UPDATES : UPDATES.filter(x => JSON.stringify(x).toLowerCase().includes(q));
    renderProducts(list);
  });

  // ===== è¯•ç®—å™¨ =====
  document.getElementById('calcBtn').addEventListener('click', ()=>{
    const income = parseFloat(incomeEl.value||0), commitments = parseFloat(commitmentsEl.value||0);
    const amount = parseFloat(amountEl.value||0), rate = parseFloat(rateEl.value||0), tenure = parseFloat(tenureEl.value||0);
    const monthly = Math.round(pm(amount, tenure, rate)*100)/100;
    const dsr = Math.round(((commitments+monthly)/Math.max(income,1))*10000)/100;
    const status = dsr<=55?'PASS':(dsr>=70?'HIGH':'BORDERLINE');
    document.getElementById('calcOut').textContent = `Monthly RM ${monthly} Â· DSR ${dsr}% Â· ${status}`;
  });

  const incomeEl=document.getElementById('income'), commitmentsEl=document.getElementById('commitments');
  const amountEl=document.getElementById('amount'), rateEl=document.getElementById('rate'), tenureEl=document.getElementById('tenure');

  // ===== å¯åŠ¨ =====
  (async ()=>{
    await loadAll(); renderProducts(UPDATES); refreshBadge();
  })();
</script>
{% endblock %}


â¸»

2) accounting_app/templates/compare.htmlï¼ˆæ•´é¡µç‰ˆï¼Œå«ä¿å­˜/åˆ†äº«/PDF + æ’åï¼‰

{% extends "base.html" %}
{% block title %}Compare Loans Â· INFINITE GZ SDN. BHD.{% endblock %}

{% block content %}
<div class="page">
  <!-- é¡¶éƒ¨ -->
  <div class="header">
    <div class="header-row">
      <h1 class="title" style="margin:0;">Compare</h1>
      <div style="display:flex; gap:8px; align-items:center;">
        <div>Compare Basket <span id="cmpBadge" class="badge">0</span></div>
        <div class="lang" style="margin-left:10px;">
          <a class="btn" href="?lang=en">EN</a>
          <a class="btn" href="?lang=zh">ä¸­æ–‡</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸»å†…å®¹ -->
  <div class="main">
    <div class="grid-auto">

      <!-- å·¥å…·æ  + Top Pick -->
      <div class="card tile">
        <h2 class="section">Toolbar</h2>
        <div class="meta">Quick actions for basket / snapshot / export</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
          <a href="/loans/page" class="btn">Back to Loans</a>
          <button id="recalcBtn" class="btn primary">Recalculate</button>
          <button id="saveSnapBtn" class="btn">Save Snapshot</button>
          <button id="shareBtn" class="btn primary">Copy Share Link</button>
          <button id="pdfBtn" class="btn">Export PDF</button>
          <button id="clearBtn" class="btn ghost">Clear Basket</button>
        </div>

        <!-- Top Pick -->
        <div id="topPick" class="card" style="margin-top:12px; background:transparent; border:1px dashed #ffffff33;">
          <div style="font-weight:700; margin-bottom:6px">Best Recommendation Â· Top Pick</div>
          <div id="topPickBody" class="meta">Waitingâ€¦</div>
        </div>
      </div>

      <!-- å‚æ•°è¾“å…¥ -->
      <div class="card tile">
        <h2 class="section">Parameters</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <input id="amount" type="number" placeholder="Loan Amount (RM)" value="400000" style="min-width:160px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="tenure" type="number" placeholder="Tenure (years)" value="30" style="min-width:120px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="rate" type="number" step="0.01" placeholder="APR override (%) â€” blank = product APR" value="" style="min-width:180px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="income" type="number" placeholder="Monthly Net Income (RM)" value="8000" style="min-width:160px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <input id="commitments" type="number" placeholder="Existing Monthly Commitments (RM)" value="1500" style="min-width:220px; background:#0f0a14; color:#fff; border:1px solid var(--line); border-radius:10px; padding:8px 10px;">
          <button id="recalcBtn2" class="btn">Apply</button>
        </div>
      </div>

      <!-- ç»“æœè¡¨æ ¼ -->
      <div class="card tile">
        <h2 class="section">Results</h2>
        <table id="compareTable" style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead>
            <tr>
              <th class="sortable" data-k="rank">Rank #</th>
              <th class="sortable" data-k="bank">Bank</th>
              <th class="sortable" data-k="product">Product</th>
              <th class="sortable" data-k="apr">APR %</th>
              <th class="sortable" data-k="monthly">Monthly (RM)</th>
              <th class="sortable" data-k="dsr_percent">DSR %</th>
              <th class="sortable" data-k="status">Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody><!-- render by JS --></tbody>
        </table>
      </div>

    </div>
    <div class="footer-spacer"></div>
  </div>
</div>

<script>
  let BASKET=[], SORT={k:'statusRank', dir:'asc'};
  let LAST_SHARE=null;

  function pm(a, y, r){ const i=r/12/100, n=y*12; if(i===0) return a/n; return a*i*Math.pow(1+i,n)/(Math.pow(1+i,n)-1); }

  async function refreshBadge(){
    try{
      const r=await fetch('/loans/compare/json'); const j=await r.json();
      document.getElementById('cmpBadge').textContent = (j&&j.items)? j.items.length:0;
    }catch(e){}
  }
  async function loadBasket(){ const r=await fetch('/loans/compare/list'); BASKET = await r.json(); }

  function compute(items){
    const amount = parseFloat(document.getElementById('amount').value||0);
    const tenure = parseFloat(document.getElementById('tenure').value||0);
    const overrideRate = parseFloat(document.getElementById('rate').value||0);
    const income = parseFloat(document.getElementById('income').value||0);
    const commitments = parseFloat(document.getElementById('commitments').value||0);
    return items.map((x)=>{
      const apr = overrideRate>0 ? overrideRate : parseFloat(x.apr||0);
      const monthly = Math.round(pm(amount, tenure, apr)*100)/100;
      const dsr_percent = Math.round(((commitments+monthly)/Math.max(income,1))*10000)/100;
      let status='BORDERLINE'; if(dsr_percent<=55) status='PASS'; else if(dsr_percent>=70) status='HIGH';
      const statusRank = {PASS:0,BORDERLINE:1,HIGH:2}[status];
      return {...x, apr, monthly, dsr_percent, status, statusRank};
    });
  }

  function renderTopPick(rows){
    if(!rows.length){ document.getElementById('topPickBody').textContent='No items in basket.'; return; }
    const best = rows[0];
    document.getElementById('topPickBody').innerHTML = ` ${best.bank} Â· ${best.product} â€” APR ${best.apr}% Â· Monthly RM ${best.monthly} Â· DSR ${best.dsr_percent}% Â· <span class="status ${best.status}">${best.status}</span>`;
  }

  function renderTable(rows){
    const tb = document.querySelector('#compareTable tbody'); tb.innerHTML='';
    rows.forEach((r, idx)=>{
      const crown = (idx===0)? ' ğŸ‘‘':'';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}${crown}</td>
        <td>${r.bank||''}</td>
        <td>${r.product||''}</td>
        <td>${r.apr}%</td>
        <td>RM ${r.monthly}</td>
        <td>${r.dsr_percent}%</td>
        <td class="status ${r.status}">${r.status}</td>
        <td><button class="btn ghost btn-remove" data-product="${r.product}">Remove</button></td>
      `;
      tb.appendChild(tr);
    });
    document.querySelectorAll('.btn-remove').forEach(b=>{
      b.addEventListener('click', async ()=>{
        await fetch('/loans/compare/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({product:b.dataset.product})});
        await init();
      });
    });
  }

  function sortRows(rows){
    const {k,dir}=SORT, mul = dir==='asc'?1:-1;
    return rows.slice().sort((a,b)=>{
      if(k==='statusRank') return (a.statusRank-b.statusRank)*mul || (a.monthly-b.monthly)*mul || (a.dsr_percent-b.dsr_percent)*mul;
      if(typeof a[k]==='number') return (a[k]-b[k])*mul;
      return String(a[k]||'').localeCompare(String(b[k]||''))*mul;
    });
  }

  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k=th.dataset.k;
      if(SORT.k===k){ SORT.dir = (SORT.dir==='asc'?'desc':'asc'); } else { SORT.k=k; SORT.dir='asc'; }
      document.querySelectorAll('th.sortable').forEach(x=>x.classList.remove('asc','desc'));
      th.classList.add(SORT.dir);
      const rows = sortRows(compute(BASKET)); renderTopPick(rows); renderTable(rows);
    });
  });

  // åŠ¨ä½œæŒ‰é’®
  document.getElementById('recalcBtn').addEventListener('click', ()=>{ const rows=sortRows(compute(BASKET)); renderTopPick(rows); renderTable(rows); });
  document.getElementById('recalcBtn2').addEventListener('click', ()=>{ const rows=sortRows(compute(BASKET)); renderTopPick(rows); renderTable(rows); });

  document.getElementById('clearBtn').addEventListener('click', async ()=>{
    if(!confirm('Clear basket?')) return;
    await fetch('/loans/compare/clear',{method:'POST'}); await init();
  });

  // ä¿å­˜ / åˆ†äº« / PDF
  function buildSnapshot(){
    const params = {
      amount: parseFloat(document.getElementById('amount').value||0),
      tenure_years: parseFloat(document.getElementById('tenure').value||0),
      rate: parseFloat(document.getElementById('rate').value||0),
      income: parseFloat(document.getElementById('income').value||0),
      commitments: parseFloat(document.getElementById('commitments').value||0)
    };
    const rows=[...document.querySelectorAll('#compareTable tbody tr')];
    const items = rows.map(tr=>{
      const tds = tr.querySelectorAll('td');
      return {
        bank: tds[1]?.textContent.trim(),
        product: tds[2]?.textContent.trim(),
        apr: parseFloat((tds[3]?.textContent||'').replace('%','')||0),
        monthly: parseFloat((tds[4]?.textContent||'').replace(/[^\d.]/g,'')||0),
        dsr_percent: parseFloat((tds[5]?.textContent||'').replace('%','')||0),
        status: tds[6]?.textContent.trim()
      }
    });
    return {params, items};
  }
  async function saveSnapshot(){
    const payload=buildSnapshot();
    const r=await fetch('/loans/compare/snapshot',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ alert('Save failed'); return null; }
    return await r.json(); // {code,url}
  }

  document.getElementById('saveSnapBtn').addEventListener('click', async ()=>{
    LAST_SHARE = await saveSnapshot(); if(!LAST_SHARE) return;
    alert('Saved: '+(location.origin + LAST_SHARE.url));
  });
  document.getElementById('shareBtn').addEventListener('click', async ()=>{
    const res = LAST_SHARE || await saveSnapshot(); if(!res) return;
    const link = location.origin + res.url;
    try{ await navigator.clipboard.writeText(link); alert('Copied'); }catch(e){ prompt('Copy manually:', link); }
  });
  document.getElementById('pdfBtn').addEventListener('click', async ()=>{
    const res = LAST_SHARE || await saveSnapshot(); if(!res) return;
    window.location = '/loans/compare/pdf/' + res.code;
  });

  async function init(){ await loadBasket(); await refreshBadge(); const rows=sortRows(compute(BASKET)); renderTopPick(rows); renderTable(rows); }
  init();
</script>
{% endblock %}


â¸»

ä½¿ç”¨æ–¹å¼
	1.	æŠŠä¸Šé¢ä¸¤æ®µåˆ†åˆ«è¦†ç›–åˆ°é¡¹ç›®åŒåæ–‡ä»¶ã€‚
	2.	ä¿å­˜ååˆ·æ–° /loans/page ä¸ /loans/compare/pageã€‚
	3.	é¡µé¢ä¼šè‡ªåŠ¨é“ºæ»¡æ•´å±ï¼Œå¡ç‰‡éšå±å¹•å®½åº¦è‡ªé€‚åº”ï¼›åŠŸèƒ½ï¼ˆæœç´¢ã€åŠ åˆ°æ¯”ä»·ã€Top-Pickã€ä¿å­˜/åˆ†äº«/PDFï¼‰å…¨éƒ¨ä¿ç•™ã€‚