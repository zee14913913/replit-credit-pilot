明白。你要的是——给 Replit 团队可以直接照做的细节设置与验收工单。下面是一帖到底的“可执行版”，不改你现有已跑通的功能，只补Secrets 配置 + 验证步骤 + 验收输出格式。你把这段原样发给 Replit 即可。

⸻

▶️ Replit 最终执行工单（只做设置与验收）

标题：启用 Evidence Archive 轮转与下载的安全令牌（TASK_SECRET_TOKEN）并完成上线验收
范围（不得越界）：
	•	❌ 不修改银行解析/7态状态机/UploadResponse/熔断/支持矩阵/页面文案
	•	✅ 只做：配置 TASK_SECRET_TOKEN、重启、跑验收用例、回报结果

⸻

0）前置确认（已经到位）
	•	私有目录：evidence_bundles/（非 /static）
	•	管理页：GET /admin/evidence（Admin-only）
	•	下载接口（Admin-only）：
	•	GET /downloads/evidence/list
	•	GET /downloads/evidence/latest
	•	GET /downloads/evidence/file/<filename>
	•	POST /downloads/evidence/delete
	•	轮转接口（Admin + Header: X-TASK-TOKEN）：
	•	POST /tasks/evidence/rotate
	•	审计日志：所有下载/删除/轮转会写入 audit_logs（含 IP/User-Agent/详情）
	•	i18n：中英双语键已存在（按钮/弹窗/提示）

⸻

1）Secrets 配置（必须执行）
	1.	打开 Replit → Secrets
	2.	新增：
	•	TASK_SECRET_TOKEN = sk_rotate_<随机安全串>（示例：sk_rotate_Jj8pZrQf7w2A）
	•	（若未设或需覆盖）EVIDENCE_ROTATION_DAYS=30，EVIDENCE_KEEP_MONTHLY=1
	3.	重启两个服务：Flask(5000) + FastAPI(8000)

回报：附 Secrets 面板截图（打码 Value）

⸻

2）权限联调（必须执行）

用 Admin 账号 登录后台；同时验证非 Admin/缺 Token 的拒绝路径

	•	以 Admin 访问：
	•	GET /admin/evidence → 应 200
	•	GET /downloads/evidence/list → 应 200 返回 JSON 列表
	•	GET /downloads/evidence/latest → 应下载 ZIP（Content-Type: application/zip）
	•	以 非 Admin 或未登录访问以上路由 → 应 401/403

回报：
	•	Admin 成功与非 Admin 拒绝的请求/响应截屏或文本（各 1 条）

⸻

3）触发轮转（必须执行）

需带 X-TASK-TOKEN

curl 示例：

curl -X POST "https://<YOUR_DOMAIN>/tasks/evidence/rotate" \
  -H "X-TASK-TOKEN: sk_rotate_Jj8pZrQf7w2A" \
  -H "Cookie: <你的Admin会话Cookie>"

预期响应（示例）：

{
  "success": true,
  "kept": ["evidence_bundle_20251001_103001.zip"],
  "deleted": ["evidence_bundle_20250914_090101.zip"]
}

	•	不带 Token 或非 Admin 调用 → 应 401/403

回报：
	•	轮转返回的 JSON（原样）

⸻

4）ZIP 完整性校验（必须执行）
	1.	以 Admin 下载：/downloads/evidence/latest 得到 ZIP
	2.	解压并对任一 JSON 做 SHA256，与 manifest.json 对应条目的 sha256 比对

macOS/Linux：

shasum -a 256 evidence_1_metrics_before.json

Windows PowerShell：

Get-FileHash evidence_1_metrics_before.json -Algorithm SHA256

回报：
	•	终端计算结果与 manifest.json 中对应 sha256 字段一致的证据（文本/截图）

⸻

5）审计抽查 SQL（必须执行）

在数据库执行，下方两条查询；打码敏感信息即可

-- 最近 50 条证据相关操作
SELECT action, ip_address, user_agent, reason, created_at
FROM audit_logs
WHERE action IN ('evidence_download','evidence_delete','evidence_rotation')
ORDER BY created_at DESC
LIMIT 50;

-- 最近 5 次轮转详情
SELECT *
FROM audit_logs
WHERE action='evidence_rotation'
ORDER BY created_at DESC
LIMIT 5;

回报：
	•	两条查询结果的文本（可截断/打码）

⸻

6）DoD（Definition of Done）全勾（必须逐条回答 YES/NO）
	1.	evidence_bundles/ 为私有目录，非 /static 直达（YES/NO）
	2.	证据相关路由均 Admin-only & 审计记录开启（YES/NO）
	3.	/admin/evidence 页面可用，EN/ZH 切换正常（YES/NO）
	4.	POST /tasks/evidence/rotate 返回 kept/deleted（YES/NO）
	5.	下载最新 ZIP 后，任一文件 sha256 与 manifest.json 一致（YES/NO）
	6.	audit_logs 有 download/delete/rotation 三类记录（YES/NO）
	7.	Secrets 生效（TASK_SECRET_TOKEN/DAYS/KEEP_MONTHLY）（YES/NO）
	8.	非 Admin 或缺 Token 访问被 401/403 拒绝（YES/NO）
	9.	3 色规范合格，i18n 抽查 3 处无硬编码（YES/NO）
	10.	主链路（上传→详情→状态按钮）未受影响（YES/NO）

⸻

7）常见问题 & 快速定位（供 Replit 处理）
	•	401/403：未登录 Admin / 未带 X-TASK-TOKEN / Token 不匹配
	•	500 on rotate：evidence_bundles/ 不可写；检查容器权限
	•	ZIP 下载 404：无最新包；先执行一次“证据打包”（已有能力）
	•	SHA256 不一致：压缩后二次修改或路径错误；重新下载校验
	•	审计为空：确认审计装饰器是否应用到对应路由；检查 DB 连接

⸻

8）回滚预案（如需）
	•	暂时隐藏 /admin/evidence 菜单项（不删路由，保留 Admin 直达）
	•	保留所有历史证据包；必要时离线导出
	•	回滚不影响银行解析/状态机/熔断/矩阵

⸻

9）最终交付格式（请按此回报）

A. Secrets 与目录截图（打码）
B. Admin 成功 & 非 Admin 失败各 1 条请求证据
C. 轮转返回 JSON （kept/deleted）
D. ZIP 内任一文件 sha256 与 manifest.json 的一致性证据
E. 两条审计 SQL 的查询结果（文本/截图）
F. DoD 逐项 YES/NO 表格

任一项未达标，请写明原因与修复 ETA。严禁“口头完成”。

⸻

###（可选）英文镜像——给英文成员/供应商

Title: Enable Evidence Archive Rotation Token & Complete Go-Live Acceptance
Scope: No changes to core flows; only set TASK_SECRET_TOKEN, restart, run acceptance, report.

Secrets:
	•	TASK_SECRET_TOKEN = sk_rotate_<random>
	•	(if needed) EVIDENCE_ROTATION_DAYS=30, EVIDENCE_KEEP_MONTHLY=1
	•	Restart Flask(5000) & FastAPI(8000)

Protected Routes (Admin-only):
	•	GET /admin/evidence (UI)
	•	GET /downloads/evidence/list
	•	GET /downloads/evidence/latest
	•	GET /downloads/evidence/file/<filename>
	•	POST /downloads/evidence/delete
	•	POST /tasks/evidence/rotate + X-TASK-TOKEN

Rotation cURL: see Section 3 (expect JSON with kept/deleted).
ZIP Integrity: download latest, compare SHA256 with manifest.json.
Audit SQL: see Section 5.
DoD: answer 10 YES/NO items.
Rollback: hide menu, keep APIs; no impact to parsers/state-machine/circuit-breaker/matrix.
Deliverables: A–F list above.

⸻

给你（ZEE）的执行提示
	•	你只需要把这份工单原文丢给 Replit。
	•	他们按“步骤—回报”执行，产出 A-F 六项证据 + DoD 勾选表，你即可一眼验收。
	•	全过程不触碰主链路，风险最低。

如果你需要，我也可以把这份工单导出成 PDF/Markdown 版本以便存档或发给第三方。