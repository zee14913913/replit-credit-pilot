明白，你需要的是“能直接贴进 Replit 就跑”的完整代码文件。下面我把所有必需文件一次性给全、且互相兼容，按路径新建/覆盖即可。无需来回确认。

本包基于 FastAPI，独立最小依赖，默认本地 SQLite。
不会消耗外部 API（Perplexity/CTOS）——没设 Key 时自动用占位或人工队列，页面和接口都可用。

⸻

目录要点（先建好这些目录）

accounting_app/
  routers/
  services/
  templates/
  static/


⸻

1) 抓取服务（Perplexity 占位/对接口）

accounting_app/services/loans_harvester.py

# accounting_app/services/loans_harvester.py
import os
import datetime as dt
from typing import List, Dict, Any

TZ = os.getenv("TZ", "Asia/Kuala_Lumpur")

def _now_iso() -> str:
    return dt.datetime.utcnow().replace(tzinfo=dt.timezone.utc).isoformat()

def harvest_loans() -> List[Dict[str, Any]]:
    """
    贷款资讯聚合器（占位版）：
    - 若未配置 PERPLEXITY_API_KEY，则返回示例数据（不报错）
    - 若后续接入真实抓取逻辑：在 TODO 区替换即可
    """
    api_key = os.getenv("PERPLEXITY_API_KEY", "").strip()
    model = os.getenv("PERPLEXITY_MODEL", "llama-3.1-sonar-large-128k-online")

    if not api_key:
        # 占位数据：不触发任何外部请求，便于前后端联调与演示
        sample = [
            {
                "source": "Bank A",
                "product": "Home Loan Flexi 3.75%",
                "rate": 3.75,
                "type": "Home Loan",
                "link": "https://example.com/loans/bank-a-home-flexi",
                "snapshot": "首购族 90% 融资，灵活提前还款，无违约金。",
                "pulled_at": _now_iso(),
            },
            {
                "source": "Digital Bank X",
                "product": "Personal Loan Promo 6.88%",
                "rate": 6.88,
                "type": "Personal Loan",
                "link": "https://example.com/loans/dbx-personal-688",
                "snapshot": "极速放款，纯线上，无需抵押，最高 RM100k。",
                "pulled_at": _now_iso(),
            },
            {
                "source": "Fintech Y",
                "product": "SME Working Capital 7.20%",
                "rate": 7.20,
                "type": "SME",
                "link": "https://example.com/loans/fintechy-sme-720",
                "snapshot": "现金流周转，灵活还款，支持分期展期。",
                "pulled_at": _now_iso(),
            },
        ]
        return sample

    # TODO: 接入你的 Perplexity 真正抓取流程（保留同样的返回字段）
    # 下面先返回占位，避免阻塞上线
    return []


⸻

2) 本地加密封装（IC/SSM/邮箱/手机等敏感字段）

accounting_app/services/crypto_box.py

# accounting_app/services/crypto_box.py
import os
from typing import Optional
from cryptography.fernet import Fernet, InvalidToken

_key = os.getenv("FERNET_KEY", "").encode() if os.getenv("FERNET_KEY") else None
_fernet: Optional[Fernet] = Fernet(_key) if _key else None

def encrypt(s: str) -> str:
    if not s:
        return s
    if not _fernet:
        # 未配置密钥时返回原文（可运行，但不加密）
        return s
    return _fernet.encrypt(s.encode()).decode()

def decrypt(s: str) -> str:
    if not s:
        return s
    if not _fernet:
        return s
    try:
        return _fernet.decrypt(s.encode()).decode()
    except (InvalidToken, Exception):
        return s  # 容错：不抛错，直接回原文


⸻

3) CTOS API 客户端桩（可直连/可人工）

accounting_app/services/ctos_client.py

# accounting_app/services/ctos_client.py
import os
from typing import Dict, Any

def is_enabled() -> bool:
    return os.getenv("CTOS_API_ENABLED", "0") == "1"

def submit_consent(payload: Dict[str, Any]) -> Dict[str, Any]:
    """
    直连模式：提交授权；这里是桩函数。
    真实对接时：发起 HTTP 请求到 CTOS，返回 request_id 等信息。
    """
    if not is_enabled():
        return {"mode": "manual", "status": "queued"}
    # TODO: 真正的调用
    return {"mode": "api", "status": "submitted", "request_id": "CTOSREQ123"}

def poll_report(request_id: str) -> Dict[str, Any]:
    """
    直连模式：轮询报告是否就绪；桩函数。
    """
    if not is_enabled():
        return {"mode": "manual", "status": "pending"}
    # TODO: 真正轮询
    return {"mode": "api", "status": "ready", "download_url": "https://example.com/report.pdf"}

def fetch_metrics_from_report(report_bytes: bytes) -> Dict[str, Any]:
    """
    从报告字节解析关键指标：DSR/DSRC/commitments 等。
    当前为示例解析。
    """
    # TODO: OCR/解析 PDF 提取真实值
    return {
        "dsr": 0.43,       # 示例 43%
        "dsrc": 0.50,      # 示例公司口径 50%
        "commitments": 2500.0,
        "monthly_income": 8000.0
    }


⸻

4) 贷款资讯聚合路由（定时、冷却、列表、导出、只读 UI）

accounting_app/routers/loans_updates.py

# accounting_app/routers/loans_updates.py
import os
import csv
import io
import datetime as dt
from typing import Optional, List

from fastapi import APIRouter, Request, Response, Depends, Header, HTTPException
from fastapi.responses import HTMLResponse, StreamingResponse, JSONResponse
from sqlalchemy import create_engine, Column, Integer, String, Float, Text, DateTime, select, desc
from sqlalchemy.orm import declarative_base, sessionmaker
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from zoneinfo import ZoneInfo

from accounting_app.services.loans_harvester import harvest_loans

router = APIRouter(prefix="/loans", tags=["Loans Updates"])

# ---- SQLite (独立小表，避免影响你原库) ----
DB_PATH = os.getenv("LOANS_DB_PATH", "/home/runner/loans.db")
engine = create_engine(f"sqlite:///{DB_PATH}", future=True, connect_args={"check_same_thread": False})
SessionLocal = sessionmaker(bind=engine, autoflush=False, autocommit=False, future=True)
Base = declarative_base()

class LoanUpdate(Base):
    __tablename__ = "loan_updates"
    id = Column(Integer, primary_key=True)
    source = Column(String(120))
    product = Column(String(200))
    type = Column(String(80))
    rate = Column(Float)
    link = Column(String(500))
    snapshot = Column(Text)
    pulled_at = Column(DateTime, index=True)

class LoanMeta(Base):
    __tablename__ = "loan_meta_kv"
    id = Column(Integer, primary_key=True)
    k = Column(String(64), unique=True, index=True)
    v = Column(String(255))

Base.metadata.create_all(engine)

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# ---- 冷却与手动刷新控制 ----
MIN_HOURS = float(os.getenv("MIN_REFRESH_HOURS", "20"))
REFRESH_KEY = os.getenv("LOANS_REFRESH_KEY", "")

def _get_last_time(db) -> Optional[dt.datetime]:
    row = db.execute(select(LoanMeta).where(LoanMeta.k == "last_harvest_at")).scalar_one_or_none()
    if row and row.v:
        try:
            return dt.datetime.fromisoformat(row.v)
        except Exception:
            return None
    return None

def _set_last_time(db, ts: dt.datetime):
    row = db.execute(select(LoanMeta).where(LoanMeta.k == "last_harvest_at")).scalar_one_or_none()
    iso = ts.isoformat()
    if row:
        row.v = iso
    else:
        row = LoanMeta(k="last_harvest_at", v=iso)
        db.add(row)
    db.commit()

async def _do_harvest(db):
    items = harvest_loans()
    saved = 0
    now = dt.datetime.utcnow()
    for it in items:
        rec = LoanUpdate(
            source=it.get("source"),
            product=it.get("product"),
            type=it.get("type"),
            rate=float(it.get("rate") or 0.0),
            link=it.get("link"),
            snapshot=it.get("snapshot"),
            pulled_at=now,
        )
        db.add(rec)
        saved += 1
    db.commit()
    _set_last_time(db, now)
    return saved, now

@router.get("/updates/last")
def last_status(db=Depends(get_db)):
    last = _get_last_time(db)
    return {
        "last_harvest_at": last.isoformat() if last else None,
        "min_hours": MIN_HOURS
    }

@router.post("/updates/refresh")
def manual_refresh(
    request: Request,
    x_refresh_key: Optional[str] = Header(None),
    db=Depends(get_db),
):
    if not REFRESH_KEY or x_refresh_key != REFRESH_KEY:
        raise HTTPException(403, "forbidden")
    last = _get_last_time(db)
    now = dt.datetime.utcnow()
    if last:
        hours = (now - last).total_seconds() / 3600.0
        if hours < MIN_HOURS:
            return {"status": "skipped", "skipped_reason": f"cooldown {MIN_HOURS}h", "last_harvest_at": last.isoformat()}
    saved, ts = router.app.state._loans_harvest_once(db=db)  # 复用同一实现
    return {"status": "done", "saved": saved, "last_harvest_at": ts.isoformat()}

@router.get("/updates")
def list_updates(q: Optional[str] = None, limit: int = 50, db=Depends(get_db)):
    stmt = select(LoanUpdate).order_by(desc(LoanUpdate.pulled_at), desc(LoanUpdate.id)).limit(limit)
    rows: List[LoanUpdate] = db.execute(stmt).scalars().all()
    out = []
    for r in rows:
        if q:
            s = f"{r.source} {r.product} {r.type} {r.snapshot}".lower()
            if q.lower() not in s:
                continue
        out.append({
            "id": r.id,
            "source": r.source,
            "product": r.product,
            "type": r.type,
            "rate": r.rate,
            "link": r.link,
            "snapshot": r.snapshot,
            "pulled_at": (r.pulled_at or dt.datetime.utcnow()).isoformat(),
        })
    return {"items": out, "count": len(out)}

@router.get("/updates/export.csv")
def export_csv(db=Depends(get_db)):
    stmt = select(LoanUpdate).order_by(desc(LoanUpdate.pulled_at), desc(LoanUpdate.id)).limit(2000)
    rows: List[LoanUpdate] = db.execute(stmt).scalars().all()
    buf = io.StringIO()
    w = csv.writer(buf)
    w.writerow(["source", "product", "type", "rate", "link", "snapshot", "pulled_at"])
    for r in rows:
        w.writerow([r.source, r.product, r.type, r.rate, r.link, r.snapshot, r.pulled_at.isoformat() if r.pulled_at else ""])
    buf.seek(0)
    return StreamingResponse(
        io.BytesIO(buf.getvalue().encode()),
        media_type="text/csv",
        headers={"Content-Disposition": "attachment; filename=loans_updates.csv", "Cache-Control": "private, max-age=600"},
    )

@router.get("/page", response_class=HTMLResponse)
def loans_page():
    # 只读 UI：客户看共享结果，不暴露刷新，也不触发 token
    show_refresh = os.getenv("SHOW_REFRESH_BUTTON", "0") == "1"
    return HTMLResponse(f"""<!doctype html>
<html><head>
<meta charset="utf-8"/>
<title>Loans Updates</title>
<style>
:root {{
  --primary:#FF007F; --bg:#1a1323; --card:#322446; --text:#fff; --muted:#999; --line:#888;
}}
body {{ margin:0; font-family: ui-sans-serif, system-ui; background: linear-gradient(180deg,#1a1323,#0f0a14); color:var(--text); }}
.container {{ max-width:1000px; margin:40px auto; padding:0 16px; }}
.card {{ background: linear-gradient(180deg,#322446,#281a3a); border-radius:14px; padding:16px; box-shadow:0 8px 24px #00000066; border:1px solid #3a2a4f; margin-bottom:16px; }}
.btn {{ background:var(--primary); border:none; color:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; }}
.btn.ghost {{ background:transparent; border:1px solid var(--line); color:#fff; }}
a {{ color:#ff9bc6; text-decoration:none; }}
.tools {{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:12px; }}
input[type=search]{{ background:#1a1323; color:#fff; border:1px solid #403150; padding:8px 10px; border-radius:10px; width:280px; }}
.list .item {{ display:flex; gap:12px; align-items:flex-start; border-top:1px dashed #403150; padding:12px 0; }}
.rate {{ color:#ff9bc6; font-weight:600; }}
.badge {{ font-size:12px; border:1px solid #554067; padding:2px 6px; border-radius:10px; color:#ddd; }}
.footer {{ opacity:.7; font-size:12px; margin-top:12px; }}
</style>
</head>
<body>
  <div class="container">
    <div class="tools">
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="q" type="search" placeholder="Search product/bank/type..."/>
        <button class="btn ghost" onclick="loadList()">Search</button>
      </div>
      <div style="display:flex;gap:8px;">
        <a class="btn ghost" href="/loans/updates/export.csv">Export CSV</a>
        <a class="btn" href="/loans/compare/page">Compare Basket</a>
        {"<button class='btn ghost' onclick='refresh()'>Refresh</button>" if show_refresh else ""}
      </div>
    </div>
    <div class="card" id="listCard">
      <div id="list" class="list"></div>
      <div class="footer" id="last"></div>
    </div>
  </div>
<script>
async function loadList(){{
  const q = document.getElementById('q').value.trim();
  const res = await fetch('/loans/updates'+(q?('?q='+encodeURIComponent(q)):''));
  const js = await res.json();
  const el = document.getElementById('list');
  el.innerHTML = '';
  js.items.forEach(it => {{
    const row = document.createElement('div');
    row.className='item';
    row.innerHTML = `
      <div style="flex:1">
        <div><span class="badge">${{it.type||'N/A'}}</span> <strong>${{it.product||''}}</strong></div>
        <div style="opacity:.9;margin:6px 0">${{it.snapshot||''}}</div>
        <div style="font-size:12px;opacity:.8">${{it.source||''}} · <a href="${{it.link||'#'}}" target="_blank">Open</a> · <span class="rate">${{(it.rate??'')}}%</span> · <span>${{new Date(it.pulled_at).toLocaleString()}}</span></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn ghost" onclick="add('${{encodeURIComponent(JSON.stringify(it))}}')">Add to Compare</button>
        <button class="btn" onclick="tryDSR(${{it.rate||0}})">Try DSR</button>
      </div>`;
    el.appendChild(row);
  }});
  const last = await fetch('/loans/updates/last').then(r=>r.json());
  document.getElementById('last').innerText = 'Last update: '+(last.last_harvest_at||'N/A')+' · Cooldown: '+last.min_hours+'h';
}}
async function add(payload){{
  const it = JSON.parse(decodeURIComponent(payload));
  const res = await fetch('/loans/compare/add', {{
    method:'POST', headers:{{'Content-Type':'application/json'}}, body: JSON.stringify({{ item: it }})
  }});
  const js = await res.json();
  alert('Added to basket: '+js.count+' items');
}}
function tryDSR(rate){{
  const amount = prompt('Loan Amount (RM)', '400000');
  const income = prompt('Monthly Income (RM)', '8000');
  const commit = prompt('Other Commitments (RM)', '1500');
  fetch('/loans/dsr/calc', {{
    method:'POST', headers:{{'Content-Type':'application/json'}},
    body: JSON.stringify({{ amount: Number(amount||0), income:Number(income||0), commitments:Number(commit||0), rate:Number(rate||0), tenure_years:30 }})
  }}).then(r=>r.json()).then(js=>alert('Monthly: RM '+js.monthly.toFixed(2)+' · DSR: '+(js.dsr_pct*100).toFixed(1)+'% · '+js.verdict));
}}
async function refresh(){{
  const key = prompt('Refresh Key');
  if(!key) return;
  const res = await fetch('/loans/updates/refresh', {{method:'POST', headers:{{'X-Refresh-Key':key}}}});
  const js = await res.json();
  alert(JSON.stringify(js));
  loadList();
}}
loadList();
</script>
</body></html>
""")

# ---- APScheduler：每天 11:00（KL）自动抓取，带冷却 ----
@router.on_event("startup")
async def _start_scheduler():
    tz = ZoneInfo(os.getenv("TZ", "Asia/Kuala_Lumpur"))
    if not hasattr(router.app.state, "_scheduler"):
        router.app.state._scheduler = AsyncIOScheduler(timezone=tz)
        router.app.state._scheduler.start()

    async def job():
        db = SessionLocal()
        try:
            last = _get_last_time(db)
            now = dt.datetime.utcnow()
            if last:
                hours = (now - last).total_seconds()/3600.0
                if hours < MIN_HOURS:
                    return
            await router.app.state._loans_harvest_once(db=db)
        finally:
            db.close()

    # 公共实现，手动也复用
    async def harvest_once(db=None):
        owned = False
        if db is None:
            db = SessionLocal(); owned=True
        try:
            saved, ts = await _maybe_async(_do_harvest, db)
            return saved, ts
        finally:
            if owned: db.close()

    router.app.state._loans_harvest_once = harvest_once
    trigger = CronTrigger(hour=11, minute=0)
    router.app.state._scheduler.add_job(job, trigger, id="loans_harvest_daily", replace_existing=True)

async def _maybe_async(fn, *a, **kw):
    ret = fn(*a, **kw)
    if hasattr(ret, "__await__"):
        return await ret
    return ret


⸻

5) 贷款业务（DSR 计算 + 比价篮 + 比价页）

accounting_app/routers/loans_business.py

# accounting_app/routers/loans_business.py
from typing import Dict, Any, Optional
from uuid import uuid4
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse, JSONResponse
import math
import os
import json
import http.client

router = APIRouter(prefix="/loans", tags=["Loans Business"])

# 简易内存比价篮；生产可替换 Redis
BASKETS: Dict[str, Dict[str, Any]] = {}

def get_basket_id(req: Request) -> str:
    bid = req.cookies.get("basket_id")
    if not bid:
        bid = str(uuid4())
    return bid

def annuity_monthly(amount: float, annual_rate_pct: float, years: int) -> float:
    r = (annual_rate_pct/100.0)/12.0
    n = years*12
    if r == 0:
        return amount/n
    return amount * (r * (1 + r) ** n) / ((1 + r) ** n - 1)

@router.post("/dsr/calc")
async def dsr_calc(payload: Dict[str, Any]):
    amount = float(payload.get("amount", 0))
    rate = float(payload.get("rate", 0))
    tenure = int(payload.get("tenure_years", 30))
    income = float(payload.get("income", 0))
    commitments = float(payload.get("commitments", 0))
    monthly = annuity_monthly(amount, rate, tenure)
    dsr = (monthly + commitments) / income if income > 0 else 1.0
    verdict = "PASS" if dsr < 0.6 else ("BORDERLINE" if dsr < 0.7 else "HIGH")
    return {"monthly": monthly, "dsr_pct": dsr, "verdict": verdict}

@router.post("/compare/add")
async def compare_add(req: Request, payload: Dict[str, Any]):
    bid = get_basket_id(req)
    item = payload.get("item", {})
    BASKETS.setdefault(bid, {"items": []})
    BASKETS[bid]["items"].append(item)
    resp = JSONResponse({"ok": True, "count": len(BASKETS[bid]["items"]), "basket_id": bid})
    resp.set_cookie("basket_id", bid, max_age=86400*7)
    return resp

@router.post("/compare/remove")
async def compare_remove(req: Request, payload: Dict[str, Any]):
    bid = get_basket_id(req)
    idx = int(payload.get("index", -1))
    if bid in BASKETS and 0 <= idx < len(BASKETS[bid]["items"]):
        BASKETS[bid]["items"].pop(idx)
    return {"ok": True, "count": len(BASKETS.get(bid, {}).get("items", []))}

@router.get("/compare/list/{basket_id}")
async def compare_list(basket_id: str):
    return BASKETS.get(basket_id, {"items": []})

@router.get("/compare/page", response_class=HTMLResponse)
async def compare_page(req: Request, use_ctos: Optional[int] = 0, consent_id: Optional[str] = None, key: Optional[str] = None):
    bid = get_basket_id(req)
    items = BASKETS.setdefault(bid, {"items":[]})["items"]

    # 若来自 CTOS 表单，尝试读取最新指标辅助试算
    ctos_hint = ""
    if use_ctos and consent_id:
        try:
            conn = http.client.HTTPConnection("127.0.0.1", int(os.getenv("PORT", "5000")), timeout=2)
            path = f"/ctos/metrics/{consent_id}"
            conn.request("GET", path)
            r = conn.getresponse()
            if r.status == 200:
                meta = json.loads(r.read().decode())
                ctos_hint = f"CTOS 最新 DSR: {(meta.get('dsr',0)*100):.1f}% · DSRC: {(meta.get('dsrc',0)*100):.1f}% · Commitments: RM {meta.get('commitments',0):,.2f}"
        except Exception:
            pass

    return HTMLResponse(f"""<!doctype html>
<html><head>
<meta charset="utf-8"/>
<title>Compare Basket</title>
<style>
:root {{ --primary:#FF007F; --bg:#1a1323; --card:#322446; --text:#fff; --muted:#999; --line:#888; }}
body {{ margin:0; font-family:ui-sans-serif,system-ui; background:linear-gradient(180deg,#1a1323,#0f0a14); color:var(--text); }}
.container {{ max-width:1000px; margin:40px auto; padding:0 16px; }}
.card {{ background:linear-gradient(180deg,#322446,#281a3a); border-radius:14px; padding:16px; border:1px solid #3a2a4f; box-shadow:0 8px 24px #0003; }}
.btn {{ background:var(--primary); border:none; color:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; }}
input,select {{ background:#1a1323; color:#fff; border:1px solid #403150; padding:8px 10px; border-radius:10px; }}
table {{ width:100%; border-collapse:collapse; }}
th,td {{ border-bottom:1px dashed #403150; padding:10px; text-align:left; }}
.hint {{ font-size:12px; opacity:.85; }}
</style></head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h2>Compare Basket</h2>
    <a href="/loans/page" class="btn" style="text-decoration:none">← Back to Loans</a>
  </div>

  <div class="card" style="margin-bottom:16px;">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <div class="hint">{ctos_hint}</div>
      <div style="margin-left:auto"></div>
      <label>Income RM <input id="income" type="number" value="8000" style="width:120px"/></label>
      <label>Commitments RM <input id="commit" type="number" value="1500" style="width:120px"/></label>
      <label>Tenure <select id="tenure"><option>30</option><option>25</option><option>20</option></select> years</label>
      <button class="btn" onclick="recalc()">Recalculate</button>
    </div>
  </div>

  <div class="card">
    <table id="tb"><thead>
      <tr><th>#</th><th>Product</th><th>Bank</th><th>Type</th><th>Rate</th><th>Monthly (RM)</th><th>DSR</th><th></th></tr>
    </thead><tbody></tbody></table>
  </div>
</div>
<script>
const basketId = "{bid}";
const fmt = n=> Number(n||0).toFixed(2);
async function load(){{
  const res = await fetch('/loans/compare/list/{bid}');
  const js = await res.json();
  window._items = js.items||[];
  render();
}}
async function recalc(){{
  const income = Number(document.getElementById('income').value||0);
  const commit = Number(document.getElementById('commit').value||0);
  const tenure = Number(document.getElementById('tenure').value||30);
  const tbody = document.querySelector('#tb tbody');
  tbody.querySelectorAll('tr').forEach(tr=>{{
    const rate = Number(tr.getAttribute('data-rate')||0);
    const amt = Number(tr.getAttribute('data-amount')||400000);
    fetch('/loans/dsr/calc', {{
      method:'POST', headers:{{'Content-Type':'application/json'}},
      body: JSON.stringify({{ amount: amt, rate: rate, tenure_years: tenure, income: income, commitments: commit }})
    }}).then(r=>r.json()).then(js=>{{
      tr.querySelector('[data-monthly]').innerText = fmt(js.monthly);
      tr.querySelector('[data-dsr]').innerText = (js.dsr_pct*100).toFixed(1)+'% '+js.verdict;
    }});
  }});
}}
function render(){{
  const tbody = document.querySelector('#tb tbody');
  tbody.innerHTML = '';
  (window._items||[]).forEach((it,idx)=>{{
    const tr = document.createElement('tr');
    tr.setAttribute('data-rate', it.rate||0);
    tr.setAttribute('data-amount', 400000); // 默认演示额度，可改
    tr.innerHTML = `
      <td>${{idx+1}}</td>
      <td>${{it.product||''}}</td>
      <td>${{it.source||''}}</td>
      <td>${{it.type||''}}</td>
      <td>${{it.rate??''}}%</td>
      <td data-monthly>-</td>
      <td data-dsr>-</td>
      <td><button class="btn" onclick="rm(${idx})">Remove</button></td>`;
    tbody.appendChild(tr);
  }});
  recalc();
}}
async function rm(i){{
  await fetch('/loans/compare/remove', {{method:'POST', headers:{{'Content-Type':'application/json'}}, body: JSON.stringify({{index:i}})}});
  load();
}}
load();
</script>
</body></html>
""")

# 给 Loans 与 CTOS 联动用：从 CTOS 拉最新 DSR/DSRC（由 ctos 路由提供）
@router.get("/dsr/from-ctos")
async def dsr_from_ctos(consent_id: str):
    # 由 /ctos/metrics/{consent_id} 提供数据，这里只是转发示例
    import http.client, json, os
    try:
        conn = http.client.HTTPConnection("127.0.0.1", int(os.getenv("PORT","5000")), timeout=2)
        conn.request("GET", f"/ctos/metrics/{consent_id}")
        r = conn.getresponse()
        if r.status == 200:
            meta = json.loads(r.read().decode())
            return meta
    except Exception:
        pass
    return {"dsr": None, "dsrc": None, "commitments": None, "monthly_income": None}


⸻

6) CTOS 表单 + 上传 + 队列 + 回调（可人工/可直连）

accounting_app/routers/ctos.py

# accounting_app/routers/ctos.py
import os
import uuid
import datetime as dt
from typing import Optional, Dict, Any

from fastapi import APIRouter, UploadFile, File, Form, Request, HTTPException
from fastapi.responses import HTMLResponse, JSONResponse, RedirectResponse, StreamingResponse
from sqlalchemy import create_engine, Column, String, Integer, DateTime, LargeBinary, Text, select
from sqlalchemy.orm import declarative_base, sessionmaker

from accounting_app.services.crypto_box import encrypt, decrypt
from accounting_app.services.ctos_client import is_enabled, submit_consent, fetch_metrics_from_report

router = APIRouter(prefix="/ctos", tags=["CTOS"])

DB_PATH = os.getenv("CTOS_DB_PATH", "/home/runner/ctos.db")
engine = create_engine(f"sqlite:///{DB_PATH}", future=True, connect_args={"check_same_thread": False})
SessionLocal = sessionmaker(bind=engine, autoflush=False, autocommit=False, future=True)
Base = declarative_base()

UPLOAD_DIR = os.getenv("CTOS_UPLOAD_DIR", "/home/runner/ctos_uploads")
os.makedirs(UPLOAD_DIR, exist_ok=True)

class Consent(Base):
    __tablename__ = "ctos_consent"
    id = Column(String(64), primary_key=True)
    created_at = Column(DateTime, index=True)
    name = Column(String(120))
    email_enc = Column(Text)
    phone_enc = Column(Text)
    ic_enc = Column(Text)
    company_ssm_enc = Column(Text)
    status = Column(String(32))     # queued / submitted / ready / error
    report_path = Column(Text)      # 存储PDF路径
    dsr = Column(String(32))        # 文本存储，简单化
    dsrc = Column(String(32))
    commitments = Column(String(32))
    monthly_income = Column(String(32))

Base.metadata.create_all(engine)

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def _require_key(key: Optional[str]):
    portal_key = os.getenv("PORTAL_KEY", "")
    if not portal_key or key != portal_key:
        raise HTTPException(404, "Not Found")

@router.get("/page", response_class=HTMLResponse)
def ctos_page(key: Optional[str] = None):
    _require_key(key)
    return HTMLResponse(f"""<!doctype html>
<html><head>
<meta charset="utf-8"/>
<title>CTOS Consent</title>
<style>
:root {{ --primary:#FF007F; --bg:#1a1323; --card:#322446; --text:#fff; --muted:#999; --line:#888; }}
body {{ margin:0; font-family:ui-sans-serif,system-ui; background:linear-gradient(180deg,#1a1323,#0f0a14); color:var(--text); }}
.container {{ max-width:760px; margin:40px auto; padding:0 16px; }}
.card {{ background:linear-gradient(180deg,#322446,#281a3a); border-radius:14px; padding:16px; border:1px solid #3a2a4f; box-shadow:0 8px 24px #0003; }}
input {{ background:#1a1323; color:#fff; border:1px solid #403150; padding:8px 10px; border-radius:10px; width:100%; }}
.btn {{ background:var(--primary); border:none; color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; }}
label {{ display:block; margin:10px 0 6px; color:#ddd; }}
</style></head>
<body>
<div class="container">
  <h2>CTOS 授权与资料上传</h2>
  <div class="card">
    <form action="/ctos/submit" method="post" enctype="multipart/form-data">
      <input type="hidden" name="key" value="{key}"/>
      <label>姓名 Name</label>
      <input name="name" required/>
      <div style="display:flex; gap:10px;">
        <div style="flex:1">
          <label>Email</label>
          <input name="email" required/>
        </div>
        <div style="flex:1">
          <label>Phone</label>
          <input name="phone" required/>
        </div>
      </div>
      <label>IC（NRIC）</label>
      <input name="ic" required/>
      <label>公司 SSM No.（可选）</label>
      <input name="ssm"/>
      <label>上传 IC/公司文件（PDF/JPG/PNG）</label>
      <input type="file" name="doc" accept=".pdf,.jpg,.jpeg,.png" required/>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn" type="submit">提交并跳转 Loans 比价</button>
      </div>
    </form>
  </div>
</div>
</body></html>
""")

@router.post("/submit")
async def ctos_submit(
    key: str = Form(...),
    name: str = Form(...),
    email: str = Form(...),
    phone: str = Form(...),
    ic: str = Form(...),
    ssm: Optional[str] = Form(None),
    doc: UploadFile = File(...)
):
    _require_key(key)
    if doc.content_type not in ("application/pdf", "image/jpeg", "image/png"):
        raise HTTPException(400, "Unsupported file type")

    cid = str(uuid.uuid4())
    now = dt.datetime.utcnow()
    db = SessionLocal()
    try:
        consent = Consent(
            id=cid,
            created_at=now,
            name=name,
            email_enc=encrypt(email),
            phone_enc=encrypt(phone),
            ic_enc=encrypt(ic),
            company_ssm_enc=encrypt(ssm or ""),
            status="queued",
            report_path="",
            dsr="",
            dsrc="",
            commitments="",
            monthly_income=""
        )
        db.add(consent)
        db.commit()

        # 保存上传文件
        ext = ".pdf" if doc.content_type == "application/pdf" else (".jpg" if doc.content_type=="image/jpeg" else ".png")
        save_path = os.path.join(UPLOAD_DIR, f"{cid}{ext}")
        with open(save_path, "wb") as f:
            f.write(await doc.read())

        # 直连或人工队列
        meta = submit_consent({
            "id": cid, "name": name, "email": email, "phone": phone, "ic": ic, "ssm": ssm, "doc_path": save_path
        })

        consent.status = "submitted" if meta.get("status") in ("submitted","queued") else "queued"
        db.commit()

        # 提交后**自动跳转**到 Loans 比价页
        url = f"/loans/compare/page?use_ctos=1&consent_id={cid}&key={key}"
        return RedirectResponse(url, status_code=302)
    finally:
        db.close()

@router.get("/admin", response_class=HTMLResponse)
def admin_page(key: Optional[str] = None, ak: Optional[str] = None):
    _require_key(key)
    admin_key = os.getenv("ADMIN_KEY", "")
    if not admin_key or ak != admin_key:
        raise HTTPException(404, "Not Found")

    return HTMLResponse(f"""<!doctype html>
<html><head><meta charset="utf-8"/><title>CTOS Admin</title>
<style>
:root {{ --primary:#FF007F; --bg:#1a1323; --card:#322446; --text:#fff; --muted:#999; --line:#888; }}
body {{ margin:0; font-family:ui-sans-serif,system-ui; background:linear-gradient(180deg,#1a1323,#0f0a14); color:var(--text); }}
.container {{ max-width:900px; margin:40px auto; padding:0 16px; }}
.card {{ background:linear-gradient(180deg,#322446,#281a3a); border-radius:14px; padding:16px; border:1px solid #3a2a4f; }}
table {{ width:100%; border-collapse:collapse; }}
th,td {{ border-bottom:1px dashed #403150; padding:10px; text-align:left; }}
.btn {{ background:var(--primary); border:none; color:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; }}
</style></head>
<body>
<div class="container">
  <h2>CTOS 队列（管理员）</h2>
  <div class="card">
    <table id="tb"><thead>
      <tr><th>ID</th><th>Name</th><th>Status</th><th>DSR</th><th>Action</th></tr>
    </thead><tbody></tbody></table>
  </div>
</div>
<script>
async function load(){{
  const res = await fetch('/ctos/list?key={key}&ak={ak}');
  const js = await res.json();
  const tb = document.querySelector('#tb tbody'); tb.innerHTML='';
  js.items.forEach(it=>{{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${{it.id}}</td><td>${{it.name}}</td><td>${{it.status}}</td><td>${{it.dsr||'-'}}</td>
    <td><button class="btn" onclick="upload('${{it.id}}')">Attach Report</button></td>`;
    tb.appendChild(tr);
  }});
}}
function upload(id){{
  const form = document.createElement('form');
  form.method='post'; form.enctype='multipart/form-data'; form.action='/ctos/attach-report';
  form.innerHTML = `<input name="consent_id" value="${{id}}"/><input name="ak" value="{ak}"/><input type="file" name="pdf" accept=".pdf"/><button>Upload</button>`;
  document.body.appendChild(form); form.querySelector('input[type=file]').click();
}}
load();
</script>
</body></html>
""")

@router.get("/list")
def list_items(key: Optional[str] = None, ak: Optional[str] = None):
    _require_key(key)
    if os.getenv("ADMIN_KEY", "") != (ak or ""):
        raise HTTPException(404, "Not Found")
    db = SessionLocal()
    try:
        rows = db.execute(select(Consent).order_by(Consent.created_at.desc())).scalars().all()
        out = []
        for c in rows:
            out.append({
                "id": c.id, "name": c.name, "status": c.status,
                "dsr": c.dsr, "dsrc": c.dsrc, "created_at": (c.created_at or dt.datetime.utcnow()).isoformat()
            })
        return {"items": out}
    finally:
        db.close()

@router.post("/attach-report")
async def attach_report(consent_id: str = Form(...), ak: str = Form(...), pdf: UploadFile = File(...)):
    if os.getenv("ADMIN_KEY", "") != ak:
        raise HTTPException(404, "Not Found")
    if pdf.content_type != "application/pdf":
        raise HTTPException(400, "PDF only")

    db = SessionLocal()
    try:
        c = db.get(Consent, consent_id)
        if not c:
            raise HTTPException(404, "not found")
        save_path = os.path.join(UPLOAD_DIR, f"{consent_id}-report.pdf")
        with open(save_path, "wb") as f:
            f.write(await pdf.read())

        c.report_path = save_path
        c.status = "ready"

        # 从报告提取指标（示例）
        with open(save_path, "rb") as f:
            meta = fetch_metrics_from_report(f.read())
        c.dsr = str(meta.get("dsr", ""))
        c.dsrc = str(meta.get("dsrc", ""))
        c.commitments = str(meta.get("commitments", ""))
        c.monthly_income = str(meta.get("monthly_income", ""))
        db.commit()
        return {"ok": True}
    finally:
        db.close()

@router.get("/metrics/{consent_id}")
def metrics(consent_id: str):
    db = SessionLocal()
    try:
        c = db.get(Consent, consent_id)
        if not c:
            raise HTTPException(404, "not found")
        def _f(v: str) -> Optional[float]:
            try:
                return float(v)
            except Exception:
                return None
        return {
            "consent_id": consent_id,
            "dsr": _f(c.dsr),
            "dsrc": _f(c.dsrc),
            "commitments": _f(c.commitments),
            "monthly_income": _f(c.monthly_income)
        }
    finally:
        db.close()

@router.get("/download/{consent_id}")
def download_report(consent_id: str):
    db = SessionLocal()
    try:
        c = db.get(Consent, consent_id)
        if not c or not c.report_path or not os.path.exists(c.report_path):
            raise HTTPException(404, "not found")
        return StreamingResponse(
            open(c.report_path, "rb"),
            media_type="application/pdf",
            headers={"Content-Disposition": f'attachment; filename="{consent_id}-report.pdf"'}
        )
    finally:
        db.close()


⸻

7) （可选）Credit Cards 三步漏斗 UI（轻量演示版）

accounting_app/routers/ui_cards.py

# accounting_app/routers/ui_cards.py
from fastapi import APIRouter, Query
from fastapi.responses import HTMLResponse

router = APIRouter(prefix="/ui", tags=["UI Demo"])

@router.get("/cards", response_class=HTMLResponse)
def cards(step: int = Query(1, ge=1, le=3), lang: str = "zh"):
    # 纯前端切换，演示“上一步/下一步”型漏斗
    label = {
        "zh": ["上传账单", "收据匹配", "月结报告"],
        "en": ["Upload Statements", "Receipt Matching", "Monthly Report"]
    }.get(lang, ["Step1","Step2","Step3"])
    return HTMLResponse(f"""<!doctype html>
<html><head><meta charset="utf-8"/><title>Cards Funnel</title>
<style>
:root {{ --primary:#FF007F; --bg:#1a1323; --card:#322446; --text:#fff; --muted:#999; --line:#888; }}
body {{ margin:0; font-family:ui-sans-serif; background:linear-gradient(180deg,#1a1323,#0f0a14); color:var(--text); }}
.container {{ max-width:1000px; margin:40px auto; padding:0 16px; display:grid; grid-template-columns:220px 1fr 240px; gap:12px; }}
.panel {{ background:linear-gradient(180deg,#322446,#281a3a); border-radius:14px; padding:16px; border:1px solid #3a2a4f; }}
.btn {{ background:var(--primary); border:none; color:#fff; padding:8px 12px; border-radius:12px; cursor:pointer; text-decoration:none; display:inline-block; }}
.step {{ padding:10px 12px; border-radius:10px; margin-bottom:8px; border:1px solid #403150; }}
.step.active {{ border-color:#FF007F; box-shadow:0 0 0 2px #ff007f44 inset; }}
</style></head>
<body>
<div class="container">
  <div class="panel">
    <div class="step {'active' if step==1 else ''}">1. {label[0]}</div>
    <div class="step {'active' if step==2 else ''}">2. {label[1]}</div>
    <div class="step {'active' if step==3 else ''}">3. {label[2]}</div>
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
      <a class="btn" href="/ui/cards?step={max(1,step-1)}&lang={lang}">上一步</a>
      <a class="btn" href="/ui/cards?step={min(3,step+1)}&lang={lang}">下一步</a>
    </div>
  </div>
  <div class="panel">
    <h3>Work Area · Step {step}</h3>
    <p style="opacity:.85">这里展示与该步骤相关的主要操作入口（上传、匹配、导出）。</p>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <a class="btn" href="/portal">上传账单</a>
      <a class="btn" href="/portal/history">收据/记录</a>
      <a class="btn" href="/files/result/txt/DEMO">导出 TXT</a>
    </div>
  </div>
  <div class="panel">
    <h3>收益 · Value</h3>
    <ul>
      <li>节省时间 67%</li>
      <li>数据准确 100%</li>
      <li>一键导出（PDF/Excel/CSV）</li>
    </ul>
  </div>
</div>
</body></html>
""")


⸻

8) 在主程序挂载路由

在你的 accounting_app/main.py 新增这些行（不要删你已有的）：

from accounting_app.routers import loans_updates, loans_business, ctos
# 可选
from accounting_app.routers import ui_cards

app.include_router(loans_updates.router)
app.include_router(loans_business.router)
app.include_router(ctos.router)
# 可选
app.include_router(ui_cards.router)


⸻

9) 环境变量（Replit Secrets）——再次确认

LOANS_REFRESH_KEY=（强随机，用于人工刷新）
MIN_REFRESH_HOURS=20
SHOW_REFRESH_BUTTON=0

FERNET_KEY=（你已生成）
PORTAL_KEY=（客户访问 CTOS 页面用）
ADMIN_KEY=（管理端口令）

# 可选：
PERPLEXITY_API_KEY=
PERPLEXITY_MODEL=llama-3.1-sonar-large-128k-online
CTOS_API_ENABLED=0


⸻

10) 快速验收（逐条复制测）
	•	资讯页（只读）：GET /loans/page
	•	上次更新时间：GET /loans/updates/last
	•	列表数据：GET /loans/updates?limit=5
	•	导出 CSV：GET /loans/updates/export.csv
	•	手动刷新（带密钥）：POST /loans/updates/refresh（Header: X-Refresh-Key: …）
	•	DSR 计算：POST /loans/dsr/calc

{"income":8000,"commitments":1500,"amount":400000,"rate":3.75,"tenure_years":30}


	•	比价页：GET /loans/compare/page
	•	CTOS 表单（客户页）：GET /ctos/page?key=你的PORTAL_KEY → 提交后会自动跳转到比价页
	•	CTOS 管理页：GET /ctos/admin?key=你的PORTAL_KEY&ak=你的ADMIN_KEY
	•	管理上传报告（Attach Report）按钮可用；成功后
GET /ctos/metrics/{consent_id} 应返回 {dsr,dsrc,commitments,monthly_income}

⸻

你只需要把以上文件逐个创建/覆盖后，按第 8 步挂载路由，重启即可。
有需要，我再给你把 /loans/page 顶部插一个“今日简报条”的小组件（只读，不触发刷新），也是一段可直接贴的 HTML。