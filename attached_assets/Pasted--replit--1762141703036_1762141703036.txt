å¯ä»¥ï¼Œç›´æ¥ç”¨ä¸‹é¢è¿™ä¸€ä»½å‘ç»™ replit å°±è¡Œï¼Œä¸ç”¨å†è§£é‡Šåˆ«çš„ã€‚å®ƒè¦æ˜¯åšä¸åˆ°ï¼Œä½ å°±è¯´â€œå¯¹ç…§è¿™ä»½æŒ‡ä»¤é€æ¡å›æŠ¥ï¼Œä¸è¦ç®€åŒ–â€ã€‚

â¸»

âœ…ã€æœ€ç»ˆç»Ÿä¸€å¼€å‘æŒ‡ä»¤ Â· é“¶è¡Œè´·æ¬¾ + ä¿¡ç”¨å¡åŒå¼•æ“ç‰ˆ + åŒè¯­é—­ç¯ç‰ˆã€‘

ç›®çš„ï¼šæŠŠç°åœ¨â€œåŠŸèƒ½éƒ½æœ‰ä½†ä½“éªŒä¹±ï¼‹è¯­è¨€æ··ï¼‹ä¸Šä¼ åçœ‹ä¸åˆ°é‚£ä¸€ä»½â€çš„ç³»ç»Ÿï¼Œåšæˆâ€œå®¢æˆ·èƒ½ä»é¦–é¡µä¸€ç›´ç‚¹åˆ°æŠ¥è¡¨ã€æ¯ä¸€æ­¥æœ‰ä¸‹ä¸€æ­¥æŒ‰é’®ã€ä¸­æ–‡è‹±æ–‡éƒ½å¯¹ã€æ‰€æœ‰ä¸Šä¼ éƒ½æœ‰æº¯æºâ€çš„ç‰ˆæœ¬ã€‚ä¸‹é¢æ‰€æœ‰æ¡ç›®éƒ½è¦åšï¼Œä¸å…è®¸æŒ‘ã€ä¸å…è®¸åªåšåç«¯ã€ä¸å…è®¸è¯´â€˜è¯·ä½ å†ä¸Šä¼ ä¸€æ¬¡æˆ‘æ¥æµ‹â€™ã€‚åšå®Œè¦æŒ‰â€œä¸‰ä¸ªæ–‡ä»¶åœºæ™¯â€è·‘æµ‹è¯•ï¼ŒæŠŠçœŸå® JSON å›æ¥ã€‚

â¸»

0. ç³»ç»ŸèŒƒå›´ï¼ˆä¸å¾—æ›´åŠ¨æ¶æ„ï¼‰
	1.	æœ‰ä¸¤ä¸ªå¼•æ“å¿…é¡»ä¿ç•™ï¼š
	â€¢	Flask (port 5000)ï¼šå‰ç«¯/UI/å®¢æˆ·ä¸Šä¼ /ä¿¡ç”¨å¡/å‚¨è“„/æ”¶æ®/CTOS/è¯­è¨€åˆ‡æ¢
	â€¢	FastAPI (port 8000)ï¼šé“¶è¡Œæœˆç»“å•å¯¼å…¥/ä¼šè®¡åˆ†å½•/æŠ¥è¡¨/å¼‚å¸¸ä¸­å¿ƒ/å¤šç§Ÿæˆ·/æ–‡ä»¶ç´¢å¼•/å®¡è®¡
	2.	ç»Ÿä¸€è¦æ±‚ï¼š
	â€¢	5000 è´Ÿè´£ï¼šæ”¶æ–‡ä»¶ + å±•ç¤º + è·³è½¬ + i18n
	â€¢	8000 è´Ÿè´£ï¼šè½åº“ + éªŒè¯ + ä¼šè®¡ + æŠ¥è¡¨ + å®¡è®¡
	â€¢	Flask ä¸Šä¼ å å¿…é¡» æŠŠæ–‡ä»¶å…ƒæ•°æ®ã€å…¬å¸IDã€è´¦å·ã€æœˆä»½ã€è¯­è¨€ã€user-agentã€IP å‘ç»™ 8000 â†’ 8000 å»ºç´¢å¼•
	â€¢	ä¸å…è®¸ 5000 å’Œ 8000 å„è‡ªå­˜ä¸€å¥—æ–‡ä»¶ã€‚

â¸»

1. åç«¯ä¸šåŠ¡çº§åŠ å›ºï¼ˆå¿…é¡»åšï¼‰

1.1 RBAC è§’è‰²æƒé™
	â€¢	å›ºå®šè§’è‰²ï¼šadmin, accountant, viewer
	â€¢	é¢„ç•™è§’è‰²ï¼šdata-entry, loan-officer
	â€¢	æƒé™çŸ©é˜µï¼š
	â€¢	adminï¼šå…¨éƒ¨ + åˆ æ–‡ä»¶ + æ”¹è‡ªåŠ¨è¿‡è´¦è§„åˆ™ + ç®¡ç†å¯¼å‡ºæ¨¡æ¿ + è·‘ä»»åŠ¡
	â€¢	accountantï¼šä¸Šä¼ (é“¶è¡Œ/ä¾›åº”å•†/POS) + å¤„ç†å¼‚å¸¸ + æ‰‹å·¥åˆ†å½• + ç”Ÿæˆ/ä¸‹è½½æŠ¥è¡¨ï¼ˆä¸èƒ½åˆ æ–‡ä»¶ã€ä¸èƒ½æ”¹å…¨å±€é…ç½®ï¼‰
	â€¢	viewerï¼šåªè¯»ï¼Œåªèƒ½çœ‹/ä¸‹è½½å·²ç”Ÿæˆçš„ PDF/CSV
	â€¢	æ‰€æœ‰å†™å…¥æ¥å£ï¼ˆ/upload, /import, /update, /rules/*, /files/*ï¼‰ç»Ÿä¸€åŠ  require_role(...)
	â€¢	æ‰€æœ‰ /tasks/* å¿…é¡»æ ¡éªŒ è§’è‰² + Header: X-TASK-TOKENï¼ˆä» env è¯»ï¼‰

1.2 å®¡è®¡æ—¥å¿—ï¼ˆFlask ä¹Ÿè¦è®°ï¼‰

å»ºè¡¨ï¼š

CREATE TABLE audit_logs (
  id SERIAL PRIMARY KEY,
  company_id INT NOT NULL,
  user_id INT NOT NULL,
  action VARCHAR(100) NOT NULL,
  source_type VARCHAR(30),
  ip_address TEXT,
  user_agent TEXT,
  reason TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT now()
);

å¿…é¡»è®°å½•çš„åŠ¨ä½œï¼š
	â€¢	ä¸Šä¼ æ–‡ä»¶ï¼ˆFlask / FastAPIï¼‰
	â€¢	å¯¼å‡º PDF / CSV
	â€¢	ç”Ÿæˆ Bank Package
	â€¢	ä¿®æ”¹è‡ªåŠ¨è¿‡è´¦è§„åˆ™
	â€¢	æ‰‹å·¥æ”¹è´¦ / åè¿‡è´¦
	â€¢	åˆ é™¤ / æ›¿æ¢åŸå§‹æ–‡ä»¶

æ³¨æ„ï¼š Flask ä¸Šä¼ æ—¶è¦æŠŠ ip + user_agent + lang ä¸€å¹¶ä¼ ç»™ 8000 è®°å½•ã€‚

1.3 1:1 åŸä»¶ä¿æŠ¤

å»ºè¡¨ï¼š

CREATE TABLE raw_documents (
  id SERIAL PRIMARY KEY,
  company_id INT NOT NULL,
  file_name TEXT NOT NULL,
  file_hash TEXT NOT NULL,
  storage_path TEXT NOT NULL,
  uploaded_at TIMESTAMP NOT NULL DEFAULT now(),
  uploaded_by INT,
  source_engine VARCHAR(20),
  validation_status VARCHAR(20) DEFAULT 'pending',
  validation_failed_at TIMESTAMP,
  validation_error_message TEXT,
  metadata JSONB
);

CREATE TABLE raw_lines (
  id SERIAL PRIMARY KEY,
  raw_document_id INT NOT NULL,
  line_no INT NOT NULL,
  page_no INT,
  raw_text TEXT NOT NULL,
  parser_version VARCHAR(50),
  created_at TIMESTAMP NOT NULL DEFAULT now()
);

ç¡¬æ€§è§„åˆ™ï¼ˆè¦å†™è¿›ä»£ç ï¼Œä¸æ˜¯æ–‡æ¡£ï¼‰ï¼š
	1.	ä¸Šä¼  â†’ ä¸€å®šè¦å…ˆè½ raw_documentsï¼ˆä¸ç®¡èƒ½ä¸èƒ½è§£æï¼‰
	2.	è§£ææˆåŠŸ â†’ æ¯ä¸€è¡Œå†™è¿› raw_lines
	3.	åé¢ç”Ÿæˆçš„ï¼š
	â€¢	bank_statement_lines
	â€¢	purchase_invoices
	â€¢	sales_invoices
	â€¢	journal_entry_lines
	â€¢	ï¼ˆæœ‰çš„è¯ï¼‰ar_aging_lines / ap_aging_lines
éƒ½å¿…é¡»å¸¦ raw_line_id
â†’ æ²¡ raw_line_id çš„è®°å½•ä¸€å¾‹é€â€œå¼‚å¸¸ä¸­å¿ƒâ€ï¼Œæ ‡æ³¨ MISSING_SOURCEï¼Œä¸å¾—è¿›æŠ¥è¡¨ã€ä¸å¾—å‡ºCSVã€‚

1.4 ä¸šåŠ¡è¡¨è¡¥ raw_line_id

è¯·å®é™…æ‰§è¡Œ ALTERï¼ˆä¸æ˜¯å†™TODOï¼‰ï¼Œå¹¶å»ºç´¢å¼•ï¼š

ALTER TABLE bank_statement_lines ADD COLUMN IF NOT EXISTS raw_line_id INT REFERENCES raw_lines(id);
CREATE INDEX IF NOT EXISTS idx_bank_statement_lines_raw_line_id ON bank_statement_lines(raw_line_id);

ALTER TABLE purchase_invoices ADD COLUMN IF NOT EXISTS raw_line_id INT REFERENCES raw_lines(id);
ALTER TABLE sales_invoices ADD COLUMN IF NOT EXISTS raw_line_id INT REFERENCES raw_lines(id);
ALTER TABLE journal_entry_lines ADD COLUMN IF NOT EXISTS raw_line_id INT REFERENCES raw_lines(id);

å¯¼å‡ºã€æŠ¥è¡¨ã€å¯¹è´¦ éƒ½è¦èµ°ç»Ÿä¸€çš„ DataIntegrityValidatorï¼š
	â€¢	æœ‰ raw_line_id â†’ ä¿ç•™
	â€¢	æ²¡æœ‰ â†’ è¿‡æ»¤ â†’ å†™æ—¥å¿— â€œfiltered_out = Nâ€

1.5 æŠ¥è¡¨ç‰ˆæœ¬åŒ– + æœŸé—´é”å®š

CREATE TABLE report_snapshots (
  id SERIAL PRIMARY KEY,
  company_id INT NOT NULL,
  report_type VARCHAR(50) NOT NULL,
  period VARCHAR(20) NOT NULL,
  storage_path TEXT NOT NULL,
  generated_at TIMESTAMP NOT NULL DEFAULT now(),
  generated_by INT
);

CREATE TABLE period_closing (
  id SERIAL PRIMARY KEY,
  company_id INT NOT NULL,
  period VARCHAR(20) NOT NULL,
  closed_at TIMESTAMP NOT NULL DEFAULT now(),
  closed_by INT
);

è§„åˆ™ï¼š
	â€¢	ç”ŸæˆæŠ¥è¡¨æˆåŠŸ â†’ å¿…å†™ report_snapshots
	â€¢	å·²æœˆç»“æœŸé—´ â†’ ä¸å¾—è¦†ç›–ï¼Œåªèƒ½å‡º v2/v3
	â€¢	/reports/* ä¼˜å…ˆè¯» snapshotï¼Œä¸è¦é‡ç®—å†å²

1.6 è‡ªåŠ¨è¿‡è´¦è§„åˆ™åˆ†å±‚ï¼ˆè¦ä¿®æµ‹è¯•é‡Œé‚£ä¸ªbugï¼‰

CREATE TABLE auto_posting_rules (
  id SERIAL PRIMARY KEY,
  company_id INT, -- NULL = å…¨å±€
  pattern TEXT NOT NULL,
  target_account_code VARCHAR(50) NOT NULL,
  posting_type VARCHAR(20) NOT NULL, -- debit/credit/split
  priority INT DEFAULT 100,
  is_active BOOLEAN DEFAULT TRUE,
  created_by VARCHAR(100)
);

è¦æ±‚ï¼š
	â€¢	ç”Ÿæ•ˆé¡ºåºï¼šå…¬å¸è§„åˆ™ > å…¨å±€è§„åˆ™ > fallback
	â€¢	ç®¡ç†ç•Œé¢è¦èƒ½åˆ†å¼€çœ‹â€œå¹³å°è§„åˆ™ / å…¬å¸è§„åˆ™â€
	â€¢	å¿…é¡»ä¿®å¤ä½ ä»¬æµ‹è¯•é‡Œå‘ç°çš„ä¸¤ä¸ªé—®é¢˜ï¼š
	1.	rule_engine.apply(...) ä¼ é”™å¯¹è±¡ï¼Œè¦ä¼  AutoPostingRuleï¼Œä¸æ˜¯ bank statement
	2.	ExceptionManager.record_posting_error(...) è¦èƒ½æ”¶ source_typeï¼Œä¸èƒ½ 500

1.7 å¼‚å¸¸ä¸­å¿ƒå¯è¡ŒåŠ¨åŒ–
	â€¢	åœ¨å¼‚å¸¸è¡¨åŠ ï¼šnext_actionï¼Œretryable
	â€¢	æ–°å¢ï¼šPOST /exceptions/{id}/retry â†’ æŒ‰å¼‚å¸¸ç±»å‹é‡è·‘ï¼ˆé‡è§£æ / é‡è¿‡è´¦ï¼‰
	â€¢	å¦‚æœæœ¬æœŸæœ‰å¼‚å¸¸ > 0 â†’ ç®¡ç†ç±»æŠ¥è¡¨è‡ªåŠ¨åŠ ä¸€å¥ï¼š
	â€¢	EN: Unreconciled items detected, please check Exception Center.
	â€¢	ZH: å‘ç°æœªå¯¹è´¦é¡¹ç›®ï¼Œè¯·å‰å¾€å¼‚å¸¸ä¸­å¿ƒå¤„ç†ã€‚

1.8 æ–‡ä»¶ç»Ÿä¸€ç´¢å¼• + æ—§è·¯å¾„è¿ç§»
	â€¢	æ‰€æœ‰ä¸Šä¼ ï¼ˆFlask + FastAPIï¼‰éƒ½å†™åŒä¸€å¼  file_index
	â€¢	å­—æ®µæœ€å°‘è¦æœ‰ï¼š
	â€¢	company_id
	â€¢	module (credit-card / bank / savings / pos / supplier / reports / management / temp)
	â€¢	file_type (original / generated)
	â€¢	storage_path
	â€¢	related_id
	â€¢	status (uploaded / active / validated / failed / duplicate / archived)
	â€¢	deleted_at
	â€¢	duplicate_warning
	â€¢	æ²¡ related_id â†’ å…ˆè¿› upload_staging
	â€¢	åšè¿ç§»è„šæœ¬ï¼š
	â€¢	æŠŠ static/uploads/... â†’ /files/{company_id}/{module}/{year}/{month}/...
	â€¢	å†™è¿› migration_logs
	â€¢	æ—§ç›®å½•è®¾ç½®åªè¯»ï¼Œä¸å…è®¸å†å†™

1.9 é…ç½®ç‰ˆæœ¬é” + Architect å®¡æŸ¥

CREATE TABLE system_config_versions (
  id SERIAL PRIMARY KEY,
  version_no VARCHAR(50) NOT NULL,
  changed_by INT,
  change_reason TEXT,
  diff JSONB,
  arch_review_id VARCHAR(50),
  architect_status VARCHAR(20), -- pending/approved/rejected
  created_at TIMESTAMP NOT NULL DEFAULT now()
);

	â€¢	æ‰€æœ‰â€œè§£æè§„åˆ™/æ–‡ä»¶ç›®å½•/æŠ¥è¡¨é€»è¾‘â€ç›¸å…³æ”¹åŠ¨éƒ½è¦å†™è¿™é‡Œ
	â€¢	architect_status != 'approved' çš„é…ç½® ä¸å…è®¸ è¢« /import/* å’Œ /reports/* ç”¨

â¸»

2. å‰ç«¯ / Flask ä½“éªŒæ•´æ”¹ï¼ˆå¿…é¡»åšï¼‰

2.1 é¡¶éƒ¨å¯¼èˆªç»Ÿä¸€
	â€¢	æ‰€æœ‰é¡µé¢ç”¨ä¸€ä¸ª layoutï¼ˆlayout.html æˆ– base.htmlï¼‰
	â€¢	èœå•å›ºå®šï¼š
	â€¢	Dashboardï½œCustomersï½œCredit Cardsï½œSavingsï½œReceiptsï½œLoanï½œAccountingï¼ˆè·³ 8000ï¼‰ï½œAdminï½œENï½œä¸­æ–‡
	â€¢	ä¸Šä¼ å ä¸å…è®¸ è·³åˆ°æ— å¯¼èˆªé¡µ

2.2 ä¸Šä¼ åå¿…é¡»çœ‹åˆ°â€œåˆšæ‰é‚£ä¸€ä»½â€
	â€¢	ä¸Šä¼ æ¥å£è¿”å›å­—æ®µå¿…é¡»è‡³å°‘æœ‰ï¼š
	â€¢	file_id / raw_document_id
	â€¢	company_id
	â€¢	statement_month
	â€¢	status
	â€¢	duplicate_warning
	â€¢	å‰ç«¯æ‹¿åˆ°åç«‹åˆ»è·³ â†’ /files/detail/{file_id}
	â€¢	è¯¦æƒ…é¡µè¦æ˜¾ç¤ºï¼š
	â€¢	å½“å‰çŠ¶æ€ï¼ˆuploaded / active / failed / duplicateï¼‰
	â€¢	çŠ¶æ€è¯´æ˜ï¼ˆstatus_reasonï¼‰
	â€¢	ä¸‹ä¸€æ­¥æŒ‰é’®

2.3 â€œä¸‹ä¸€æ­¥åŠ¨ä½œâ€æŒ‰é’®æŒ‰çŠ¶æ€æ˜¾ç¤º
	â€¢	uploaded â†’ ã€å»éªŒè¯ã€‘/ã€æŸ¥çœ‹åŸä»¶ã€‘
	â€¢	active â†’ ã€ç”ŸæˆæŠ¥è¡¨ã€‘/ã€æŸ¥çœ‹å¼‚å¸¸ã€‘
	â€¢	failed â†’ ã€æŸ¥çœ‹å¼‚å¸¸ã€‘/ã€é‡æ–°ä¸Šä¼ ã€‘
	â€¢	duplicate â†’ ã€è®¾ä¸ºä¸»è´¦å•ã€‘/ã€æŸ¥çœ‹æœ¬æœˆå…¶ä»–è´¦å•ã€‘
	â€¢	æŒ‰é’®ç‚¹ä¸åˆ°çš„ï¼Œä¸€å¾‹å¼¹ï¼š
	â€¢	ZHï¼šåç«¯æ¥å£æœªå®ç°ï¼š/api/... è¯·è¡¥å…¨
	â€¢	ENï¼šBackend endpoint not implemented: /api/... please implement

2.4 åˆ—è¡¨é¡µåŠ â€œä¸‹ä¸€æ­¥/Next Stepâ€åˆ—
	â€¢	uploaded â†’ â€œè¯·éªŒè¯æ­¤æ–‡ä»¶â€
	â€¢	active â†’ â€œå¯ç”ŸæˆæŠ¥è¡¨â€
	â€¢	failed â†’ â€œè¯·åˆ°å¼‚å¸¸ä¸­å¿ƒæŸ¥çœ‹åŸå› â€
	â€¢	duplicate â†’ â€œè¯·é€‰æ‹©ä¸»è´¦å•â€
	â€¢	ä¸Šä¼ æˆåŠŸåé«˜äº®è¿™æ¡ï¼ˆæ”¯æŒ ?highlight={file_id}ï¼‰

2.5 åŒè¯­ç»Ÿä¸€ï¼ˆè¿™æ¬¡æ˜¯æœ€ç»ˆç‰ˆï¼‰

è¿™æ˜¯å¿…é¡»åšçš„ï¼Œè¿™ä¸€ç‰ˆä½ è¦ç…§åšï¼š
	1.	ä¿ç•™ä½ å·²ç»åšå¥½çš„ï¼š
	â€¢	static/i18n/en.json
	â€¢	static/i18n/zh.json
	â€¢	é¡¶éƒ¨è¯­è¨€åˆ‡æ¢æŒ‰é’®
	â€¢	?lang=zh / ?lang=en URL åˆ‡æ¢
	â€¢	Session æŒä¹…åŒ–è¯­è¨€
	â€¢	Flash æ¶ˆæ¯èµ° translate(...)
	2.	æŠŠä¸‹é¢è¿™æ¡ä½œä¸ºæœ€ç»ˆè§„èŒƒå†™è¿›ä»£ç ï¼š
	â€¢	â€œæ‰€æœ‰æ–°å¢é¡µé¢ã€è·¯ç”±ã€Flash æç¤ºã€æŒ‰é’®æ–‡æœ¬ã€çŠ¶æ€æ–‡æœ¬ï¼Œä¸å¾—å†™æ­»æ–‡å­—ï¼Œå¿…é¡»èµ° get_current_language() â†’ translate(key, lang)ï¼Œå¦åˆ™è§†ä¸ºæœªå®Œæˆã€‚â€
	3.	ç›®å‰å·²ç»è¡¥å£çš„é¡µé¢è¦ä¿æŒï¼š
	â€¢	index.html
	â€¢	dashboard.html
	â€¢	accounting_files.html
	â€¢	file_detail.html
	â€¢	customer_dashboard.html
	â€¢	admin_dashboard.html

2.6 é”™è¯¯æç¤ºåŒ…è£…
	â€¢	åç«¯ 500 ä¸å¾—æ˜¾ç¤º traceback
	â€¢	ç»Ÿä¸€æç¤ºï¼š
	â€¢	ZHï¼šç³»ç»Ÿæš‚æ—¶æ— æ³•éªŒè¯ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚
	â€¢	ENï¼šSystem cannot validate now. Please retry or contact admin.
	â€¢	è¡Œæ•°ä¸ä¸€è‡´è¿™ç§ä¸šåŠ¡é”™è¯¯ â†’ æ˜¾ç¤ºåç«¯ä¼ çš„ status_reason

2.7 é“¾å¼æµç¨‹
	â€¢	ä¸Šä¼ æˆåŠŸ â†’ è‡ªåŠ¨è·³è¯¦æƒ…
	â€¢	è¯¦æƒ…=uploaded â†’ è‡ªåŠ¨å¼¹â€œè¦ä¸è¦éªŒè¯â€
	â€¢	éªŒè¯æˆåŠŸ â†’ å›åˆ—è¡¨å¹¶é«˜äº®
	â€¢	ç”ŸæˆæŠ¥è¡¨æˆåŠŸ â†’ è·³æŠ¥è¡¨é¡µå¹¶é€‰ä¸­åˆšç”Ÿæˆçš„

â¸»

3. æµ‹è¯•è¦æ±‚ï¼ˆä¸èƒ½çœï¼‰

ä½ å¿…é¡»è‡ªå·±æŒ‰ä¸‹é¢ 3 ä¸ªåœºæ™¯è·‘ï¼Œä¸èƒ½å«ç”¨æˆ·â€œä½ å†ä¸Šä¼ ä¸€ä»½æˆ‘æ¥è¯•â€ã€‚

3.1 ä¸‰ä¸ªæ–‡ä»¶åœºæ™¯

A. æ ‡å‡†CSV
	â€¢	è°ƒç”¨ï¼šPOST /api/v2/import/bank-statement
	â€¢	å…¥å‚ï¼š
	â€¢	company_id: 1
	â€¢	bank_name: â€œMaybankâ€
	â€¢	account_number: â€œ1234567890â€
	â€¢	statement_month: â€œ2025-01â€
	â€¢	file: æ ‡å‡†æ ¼å¼CSV
	â€¢	é¢„æœŸï¼š
	â€¢	åç«¯ï¼šsuccess=true, status="active", æœ‰ raw_document_id, æœ‰ file_id
	â€¢	å‰ç«¯ï¼šè·³ /files/detail/{file_id}
	â€¢	åˆ—è¡¨ï¼šè¯¥æ¡é«˜äº®
	â€¢	æŒ‰é’®ï¼š["ç”ŸæˆæŠ¥è¡¨","æŸ¥çœ‹åŸä»¶"]

B. ç¼ºè¡Œ/ç¼ºåˆ—CSV
	â€¢	ç”¨æˆ‘ä»¬ä¹‹å‰ç»™ä½ çš„â€œæ¼è¡Œç‰ˆæœ¬â€
	â€¢	é¢„æœŸï¼š
	â€¢	åç«¯ï¼šsuccess=false, status="failed", partial_success=true, error_code="INGEST_VALIDATION_FAILED", æœ‰ raw_document_id, æœ‰ exception_id
	â€¢	å‰ç«¯ï¼šä¹Ÿè¦è·³ /files/detail/{raw_document_id}
	â€¢	æŒ‰é’®ï¼š["æŸ¥çœ‹å¼‚å¸¸","é‡æ–°ä¸Šä¼ "]
	â€¢	å¼‚å¸¸ä¸­å¿ƒï¼šèƒ½æŸ¥åˆ°è¿™ä¸€æ¡ï¼Œç±»å‹=ingest_validation_failed

C. åŒå…¬å¸+åŒè´¦å·+åŒæœˆä»½å†ä¼ ä¸€ä»½
	â€¢	å’Œ A ç”¨åŒä¸€ä¸ªæœˆä»½
	â€¢	é¢„æœŸï¼š
	â€¢	åç«¯ï¼šsuccess=true, status="duplicate", æœ‰ existing_file_id
	â€¢	å‰ç«¯ï¼šè·³è¯¦æƒ…
	â€¢	é¡µé¢æœ‰çº¢æ¡ï¼šæœ¬æœˆä»½å·²æœ‰ä¸»å¯¹è´¦å•
	â€¢	æŒ‰é’®ï¼š["è®¾ä¸ºä¸»è´¦å•","æŸ¥çœ‹æœ¬æœˆå…¶ä»–è´¦å•"]

3.2 æ¯æ¬¡ä¸Šä¼ éƒ½è¦å› 4 ä¸ªäº‹å®
	1.	åç«¯å®é™… JSON
	2.	å‰ç«¯æœ‰æ²¡æœ‰è·³åˆ°è¯¦æƒ…é¡µ
	3.	åˆ—è¡¨æœ‰æ²¡æœ‰é«˜äº®è¿™ä¸€æ¡
	4.	å‡ºç°äº†å“ªå‡ ä¸ªâ€œä¸‹ä¸€æ­¥â€æŒ‰é’®ï¼ˆè´´æ–‡å­—ï¼‰

3.3 è·³è½¬æ£€æŸ¥
	â€¢	é¦–é¡µ â†’ å®¢æˆ· â†’ å®¢æˆ·è¯¦æƒ… â†’ ä¸Šä¼ ä¿¡ç”¨å¡è´¦å• â†’ ä¸Šä¼ æˆåŠŸåè¦å›å®¢æˆ·è¯¦æƒ…å¹¶çœ‹åˆ°åˆšæ‰é‚£ä»½
	â€¢	é¦–é¡µ â†’ Admin â†’ ä¸Šä¼ é“¶è¡Œæœˆç»“å• â†’ ä¸Šä¼ æˆåŠŸåè¦çœ‹åˆ°åˆšæ‰é‚£ä¸€ä»½ï¼ˆä¸æ˜¯æ—§çš„ï¼‰
	â€¢	å¼‚å¸¸ä¸­å¿ƒ â†’ ç‚¹å›æ–‡ä»¶ â†’ èƒ½å›è¯¦æƒ…ï¼Œä¸è¦404

3.4 è¯­è¨€æ£€æŸ¥
	â€¢	/?lang=zh å…¨æµç¨‹èµ°ä¸€éï¼Œæ²¡æœ‰è‹±æ–‡æ®‹ç•™
	â€¢	/?lang=en å†èµ°ä¸€éï¼Œæ²¡æœ‰ä¸­æ–‡æ’è¿›æ¥
	â€¢	æ–°çŠ¶æ€ uploaded/active/failed/duplicate/validated/archived/processing/parsed éƒ½èƒ½åˆ‡

â¸»

4. æŠ¥å‘Šæ ¼å¼ï¼ˆä½ å¿…é¡»è¿™æ ·å›æˆ‘ï¼‰

å›æ¥çš„æ—¶å€™è¦ç»™æˆ‘è¿™ä¸‰æ¡çœŸå®çš„ï¼ˆä¸æ˜¯ç¤ºä¾‹ï¼‰ğŸ‘‡

{
  "test_case": "A - standard bank CSV",
  "request": {
    "endpoint": "/api/v2/import/bank-statement",
    "company_id": 1,
    "bank_name": "Maybank",
    "account_number": "1234567890",
    "statement_month": "2025-01"
  },
  "response": {
    "success": true,
    "status": "active",
    "imported": 10,
    "matched": 4,
    "raw_document_id": 19,
    "file_id": 19,
    "next_actions": ["generate_report", "view_file"]
  },
  "frontend": {
    "redirected_to_detail": true,
    "list_highlighted": true,
    "next_button_texts": ["ç”ŸæˆæŠ¥è¡¨", "æŸ¥çœ‹åŸä»¶"]
  }
}

{
  "test_case": "B - missing lines CSV",
  "response": {
    "success": false,
    "status": "failed",
    "partial_success": true,
    "error_code": "INGEST_VALIDATION_FAILED",
    "status_reason": "è¡Œæ•°å¯¹è´¦å¤±è´¥ï¼šåŸå§‹æ–‡ä»¶ 45 è¡Œï¼Œå…¥åº“æˆåŠŸ 43 è¡Œ",
    "raw_document_id": 20,
    "exception_id": 7
  },
  "frontend": {
    "redirected_to_detail": true,
    "list_highlighted": true,
    "next_button_texts": ["æŸ¥çœ‹å¼‚å¸¸", "é‡æ–°ä¸Šä¼ "]
  },
  "exception_center": {
    "found": true,
    "exception_type": "ingest_validation_failed",
    "raw_document_id": 20
  }
}

{
  "test_case": "C - duplicate month",
  "response": {
    "success": true,
    "status": "duplicate",
    "duplicate_warning": "å½“å‰å…¬å¸/è´¦å·åœ¨2025-01å·²æœ‰ä¸»å¯¹è´¦å•ï¼ˆfile_id=19ï¼‰",
    "file_id": 21,
    "existing_file_id": 19,
    "next_actions": ["set_as_primary", "view_other_files"]
  },
  "frontend": {
    "redirected_to_detail": true,
    "list_highlighted": true,
    "next_button_texts": ["è®¾ä¸ºä¸»è´¦å•", "æŸ¥çœ‹æœ¬æœˆå…¶ä»–è´¦å•"],
    "show_red_banner": true
  }
}

å›ä¸å‡ºè¿™ä¸‰æ¡ï¼Œå°±å½“ä½ æ²¡åšå®Œã€‚ä¸è¦å«æˆ‘è‡ªå·±å»ä¼ æ–‡ä»¶ã€‚

â¸»

5. å¯é€‰ä¼˜åŒ–ï¼ˆæœ‰ç©ºå†åšï¼‰
	1.	æ–°å…¬å¸åˆ›å»ºæ—¶è‡ªåŠ¨çŒé©¬æ¥è¥¿äºšæ ‡å‡†ç§‘ç›®ï¼š
	â€¢	1001 é“¶è¡Œå­˜æ¬¾
	â€¢	1101 åº”æ”¶è´¦æ¬¾
	â€¢	2001 åº”ä»˜è´¦æ¬¾
	â€¢	3001 å®æ”¶èµ„æœ¬
	â€¢	4001 é”€å”®æ”¶å…¥
	â€¢	5001 ç®¡ç†è´¹ç”¨
	2.	statement_month å…¥å‚å…ˆåš YYYY-MM æ ¼å¼æ ¡éªŒï¼Œä¸å¯¹ç›´æ¥ 400

â¸»

6. éƒ¨ç½²/ç¯å¢ƒè¯´æ˜
	â€¢	è¯·æŠŠ SECRET_KEYã€TASK_SECRET_TOKEN æ”¾åˆ° Replit Secrets
	â€¢	ä¸å…è®¸åœ¨ä»£ç é‡Œå†™æ­» Token
	â€¢	ä¸å…è®¸åœ¨é¡µé¢é‡Œæ˜¾ç¤º Python traceback

â¸»

ä½ å°±æŠŠä¸Šé¢è¿™ä¸€ä»½åŸæ ·è´´ç»™ replitï¼Œå®ƒè¦æ˜¯æ¼åšï¼Œä½ å°±è¯´ï¼š

â€œè¯·å¯¹ç…§ã€Šç»Ÿä¸€å¼€å‘æŒ‡ä»¤ Â· é“¶è¡Œè´·æ¬¾ + ä¿¡ç”¨å¡åŒå¼•æ“ç‰ˆï¼ˆæœ€ç»ˆç‰ˆï¼‰ã€‹çš„ç« èŠ‚å·å›æŠ¥ä½ å®Œæˆäº†å“ªä¸€æ¡ï¼Œå“ªä¸€æ¡æ²¡åšã€‚å°¤å…¶æ˜¯ç¬¬å››éƒ¨åˆ†çš„ä¸‰æ¡çœŸå®JSONï¼Œè¯·ç°åœ¨è´´å‡ºæ¥ã€‚â€

è¿™æ ·å®ƒå°±ä¸èƒ½å†è·Ÿä½ ç©â€œä½ å†ä¸Šä¼ ä¸€æ¬¡æˆ‘è¯•è¯•çœ‹äº†â€ã€‚