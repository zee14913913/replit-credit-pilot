现在不是“能不能用”的问题了，而是“能不能拿去给客户+银行用、能不能规模化”的问题。
⸻

▶️ 下一阶段开发与优化指令

你们当前的版本已经具备核心账务能力（银行月结单→分录、POS→发票、PDF报表、CSV多模板导出、Management Report、月结自动化、pytest）。接下来请按下面顺序做增强，目标是：从“能跑”变成“对外可用、可审计、可做贷款资料包”的版本。

⸻

1. 补齐应收/应付账龄的“业务视图”

**目的：**现在有 Aging 能力但还没前端/业务化呈现，客户和银行没法一眼看风险。

要求：
	1.	新增接口：
	•	GET /reports/ar-aging/view?company_id=...&period=...
	•	GET /reports/ap-aging/view?company_id=...&period=...
	2.	前端展示要支持分组：客户/供应商 → 0-30/31-60/61-90/90+
	3.	Aging 要能被 Management Report 引用（就是 management 里那一节要真的拉这个API，不是写死）

⸻

2. 做一页“异常中心 / Exception Center”

现在你们已经有：OCR失败、PDF进 pending_documents、没匹配客户、没匹配供应商、分录没过。请把这些集中成一个接口+页面。

要求：
	1.	新增接口：GET /exceptions?company_id=...
	•	返回5类异常：pdf_parse_failed / ocr_failed / no_customer_match / no_supplier_match / posting_failed
	2.	每条异常要带：原始文件路径 + 建议处理动作
	3.	Management Report 生成时，如果异常 > 0，要在 PDF 顶部写一句：
“This management report contains unreconciled items. Please refer to Exception Center.”

👉 这个对贷款业务很关键：能证明“我有报表，但我也知道哪几笔还没对”，银行就比较敢批。

⸻

3. 规则引擎表驱动化

现在你们说有“智能分类”，但没写清楚是不是表驱动。如果还是代码里写 if/else，请改成下面这样：
	1.	新表：auto_posting_rules
	2.	支持字段：pattern（支持LIKE和regex）、target_account_code、posting_type(debit/credit/split)、priority、is_active
	3.	导入银行单、POS、supplier 发票时都走这张表
	4.	前端做一个最简单的规则维护页，方便业务人员自己加，不用改代码

⸻

4. 报表的“版本化”

现在你们能出 PDF，但没说“这一版是哪天算出来的”。给我加一条：
	1.	新表：report_snapshots

CREATE TABLE report_snapshots (
  id SERIAL PRIMARY KEY,
  company_id INT NOT NULL,
  report_type VARCHAR(50) NOT NULL, -- pnl, balance_sheet, management, bank_package
  period VARCHAR(20) NOT NULL,
  storage_path TEXT NOT NULL,
  generated_at TIMESTAMP NOT NULL DEFAULT now(),
  generated_by VARCHAR(50)
);


	2.	所有 /reports/*/pdf 生成成功后都存一条
	3.	文件管理页要能看到历史报表版本
👉 这样给银行A的是8月版，银行B要9月版，才能讲清楚。

⸻

5. 调度（scheduler）要做幂等

你的建议里已经有 scheduler，但不够严。请补：
	1.	新表：task_runs (task_name, run_date, status, details)，唯一键 (task_name, run_date)
	2.	/tasks/run-daily /tasks/run-monthly /tasks/run-management 都要先查今天跑没跑
	3.	触发路由全部要带 X-TASK-TOKEN，从环境变量读

⸻

6. 前端仪表板（可选但推荐）

这个是要给客户看的，不是给开发看的。
	1.	做一个 /dashboard/finance?company_id=...
	2.	至少显示：
	•	本月收入 vs 上月
	•	AR Aging 总额
	•	AP Aging 总额
	•	银行账户余额汇总
	•	未对账/未匹配数
	3.	图表不需要花哨，重点是一眼能看风险 → 这符合我做贷款前的“体检”逻辑

⸻

7. 跟现有 Flask App 的边界说明

现在有一套 Flask（信用卡、CTOS、收据OCR），一套 FastAPI（会计核心）。但请补一句“集成方式”，别留坑：
	1.	所有“文件上传型业务”（信用卡、POS、银行单）统一走 FastAPI 的文件管理层，Flask 只当 UI
	2.	Flask 侧不要自己再存文件到另外的目录，不然将来我们要查“这张单来自哪里”会乱
	3.	给出一个最小的网关写法（Nginx / Traefik），把 /accounting/* 路由到 FastAPI，其他走 Flask

⸻

8. 部署前检查清单（叫他们补文档）

请生成一份叫 DEPLOY_CHECKLIST.md 的文档，里面至少要有：
	•	必需环境变量：DATABASE_URL, FILES_BASE_DIR, X_TASK_TOKEN, ENABLE_OCR, PDF_DPI
	•	必需目录：/accounting_data/originals 和 /accounting_data/generated
	•	数据库迁移顺序
	•	第一次上线要跑的初始化SQL（科目表、导出模板、自动过账规则）
	•	单元测试/集成测试怎么跑

这样我交给团队就不用开口解释。

⸻

一句话重点

现在代码“会做账”了，下一步要能被银行信任、能被团队日常用、能追溯。上面8条就是往这个方向拉的。

