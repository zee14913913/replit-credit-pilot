妥。给你一份“上线前最后一页纸”。照这个走一遍，就能稳稳发版。

Production Launch Checklist（CreditPilot）

0) 决策框架
	•	Go/No-Go 窗口确定（含回滚负责人）
	•	预留维护时段/公告（15–30 分钟）

⸻

1) 环境与密钥（Replit Secrets）

把下列键填好；没有就留空，但要标注“未启用”。
	•	ENV=prod
	•	DATABASE_URL=postgres://…（生产库）
	•	FERNET_KEY=（重新生成：python -c "from cryptography.fernet import Fernet;print(Fernet.generate_key().decode())"）
	•	CORS_ALLOW=https://portal.creditpilot.digital
	•	LOANS_REFRESH_KEY=…（手动刷新利率用）
	•	OCR_PROVIDER=google|azure|tesseract|demo
	•	OCR_API_KEY=…（选了 google/azure 时必填）
	•	SENDGRID_API_KEY=…（发票/提醒邮件）
	•	MAIL_FROM=noreply@infinitegz.com（或你的业务邮箱）
	•	TWILIO_SID=…
	•	TWILIO_TOKEN=…
	•	TWILIO_FROM=+60…
	•	TWILIO_WHATSAPP_FROM=+60…（可选）
	•	ENABLE_WHATSAPP=0|1

备注：暂不做 SendGrid 也行，上面三项先留空即可。

⸻

2) 数据库健康与备份
	•	生产库连通：/health 返回 database: ok
	•	只读巡检：记录表数量、最新发票编号
	•	备份：触发一次全量快照或导出（至少 invoices/invoice_sequences/supplier_transactions）
	•	建索引（如未建）
	•	supplier_transactions(supplier_id, txn_date)
	•	invoices(number)（UNIQUE）

⸻

3) 安全基线
	•	关闭调试与文档：prod 下不暴露 /docs、/openapi.json
	•	速率限制：100 req/min（按需在 main.py 调整）
	•	文件名清洗：已启用 sanitize_filename()（发票/ZIP 共用）
	•	CORS 白名单：仅允许你的域名
	•	日志脱敏：屏蔽账号/身份证等个人信息

⸻

4) 应用配置（发票 & 收据）
	•	公司抬头（routers/invoices.py → COMPANY）：
INFINITE GZ SDN BHD / 注册号 / 地址 / 银行
	•	税率：COMPANY["tax"]["sst"]=0.00（或 0.06）
	•	条款 TERMS_EN/TERMS_ZH 按你的标准语改好
	•	自动编号：确认使用“INV-YYYY-NNNN”（invoice_sequences 正常递增）

⸻

5) 功能冒烟测试（生产环境）

依次在浏览器或终端跑一遍：

5.1 健康与门户
	•	GET /health → status=healthy
	•	GET /preview / Portal 打开，显示三张卡（Credit Cards / Savings / Loans）

5.2 供应商发票页
	•	GET /credit-cards/supplier-invoices → 表格渲染 & 月份切换
	•	预览 PDF：
GET /invoices/preview.pdf?layout=service&lang=en（内嵌预览）
GET /invoices/preview.pdf?layout=debit&lang=zh
GET /invoices/preview.pdf?layout=itemised&lang=en
	•	生成单张（下载）
GET /invoices/make?layout=service&bill_to_name=DINAS%20RESTAURANT&amount=8.50&lang=en
	•	批量 ZIP（如有按钮）：能下载、能正常解压，文件名无怪字符

5.3 收据匹配页
	•	GET /credit-cards/receipts → 页面可用
	•	上传一张图片 → 返回 OCR 结果（demo 或真服务）
	•	“匹配”动作执行，覆盖率数字更新

5.4 月度报告与导出
	•	GET /credit-cards/monthly-report → 评级显示
	•	GET /credit-cards/monthly-report/export.csv → 能被 Excel 打开

5.5 贷款模块
	•	GET /loans/page、/loans/ranking 正常
	•	DSR API：

curl -s -X POST http://<prod>/loans/dsr/calc \
  -H "Content-Type: application/json" \
  -d '{"monthly_income":10000,"existing_loans":[{"monthly_payment":1500}],"new_loan_monthly":2000}'

返回 ok: true 且 DSR 合理

⸻

6) 前端体验微调（小改高收益）
	•	Portal 待办卡 30s 自动刷新（前面给过 JS 片段）
	•	所有批量按钮执行时禁用（loading 态）
	•	Receipts 成功后跳回 ?filter=pending
	•	Supplier 表头粘性（滚动固定）

⸻

7) 监控与日志
	•	启动日志：写出 “Reminders scheduler started”
	•	错误告警：500 级别写入 processing_logs（或外部日志）
	•	关键指标面板 /stats 可打开（CPU/内存/数量级 OK）

⸻

8) 版本与文档
	•	bump 版本号：VERSION=1.0.0-prod
	•	更新变更记录：UI_UPGRADE_SUMMARY.md、SECURITY_FIXES_REPORT.md
	•	生成只读“运维手册”一页版（常用 URL、回滚方式）

⸻

9) 回滚计划（必须可执行）
	•	预留上一版镜像/分支：release-<prev>
	•	出问题 ≤10 分钟回滚步骤：
	1.	切换到上一版分支并 Run
	2.	恢复 invoices 与 invoice_sequences 的最新快照（如有变更）
	3.	验证 /health、核心页面
	•	回滚后公告模板准备好

⸻

10) 上线后首日巡检
	•	生成一张真实发票，编号连续、PDF打开无错
	•	收据上传 + 匹配一次，覆盖率卡片能刷新
	•	月报导出 CSV 能被财务打开
	•	贷款页响应 < 300ms（首屏）

⸻

附：两段“一键核查”命令（可选）

# 发票编号唯一 & 递增
python - <<'PY'
from accounting_app.db import get_session
from accounting_app.models import Invoice
with get_session() as db:
    nums = [x.number for x in db.query(Invoice).order_by(Invoice.id).all()]
    assert len(nums)==len(set(nums))
    print("Invoice numbers OK:", nums[-5:])
PY

# 月末汇总 ≈ 发票合计（允许少量差异）
curl -s http://<prod>/credit-cards/month-summary | jq .


⸻

要不要我把这份清单放进仓库里，命名成 PRODUCTION_LAUNCH_CHECKLIST.md，再附上两个一键脚本（Smoke Test / Rollback）？你点头，我就直接给可复制的文件版本。