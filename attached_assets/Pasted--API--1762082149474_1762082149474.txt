下面这段是“前端跳转/连接强制校验版”，你直接使用来调整运行设置，意思就是：不只是API要过，页面也要过；不只是能上传，还要看到；不只是有报错，还要友好提示；不只是有下一步，还要能回上一层。全部补齐。

⸻

▶️【前端跳转/连接强制校验补丁 v2】

说明：当前系统功能点很多，但前端流程断点多、上传后不刷新、点旧文件报错、5000端口和8000端口状态不同步。下面这些是“必须测、必须修、不能叫我再上传”的前端交互要求。做不到不能回报“已完成”。

⸻
	1.	核心原则（必须遵守）
	2.	每一个“提交/上传/生成/保存”操作之后，都必须有三个结果同时成立：
	•	✅ 有可见反馈（toast / alert / 顶部绿色条）
	•	✅ 自动跳转或自动刷新到能看到这次操作结果的页面
	•	✅ 列表里能马上看到这次新数据（不是旧缓存）
	3.	任何一个操作如果失败，必须留在当前页并展示可读错误，不允许直接500或白屏。
	4.	不允许要求用户“回首页再点一次才能看到刚上传的文件”。

⸻
2. 要补的页面级检查（5000端口：信用卡系统）

请逐页执行并修复：

(1) 首页 → 客户详情
	•	操作：在首页点击任意客户卡片
	•	期望：
	•	✅ 成功进入该客户的仪表板
	•	✅ URL 含客户ID
	•	✅ 顶部能看到客户名
	•	如失败：必须修 /customers/<id> 的路由或模板绑定

(2) 客户详情 → 上传账单
	•	操作：在客户页点“上传账单”
	•	期望：
	•	✅ 出现上传表单
	•	✅ 表单里预选当前客户
	•	✅ 上传成功后自动跳转到“账单验证页”
	•	✅ 左边原件 / 右边解析结果 都能看到
	•	缺失处理：
	•	没跳转 → 补 redirect
	•	跳转了但没数据 → 补上传成功后写入 file_index 再跳

(3) 账单验证页 → 客户账单列表
	•	操作：点“确认无误”
	•	期望：
	•	✅ 回到该客户页
	•	✅ “最近账单”第一条就是刚刚这份
	•	✅ 状态=已验证(绿色)
	•	✅ 有时间戳
	•	如没出现：说明你上传后没刷新列表 → 必须在后端返回的数据里带上“刚创建的账单ID”并在前端插入一条

(4) 客户账单列表 → 查看账单详情
	•	操作：点列表中任何一条账单
	•	期望：
	•	✅ 能打开（不500、不404）
	•	✅ 如果该账单是旧目录的文件，必须走“旧目录兼容读取”，不能直接报错
	•	✅ 打不开必须给用户提示“这是旧版文件，已迁移/请管理员恢复”，而不是空白
	•	如报错：修“旧路径兼容查询”，不要让我再传

(5) 客户页 → 信用卡时间轴
	•	操作：点“信用卡账本/账单时间轴”
	•	期望：
	•	✅ 12个月都显示
	•	✅ 有账单的变绿
	•	✅ 点某个月能跳到该月账单
	•	✅ 跳回时仍在同一客户上下文
	•	如跳回首页：要补客户上下文保持

(6) 上传收据 → 绑定交易
	•	操作：上传一张测试收据
	•	期望：
	•	✅ 上传成功提示
	•	✅ 页面立刻显示“找到的匹配交易”
	•	✅ 能点“绑定”
	•	✅ 绑定后再次刷新还能看到
	•	如提示“没找到交易，请重传”：必须修成“放进 pending”，不要把锅丢给用户

⸻
3. 要补的页面级检查（8000端口：会计系统）

(1) Swagger → 创建公司 → 列表
	•	操作：POST /api/companies → 然后 GET /api/companies
	•	期望：
	•	✅ 新公司马上能查到
	•	✅ company_id 在响应里
	•	✅ company_id 能被前端拿去上传
	•	如查不到：你要修列表缓存/排序

(2) 上传银行月结单 → 文件列表
	•	操作：POST /api/v2/import/bank-statement
	•	期望：
	•	✅ 返回 success / partial
	•	✅ 立刻 GET /api/files/list/{company_id} 能看到刚刚这份
	•	✅ 路径是新目录 /files/... 而不是旧的 static/uploads
	•	如看不到：要么没写 file_index，要么异步写 → 一律修成“写完再回”

(3) 上传失败 → 异常中心
	•	操作：上传“缺行版”CSV
	•	期望：
	•	✅ 返回 partial
	•	✅ GET /api/exceptions?company_id=… 能看到 ingest_validation_failed
	•	✅ 页面要能点进去看异常详情
	•	如没有：说明你只写日志没写API → 补

(4) 生成报表 → 成功后可见
	•	操作：GET /api/reports/pnl, GET /api/reports/balance-sheet, GET /api/reports/pdf/bank-package
	•	期望：
	•	✅ 成功后能在 /api/files/list 里看到生成的 PDF/CSV
	•	✅ 不是只下载，不落库
	•	如没落库：修报表生成逻辑，生成完写 report_snapshots + file_index 再返回

⸻
4. 跳转/提示/刷新必须检查的 10 条细节

你要一条条验证（不能说“我大概测了”）：
	1.	✅ 所有“新增/上传/生成”后页面有 toast
	2.	✅ 所有返回列表的页面默认按“创建时间 desc”排序；否则新文件会沉底，看起来像没上传
	3.	✅ 打开旧文件失败时有“旧路径兼容失败”文字提示
	4.	✅ 上传失败时保留用户已填的表单，不要清空
	5.	✅ 所有页面操作后都写入 audit_logs（含 ip, user_agent, user_id, action, entity_id）
	6.	✅ 用户从5000上传的文件，能在8000查到（文件同步成功提示一次）
	7.	✅ 用户从8000导出的报表，在5000不要显示（保持多租户视图）
	8.	✅ 前端按钮与角色联动：viewer 看不到“上传/删除/修改规则”
	9.	✅ 所有分页列表都有“空状态文案”，不是空白
	10.	✅ 所有不能继续下一步的情况，都要有“下一步指示文字”（比如：先验证账单 → 再生成报告）

⸻
5. 测试方式要求
	•	不允许再说“请你再上传文件我这边才能测”
	•	不允许只贴后端日志说“这里错了”
	•	要录下你跑的请求顺序（可以是文字）：
	•	5000: / → /customer/1 → /customer/1/upload → /customer/1/bills → /customer/1/bills/2024-07
	•	8000: /docs → POST /api/companies → POST /api/v2/import/bank-statement → GET /api/files/list → GET /api/exceptions
	•	最后必须给我一个“前端连通性结果”：

前端连通性检查（2025-11-02）

[✔] 5000 首页 → 客户详情
[✔] 5000 客户详情 → 上传账单 → 验证页
[✔] 5000 验证页 → 客户账单列表（列表已刷新）
[✔] 5000 账单列表 → 账单详情（旧路径可读提示正常）
[✔] 5000 上传收据 → 匹配交易 → 绑定
[✔] 8000 上传银行月结单 → 文件列表可见
[✔] 8000 上传失败 → 异常中心可见
[✔] 8000 报表生成 → 文件列表可见
结论：PASS（8/8）

只有这样才能说“前后端步骤都通了”。

⸻

你直接用这一版补上去就行了。你前面那篇《超详细操作指南》是“怎么给客户用”；我这段是“怎么逼你把每一步都点一遍、跳一遍、刷一遍、记一遍”。两份一配，系统就不会再出现“上传了但看不到”“旧文件点开是error”这种丢脸的情况。