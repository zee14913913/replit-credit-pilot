ğŸ“¦ ä»»åŠ¡æ ‡é¢˜ï¼š
Deploy AI Smart Assistant for Savings Page (Cross-Module Financial Analysis)

ğŸ¯ ç›®æ ‡ï¼š
åœ¨ CreditPilot ç³»ç»Ÿä¸­ï¼Œä¸º Savings é¡µé¢é›†æˆ OpenAI æ™ºèƒ½åŠ©æ‰‹æ¨¡å—ï¼Œ
å¹¶å®ç°è·¨æ¨¡å—è´¢åŠ¡åˆ†æï¼ˆSavings + Credit Cards + Loansï¼‰ã€‚

---

âœ… å®æ–½æ­¥éª¤ï¼š

1ï¸âƒ£ æ–°å»ºæ–‡ä»¶ï¼š
è·¯å¾„ï¼šaccounting_app/routes/ai_assistant.py

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from fastapi import APIRouter, Depends, Request
from openai import OpenAI
from accounting_app.middleware.rbac_fixed import require_admin_or_accountant
from accounting_app.db import get_db
from datetime import datetime
import traceback

router = APIRouter()
client = OpenAI()

@router.post("/api/ai-assistant/query")
@require_admin_or_accountant
async def ai_assistant_query(request: Request, db=Depends(get_db)):
    """AI æ™ºèƒ½é—®ç­”åŠ©æ‰‹"""
    try:
        body = await request.json()
        msg = body.get("message", "")
        s = db.execute("SELECT COUNT(*) AS accounts, SUM(amount) AS total FROM savings_transactions").fetchone()
        context = f"å½“å‰ç³»ç»Ÿå…±æœ‰ {s['accounts']} ä¸ªå‚¨è“„è´¦æˆ·ï¼Œæ€»é‡‘é¢ RM {round(s['total'] or 0,2)}ã€‚å®¢æˆ·é—®é¢˜ï¼š{msg}"
        completion = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "ä½ æ˜¯CreditPilotçš„AIç†è´¢é¡¾é—®ï¼Œè¯·ç”¨ä¸“ä¸šä½†äº²åˆ‡çš„è¯­æ°”å›ç­”å®¢æˆ·é—®é¢˜ã€‚"},
                {"role": "user", "content": context}
            ]
        )
        reply = completion.choices[0].message.content
        db.execute("INSERT INTO ai_logs (query,response,created_at) VALUES (?,?,?)", (msg, reply, datetime.utcnow()))
        db.commit()
        return {"reply": reply}
    except Exception as e:
        traceback.print_exc()
        return {"error": str(e)}

@router.post("/api/ai-assistant/analyze-system")
@require_admin_or_accountant
async def analyze_system(request: Request, db=Depends(get_db)):
    """è·¨æ¨¡å—è´¢åŠ¡åˆ†æ"""
    try:
        s = db.execute("SELECT COUNT(*) AS accounts, SUM(amount) AS total FROM savings_transactions").fetchone()
        c = db.execute("SELECT COUNT(*) AS cards, SUM(balance) AS total_balance FROM credit_cards").fetchone() if db.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='credit_cards'").fetchone() else {"cards":0,"total_balance":0}
        l = db.execute("SELECT COUNT(*) AS loans, SUM(principal) AS total_principal FROM loan_accounts").fetchone() if db.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='loan_accounts'").fetchone() else {"loans":0,"total_principal":0}
        context = f"å‚¨è“„æ€»é¢ RM {round(s['total'] or 0,2)}ï¼Œä¿¡ç”¨å¡ä½™é¢ RM {round(c['total_balance'] or 0,2)}ï¼Œè´·æ¬¾æœ¬é‡‘ RM {round(l['total_principal'] or 0,2)}ï¼Œè¯·ç”Ÿæˆèµ„é‡‘å¥åº·åˆ†æä¸ä¼˜åŒ–å»ºè®®ã€‚"
        completion = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role":"system","content":"ä½ æ˜¯ä¸€åä¼ä¸šè´¢åŠ¡åˆ†æå¸ˆï¼Œè¯·æ ¹æ®æ•°æ®ç”Ÿæˆè´¢åŠ¡å¥åº·åˆ†ææŠ¥å‘Šã€‚"},
                {"role":"user","content":context}
            ]
        )
        report = completion.choices[0].message.content
        db.execute("INSERT INTO ai_logs (query,response,created_at) VALUES (?,?,?)", ("ç³»ç»Ÿåˆ†æ", report, datetime.utcnow()))
        db.commit()
        return {"analysis": report}
    except Exception as e:
        traceback.print_exc()
        return {"error": str(e)}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

2ï¸âƒ£ ä¿®æ”¹ main.pyï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from accounting_app.routes import ai_assistant
app.include_router(ai_assistant.router)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

3ï¸âƒ£ åˆ›å»ºè¡¨ç»“æ„ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE TABLE IF NOT EXISTS ai_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    query TEXT,
    response TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

4ï¸âƒ£ å‰ç«¯æ–‡ä»¶ï¼š
è·¯å¾„ï¼štemplates/partials/chatbot.html
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
<div id="ai-chatbox" style="position:fixed;bottom:40px;right:40px;z-index:9999;">
  <button id="chat-toggle" style="background:#ff007f;color:#fff;border:none;border-radius:999px;padding:12px 18px;font-weight:700;box-shadow:0 0 18px rgba(255,0,127,0.6);">ğŸ’¬ æ™ºèƒ½é¡¾é—®</button>
  <div id="chat-window" style="display:none;width:340px;height:480px;background:#111;border:1px solid #ff007f;border-radius:16px;padding:10px;color:#fff;">
    <div id="chat-log" style="height:360px;overflow-y:auto;font-size:14px;"></div>
    <div style="display:flex;gap:6px;">
      <input id="chat-input" placeholder="è¾“å…¥é—®é¢˜..." style="flex:1;padding:8px;border-radius:10px;border:none;color:#fff;background:#222;">
      <button id="sys-analyze" style="background:#ff007f;border:none;border-radius:10px;padding:8px 10px;color:#fff;">ğŸ“Š ç³»ç»Ÿåˆ†æ</button>
    </div>
  </div>
</div>
<script>
const toggle=document.getElementById("chat-toggle");
const win=document.getElementById("chat-window");
const log=document.getElementById("chat-log");
const input=document.getElementById("chat-input");
const analyze=document.getElementById("sys-analyze");
toggle.onclick=()=>win.style.display=(win.style.display==="none")?"block":"none";
async function send(msg,endpoint){
 log.innerHTML+=`<div><b>æ‚¨ï¼š</b> ${msg}</div>`;
 const r=await fetch(endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})});
 const d=await r.json();
 log.innerHTML+=`<div style='color:#ff007f;'><b>AIï¼š</b> ${d.reply||d.analysis||d.error}</div>`;
 log.scrollTop=log.scrollHeight;
}
input.addEventListener("keypress",e=>{if(e.key==="Enter"&&input.value.trim()!==""){send(input.value,"/api/ai-assistant/query");input.value="";}});
analyze.onclick=()=>send("è¯·åˆ†ææ•´ä¸ªç³»ç»Ÿçš„è´¢åŠ¡çŠ¶å†µ","/api/ai-assistant/analyze-system");
</script>
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

5ï¸âƒ£ åœ¨ layout.html æœ€åº•éƒ¨åŠ å…¥ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{% include 'partials/chatbot.html' %}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

6ï¸âƒ£ æ£€æŸ¥ Secretsï¼š
AI_INTEGRATIONS_OPENAI_API_KEY  
AI_INTEGRATIONS_OPENAI_BASE_URL=https://api.openai.com/v1

7ï¸âƒ£ é‡å¯åº”ç”¨ï¼š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pkill -f uvicorn; python app.py
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

---

ğŸ’¬ æˆæœï¼š
Savings é¡µé¢å³ä¸‹è§’å‡ºç°ã€ŒğŸ’¬ æ™ºèƒ½é¡¾é—®ã€æŒ‰é’®ï¼Œå¯å³æ—¶å¯¹è¯ã€‚
ç‚¹å‡» ğŸ“Š æŒ‰é’®æ—¶ï¼ŒAI å°†è‡ªåŠ¨è¯»å– Savings / Credit Card / Loan æ¨¡å—æ•°æ®ï¼Œ
ç”Ÿæˆä¸€ä»½å®æ—¶çš„è´¢åŠ¡å¥åº·æŠ¥å‘Šä¸å»ºè®®ã€‚
