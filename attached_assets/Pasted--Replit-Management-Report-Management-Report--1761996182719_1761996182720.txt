▶️ 给 Replit 的指令（最终版，含 Management Report）

我现在要你在现有说明的基础上，再加一层文件解析、自动记账、管理层报表（Management Report）与自动导出能力，让这个财务/贷款辅助系统能处理不同来源的原始文件，然后自动生成我能导入到现有 SQL 财务软件里的分录文件，同时还能生成银行在贷款审核时常要看的 management report。请按下面要求更新设计，不要省略。

⸻

① 输入文件类型（很重要）
系统必须同时支持：
	1.	CSV / Excel
	•	这是银行月结单的首选格式
	•	读完后直接入表：bank_statements
	2.	PDF
	•	可能是银行月结单、POS 日报、供应商发票
	•	先做一个统一的“PDF 解析服务”模块：app/services/pdf_parser.py
	•	优先用可解析的文本型 PDF
	•	如果是扫描件，要调用 OCR（用开源库即可；如果 Replit 环境受限，请生成可替代的本地跑法提示）
	•	解析失败的记录要进入一个“待人工确认”表：pending_documents，不能直接丢

请你在代码里明确区分：成功自动识别的 → 直接进账；识别失败的 → 进待确认，不要假装 100% 成功。

⸻

② 银行月结单 → 会计分录 → 可下载 CSV
在原本的银行导入功能上继续加要求：
	1.	路由：POST /import/bank-statement 同时接受 CSV 和 PDF
	2.	解析完成后，统一写入 bank_statements
	3.	然后调用规则匹配引擎，把每一条交易生成一条或多条会计分录，写入：
	•	journal_entries（分录头）
	•	journal_entry_lines（分录行，含 debit / credit）
	4.	新增导出接口：
	•	GET /export/journal/csv?company_id=...&period=2025-01
	•	这个接口要导出“已经分析好的”分录，字段至少要有：date, account_code, description, debit, credit, ref_no
	•	导出的 CSV 要适配“可以直接导入市面上常见的 SQL 财务/会计软件”的格式（请在代码里写成可配置的列顺序）

这样我就可以：上传银行单 → 系统分析 → 我下载分录 CSV → 导入我现有的 finance acc 软件。

⸻

③ 供应商发票 / 进出货单的日常自动化
我要一个专门处理供应商 invoices / 出入货单的流程：
	1.	路由：POST /upload/supplier-invoice，接受 PDF / CSV
	2.	解析后写入：
	•	suppliers
	•	purchase_invoices
	3.	自动生成对应的会计分录（应付账款）
	4.	同步更新 Suppliers Aging 报表
	5.	文件归档要求：原始文件要存到一个逻辑上的“文件管理”里，例如：
	•	/files/{company_id}/suppliers/{year}/{month}/{original_filename}.pdf
	•	系统要能列出这些文件的下载链接：GET /files/list?company_id=...&type=supplier-invoices
	6.	同一张发票不能重复入账，要做重复检测（供应商 + 发票号 + 日期）

⸻

④ POS 日报 → 自动生成客户发票（Customer Invoices）
很多公司每天会从 POS 导出一份 Daily Business Report（通常是 CSV / Excel，有时是 PDF）。我要你做一个模块，专门处理这个场景：
	1.	路由：POST /import/pos-daily-report
	2.	支持 CSV / PDF（PDF 同样先走解析模块）
	3.	解析出每一笔交易：日期、客户/会员号、消费金额、税额、支付方式
	4.	系统根据客户/会员号 → 去 customers 表里找客户，匹配不到的要进待确认
	5.	对同一天的同一客户，可以汇总成一张发票，生成到：sales_invoices
	6.	生成发票后要自动生成会计分录（收入 + 应收 / 银行）
	7.	文件归档：所有自动生成的发票，要能导出 PDF，放到：
	•	/files/{company_id}/customers/{year}/{month}/{invoice_no}.pdf
	•	并提供一个列表接口：GET /files/customer-invoices?company_id=...&month=2025-01

⸻

⑤ PDF 导出能力（报表级）
除了能下载 CSV，我还需要报表级 PDF，给客户/给银行用：
	1.	GET /reports/balance-sheet/pdf?company_id=...&month=2025-01
	•	生成一份“比较正式的”资产负债表 PDF
	•	样式不要太丑，给我一个基础模板，后面我自己改
	2.	GET /reports/pnl/pdf?...
	•	同理，生成 P&L PDF
	3.	GET /reports/bank-package/pdf?...
	•	把前面生成的财务报表、aging、税务调整做成一个打包 PDF（你先做 JSON + 单 PDF，打包可以先留 TODO）

如果 Replit 环境里生成 PDF 有限制，请你在代码里写清楚可以选的方案（比如用 WeasyPrint / ReportLab / 前端拉 HTML 转 PDF），不要跳过。

⸻

⑥ Management Report（管理层经营报表）
我要你额外做一组专门给银行或管理层看的管理报表。跟法定报表不一样，它要用最近月份的数据，以便在贷款、renew facility、加额度时证明公司仍在正常经营。

请新增以下内容：
	1.	新增路由：
	•	GET /reports/management?company_id=...&period=2025-08
	•	支持 period 不跟财政年结同步（例：公司年结是 12 月，但我要看 8 月）
	2.	这个接口要综合下面几块数据：
	•	最近月度的 P&L（当月 & 年初至今）
	•	最近月末的 Balance Sheet
	•	AR Aging & AP Aging（来自前面模块）
	•	银行账户余额汇总 / 当月收支汇总（来自 bank_statements）
	•	当月/最近3个月的异常或税务调整（来自 tax_adjustments）
	3.	要能输出 JSON + PDF 两种：
	•	GET /reports/management/pdf?...
	4.	PDF 模板里请标注：
	•	数据口径（unaudited / management purpose only）
	•	数据期间（from / to）
	•	数据来源（bank statements / POS / supplier invoices / manual journals）
	•	这样银行看时不会误会为什么跟 audited accounts 不同
	5.	请在代码里说明：如果当月有“未匹配/未确认”的交易（例如还留在 pending_documents），要在 management report 里加一节 “Unreconciled / Pending Items”。

这部分是为了支持“年报很久、但银行要看最新经营状态”的场景，不能省。

⸻

⑦ 文件管理与目录结构
我要你在项目里设计一个统一的“文件管理层”，不要把文件随便丢。请你：
	1.	在配置里预留一个 FILES_BASE_DIR，从环境变量读取
	2.	所有上传的源文件（银行单、供应商发票、POS 日报、生成的客户发票 PDF、财务报表 PDF、management report PDF）都按下面规则存：
	•	/files/{company_id}/{module}/{year}/{month}/...
	3.	做一个通用的列表接口：
	•	GET /files/list?company_id=...&module=bank-statements
	•	GET /files/list?company_id=...&module=customer-invoices
	•	GET /files/list?company_id=...&module=management-reports
	4.	做一个下载接口：
	•	GET /files/download?path=...
	5.	重要补充：每一种分析、每一种报表都必须有固定、可预测的文件夹路径来同时存放“上传的原件”和“系统生成的成品文件”，否则在需要下载时会出现“文件不见/找不到”问题。请在代码里把“原件路径”和“成品路径”都写死成同一套命名规则，不要让它随机生成路径。

⸻

⑧ 自动化与定时任务的补充
在原本的 app/tasks/monthly_close.py 里面，请再加上：
	1.	检查当月是否有还没转成分录的银行记录 / POS 记录 / 供应商发票，列成一个“待处理清单”
	2.	每天定时把当天的上传文件跑一遍解析（用于 POS / 供应商发票）
	3.	每个月底自动生成：
	•	P&L
	•	Balance Sheet
	•	Aging
	•	Management Report（本月）
	•	并把 PDF 存到对应文件夹
	4.	如果 Replit 没有内建 cron，请给我一个可被外部请求触发的路由，比如：
	•	POST /tasks/run-daily
	•	POST /tasks/run-monthly
	•	POST /tasks/run-management
这样我可以用 UptimeRobot / GitHub Actions 去调

⸻

⑨ 输出要求
最后输出时，请你还是按这个顺序来：
	1.	是否建议我把这套“文件解析 + 自动记账 + PDF/CSV 导出 + Management Report”的功能独立成一个服务，还是能安全地插到我现有 app 里（请根据文件上传频率、存储量、报表生成耗时来判断）
	2.	数据库建表 SQL（要包含你刚加的 pending_documents、文件索引表，如果需要的话 management_reports 或生成日志表）
	3.	FastAPI 目录结构
	4.	关键路由示例代码：
	•	上传 PDF 银行单
	•	导出分录 CSV
	•	上传 POS 日报并生成客户发票
	•	下载 PDF 报表
	•	生成 / 下载 Management Report
	5.	环境变量说明：DATABASE_URL、FILES_BASE_DIR、PDF 渲染相关配置（如果需要）

不要省略，也不要只写伪代码。
