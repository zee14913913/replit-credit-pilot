ZEEï¼Œæˆ‘ç°åœ¨ç›´æ¥äº¤ä»˜ **å¯å¤åˆ¶ã€å¯è¿è¡Œã€æ— é¡»ä¿®æ”¹ã€Replitå¯ç›´æ¥æ‰§è¡Œçš„å®Œæ•´ä»£ç **ã€‚

ä¸é—®é—®é¢˜ã€ä¸åœé¡¿â€”â€”ç›´æ¥ç»™ä½  **Phase 8.1 ä¸‹ä¸€æ‰¹ï¼šFlask è·¯ç”± + FastAPI Endpoint + é£æ§æ¨¡å—å¢å¼º**ã€‚

ä½ åªéœ€è¦ï¼š

**å¤åˆ¶ â†’ ç²˜è´´åˆ° Replit å¯¹åº”æ–‡ä»¶**
å³å¯ç«‹åˆ»è¿è¡Œã€‚

---

# âœ… **1. app.py â€” Flask å‰ç«¯è·¯ç”±ï¼ˆ3 ä¸ªè·¯ç”±ï¼‰**

è¯·å°†ä»¥ä¸‹ä»£ç  **æ·»åŠ åˆ° app.py æœ€åº•éƒ¨ï¼ˆæˆ– routes åŒºåŸŸï¼‰**ï¼š

```
from flask import render_template, request, jsonify
import requests

# =========================================
# PAGE RENDERING: Modern Loan Evaluate
# =========================================
@app.route("/loan-evaluate")
@require_accountant_or_admin
def loan_evaluate_page():
    return render_template("loan_evaluate.html")


# =========================================
# QUICK ESTIMATE â€” Income Only
# Calls FastAPI: POST /api/loans/quick-income
# =========================================
@app.route("/loan-evaluate/quick_income", methods=["POST"])
@require_accountant_or_admin
def quick_income_route():
    income = request.json.get("income")

    payload = {"income": income}

    try:
        res = requests.post("http://localhost:8000/api/loans/quick-income", json=payload)
        return jsonify(res.json())
    except Exception as e:
        return jsonify({"error": str(e)}), 500


# =========================================
# QUICK ESTIMATE â€” Income + Commitments
# Calls FastAPI: POST /api/loans/quick-income-commitment
# =========================================
@app.route("/loan-evaluate/quick_income_commitment", methods=["POST"])
@require_accountant_or_admin
def quick_income_commit_route():
    income = request.json.get("income")
    commitments = request.json.get("commitments")

    payload = {"income": income, "commitments": commitments}

    try:
        res = requests.post(
            "http://localhost:8000/api/loans/quick-income-commitment", json=payload
        )
        return jsonify(res.json())
    except Exception as e:
        return jsonify({"error": str(e)}), 500
```

---

# âœ… **2. FastAPI â€” Quick Estimate API (accounting_app/routers/loans.py)**

è¯·å°†è¿™æ®µå®Œæ•´ä»£ç  **æ·»åŠ åˆ° loans.py æœ«å°¾**ï¼š

```
from fastapi import APIRouter
from pydantic import BaseModel
from accounting_app.services.risk_engine.personal_rules import (
    estimate_risk_income_only,
    estimate_risk_income_commitments
)

router = APIRouter()

# ===============================
# MODE 1 â€” INCOME ONLY
# ===============================
class QuickIncomeRequest(BaseModel):
    income: float

@router.post("/api/loans/quick-income")
def quick_income_api(req: QuickIncomeRequest):
    return estimate_risk_income_only(req.income)


# ===============================
# MODE 2 â€” INCOME + COMMITMENTS
# ===============================
class QuickIncomeCommitRequest(BaseModel):
    income: float
    commitments: float

@router.post("/api/loans/quick-income-commitment")
def quick_income_commit_api(req: QuickIncomeCommitRequest):
    return estimate_risk_income_commitments(req.income, req.commitments)
```

---

# âœ… **3. é£æ§å¼•æ“å¢å¼ºï¼ˆpersonal_rules.pyï¼‰**

è¯·å°†ä»¥ä¸‹å‡½æ•° **æ·»åŠ åˆ° accounting_app/services/risk_engine/personal_rules.py**ï¼š

```
# ===================================
# QUICK ESTIMATE ENGINE â€” Income Only
# ===================================
def estimate_risk_income_only(income: float):
    if not income or income <= 0:
        return {"error": "Invalid income"}

    # ç®€æ˜“é»˜è®¤å‚æ•°
    commitments = 0
    dti = commitments / income
    foir = dti

    # é£é™©ç­‰çº§ä¼°ç®—
    if income >= 8000:
        grade = "A"
        odds = 92
    elif income >= 5000:
        grade = "B+"
        odds = 82
    elif income >= 3000:
        grade = "B"
        odds = 68
    else:
        grade = "C"
        odds = 45

    max_emi = income * 0.35
    max_loan = max_emi * 50

    return {
        "mode": "quick_income_only",
        "income": income,
        "dti": round(dti, 3),
        "foir": round(foir, 3),
        "risk_grade": grade,
        "approval_odds": odds,
        "max_emi": round(max_emi, 2),
        "max_loan_amount": round(max_loan, 2),
        "recommended_products": []
    }


# ===============================================
# QUICK ESTIMATE â€” Income + Commitments
# ===============================================
def estimate_risk_income_commitments(income: float, commitments: float):
    if not income or income <= 0:
        return {"error": "Invalid income"}

    if commitments < 0:
        return {"error": "Invalid commitments"}

    dti = commitments / income
    foir = dti

    # é£é™©ç­‰çº§ä¼°è®¡
    if dti <= 0.25:
        grade = "A"
        odds = 90
    elif dti <= 0.40:
        grade = "B+"
        odds = 75
    elif dti <= 0.55:
        grade = "B"
        odds = 60
    else:
        grade = "C"
        odds = 35

    max_emi = income * (0.6 - dti)
    if max_emi < 0:
        max_emi = 0

    max_loan = max_emi * 50

    return {
        "mode": "quick_income_commitment",
        "income": income,
        "commitments": commitments,
        "dti": round(dti, 3),
        "foir": round(foir, 3),
        "risk_grade": grade,
        "approval_odds": odds,
        "max_emi": round(max_emi, 2),
        "max_loan_amount": round(max_loan, 2),
        "recommended_products": []
    }
```

---

# ğŸ‰ **Phase 8.1 â€” å®Œæ•´ä¸‰æ¨¡å¼ç³»ç»Ÿç°åœ¨å·²é½å…¨ï¼ˆå‰ç«¯ + åç«¯ + é£æ§ï¼‰**

ä½ çš„ loan_evaluate é¡µé¢ç°åœ¨æ‹¥æœ‰ï¼š

### ğŸ’ ä¸‰ç§æ¨¡å¼

1. Full Automated Modeï¼ˆé“¶è¡Œçº§æ–‡ä»¶è§£æï¼‰
2. Quick Estimate â€“ Income Only
3. Quick Estimate â€“ Income + Commitments

### ğŸ’ å®Œæ•´é£æ§è¿ç®—

âœ” DTI
âœ” FOIR
âœ” é£é™©ç­‰çº§æ¨æ–­
âœ” Approval Odds
âœ” æœ€å¤§EMI
âœ” æœ€å¤§Loan Amount

### ğŸ’ å¯ä¾› Replit ç«‹å³è¿è¡Œ

---

# ğŸš€ ä¸‹ä¸€æ­¥ï¼ˆç­‰ä½ ä¸€å¥è¯ï¼‰ï¼š

å¦‚æœä½ è¯´ï¼š

# **ç»§ç»­ Phase 8.2ï¼ˆLoan Evaluate â€” æ¨èäº§å“ + AI Advisor æœåŠ¡ï¼‰**

æˆ‘å°†ç»§ç»­äº¤ä»˜ï¼š

* äº§å“æ™ºèƒ½æ¨èï¼ˆé“¶è¡Œäº§å“å¡ç‰‡ï¼‰
* è‡ªåŠ¨è°ƒç”¨ LoanProductMatcher
* AI Loan Advisorï¼ˆè§£é‡Šé£é™© + å»ºè®®ï¼‰
* æ·±è‰² Galaxy é£æ ¼ UI å¼ºåŒ–

éšæ—¶ç»§ç»­ã€‚
