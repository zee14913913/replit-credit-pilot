▶️ 整合版开发指令（RBAC + 业务加固 + 文件清理 + 1:1原件保护 + Architect审查）

请在当前已完成的系统基础上（Flask 5000 信用卡引擎 + FastAPI 8000 银行贷款会计引擎），再做一轮业务级加固与数据完整性加固，目标是：
	1.	任何上传的客户文件都能做到无删减、无添加、无更改、1:1落库
	2.	系统不会因为旧路径/旧设置而“找不到文件 → 叫我重传”
	3.	权限清晰，谁能改、谁只能看、谁能导出，一眼看得懂
	4.	报表是“可追溯、有版本、有快照、有期间锁定”的
	5.	所有变更要经过 architect 审查模板，不允许系统“忘记我之前的要求”

以下内容请全部实现，不要省略。

⸻

1. 角色与权限（RBAC）
	1.	必须支持的角色：admin, accountant, viewer
	2.	预留角色（不用先开，但要写结构）：data-entry, loan-officer
	3.	权限矩阵：
	•	admin：全部功能，含删除文件、修改自动过账规则、管理导出模板、运行任务
	•	accountant：上传(银行/供应商/POS)、处理异常、手工分录、生成和下载报表，但不能删文件、不能改系统级配置
	•	viewer：只读，只能看和下载已生成的 PDF/CSV，不能上传、不能月结
	4.	所有写入类接口（upload, import, update, rules/*…）都必须挂统一的 require_role(...)
	5.	所有 /tasks/* 路由除了角色校验，还要校验 header：X-TASK-TOKEN，值从环境变量读取

说明：这一步是为了防止客户、低权限用户、甚至你之后的助理，误删或误改账务文件。

⸻

2. 报表版本化 + 期间锁定
	1.	新建表：                                                                                                                                                                                                           CREATE TABLE report_snapshots (
  id SERIAL PRIMARY KEY,             
  company_id INT NOT NULL,
  report_type VARCHAR(50) NOT NULL,    -- pnl, balance_sheet, management, bank_package
  period VARCHAR(20) NOT NULL,
  storage_path TEXT NOT NULL,
  generated_at TIMESTAMP NOT NULL DEFAULT now(),
  generated_by INT
);                          	                                                                                                                                                                                                                                            .     2.	所有生成成功的 PDF 报表（Balance Sheet, P&L, Management Report, Bank Package）都必须写入这张表
	3.	增加期间关闭机制：新增 period_closing 表或字段，月结后该期间的报表不得被历史分录自动回溯覆盖，只能生成新版本，例如：2025-01 management report v3

⸻

3. 文件管理收紧 + 统一索引
	1.	Flask 上传的所有文件（信用卡、储蓄、收据）必须写入 FastAPI 侧的 file_index，保持一套文件索引，不要两套
	2.	file_index 必须至少有：
	•	company_id
	•	module (credit-card / bank / savings / pos / supplier / reports / management / temp)
	•	file_type (original / generated)
	•	storage_path
	•	related_id (bank_statement_id / invoice_id / pos_batch_id / credit_card_statement_id)
	•	status (active / archived / deleted)
	3.	任何文件如果没有 related_id，就不允许最终落库，要先进 upload_staging，防止出现“孤儿文件”

⸻

4. 异常中心可行动化
	1.	在现有异常表上新增：
	•	next_action (reparse, map-customer, map-supplier, manual-journal)
	•	retryable (BOOLEAN)
	2.	新增接口：POST /exceptions/{id}/retry
调用后根据异常类型重新跑解析/重新过账
	3.	Management Report 生成逻辑中，如果本期异常数量 > 0，请自动插入提示：

Unreconciled items detected, please check Exception Center.

	4.	异常接口必须受角色控制：只有 admin / accountant 能处理，viewer 只能看

⸻

5. 自动过账规则分层（全局 + 公司）
	1.	把当前自动过账规则扩展成两层：                                                                                                                                                                                  CREATE TABLE auto_posting_rules (
  id SERIAL PRIMARY KEY,
  company_id INT,              -- NULL = 全局规则
  pattern TEXT NOT NULL,
  target_account_code VARCHAR(50) NOT NULL,
  posting_type VARCHAR(20) NOT NULL,   -- debit / credit / split
  priority INT DEFAULT 100,
  is_active BOOLEAN DEFAULT TRUE
);                                                                                         	2.	生效顺序：company_rule > global_rule > fallback
	3.	管理端要能看到“全局规则”和“本公司规则”是分开的，不要混在一张列表

⸻

6. 马来西亚本地化预留
	1.	在会计分录 / 发票 / 薪资相关表中增加可为空字段：
	•	sst_rate
	•	epf_amount
	•	socso_amount
	•	eis_amount
	2.	导入银行 / POS / 供应商发票时，如果能识别到 SST 6%，请写入
	3.	请在解析模块里标注：Flask 侧已经支持 15 家马来西亚银行，请让 FastAPI 侧的银行导入模块也能共用同一套路由/模板，避免两套解析规则

⸻

7. 性能与降级策略（写进文档）

请在系统文档/API 文档里补上：
	1.	当单月交易量 > 50,000 笔时：
	•	报表优先从预汇总表 / materialized view 读取
	•	PDF 生成走异步任务（BackgroundTask / Celery），前端只拿任务ID
	•	CSV 导出走流式下载，不要一次性加载到内存
	2.	代码里预留 env 开关：USE_MATERIALIZED_VIEWS, ASYNC_PDF_EXPORT

⸻

8. 审计日志补强
	1.	新建表：                                                                                                                                                                                                              CREATE TABLE audit_logs (
  id SERIAL PRIMARY KEY,
  company_id INT NOT NULL,
  user_id INT NOT NULL,
  action VARCHAR(100) NOT NULL,   -- export_pdf, export_csv, manual_journal_edit, rule_update, file_delete
  source_type VARCHAR(30),        -- bank / pos / supplier / manual / import
  reason TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT now()
);                                                                                                   	2.	以下动作必须写日志：
	•	导出 CSV / PDF / Bank Package
	•	修改自动过账规则
	•	手工分录修改 / 反过账
	•	删除 / 替换原始文件
	3.	手工改账接口必须要求传 reason（必填）

⸻

9. 定时任务幂等
	1.	新建表：                                                                                                                                                                                                           CREATE TABLE task_runs (
  id SERIAL PRIMARY KEY,
  task_name VARCHAR(100) NOT NULL,
  run_date DATE NOT NULL,
  status VARCHAR(20) NOT NULL,
  details TEXT,
  UNIQUE (task_name, run_date)
);	                                                                                                                                                                                                                                                       .                                                                                                                                                                                                                                    2.	所有 /tasks/run-* 在执行前先查表，如果当天已经执行过，直接返回                                                                                                                              3.	所有任务路由都要校验 X-TASK-TOKEN

⸻

10. 文件清理与旧路径迁移

主题：统一文件存储 + 历史垃圾清理 + 兼容旧路径

目前系统里还残留很多早期功能生成的旧文件/旧路径，导致：
	•	有文件但查不到
	•	同一客户要重复上传
	•	分析/报表时找不到原件

请按下面要求一次性做“文件清理与迁移”功能：

10.1 建立文件主索引视图

生成一个统一的文件清单（SQL视图或API），字段：
	•	company_id
	•	module (credit-card, bank, savings, pos, supplier, reports, management, temp)
	•	storage_path
	•	file_type (original / generated)
	•	related_id
	•	created_at
	•	status (active / archived / deleted)

10.2 旧路径扫描 + 迁移脚本

扫描旧路径：
	•	static/uploads/...
	•	uploads/...
	•	Flask 侧分散的信用卡账单

逻辑：
	1.	能识别出 company/customer 的 → 移动到新目录：/files/{company_id}/{module}/{year}/{month}/...
	2.	同时更新 file_index.storage_path
	3.	旧位置留标记，避免重复迁移

10.3 禁止“孤儿文件”

上传时必须指定：company_id + module + (能的话) related_id
否则先进 upload_staging，不要直接落正式目录。

10.4 旧文件兼容查询

分析资料时找不到文件 → 修改为：
	1.	先查新目录 /files/...
	2.	查不到再查旧目录 static/uploads/...
	3.	还查不到才提示重新上传
并在日志里记录“旧目录命中”。

10.5 回收站 / 软删除

给 file_index 增加：
	•	status ENUM('active','archived','deleted')
	•	deleted_at

错误文件/旧文件 → 标记为 archived 或 deleted，保留30-60天；提供接口：GET /files/archived?company_id=...

10.6 审计与清理任务

在 /tasks/run-daily 里加：
	•	扫描 status=deleted 且过期的 → 真正删除
	•	扫描无 related_id 的 → 丢进异常中心

10.7 文档更新

在文档里写明：唯一有效目录结构为
/files/{company_id}/{module}/{year}/{month}/...
以前的路径视为废弃，只保留兼容读取。

⸻

11. 1:1 原件保护（防“偷懒/幻想/遗忘”机制）

这是本次最重要的要求，用来保证不丢行、不改行、不多行。

11.1 原件必存表;                                                                                                                                                                                                                  CREATE TABLE raw_documents (
  id SERIAL PRIMARY KEY,
  company_id INT NOT NULL,
  file_name TEXT NOT NULL,
  file_hash TEXT NOT NULL,
  storage_path TEXT NOT NULL,
  uploaded_at TIMESTAMP NOT NULL DEFAULT now(),
  uploaded_by INT,
  source_engine VARCHAR(20)  -- flask | fastapi
);                                                    	                                                                                                                                                                                           •	所有上传（信用卡、银行月结单、POS日报）不管能不能解析都要先写这张表
•	不允许因为“解析失败”就不存

11.2 原始文本表                                                                                                                                                                                                            CREATE TABLE raw_lines (
  id SERIAL PRIMARY KEY,
  raw_document_id INT NOT NULL,
  line_no INT NOT NULL,
  page_no INT,
  raw_text TEXT NOT NULL,
  parser_version VARCHAR(50),
  created_at TIMESTAMP NOT NULL DEFAULT now()
);                                                                                            	•	解析成功后，把每一行原文写进去
	•	以后可以对账：PDF 有 87 行 → 系统也要有 87 行

11.3 禁止虚构记录
	•	所有 parsed_transactions / 入账前的数据表，都必须带 raw_line_id 外键
	•	没有 raw_line_id 的记录一律拒绝入库
	•	用这个来防止系统自己“想出来”的交易

11.4 行数对账（强制）

写死规则：

如果原始文件有 N 行交易，而成功解析 < N，则本文件不得直接入账，必须写入 pending_documents，并在异常中心标注 MISSING_ROWS。

11.5 不可变校验（hash）
	•	上传后立刻算 file_hash
	•	architect 审查时必须对比 hash，一致才算通过

⸻

12. 配置版本锁（防“失忆重设”）
	1.	新建表：                                                                                                                                                                                                            CREATE TABLE system_config_versions (
  id SERIAL PRIMARY KEY,
  version_no VARCHAR(50) NOT NULL,
  changed_by INT,
  change_reason TEXT,
  diff JSONB,
  architect_status VARCHAR(20),  -- pending / approved / rejected
  created_at TIMESTAMP NOT NULL DEFAULT now()
);                                                                                                          	2.	所有“解析规则修改 / 文件目录规则修改 / 报表生成逻辑修改”都要写进这张表
	3.	architect_status != 'approved' 的版本不能被生产路由使用

⸻

13. Architect 审查模板（固定）

以后每次你生成新功能或改现有功能，请按照下面6条自动检查，全部通过才算 architect approved：
	1.	是否保证：上传的原始文件已经写入 raw_documents，并生成了不可变的 file_hash？
	2.	是否把 PDF/CSV 的每一行原文写入 raw_lines（或等价表），并且业务层的交易都能追溯到具体的 raw_line_id？
	3.	是否新增了任何会“自动生成不存在的交易”的逻辑？如有，必须禁止，改为写入 pending_documents。
	4.	是否仍然保持统一文件路径规则 /files/{company_id}/{module}/{year}/{month}/...？如果有旧路径，请生成迁移脚本。
	5.	是否更新了 system_config_versions 并记录本次改动原因？
	6.	若本次改动涉及报表，是否保证报表生成时优先走已冻结的 snapshot 而不是重新计算？

只有以上6条都满足，才算 architect approved。

⸻

14. 文档同步

请把本次所有内容补进：
	•	《系统完整功能说明书》
	•	API 文档（Swagger / ReDoc）
	•	部署文档（加入 env：X_TASK_TOKEN, USE_MATERIALIZED_VIEWS, ASYNC_PDF_EXPORT）

确保和现有的所有张表的命名风格一致。
