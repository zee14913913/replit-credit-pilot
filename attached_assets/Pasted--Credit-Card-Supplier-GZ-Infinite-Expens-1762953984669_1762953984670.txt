更新版最终交付文件，
在原来的《Credit Card 页面完整功能说明》基础上，
我已正式整合你的最新会计规则：

Supplier 的信用卡消费属于 GZ 消费交易（Infinite Expense），但自动计入的 1% merchant fee 独立计算，归入信用卡 Owner 的应付款项。
GZ 只支付 Supplier 的消费本金，不承担手续费。

下面是整合后的完整版本——这是你可以直接交给 Replit 团队实施的最终文档。
它保持系统逻辑不变，但强化账务划分、数据库字段、结算算法、发票与报表逻辑。

💳《Credit Card Ledger 页面完整功能与逻辑蓝图（更新版 v5.1）》
🎯 页面入口

路由：/credit-card/ledger
访问权限：Admin 或 Accountant
访问控制：未登录跳转登录页；登录后返回原路径。

🏗️ 页面总体结构（4大核心模块）
模块	功能目标
1️⃣ 上传账单模块	自动导入信用卡账单并智能分类
2️⃣ 客户列表模块	管理所有客户的账单及时间线
3️⃣ 供应商发票模块	自动生成 Supplier 发票与手续费分摊
4️⃣ 付款收据模块	管理客户与 GZ 的付款记录
1️⃣ 上传账单模块（Upload Credit Card Statements）

功能目标：上传 → 自动解析 → 智能分类 → 自动归档 → 双重验证

上传支持格式：

PDF（OCR文本识别）

Excel（数据表结构）

批量上传：后台异步处理，防止阻塞

自动识别内容：

银行类型（Maybank、CIMB、UOB、OCBC、HLB）

账单周期与到期日

卡号后四位 + 客户名绑定

金额校验（DR/CR对称）

验证机制：

OCR验证 + 金额验证（双重验证）

置信度评分 ≥95% 自动通过；低于则标记“requires_review”

重复检测（同卡同月不重复插入）

文件归档路径：

static/uploads/customers/{customer_code}/credit_card_statements/{YYYY-MM}/

2️⃣ 客户账单列表（Customer List）

显示所有已上传账单的客户：

列名	含义
CUSTOMER CODE	客户代号（如：Be_rich_CJY）
CUSTOMER NAME	客户全名
STATEMENT COUNT	已上传账单数量
ACTIONS	“VIEW TIMELINE” 按钮进入时间线视图

📊 界面设计

热粉色边框（#FF007F）

黑色背景 + 悬停高亮效果

顶部显示客户总数

3️⃣ 供应商发票模块（Supplier Invoices）
📌 功能逻辑更新（重点修改）

当系统识别到 Supplier 消费交易 时：

主交易（消费金额）计入 INFINITE Ledger（GZ代付）

自动计算 1% 手续费，单独生成一条 OWNER Ledger（客户负担） 记录

GZ 只支付 Supplier 的消费本金，不支付手续费。

🔹 举例：
交易描述	金额	分类	说明
7SL TECH SDN BHD	RM 1,000.00	infinite_expense	GZ代付消费
7SL TECH SDN BHD - Merchant Fee	RM 10.00	owner_expense_fee	客户承担1%手续费

系统后台自动生成两条记录，绑定同一交易日期与Supplier名。

🔹 自动化处理流程

分类识别：匹配 7大 Supplier 清单

['7sl', 'dinas', 'raub syc hainan', 'ai smart tech', 'huawei', 'pasar raya', 'puchong herbs']


计算手续费：

supplier_fee = round(abs(amount) * 0.01, 2)


记录分账：

Infinite Expense → GZ支付

Owner Fee Expense → 客户应付

账本结算公式：

GZ账本：

gz_balance = prev_gz_balance + infinite_expenses - infinite_payments


Owner账本：

owner_balance = prev_owner_balance + owner_expenses + owner_fees - owner_payments


发票生成：

仅包含 Supplier 本金消费（不含手续费）

PDF自动生成，文件名格式：

INV-{customer_code}-{YYYYMM}-{supplier_name}.pdf


手续费部分会在月结报告中单独汇总，不生成独立发票。

归档结构：

static/exports/customers/{customer_code}/invoices/{YYYY-MM}/

📊 发票汇总界面
发票编号	日期	客户	供应商	金额	手续费	总计	操作
INV-BRICH-202511-7SL	2025-11-05	CHEOK JUN YOON	7SL TECH	1000	10	1010	VIEW
🧮 月结报表更新字段：
字段名	说明
total_supplier_spend	当月 Supplier 消费总额（GZ支付）
total_supplier_fee	当月 Supplier 手续费（Owner支付）
total_infinite_payments	GZ还款总额
total_owner_payments	客户还款总额
4️⃣ 付款收据模块（Payment Receipts）

功能：

记录客户付款到 GZ 的每笔交易

关联账单与客户姓名

核对 GZ账户银行流水（交叉验证）

区分付款来源（客户本名 vs 公司账户 vs 第三方）

验证逻辑：

if payer_name in [customer_name, aliases]:
    category = 'owner_payment'
elif payer_name in GZ_BANK_LIST:
    category = 'infinite_payment'
else:
    category = 'third_party_payment'

🔄 时间线视图（Timeline View）

路径：/credit-card/ledger/{customer_id}/timeline
显示该客户每月账单变化趋势。

内容：

月度时间轴（最新→最旧）

按银行分组显示

各月关键指标：

指标	说明
Previous Balance	上期余额
Owner Expenses	个人消费（含手续费）
Owner Payments	客户付款
GZ Expenses	代付消费
GZ Payments	GZ付款
Closing Balance	月末余额
📘 月度结算验证逻辑（核心算法）

系统执行三层验证，确保所有交易 100% 对账正确：

1️⃣ 交易数量验证

assert total_transactions == (owner_expense_count + infinite_expense_count + payments_count)


2️⃣ 金额合计验证

assert round(abs(sum_original) - abs(sum_categorized), 2) <= 0.1


3️⃣ 账单金额匹配验证

assert abs((owner_balance + gz_balance) - statement_total) <= 0.01


若失败：

自动标记“requires_review”

触发审计记录 + 邮件警告

📄 报表与导出
月度汇总报告（PDF/Excel）
项目	公式	说明
Previous Balance	PDF上一期余额	初始参考点
Owner Expenses	客户消费总额	不含Supplier交易
Owner Fees	Supplier手续费总额	自动分账
GZ Expenses	Supplier代付消费	GZ支付
Owner Payments	客户付款	CR类型
GZ Payments	GZ付款	CR类型
Owner Balance	上期 + 消费 + 手续费 - 付款	计算余额
GZ Balance	上期 + 消费 - 付款	计算余额
🧩 数据库表新增字段（供开发实施）
表名	新增字段	类型	说明
transactions	is_fee_split	BOOLEAN	是否已拆分手续费
fee_reference_id	UUID	关联原Supplier交易	
category	VARCHAR	owner_expense / infinite_expense / owner_fee / payments	
supplier_name	VARCHAR	供应商名称	
supplier_fee	DECIMAL(10,2)	手续费金额	
payer_name	VARCHAR	付款人	
verified	BOOLEAN	审核标记	
🔐 安全与合规

文件格式验证（仅PDF/Excel）

上传大小限制

防重复导入保护

所有导入操作写入 audit_logs

GZ与Owner账本分开核算（独立balance字段）

计算日志全程可追溯（防止人工干预）

⚙️ 技术与前端设计规范
元素	规范
主色	Hot Pink #FF007F
辅色	Dark Purple #322446
背景	Black
字体	Pearl White
标题字重	900
区块间距	主5rem / 子3rem
表格	响应式 + 悬停高亮
上传区	折叠式，隐藏表单默认关闭
按钮	渐变边框 + 阴影
✅ 系统运行结果预期

上传账单 → 自动识别分类 → GZ与Owner账本独立核算

Supplier消费 + 1%手续费自动拆分

GZ仅付款 Supplier 本金，Owner负责手续费与自有消费

报表完全平衡，差额=0

系统自动生成 PDF发票与汇总报告

🚀 可交付开发文件（交给Replit）
文件	作用
/routers/supplier_invoices.py	增加fee_split逻辑
/services/reconciliation_engine.py	新增双账本结算
/templates/credit_card_ledger.html	更新前端展示字段（手续费独立显示）
/core/db/schema_extensions.sql	新增字段定义
/tasks/monthly_close.py	自动生成手续费记录与汇总