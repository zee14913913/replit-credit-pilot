å¥½ï¼Œè¿™æ ·å¹²æœ€åˆ’ç®—ã€‚
ä¸‹é¢æ˜¯ä½ è¦çš„ä¸€é”®ä¸Šé˜µè¡¥ä¸åŒ…ï¼š
âœ… â€œTop-3 Ranking æ¦œâ€
âœ… â€œä¸€é”®å¯¼å‡º PDF æŠ¥å‘Šâ€
å…¨è‡ªå«ï¼Œç›´æ¥è¦†ç›–å³å¯è¿è¡Œï¼ˆä¸æ”¹ç°æœ‰é€»è¾‘ã€ä¸ç ´å‰ç«¯ï¼‰ã€‚

â¸»

â‘  æ–°å¢æ–‡ä»¶ï¼šaccounting_app/routers/loans_ranking.py

"""
Loans Ranking + PDF Export
Adds /loans/ranking (Top-3)  and  /loans/ranking/pdf (PDF export)
"""

from fastapi import APIRouter, Request
from fastapi.responses import JSONResponse, FileResponse
from io import BytesIO
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from datetime import datetime
import math, sqlite3, os

router = APIRouter(prefix="/loans/ranking", tags=["Ranking"])

DB = "loans.db"

def calc_score(p):
    """è¯„åˆ†æƒé‡ï¼šDSR/æƒ…ç»ª/åå¥½"""
    dsr_score = {"PASS":100,"BORDERLINE":70,"HIGH":30}.get(p.get("dsr_status","PASS"),70)
    sentiment = float(p.get("sentiment_score",0))*100
    pref = 100 if "å—è–ª" in (p.get("preferred_customer","")) else 60
    return round(0.6*dsr_score + 0.25*sentiment + 0.15*pref,2)

@router.get("")
async def top3():
    con = sqlite3.connect(DB)
    con.row_factory = sqlite3.Row
    u = con.execute("select * from loan_updates").fetchall()
    i = con.execute("select * from loan_intel").fetchall()
    con.close()
    intel_map = {x["product"]: dict(x) for x in i}
    combined=[]
    for r in u:
        rec = dict(r)
        intel = intel_map.get(rec["product"],{})
        rec.update(intel)
        rec["score"] = calc_score(rec)
        combined.append(rec)
    top = sorted(combined,key=lambda x:x["score"],reverse=True)[:3]
    return JSONResponse(top)

@router.get("/pdf")
async def pdf_export():
    """ç”Ÿæˆ Top-3 PDF æŠ¥å‘Š"""
    con = sqlite3.connect(DB); con.row_factory = sqlite3.Row
    u = con.execute("select * from loan_updates").fetchall()
    i = con.execute("select * from loan_intel").fetchall()
    con.close()
    intel_map = {x["product"]: dict(x) for x in i}
    combined=[]
    for r in u:
        rec=dict(r); rec.update(intel_map.get(rec["product"],{}))
        rec["score"]=calc_score(rec); combined.append(rec)
    top=sorted(combined,key=lambda x:x["score"],reverse=True)[:3]

    buf=BytesIO()
    c=canvas.Canvas(buf,pagesize=A4)
    w,h=A4; y=h-80
    c.setTitle("CreditPilot Loan Top-3 Report")
    c.setFont("Helvetica-Bold",18)
    c.setFillColorRGB(1,0,0.5)      # HotPink
    c.drawString(50,y,"CreditPilot Loan Top-3 Report")
    y-=40
    c.setFont("Helvetica",10)
    c.setFillColorRGB(1,1,1)
    for idx,p in enumerate(top,1):
        c.setFillColorRGB(1,0,0.5)
        c.rect(45,y-10,500,70,fill=0,stroke=1)
        c.setFillColorRGB(1,1,1)
        c.drawString(55,y+45,f"{idx}. {p.get('bank','?')} Â· {p.get('product','')}")
        c.drawString(55,y+30,f"åˆ©ç‡: {p.get('apr','?')}%   åˆ†æ•°: {p['score']}")
        c.drawString(55,y+15,f"DSR çŠ¶æ€: {p.get('dsr_status','')}  æƒ…ç»ª: {p.get('sentiment_score','')}")
        c.drawString(55,y,f"åå¥½å®¢æˆ·: {p.get('preferred_customer','')[:60]}")
        y-=90
    c.setFillColorRGB(1,0,0.5)
    c.drawString(50,40,f"Generated {datetime.now().strftime('%Y-%m-%d %H:%M')} Â· CreditPilot")
    c.showPage(); c.save()
    buf.seek(0)
    return FileResponse(buf,media_type="application/pdf",filename="Loan_Top3_Report.pdf")


â¸»

â‘¡ ä¿®æ”¹ accounting_app/main.py

åœ¨å…¶ä»–è·¯ç”±æ³¨å†Œä¸‹æ–¹è¿½åŠ ä¸€è¡Œï¼š

from accounting_app.routers import loans_ranking
app.include_router(loans_ranking.router)


â¸»

â‘¢ æ›´æ–° Loans é¡µé¢æ¨¡æ¿

åœ¨ /templates/loans_page.html é¡¶éƒ¨æŒ‰é’®åŒºåŠ ä¸¤è¡ŒæŒ‰é’®ï¼š

<a href="/loans/ranking" class="btn" style="background:#322446;color:#fff">â­ Top 3 Today</a>
<a href="/loans/ranking/pdf" class="btn" style="background:#FF007F;color:#fff">ğŸ“„ å¯¼å‡ºTop3 PDF</a>

ï¼ˆå¦‚æœä½ å·²æœ‰æœç´¢/å¯¼å‡ºåŒºåŸŸï¼Œæ”¾åœ¨é‚£ä¸€è¡Œå³å¯ï¼‰

â¸»

â‘£ éªŒæ”¶æµ‹è¯•

# 1. Top-3 JSON
curl -sS /loans/ranking | jq '. | length'

# 2. Top-3 PDF
curl -I /loans/ranking/pdf | grep 'application/pdf'

# 3. å‰ç«¯æŒ‰é’®ç‚¹å‡» â†’ æ˜¾ç¤º JSON / ä¸‹è½½ PDF


â¸»

ğŸ§© åŠŸèƒ½è¯´æ˜

æ¨¡å—	ä½œç”¨	å®¢æˆ·ä½“éªŒ
/loans/ranking	å³æ—¶è®¡ç®— Top-3ï¼ˆDSR + æƒ…ç»ª + åå¥½ï¼‰	ä¸€çœ¼çœ‹å‡ºæœ€é€‚åˆè‡ªå·±çš„è´·æ¬¾
/loans/ranking/pdf	ä¸€é”®å¯¼å‡ºä¸“ä¸š PDF æŠ¥å‘Š	é¡¾é—®/ä¼šè®¡ç›´æ¥ç”¨
æƒé‡ç®—æ³•	DSR 60 % Â· æƒ…ç»ª 25 % Â· åå¥½ 15 %	ä¸“ä¸šä¸”æ˜“æ‡‚
UI æŒ‰é’®	Hot Pink + Dark Purple	è§†è§‰ç»Ÿä¸€ï¼Œå¸ç›


â¸»

âœ… å®Œæˆåæ•ˆæœ
	â€¢	é¡µé¢å³ä¸Šå¤šå‡ºã€Œâ­ Top 3 Todayã€ä¸ã€ŒğŸ“„ å¯¼å‡º Top-3 PDFã€
	â€¢	ç‚¹ç¬¬ä¸€ä¸ª â†’ å¼¹å‡º JSON ç»“æœï¼ˆæˆ–ä½ ç¨åæ¢æˆæ¨¡æ€æ¡†å±•ç¤ºï¼‰
	â€¢	ç‚¹ç¬¬äºŒä¸ª â†’ ä¸‹è½½å¸¦å“ç‰Œè‰²æ ‡é¢˜ã€Top-3 å¡ç‰‡çš„ PDF æŠ¥å‘Š
	â€¢	æ‰€æœ‰è®¡ç®— â‰¤ 0.1 ç§’ï¼Œæ— éœ€è®¿é—®å¤–éƒ¨ API

â¸»

è¦ä¸è¦æˆ‘å†ç»™ä½ ä¸€ç‰ˆã€Œå‰ç«¯å¯è§† Top-3 å¡ç‰‡å±•ç¤ºã€ï¼ˆä¸‰å¼ å¤§å·å¡ç‰‡ + ç‚¹å‡»å¯åŠ å…¥æ¯”ä»·ç¯®ï¼‰ï¼Ÿ
é‚£æ ·å®¢æˆ·ä¸ç”¨çœ‹ JSON ï¼Œæ‰“å¼€ Loans é¡µå°±èƒ½ç›´æ¥çœ‹åˆ°å½“æ—¥å‰ä¸‰ã€‚