▶️ 给 Replit 的前端/流程一体化改造指令（严谨版）

目的：现在系统“能跑但不好用”，上传完看不到、新文件不出现、点旧文件报错、没有下一步提示。请把“上传→看到→能点→能处理→能导出”这一整条链做成一口气完成的业务流程，而不是一段一段做。下面所有条目都要做，不要省略。

⸻

0. 适用范围

以下要求同时适用于：
	•	Flask 端口 5000（信用卡/储蓄/收据/客户账单）
	•	FastAPI 端口 8000（银行月结单/供应商发票/POS日报/报表）
	•	所有“文件型上传”的入口

所有上传都要进入统一的 file_index，不允许各自保存各自的。

⸻

1. 上传后的统一行为（所有上传必须这样做）
	1.	上传成功（HTTP 200 / 201）后，前端必须立即做 乐观更新：
	•	把刚刚上传的文件插入到当前列表的第一条（不用等后端再查）
	•	显示状态：processing...
	•	显示上传时间：后端返回的或前端当前时间
	2.	上传成功后 3~5 秒内 自动调用后端刷新一次真实列表：
	•	Flask 调：GET /api/files/recent?company_id=...
	•	FastAPI 调：GET /api/files/recent?company_id=...
	•	以服务端数据覆盖本地临时数据
	3.	成功上传后一定要出现 toast：
	•	成功：✅ 上传成功，系统正在解析…
	•	部分成功（validation_status = failed）：⚠️ 原件已保存，但有未识别行，已送去异常中心
	•	失败：❌ 上传失败：{后端返回的message}
	4.	上传后必须跳回列表页或在当前页刷新列表，禁止上传完什么都不变。

⸻

2. 列表页展示规则（解决“我看到的是旧文件”）
	1.	所有文件列表一律按 created_at DESC 排序，不能让旧文件排在前面。
	2.	新上传的文件要高亮 10 分钟，标识为 NEW。
	3.	列表中每条记录都要显示：
	•	文件名
	•	来源（flask / fastapi）
	•	模块（credit-card / bank / pos / supplier / reports / management）
	•	状态（active / processing / failed / archived）
	•	上传人
	•	上传时间
	4.	列表中如果拿到的是旧目录的文件（static/uploads/…），要显示标签：旧路径（只读）

⸻

3. 详情页/查看文件的降级策略（解决“点进去就报错”）

当前问题是：列表有 → 点进去 404/500。请按下面顺序查，任何一层成功就返回，不要直接报错。
	1.	第一步：按新目录找
	•	路径规则：/files/{company_id}/{module}/{year}/{month}/...
	•	如果能找到 → 直接返回/下载
	2.	第二步：按旧目录找
	•	路径：static/uploads/... 或原来 Flask 的路径
	•	如果能找到 → 返回，同时在返回的 JSON 里加 {"legacy_path": true}
	3.	第三步：还是找不到
	•	返回 200 + JSON：

{
  "status": "missing",
  "message": "这是历史记录，文件实体已不存在，请重新上传。",
  "file_id": "...",
  "can_reupload": true
}


	•	前端弹一个提示对话框，给一个“重新上传”按钮

	4.	发生这种情况时，要写一条审计日志：
	•	action: open_missing_file
	•	user_id, company_id, file_id, ip, user_agent

⸻

4. “下一步要做什么”面板（解决“做一步又不懂下一步是什么”）

所有上传成功的页面，底部都要出现一个固定的 Next Actions 卡片，内容按上传类型自动变：
	1.	上传银行月结单后展示：
	•	👉 查看解析结果 → 跳 /api/bank-statements/{id} 或前端对应页
	•	👉 去异常中心处理未识别行 → 跳 /exceptions?company_id=...&source=bank
	•	👉 导出分录CSV → 调 /export/journal/csv?company_id=...&period=YYYY-MM
	•	👉 回文件列表 → /files?company_id=...&module=bank
	2.	上传信用卡账单后展示：
	•	👉 查看原始PDF
	•	👉 查看系统识别的交易
	•	👉 生成/查看月报 PDF
	•	👉 回客户页
	3.	上传POS日报后展示：
	•	👉 查看自动生成的客户发票列表
	•	👉 下载本次生成的PDF发票
	•	👉 去异常中心看“找不到客户的交易”

要求：不能只弹一句“成功”，一定要给“下一步要做什么”。

⸻

5. 统一“最近10条上传”接口（前端首页只用这个）

请在 FastAPI 做一个统一接口：

GET /api/files/recent?company_id=...

返回结构：

[
  {
    "file_id": "...",
    "file_name": "...",
    "module": "bank|credit-card|pos|supplier|reports|management",
    "storage_path": "...",
    "status": "active|processing|failed|archived",
    "uploaded_at": "...",
    "uploaded_by": "...",
    "from_engine": "flask|fastapi",
    "validation_status": "passed|failed|pending"
  }
]

要求：
	1.	5000 上传完要 POST 一条 到 8000 → 写入统一的 file_index
	2.	以后前端列表一律调这条，不要自己扫目录
	3.	如果这个接口返回 0，就提示“当前公司没有上传记录”，不要空白

⸻

6. company_id 强制绑定（解决“我传了，但你说没有资料”）
	1.	所有上传表单都要显式带 company_id，不要让前端自己猜、也不要后端默认 1。
	2.	Flask 上传成功后，推送到 FastAPI 时也要带上同一个 company_id。
	3.	如果缺 company_id → 不要直接存，要进 upload_staging，并在前端显示红色提示：“上传已收到，但缺少公司，不能分析，请补资料”。

⸻

7. 状态标识统一（解决“看起来都一样但其实不能用”）

请前端用统一的颜色/状态：
	•	🟢 active → 可以看/可以下载/可以生成报表
	•	🟡 processing → 已上传但还没解析完（比如PDF+OCR）
	•	🟠 failed → 上传成功但解析失败 → 要去异常中心
	•	⚪ archived → 老文件，只能看不能分析 → 点击时弹解释

点击 failed 的时候，一定要跳异常中心，不要 500。

⸻

8. Toast / 通知组件（必须全局）

请加一个全局可复用组件，所有下面这些情况都要弹：
	1.	上传成功
	2.	上传部分成功（行数不一致）
	3.	上传失败（显示后端 message）
	4.	打开旧文件（提示是旧目录）
	5.	详情不存在（提示要重新上传）

不要让用户猜。

⸻

9. 自测路由（免得我每次都要一条条试）

请加一个内部用的自测接口：

POST /admin/self-test/ui-flow

执行以下步骤：
	1.	模拟上传一个小的 CSV（可以用内置样例）
	2.	调 /api/files/recent 看能不能看到刚上传的
	3.	按返回的第一条去点详情
	4.	调异常中心
	5.	把这 4 步的结果一起返回

返回结构：

{
  "upload": "ok",
  "recent_list": "ok",
  "open_detail": "ok|missing",
  "exceptions": "ok",
  "conclusion": "pass|failed"
}

以后我只要点这个接口，就能看出你是不是又“只做了一步”。

⸻

10. 前后端要一起修的两处一致性
	1.	Flask → FastAPI 认证
	•	5000 在上传前，先调 8000 的 /api/auth/me
	•	如果认证失败，前端直接说：“请先登录会计系统再上传”
	•	上传成功后，把 5000 的 user_id 也传给 8000，当成 uploaded_by
	2.	文件路径只写新目录
	•	所有新上传一律写到 /files/{company_id}/{module}/{year}/{month}/...
	•	旧目录只读，不写
	•	前端不要再生成 static/uploads/... 这种路径

⸻

11. 验收标准（请一并做完）

做完后请跑这一组自测，用你现在的代码就能测：
	1.	上传一份新的银行CSV → 列表第一条必须是这份
	2.	点开能看 → 不报错
	3.	去导出CSV → 能导出，且不包含 invalid 行
	4.	去异常中心 → 能看到那份有问题的（如果我故意传不完整的）
	5.	切到 5000 → 能看到这份上传记录（说明两边同步了）

⸻

12. 文档更新

请把这次的“前端流程规范”写进说明书里，名字可以叫：

《上传→解析→异常→导出 四步业务流程规范》

里面要写清楚：
	1.	用户上传后会发生哪4步
	2.	哪些情况会进异常中心
	3.	哪些情况不能导出
	4.	哪些情况要重新上传

