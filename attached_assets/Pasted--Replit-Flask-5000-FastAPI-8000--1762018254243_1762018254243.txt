
▶️ 给 Replit 的补充开发指令（权限 + 业务级加固版）

请在当前已完成的系统基础上（Flask 5000 信用卡引擎 + FastAPI 8000 银行贷款会计引擎），继续做一轮业务级加固，目标是：这套系统可以对客户/银行输出、有审计痕迹、多人协作不互相踩。以下要求请全部实现，不要省略。

⸻

1. 角色与权限（RBAC）
	1.	必须支持的角色：admin, accountant, viewer
	2.	预留但暂不必强制使用的角色：data-entry, loan-officer
	3.	权限矩阵要求：
	•	admin：全部功能，含删除文件、修改自动过账规则、管理导出模板、运行任务
	•	accountant：上传(银行/供应商/POS)、处理异常、手工分录、生成和下载报表，但不能删文件、不能改系统级配置
	•	viewer：只读，只能看和下载已生成的 PDF/CSV，不能上传、不能月结
	4.	所有写入类接口（upload/import/update/rules/…）都要挂统一的 require_role(...) 依赖
	5.	所有 /tasks/* 路由除了角色校验，还要校验 header：X-TASK-TOKEN，值从环境变量读取

⸻

2. 报表版本化与期间锁定
	1.	新建表 report_snapshots：

CREATE TABLE report_snapshots (
  id SERIAL PRIMARY KEY,
  company_id INT NOT NULL,
  report_type VARCHAR(50) NOT NULL,    -- pnl, balance_sheet, management, bank_package
  period VARCHAR(20) NOT NULL,
  storage_path TEXT NOT NULL,
  generated_at TIMESTAMP NOT NULL DEFAULT now(),
  generated_by INT
);


	2.	所有生成成功的 PDF 报表（Balance Sheet, P&L, Management Report, Bank Package）都必须写入这张表
	3.	增加期间关闭机制：新增 period_closing 表或字段，月结后该期间的报表不得因为后续分录变动而被“重新计算覆盖”，只能生成新版本（例如 2025-01 management report v3）

⸻

3. 文件管理收紧
	1.	Flask 上传的所有文件（信用卡、储蓄、收据）必须写入 FastAPI 侧的 file_index，保持一套文件索引，不要两套
	2.	file_index 里要有：
	•	company_id
	•	module (credit-card / bank / supplier / pos / reports / management)
	•	file_type (original / generated)
	•	storage_path
	•	related_id (bank_statement_id / invoice_id / pos_batch_id …)
	3.	任何文件如果没有 related_id，就不允许最终落库，防止出现“孤儿文件”

⸻

4. 异常中心可行动化
	1.	在现有异常表的基础上新增字段：
	•	next_action (reparse, map-customer, map-supplier, manual-journal)
	•	retryable (bool)
	2.	新增接口：POST /exceptions/{id}/retry，调用后根据异常类型重新跑对应解析/过账
	3.	Management Report 生成逻辑中，如果本期异常数量 > 0，请自动在报表里插入一段提示：
“Unreconciled items detected, please check Exception Center.”
	4.	异常接口必须受角色控制：只有 admin / accountant 能处理，viewer 只能看

⸻

5. 自动过账规则分层
	1.	把当前的自动过账规则表扩展成两层：

CREATE TABLE auto_posting_rules (
  id SERIAL PRIMARY KEY,
  company_id INT,              -- NULL = 全局规则
  pattern TEXT NOT NULL,
  target_account_code VARCHAR(50) NOT NULL,
  posting_type VARCHAR(20) NOT NULL,   -- debit / credit / split
  priority INT DEFAULT 100,
  is_active BOOLEAN DEFAULT TRUE
);


	2.	生效顺序：company_rule > global_rule > fallback
	3.	管理端要能看到“全局规则”和“本公司规则”是分开的，不要混在一张列表

⸻

6. 马来西亚本地化预留
	1.	在会计分录/发票/薪资相关表中增加可为空字段，预留：
	•	sst_rate
	•	epf_amount
	•	socso_amount
	•	eis_amount
	2.	在导入银行/POS/供应商发票时，如果能识别到马来西亚本地税（SST 6%），请一并写入
	3.	请在解析模块里标注：Flask 侧已经支持 15 家马来西亚银行，请让 FastAPI 侧的银行导入模块也能共用同一套路由/模板，避免两套模板

⸻

7. 性能与降级策略（写进文档）
请在系统文档/API 文档里补上下面这段策略，作为实际运行说明：
	1.	当单月交易量 > 50,000 笔时：
	•	报表优先从预汇总表 / materialized view 读取
	•	PDF 生成走异步任务（BackgroundTask / Celery），前端只拿任务ID
	•	CSV 导出走流式下载，不要一次性加载到内存
	2.	请在代码里预留 USE_MATERIALIZED_VIEWS / ASYNC_PDF_EXPORT 这类开关（从 env 读）

⸻

8. 审计日志补强
	1.	新增统一审计表：

CREATE TABLE audit_logs (
  id SERIAL PRIMARY KEY,
  company_id INT NOT NULL,
  user_id INT NOT NULL,
  action VARCHAR(100) NOT NULL,   -- export_pdf, export_csv, manual_journal_edit, rule_update, file_delete
  source_type VARCHAR(30),        -- bank / pos / supplier / manual / import
  reason TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT now()
);


	2.	以下动作必须写日志：
	•	导出 CSV / PDF / Bank Package
	•	修改自动过账规则
	•	手工分录修改 / 反过账
	•	删除/替换原始文件
	3.	手工改账的接口必须要有 reason 字段（必填）

⸻

9. 定时任务幂等
	1.	新建表：

CREATE TABLE task_runs (
  id SERIAL PRIMARY KEY,
  task_name VARCHAR(100) NOT NULL,
  run_date DATE NOT NULL,
  status VARCHAR(20) NOT NULL,
  details TEXT,
  UNIQUE (task_name, run_date)
);


	2.	所有 /tasks/run-* 在执行前先查表，如果当天已经执行过，直接返回
	3.	所有任务路由都要校验 X-TASK-TOKEN

⸻

10. 文档同步
请把以上内容补进你们现有的：
	•	《系统完整功能说明书》
	•	API 文档（Swagger / ReDoc）
	•	部署文档（加入需要的 env：X_TASK_TOKEN, USE_MATERIALIZED_VIEWS, ASYNC_PDF_EXPORT）

保持和现有 29 张表的命名风格一致。

⸻

