å¯¹ï¼Œä½ ç†è§£å¯¹äº†ï¼šæˆ‘è¯´çš„æ˜¯åœ¨â€œå¯¹æ¯”é¡µâ€é‡Œç»™äº§å“åšä¸€ä¸ªè‡ªåŠ¨æ’åï¼ˆrankingï¼‰ï¼ŒæŠŠæœ€é€‚åˆçš„ç»„åˆæ”¾åˆ°æœ€ä¸Šé¢ï¼Œå®¢æˆ·ä¸€çœ¼å°±çŸ¥é“é€‰è°ã€‚

æˆ‘å·²ç»æŠŠâ€œæ’åç‰ˆå¯¹æ¯”é¡µâ€å†™å¥½ï¼Œä½ åªè¦ç”¨ä¸‹é¢è¿™ä¸ªå®Œæ•´æ–‡ä»¶è¦†ç›– accounting_app/templates/compare.html å°±è¡Œï¼Œåç«¯ä¸éœ€è¦æ”¹ã€‚é»˜è®¤æ’åºé€»è¾‘ï¼š
	1.	çŠ¶æ€ä¼˜å…ˆï¼šPASS â†’ BORDERLINE â†’ HIGH
	2.	å†æ¯”æœˆä¾›ï¼šè¶Šä½è¶Šå‰
	3.	å†æ¯” DSRï¼šè¶Šä½è¶Šå‰
å¹¶æ˜¾ç¤ºâ€œRank #â€åˆ—ï¼ŒTop 1 å¸¦å°çš‡å† ğŸ‘‘ï¼Œé¡¶éƒ¨è¿˜æœ‰â€œæœ¬é¡µæœ€ä½³æ¨èâ€ã€‚

â¸»

âœ… è¦†ç›–æ–‡ä»¶ï¼šaccounting_app/templates/compare.html

{% extends "base.html" %}
{% block content %}
<div class="card">
  <h3 style="margin-top:0">Compare Basket Â· è´·æ¬¾å¯¹æ¯”</h3>
  <p class="small">å·²æ·»åŠ çš„äº§å“ä¼šæ˜¾ç¤ºåœ¨ä¸‹æ–¹è¡¨æ ¼ã€‚è¾“å…¥è¯•ç®—å‚æ•°ï¼Œç‚¹å‡»â€œä¸€é”®é‡ç®—â€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—æ¯ä¸ªäº§å“çš„æœˆä¾›ã€DSRï¼Œå¹¶ç»™å‡ºæ’åã€‚</p>

  <div class="grid grid-cols-3" style="margin-top:8px">
    <div><label>è´·æ¬¾é‡‘é¢</label><input class="input" id="amt" value="400000"></div>
    <div><label>å¹´æœŸï¼ˆå¹´ï¼‰</label><input class="input" id="tenure" value="30"></div>
    <div><label>å¹´åˆ©ç‡æ¥æº</label>
      <select class="input" id="rateSrc">
        <option value="product">ä½¿ç”¨å„äº§å“åˆŠç™»åˆ©ç‡</option>
        <option value="custom">æ‰‹åŠ¨ç»Ÿä¸€åˆ©ç‡ï¼ˆä¸‹æ–¹è¾“å…¥ï¼‰</option>
      </select>
    </div>
    <div><label>ç»Ÿä¸€å¹´åˆ©ç‡(%)</label><input class="input" id="customRate" value="3.75"></div>
    <div><label>æœˆå‡€æ”¶å…¥</label><input class="input" id="income" value="8000"></div>
    <div><label>ç°æœ‰æœˆä¾›</label><input class="input" id="commit" value="1500"></div>
  </div>

  <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
    <button class="btn primary" onclick="recalc()">ä¸€é”®é‡ç®—</button>
    <a class="btn" href="/loans/page">è¿”å› Loans</a>
    <button class="btn" onclick="exportCsv()">å¯¼å‡ºå¯¹æ¯” CSV</button>
    <button class="btn" onclick="clearAll()">æ¸…ç©ºå¯¹æ¯”ç¯®</button>
  </div>
</div>

<!-- é¡¶éƒ¨æœ€ä½³æ¨èå¡ç‰‡ -->
<div id="topPick" class="card" style="margin-top:14px; display:none">
  <h3 style="margin:0">æœ¬é¡µæœ€ä½³æ¨è Â· Top Pick</h3>
  <div id="topPickBody" class="small" style="margin-top:6px"></div>
</div>

<div class="card" style="margin-top:14px">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
    <h3 style="margin:0">å¯¹æ¯”ç»“æœ</h3>
    <div class="small">æç¤ºï¼šåˆ—å¤´å¯æ’åºï¼ˆå†æ¬¡ç‚¹å‡»åˆ‡æ¢å‡/é™ï¼‰ã€‚ç³»ç»Ÿé»˜è®¤æŒ‰â€œçŠ¶æ€â†’æœˆä¾›â†’DSRâ€è‡ªåŠ¨æ’åã€‚</div>
  </div>
  <table class="table" id="tbl" style="margin-top:8px">
    <thead>
      <tr>
        <th data-k="rank" class="sortable">Rank #</th>
        <th data-k="bank" class="sortable">é“¶è¡Œ/æœºæ„</th>
        <th data-k="product" class="sortable">äº§å“</th>
        <th data-k="apr" class="sortable">å¹´åˆ©ç‡</th>
        <th data-k="monthly" class="sortable">æœˆä¾›</th>
        <th data-k="dsr" class="sortable">DSR%</th>
        <th data-k="status" class="sortable">è¯„ä¼°</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
let basket = [];     // [{source, product}]
let updates = [];    // /loans/updates åˆ—è¡¨
let merged  = [];    // åˆå¹¶ + è®¡ç®—åçš„è¡Œ
let sortKey = 'rank', sortAsc = true; // é»˜è®¤æŒ‰ rank å‡åº

// â€”â€” å·¥å…· â€”â€” //
function pctToFloat(s){
  if(!s) return NaN;
  const m = (''+s).match(/[\d.]+/);
  return m ? parseFloat(m[0]) : NaN;
}
function annToMonthlyPayment(amount, annualPercent, years){
  const n = years*12;
  const r = (annualPercent/100)/12;
  if(!isFinite(r) || r<=0) return amount / Math.max(n,1);
  return amount * (r*Math.pow(1+r,n)) / (Math.pow(1+r,n)-1);
}
function statusByDsr(d){
  return d<60 ? 'PASS' : (d<70 ? 'BORDERLINE' : 'HIGH');
}
function statusWeight(s){
  if(s==='PASS') return 0;
  if(s==='BORDERLINE') return 1;
  return 2; // HIGH
}
function fmt2(x){ return isFinite(x) ? x.toFixed(2) : '-'; }
function esc(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }
function crown(i){ return i===1 ? ' ğŸ‘‘' : ''; }

// â€”â€” ä¸»æµç¨‹ â€”â€” //
async function load(){
  // 1) å¯¹æ¯”ç¯®
  const bj = await fetch('/loans/compare/json').then(r=>r.json());
  basket = bj.items || [];

  // 2) äº§å“æ¸…å•
  updates = await fetch('/loans/updates').then(r=>r.json());

  // 3) åˆå¹¶
  merged = basket.map(b=>{
    const row = updates.find(u=>u.source===b.source && u.product===b.product) || {};
    return {
      source: b.source,
      bank: row.bank || row.source || '',
      product: b.product,
      apr: row.rate || '',
      summary: row.summary || '',
      pulled_at: row.pulled_at || ''
    };
  });

  recalc(); // åˆæ¬¡è®¡ç®— + æ’å + æ¸²æŸ“
}

function recalc(){
  const amount = +document.getElementById('amt').value;
  const tenure = +document.getElementById('tenure').value;
  const income = +document.getElementById('income').value;
  const commit = +document.getElementById('commit').value;
  const rateSrc= document.getElementById('rateSrc').value;
  const custom = +document.getElementById('customRate').value;

  // è®¡ç®—æœˆä¾›/DSR/çŠ¶æ€
  merged = merged.map(r=>{
    const aprVal = rateSrc==='custom' ? custom : pctToFloat(r.apr);
    const monthly = annToMonthlyPayment(amount, aprVal, tenure);
    const dsr = ((commit + monthly) / Math.max(income,1))*100;
    const status = statusByDsr(dsr);
    return {
      ...r,
      apr: (rateSrc==='custom' ? (custom+'%') : r.apr),
      apr_num: aprVal,
      monthly, dsr, status,
      _w: statusWeight(status)
    };
  });

  // è‡ªåŠ¨æ’åï¼šçŠ¶æ€æƒé‡ â†’ æœˆä¾› â†’ DSR
  merged.sort((a,b)=>{
    if(a._w !== b._w) return a._w - b._w;                // PASS ä¼˜å…ˆ
    if(a.monthly !== b.monthly) return a.monthly - b.monthly; // æœˆä¾›è¶Šä½è¶Šå¥½
    return a.dsr - b.dsr;                                  // DSR è¶Šä½è¶Šå¥½
  });
  // å†™å…¥ rankï¼ˆ1-basedï¼‰
  merged = merged.map((r,i)=> ({...r, rank: i+1}));

  // é»˜è®¤å±•ç¤ºæŒ‰ rank å‡åº
  sortKey = 'rank'; sortAsc = true;

  render();
  renderTopPick();
}

function renderTopPick(){
  const card = document.getElementById('topPick');
  const body = document.getElementById('topPickBody');
  if(!merged.length){ card.style.display='none'; return; }
  const t = merged[0];
  card.style.display='block';
  body.innerHTML = `
    <div><b>${esc(t.bank)} Â· ${esc(t.product)}</b>${crown(1)}</div>
    <div>å¹´åˆ©ç‡ï¼š${esc(t.apr||'-')} ï½œ é¢„è®¡æœˆä¾›ï¼šRM ${fmt2(t.monthly)} ï½œ DSRï¼š${fmt2(t.dsr)}% ï½œ çŠ¶æ€ï¼š${esc(t.status)}</div>
    <div class="muted">æ•°æ®æ—¶é—´ï¼š${esc(t.pulled_at||'-')} ï½œ æ‘˜è¦ï¼š${esc(t.summary||'æ— ')}</div>
  `;
}

function render(){
  // ç”¨æˆ·è‡ªå®šä¹‰æ’åºï¼ˆå¦‚æœç‚¹å‡»äº†è¡¨å¤´ï¼‰
  const key = sortKey, asc = sortAsc;
  merged.sort((a,b)=>{
    const A = (a[key] ?? '');
    const B = (b[key] ?? '');
    if(typeof A === 'number' && typeof B === 'number') return asc ? (A-B) : (B-A);
    return asc ? (''+A).localeCompare(''+B) : (''+B).localeCompare(''+A);
  });

  const tb = document.getElementById('rows');
  tb.innerHTML = merged.map(r=>`
    <tr>
      <td>${r.rank}${crown(r.rank)}</td>
      <td>${esc(r.bank)}</td>
      <td>${esc(r.product)}</td>
      <td>${esc(r.apr||'-')}</td>
      <td>RM ${fmt2(r.monthly)}</td>
      <td>${fmt2(r.dsr)}%</td>
      <td><span class="badge" style="border-color:${badgeColor(r.status)};color:${badgeColor(r.status)}">${r.status}</span></td>
      <td><button class="btn" onclick="removeItem('${esc(r.source)}','${esc(r.product)}')">ç§»é™¤</button></td>
    </tr>
  `).join('');

  // è¡¨å¤´äº¤äº’
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.onclick = ()=>{
      const k = th.dataset.k;
      if(sortKey===k){ sortAsc = !sortAsc; } else { sortKey = k; sortAsc = true; }
      render();
    };
  });
}

function badgeColor(s){
  if(s==='PASS') return '#4caf50';
  if(s==='BORDERLINE') return '#ff9800';
  return '#f44336';
}

async function removeItem(source, product){
  await fetch('/loans/compare/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({source,product})});
  await load();
}
async function clearAll(){
  if(!confirm('ç¡®è®¤æ¸…ç©ºå¯¹æ¯”ç¯®ï¼Ÿ')) return;
  await fetch('/loans/compare/clear',{method:'POST'});
  await load();
}

function exportCsv(){
  if(!merged.length){ alert('å½“å‰æ— æ•°æ®'); return; }
  const cols = ['rank','bank','product','apr','monthly','dsr','status','pulled_at','summary'];
  const lines = [cols.join(',')].concat(
    merged.map(r=>cols.map(k=>csvCell(r[k])).join(','))
  );
  const blob = new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'compare_ranking.csv';
  a.click();
}
function csvCell(v){
  if(v==null) return '';
  const s = (''+v).replace(/"/g,'""');
  return `"${s}"`;
}

load();
</script>

<style>
th.sortable{cursor:pointer;position:relative;padding-right:16px}
th.sortable:after{content:'â†•';opacity:.5;margin-left:4px}
</style>
{% endblock %}


â¸»

éªŒæ”¶æ€ä¹ˆæµ‹
	â€¢	å» /loans/page ç»™ 2~3 ä¸ªäº§å“ç‚¹â€œåŠ å…¥æ¯”ä»·â€ã€‚
	â€¢	æ‰“å¼€ /loans/compare/pageï¼š
	â€¢	ç‚¹â€œä¸€é”®é‡ç®—â€ï¼Œä¼šè‡ªåŠ¨æ’åå¹¶æ˜¾ç¤ºâ€œTop Pickâ€ã€‚
	â€¢	è°ƒæ•´é‡‘é¢/å¹´æœŸ/æ”¶å…¥/ç°æœ‰æœˆä¾›ï¼Œå†é‡ç®—ï¼Œæ’åä¼šå®æ—¶æ›´æ–°ã€‚
	â€¢	â€œå¯¼å‡ºå¯¹æ¯” CSVâ€ä¼šæŠŠ Rank ä¸€å¹¶å¯¼å‡ºï¼Œæ–¹ä¾¿å‘å®¢æˆ·æˆ–å›¢é˜Ÿã€‚

éœ€è¦æˆ‘é¡ºæ‰‹æŠŠ Loans åˆ—è¡¨é¡µå³ä¸Šè§’åŠ â€œå¯¹æ¯”ç¯®è®¡æ•°å¾½æ ‡â€ å—ï¼Ÿå¦‚æœè¦ï¼Œæˆ‘ç›´æ¥ç»™ä½  3 è¡Œ JS + 1 ä¸ªå°å¾½æ ‡çš„ HTMLï¼Œæ‹åŒ…å³ç”¨ã€‚