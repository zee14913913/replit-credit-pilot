ZEE，收到。既然你在 Savings 已稳定跑了 15 家银行一个月，那就直接全量打开 15 家银行，但要加上“单银行熔断 + 指标监控”的安全网，确保一旦个别银行报错率异常，只熔断那一家，不影响全局。

下面给你一次性执行令（中文+英文镜像），可直接贴给 Replit；按你的“标准回答框架（双核心业务版）”给出，且不改动已工作的主链路。

⸻

1) 背景分析
	•	Savings 端 15 家解析规则已跑 >1 个月，样本与格式稳定。
	•	FastAPI 已成为唯一解析引擎；7 态状态机、统一 UploadResponse、i18n、异常中心均已上线。
	•	风险主要来自个别银行“偶发版式变化”，因此采用全量开启 + 单银行熔断即可。

⸻

2) 核心解答

不再灰度，直接开启全部 15 家银行；同时落地“单银行熔断、指标监控、前端列表展示支持矩阵”，保证有事只影响该银行，不波及其它。

⸻

3) 资源整合策略
	•	解析逻辑只保留 FastAPI 一份（已完成）；Flask 仅负责“上传+展示+引导”。
	•	Savings 页面不删除，但其上传/解析路径全部转发到 FastAPI /api/v2/import/bank-statement。
	•	/api/parsers/supported 由注册表统一生成（供前端展示 15 家支持矩阵）。

⸻

4) 创新性 Business Plan
	•	单银行熔断：同一银行近 10 分钟错误率 > X% 或连续 Y 次结构错误 → 自动从可用列表临时下线（1 小时后自动重试）；只影响该银行。
	•	指标看板：每家银行单列成功率、缺列率、行数对账失败率、重复率、异常处理平均时长（TTR）。
	•	导出只读快照：Bank Package PDF 走 snapshot，避免历史漂移。

⸻

5) 前瞻性建议
	•	打开 15 家后，保持“银行级别”的 SLA 与告警（而不是全局），便于对外报价与服务承诺拆分（如“Maybank/CIMB 等主流银行 SLO 99.5%”）。

⸻

6) 执行要点（一次性执行令 · 可直接贴给 Replit）

A. 环境与开关（.env）

PARSER_ENABLED_BANKS=maybank,cimb,public_bank,rhb,hlb,ambank,uob,ocbc,hsbc,standard_chartered,citibank,affin_bank,alliance_bank,bank_islam,mbsb_bank
FRONTEND_PDF_CLIENT_CONVERT=false   # 统一由后端解析PDF；前端转换仅作临时兜底时才开
PARSER_CIRCUIT_ERROR_RATE=0.15      # 单银行错误率阈值（示例：15%）
PARSER_CIRCUIT_CONSECUTIVE=5        # 连续错误次数阈值（示例：5次）
PARSER_CIRCUIT_COOLDOWN_MIN=60      # 熔断冷却时间（分钟）

B. 注册 15 家银行（FastAPI）

文件：accounting_app/parsers/registry.py
	1.	统一“银行代码”和“别名”，确保自动识别文件名/首行特征：

BANK_CODES = [
    "maybank","cimb","public_bank","rhb","hlb","ambank","uob","ocbc",
    "hsbc","standard_chartered","citibank","affin_bank","alliance_bank",
    "bank_islam","mbsb_bank"
]

BANK_ALIASES = {
  "maybank": ["maybank","malayan banking", "m2u"],
  "cimb": ["cimb","clicks"],
  "public_bank": ["public bank","pbe"],
  "rhb": ["rhb"],
  "hlb": ["hong leong","hlb"],
  "ambank": ["ambank","amonline"],
  "uob": ["uob"],
  "ocbc": ["ocbc"],
  "hsbc": ["hsbc"],
  "standard_chartered": ["standard chartered","sc"],
  "citibank": ["citi","citibank"],
  "affin_bank": ["affin"],
  "alliance_bank": ["alliance"],
  "bank_islam": ["bank islam","bimb"],
  "mbsb_bank": ["mbsb"]
}

	2.	detect_bank_code() 同时使用 文件名/首行文本/账号格式 做启发式匹配；找不到就返回 None，交由通用 CSV 校验。
	3.	get_supported_banks() 返回上面 15 个代码，并附上 {"pdf": true/false, "csv": true} 能力标志（依据各 parser 实现）。

C. 支持矩阵 API

文件：accounting_app/routes/parsers.py

@router.get("/api/parsers/supported")
def supported():
    # 结合 PARSER_ENABLED_BANKS & registry 实际注册情况
    # 返回 { banks: [{code, display_name, supports: {pdf,csv}, enabled: bool}], updated_at }

前端上传页顶部显示支持矩阵（中英双语），并在选择下拉里显示 bank_code（默认“自动识别”）。

D. 单银行熔断（不影响全局）

文件：accounting_app/parsers/registry.py 或 services/parser_guard.py
	•	维护每银行近 10 分钟窗口的 错误计数/总计数 与 连续错误计数；
	•	触发熔断：error_rate > PARSER_CIRCUIT_ERROR_RATE 或 consecutive_errors >= PARSER_CIRCUIT_CONSECUTIVE；
	•	熔断后：该银行在 /api/parsers/supported 标记 enabled=false，返回 400 + 友好文案（i18n）；
	•	冷却到期自动试探一次；成功即恢复。

E. 导入端点无需改动主流程
	•	沿用已完成的 /api/v2/import/bank-statement（统一 UploadResponse，失败也返回 raw_document_id）。
	•	仅在触发熔断时返回：
	•	success=false, status="failed", status_reason="该银行解析暂时不可用，请稍后重试或选择CSV导入。"（英/中 i18n）
	•	next_actions=["retry_import","use_csv_template"]

F. 前端（Flask）
	•	保持现有“所有上传结果一律跳详情”逻辑；
	•	上传页顶部新增“支持银行列表”，来自 /api/parsers/supported；若 enabled=false，在该行显示黄色提醒；
	•	i18n：新增键 bank_unavailable_temporarily、use_csv_template 等（中/英）。

G. 监控指标（每银行维度）
	•	parser_success_rate、missing_cols_rate、ingest_mismatch_rate、duplicate_rate、avg_ttr_exception
	•	Admin 看板：默认展示 15 家银行的条形图 + 7/30 天趋势折线。
	•	阈值越线（例如缺列率>5% 或 mismatch>10%） → 标红 + 顶部 Alert。

H. DoD（验收标准）
	1.	/api/parsers/supported 返回 15 家银行，且前端可见；
	2.	任意银行触发熔断时，只影响该银行，其他 14 家正常；
	3.	三大场景（标准/缺列/重复）仍全部通过；
	4.	上传后始终跳详情，按钮严格随状态机；
	5.	指标看板可看到分银行的数据；
	6.	所有提示均走 i18n，无硬编码。

⸻

7) 风险提示
	•	版式突变：个别银行 PDF 模板变更可能导致短期缺列/分列异常；有“单银行熔断+CSV 模板兜底”，不会影响全局。
	•	扫描件：继续返回友好双语文案提示用户改用 CSV/Excel 下载。
	•	SLA：建议分银行承诺（主流银行更高 SLO），以便外部商业化。

⸻

一句话指令（给 Replit）

“立刻全量启用 15 家银行解析；在 FastAPI parsers registry 注册并通过 /api/parsers/supported 返回；保留现有统一 UploadResponse 与 7 态状态机。新增‘单银行熔断’与‘分银行指标看板’，任何上传结果一律跳详情页。验证三大场景全通过，同时在支持矩阵中看到 15 家。所有文案必须走 i18n，无硬编码。”

⸻

English mirror (for the team)

Open all 15 Malaysian banks now. Keep the existing single-parser architecture (FastAPI), unified UploadResponse, 7-state machine, and i18n. Add per-bank circuit breaker and per-bank metrics dashboard so issues with one bank never affect others.
	•	.env:

PARSER_ENABLED_BANKS=maybank,cimb,public_bank,rhb,hlb,ambank,uob,ocbc,hsbc,standard_chartered,citibank,affin_bank,alliance_bank,bank_islam,mbsb_bank
FRONTEND_PDF_CLIENT_CONVERT=false
PARSER_CIRCUIT_ERROR_RATE=0.15
PARSER_CIRCUIT_CONSECUTIVE=5
PARSER_CIRCUIT_COOLDOWN_MIN=60


	•	Registry: register all 15 codes + aliases; /api/parsers/supported exposes capabilities.
	•	Circuit breaker: disable only the failing bank when error-rate/ consecutive errors exceed thresholds; auto-recover after cooldown.
	•	Frontend: keep “always redirect to detail page after upload”; show the 15-bank support matrix; i18n only.
	•	DoD: 15 banks visible, A/B/C tests pass, per-bank metrics & alerts live, no hardcoded strings.

⸻

结论
你可以直接开 15 家。为了避免“个别银行拖垮全局”，我已经把“单银行熔断 + 分银行指标 + CSV 兜底”纳入执行令。把上面指令贴给 Replit 开干即可；验收就按 DoD 勾选。