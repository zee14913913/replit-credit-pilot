{
  "info": {
    "name": "Card Optimizer API Tests",
    "description": "Complete API test suite for Smart Card Optimizer v5.1",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:5000",
      "type": "string"
    },
    {
      "key": "customer_id",
      "value": "CJY001",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1️⃣ Card Optimizer - Generate Plan",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"customer_id\": \"{{customer_id}}\",\n  \"expected_amount\": 5000.00,\n  \"expected_date\": \"2025-12-01\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/card-optimizer/generate-plan",
          "host": ["{{base_url}}"],
          "path": ["api", "card-optimizer", "generate-plan"]
        },
        "description": "生成智能刷卡优化方案\n\n✅ 验证点：\n- 返回 plan_id\n- 每张卡有 score, free_days, risk_level\n- free_days ≥ 50 的卡排名靠前\n- 利用率 >80% 的卡显示风险警告"
      },
      "response": []
    },
    {
      "name": "2️⃣ Card Optimizer - Confirm Plan",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// 设置 plan_id（需要先执行 Generate Plan 获取）",
              "// pm.environment.set('plan_id', 'PLAN-202511-CJY001');"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"plan_id\": \"{{plan_id}}\",\n  \"selected_card_id\": 1,\n  \"consent_confirmed\": true\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/card-optimizer/confirm-plan",
          "host": ["{{base_url}}"],
          "path": ["api", "card-optimizer", "confirm-plan"]
        },
        "description": "确认并执行优化方案\n\n✅ 验证点：\n- plan 状态变为 'executed'\n- card_risk_consents 表新增记录\n- audit_logs 记录操作"
      },
      "response": []
    },
    {
      "name": "3️⃣ Accounting - Import Supplier Transaction",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"customer_id\": \"{{customer_id}}\",\n  \"card_id\": 1,\n  \"transaction_date\": \"2025-11-12\",\n  \"description\": \"7SL TECH SDN BHD\",\n  \"amount\": 1000.00,\n  \"type\": \"DEBIT\",\n  \"merchant_category\": \"supplier\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/accounting/import-transaction",
          "host": ["{{base_url}}"],
          "path": ["api", "accounting", "import-transaction"]
        },
        "description": "模拟 Supplier 消费 + 手续费拆分\n\n✅ 验证点：\n- transactions 表新增 2 条记录\n- 记录1: 990 (infinite_expense, GZ支付)\n- 记录2: 10 (owner_expense, 1% fee)\n- is_fee_split=true\n- fee_reference_id 正确关联"
      },
      "response": []
    },
    {
      "name": "4️⃣ Risk Test - High Utilization Card",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"customer_id\": \"{{customer_id}}\",\n  \"expected_amount\": 15000.00,\n  \"expected_date\": \"2025-11-15\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/card-optimizer/generate-plan",
          "host": ["{{base_url}}"],
          "path": ["api", "card-optimizer", "generate-plan"]
        },
        "description": "触发风险验证（模拟刷爆卡）\n\n✅ 验证点：\n- 利用率 >90% 的卡标记为 EXTREME\n- risk_validator 返回警告\n- 建议 \"Do not use until repayment\""
      },
      "response": []
    },
    {
      "name": "5️⃣ Monthly Summary - Owner vs GZ Split",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/accounting/monthly-summary?customer_id={{customer_id}}&month=2025-11",
          "host": ["{{base_url}}"],
          "path": ["api", "accounting", "monthly-summary"],
          "query": [
            {
              "key": "customer_id",
              "value": "{{customer_id}}"
            },
            {
              "key": "month",
              "value": "2025-11"
            }
          ]
        },
        "description": "验证账本对账一致性\n\n✅ 验证点：\n- total_infinite_expenses = GZ 支付总额\n- total_owner_fees = 1% merchant fee 合计\n- closing_balance = opening + 消费 + fee - 付款\n- diff ≤ 0.01 → 对账成功"
      },
      "response": []
    },
    {
      "name": "6️⃣ Audit Logs - Card Optimizer Operations",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/audit/logs?module=card_optimizer&limit=50",
          "host": ["{{base_url}}"],
          "path": ["api", "audit", "logs"],
          "query": [
            {
              "key": "module",
              "value": "card_optimizer"
            },
            {
              "key": "limit",
              "value": "50"
            }
          ]
        },
        "description": "验证审计追踪\n\n✅ 验证点：\n- action_type = generate_plan, confirm_plan\n- entity_type = card_optimizer_plan\n- 包含 user_id, timestamp, description"
      },
      "response": []
    },
    {
      "name": "7️⃣ Get Customer Cards",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/customers/{{customer_id}}/cards",
          "host": ["{{base_url}}"],
          "path": ["api", "customers", "{{customer_id}}", "cards"]
        },
        "description": "获取客户所有信用卡信息\n\n✅ 验证点：\n- 返回所有卡片及额度\n- 包含 statement_cutoff_day, payment_due_day\n- 包含当前利用率"
      },
      "response": []
    },
    {
      "name": "8️⃣ Get Optimizer Plans History",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/card-optimizer/plans?customer_id={{customer_id}}&limit=10",
          "host": ["{{base_url}}"],
          "path": ["api", "card-optimizer", "plans"],
          "query": [
            {
              "key": "customer_id",
              "value": "{{customer_id}}"
            },
            {
              "key": "limit",
              "value": "10"
            }
          ]
        },
        "description": "获取历史优化方案\n\n✅ 验证点：\n- 按时间倒序返回\n- 显示 status (pending/executed/cancelled)\n- 包含每个方案的推荐卡片"
      },
      "response": []
    }
  ]
}
